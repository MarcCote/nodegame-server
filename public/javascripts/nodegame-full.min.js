/**
 * # Shelf.JS 
 * 
 * Persistent Client-Side Storage @VERSION
 * 
 * Copyright 2012 Stefano Balietti
 * GPL licenses.
 * 
 * ---
 * 
 */
(function(e){var t="0.3",n=e.store=function(e,t,r,i){r=r||{},i=r.type&&r.type in n.types?r.type:n.type;if(!i||!n.types[i]){n.log("Cannot save/load value. Invalid storage type selected: "+i,"ERR");return}return n.log("Accessing "+i+" storage"),n.types[i](e,t,r)};n.name="__shelf__",n.verbosity=0,n.types={};var r="volatile";try{Object.defineProperty(n,"type",{set:function(e){return"undefined"==typeof n.types[e]?(n.log("Cannot set store.type to an invalid type: "+e),!1):(r=e,e)},get:function(){return r},configurable:!1,enumerable:!0})}catch(i){n.type=r}n.addType=function(e,t){n.types[e]=t,n[e]=function(t,r,i){return i=i||{},i.type=e,n(t,r,i)};if(!n.type||n.type==="volatile")n.type=e},n.error=function(){return"shelf quota exceeded"},n.log=function(e){n.verbosity>0&&console.log("Shelf v."+t+": "+e)},n.isPersistent=function(){return n.types?n.type==="volatile"?!1:!0:!1};try{Object.defineProperty(n,"persistent",{set:function(){},get:n.isPersistent,configurable:!1})}catch(i){n.persistent=!1}n.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},n.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},n.stringify=function(e){if(!JSON||!JSON.stringify||"function"!=typeof JSON.stringify)throw new Error("JSON.stringify not found. Received non-string value and could not serialize.");return e=n.decycle(e),JSON.stringify(e)},n.parse=function(e){if("undefined"==typeof e)return undefined;if(JSON&&JSON.parse&&"function"==typeof JSON.parse)try{e=JSON.parse(e)}catch(t){n.log("Error while parsing a value: "+t,"ERR"),n.log(e)}return e=n.retrocycle(e),e},function(){function r(e){return n.parse(n.stringify(e))}var e={},t={};n.addType("volatile",function(n,i,s){return n?i===undefined?r(e[n]):(t[n]&&(clearTimeout(t[n]),delete t[n]),i===null?(delete e[n],null):(e[n]=i,s.expires&&(t[n]=setTimeout(function(){delete e[n],delete t[n]},s.expires)),i)):r(e)})}()})("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:this),function(e){var t=e.store;if(!t){console.log("cookie.shelf.js: shelf.js core not found. Cookie storage not available.");return}if("undefined"==typeof window){console.log("cookie.shelf.js: am I running in a browser? Cookie storage not available.");return}var n=function(){var e,n,r,i,s={expiresAt:null,path:"/",domain:null,secure:!1};return e=function(e){var t,n;return typeof e!="object"||e===null?t=s:(t={expiresAt:s.expiresAt,path:s.path,domain:s.domain,secure:s.secure},typeof e.expiresAt=="object"&&e.expiresAt instanceof Date?t.expiresAt=e.expiresAt:typeof e.hoursToLive=="number"&&e.hoursToLive!==0&&(n=new Date,n.setTime(n.getTime()+e.hoursToLive*60*60*1e3),t.expiresAt=n),typeof e.path=="string"&&e.path!==""&&(t.path=e.path),typeof e.domain=="string"&&e.domain!==""&&(t.domain=e.domain),e.secure===!0&&(t.secure=e.secure)),t},n=function(t){return t=e(t),(typeof t.expiresAt=="object"&&t.expiresAt instanceof Date?"; expires="+t.expiresAt.toGMTString():"")+"; path="+t.path+(typeof t.domain=="string"?"; domain="+t.domain:"")+(t.secure===!0?"; secure":"")},r=function(){var e={},n,r,i,s,o=document.cookie.split(";"),u;for(n=0;n<o.length;n+=1){r=o[n].split("="),i=r[0].replace(/^\s*/,"").replace(/\s*$/,"");try{s=decodeURIComponent(r[1])}catch(a){s=r[1]}e[i]=t.parse(s)}return e},i=function(){},i.prototype.get=function(e){var t,n,i=r();if(typeof e=="string")t=typeof i[e]!="undefined"?i[e]:null;else if(typeof e=="object"&&e!==null){t={};for(n in e)typeof i[e[n]]!="undefined"?t[e[n]]=i[e[n]]:t[e[n]]=null}else t=i;return t},i.prototype.filter=function(e){var t,n={},i=r();typeof e=="string"&&(e=new RegExp(e));for(t in i)t.match(e)&&(n[t]=i[t]);return n},i.prototype.set=function(e,r,i){if(typeof i!="object"||i===null)i={};typeof r=="undefined"||r===null?(r="",i.hoursToLive=-8760):typeof r!="string"&&(r=t.stringify(r));var s=n(i);document.cookie=e+"="+encodeURIComponent(r)+s},i.prototype.del=function(e,t){var n={},r;if(typeof t!="object"||t===null)t={};typeof e=="boolean"&&e===!0?n=this.get():typeof e=="string"&&(n[e]=!0);for(r in n)typeof r=="string"&&r!==""&&this.set(r,null,t)},i.prototype.test=function(){var e=!1,t="cT",n="data";return this.set(t,n),this.get(t)===n&&(this.del(t),e=!0),e},i.prototype.setOptions=function(t){typeof t!="object"&&(t=null),s=e(t)},new i}();n.test()&&t.addType("cookie",function(e,t,r){return"undefined"==typeof e?n.get():"undefined"==typeof t?n.get(e):t===null?(n.del(e),null):n.set(e,t,r)})}(this),function(e){function r(e,r){t.addType(e,function(i,s,o){var u,a,f,l,c=s,h=(new Date).getTime();if(!i){c={},l=[],f=0;try{i=r.length;while(i=r.key(f++))n.test(i)&&(a=t.parse(r.getItem(i)),a.expires&&a.expires<=h?l.push(i):c[i.replace(rprefix,"")]=a.data);while(i=l.pop())r.removeItem(i)}catch(p){}return c}i=t.name+i;if(s===undefined){u=r.getItem(i),a=u?t.parse(u):{expires:-1};if(!(a.expires&&a.expires<=h))return a.data;r.removeItem(i)}else if(s===null)r.removeItem(i);else{a=t.stringify({data:s,expires:o.expires?h+o.expires:null});try{r.setItem(i,a)}catch(p){t[e]();try{r.setItem(i,a)}catch(p){throw t.error()}}}return c})}var t=e.store;if(!t){console.log("amplify.shelf.js: shelf.js core not found. Amplify storage not available.");return}if("undefined"==typeof window){console.log("amplify.shelf.js: am I running in a browser? Amplify storage not available.");return}var n=new RegExp("^"+t.name);for(var i in{localStorage:1,sessionStorage:1})try{window[i].getItem&&r(i,window[i])}catch(s){}if(!t.types.localStorage&&window.globalStorage)try{r("globalStorage",window.globalStorage[window.location.hostname]),t.type==="sessionStorage"&&(t.type="globalStorage")}catch(s){}(function(){if(t.types.localStorage)return;var e=document.createElement("div"),n="shelf";e.style.display="none",document.getElementsByTagName("head")[0].appendChild(e);try{e.addBehavior("#default#userdata"),e.load(n)}catch(r){e.parentNode.removeChild(e);return}t.addType("userData",function(r,i,s){e.load(n);var o,u,a,f,l,c=i,h=(new Date).getTime();if(!r){c={},l=[],f=0;while(o=e.XMLDocument.documentElement.attributes[f++])u=t.parse(o.value),u.expires&&u.expires<=h?l.push(o.name):c[o.name]=u.data;while(r=l.pop())e.removeAttribute(r);return e.save(n),c}r=r.replace(/[^-._0-9A-Za-z\xb7\xc0-\xd6\xd8-\xf6\xf8-\u037d\u37f-\u1fff\u200c-\u200d\u203f\u2040\u2070-\u218f]/g,"-"),r=r.replace(/^-/,"_-");if(i===undefined){o=e.getAttribute(r),u=o?t.parse(o):{expires:-1};if(!(u.expires&&u.expires<=h))return u.data;e.removeAttribute(r)}else i===null?e.removeAttribute(r):(a=e.getAttribute(r),u=t.stringify({data:i,expires:s.expires?h+s.expires:null}),e.setAttribute(r,u));try{e.save(n)}catch(p){a===null?e.removeAttribute(r):e.setAttribute(r,a),t.userData();try{e.setAttribute(r,u),e.save(n)}catch(p){throw a===null?e.removeAttribute(r):e.setAttribute(r,a),t.error()}}return c})})()}(this),function(e){function i(){if(u())return!1;for(var e=0;e<r.length;e++)r[e].call(r[e])}function s(){n=!0}function o(){n=!1}function u(){return n}function a(e){r.push(e)}var t=e.store;if(!t){console.log("fs.shelf.js: shelf.js core not found. File system storage not available.");return}var n=!1,r=[],f=0;t.filename="./shelf.out";var l=require("fs"),c=require("path"),h=require("util"),p=65536,d=new Buffer(p),v=function(e,t){var n,r,i,s;r=l.openSync(e,"r"),i=l.openSync(t,"w"),n=1,s=0;while(n>0)n=l.readSync(r,d,0,p,s),l.writeSync(i,d,0,n),s+=n;return l.closeSync(r),l.closeSync(i)},m={},g=function(e,n){if(u())return a(this),!1;s();var r=e||t.filename;if(!r)return t.log("You must specify a valid file.","ERR"),!1;var f=c.dirname(r)+"/."+c.basename(r);v(r,f);var h=t.stringify(n);return h=h.substr(1,h=h.substr(0,h.legth-1)),l.writeFileSync(r,h,"utf-8"),l.unlinkSync(f),o(),i(),!0};if("undefined"!=typeof l.appendFileSync)var y=function(e,n,r){var i=e||t.filename;if(!i)return t.log("You must specify a valid file.","ERR"),!1;if(!n)return;var s=t.stringify(n)+": "+t.stringify(r)+",\n";return l.appendFileSync(i,s,"utf-8")};else var y=function(e,n,r){var i=e||t.filename;if(!i)return t.log("You must specify a valid file.","ERR"),!1;if(!n)return;var s=t.stringify(n)+": "+t.stringify(r)+",\n",o=l.openSync(i,"a","0666");return l.writeSync(o,s,null,"utf8"),l.closeSync(o),!0};var b=function(e,n){var r=e||t.filename;if(!r)return t.log("You must specify a valid file.","ERR"),!1;var i=l.readFileSync(r,"utf-8");i=i.substr(0,i.length-2);var s=t.parse("{"+i+"}");return n?s[n]:s},w=function(e,n){var r=e||t.filename,i=b(r);return delete i[n],g(r,i),null};t.addType("fs",function(e,n,r){var i=r.file||t.filename;return e?n===undefined?b(i,e):(m[e]&&(clearTimeout(m[e]),w(i,e)),n===null?(w(i,e),null):(y(i,e,n),r.expires&&(m[e]=setTimeout(function(){w(i,e)},r.expires)),n)):b(i)})}("undefined"!=typeof module&&"function"==typeof require?module.exports||module.parent.exports:{}),function(e){var t=e.JSUS={};t._classes={},t.log=function(e){console.log(e)},t.extend=function(e,n){if("object"!=typeof e&&"function"!=typeof e)return n;if("undefined"==typeof n){n=n||this;if("function"==typeof e){var r=e.toString();r=r.substr("function ".length),r=r.substr(0,r.indexOf("("))}else var r=e.constructor||e.__proto__.constructor;r&&(this._classes[r]=e)}for(var i in e)e.hasOwnProperty(i)&&(typeof n[i]!="object"?n[i]=e[i]:t.extend(e[i],n[i]));return e.prototype&&t.extend(e.prototype,n.prototype||n),n},t.require=t.get=function(e){return"undefined"==typeof t.clone?(t.log("JSUS.clone not found. Cannot continue."),!1):"undefined"==typeof e?t.clone(t._classes):"undefined"==typeof t._classes[e]?(t.log("Could not find class "+e),!1):t.clone(t._classes[e])},t.isNodeJS=function(){return"undefined"!=typeof module&&"undefined"!=typeof module.exports&&"function"==typeof require},t.isNodeJS()&&(require("./lib/compatibility"),require("./lib/obj"),require("./lib/array"),require("./lib/time"),require("./lib/eval"),require("./lib/dom"),require("./lib/random"),require("./lib/parse"),require("./lib/fs"))}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window),function(JSUS){function COMPATIBILITY(){}COMPATIBILITY.compatibility=function(){var support={};try{Object.defineProperty({},"a",{enumerable:!1,value:1}),support.defineProperty=!0}catch(e){support.defineProperty=!1}try{eval("({ get x(){ return 1 } }).x === 1"),support.setter=!0}catch(err){support.setter=!1}try{var value;eval("({ set x(v){ value = v; } }).x = 1"),support.getter=!0}catch(err){support.getter=!1}return support},JSUS.extend(COMPATIBILITY)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}Array.prototype.filter||(Array.prototype.filter=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=[],i=arguments[1];for(var s=0;s<n;s++)if(s in t){var o=t[s];e.call(i,o,s,t)&&r.push(o)}return r}),t.isArray=function(e){return e?Object.prototype.toString.call(e)==="[object Array]":!1},t.seq=function(t,n,r,i){if("number"!=typeof t)return!1;if(t===Infinity)return!1;if("number"!=typeof n)return!1;if(n===Infinity)return!1;if(t===n)return[t];if(r===0)return!1;if(!e.in_array(typeof r,["undefined","number"]))return!1;r=r||1,i=i||function(e){return e};var s=t,o=[];if(t<n)while(s<=n)o.push(i(s)),s+=r;else while(s>=n)o.push(i(s)),s-=r;return o},t.each=function(e,t,n){if("object"!=typeof e)return!1;if(!t)return!1;n=n||this;var r,i=e.length;for(r=0;r<i;r++)t.call(n,e[r]);return!0},t.map=function(){if(arguments.length<2)return;var n=Array.prototype.slice.call(arguments),r=n.shift(),i=n[0];if(!t.isArray(r)){e.log("ARRAY.map() the first argument must be an array. Found: "+r);return}var s=[],o=undefined;for(var u=0;u<r.length;u++)n[0]=r[u],o=i.apply(this,n),"undefined"!=typeof o&&s.push(o);return s},t.removeElement=function(t,n){if("undefined"==typeof t||!n)return!1;if("object"==typeof t)var r=e.equals;else var r=function(e,t){return e===t};for(var i=0;i<n.length;i++)if(r(t,n[i]))return n.splice(i,1);return!1},t.inArray=t.in_array=function(t,n){if(!n)return!1;var r=e.equals;for(var i=0;i<n.length;i++)if(r.call(this,t,n[i]))return!0;return!1},t.getNGroups=function(e,n){return t.getGroupsSizeN(e,Math.floor(e.length/n))},t.getGroupsSizeN=function(e,t){var n=e.slice(0),r=n.length,i=n.length,s=[],o,u,a=[],f=0;for(o=0;o<i;o++)u=Math.floor(Math.random()*r),f>=t&&(s.push(a),f=0,a=[]),a.push(n[u]),n.splice(u,1),r=n.length,f++;return a.length>0&&s.push(a),s},t._latinSquare=function(t,n,r){r="undefined"==typeof r?!0:r;if(t===n&&!r)return!1;var i=[],s=[];for(var o=0;o<t;o++)i[o]=o;var u=null,a=0,f=t,l=[];r||(f=t-1);for(o=0;o<n;o++){do u=e.randomInt(a,f);while(e.in_array(u,l));l.push(u),u==1?(s[o]=i.slice(u),s[o].push(0)):s[o]=i.slice(u).concat(i.slice(0,u))}return s},t.latinSquare=function(e,n){return n||(n=e),!e||e<0||n<0?!1:(n>e&&(n=e),t._latinSquare(e,n,!0))},t.latinSquareNoSelf=function(e,n){return n||(n=e-1),!e||e<0||n<0?!1:(n>e&&(n=e-1),t._latinSquare(e,n,!1))},t.generateCombinations=function(t,n){function r(e,t){var n=[];for(var r=0;r<e.length;r++)n.push(t[e[r]]);return n}var i=t.length,s=[];for(var o=0;o<n;o++)s.push(o);var u=[];for(var o=i-n;o<i;o++)u.push(o);while(!e.equals(s,u)){callback(r(s,t));var o=n-1;while(s[o]==i-n+o)o-=1;s[o]+=1;for(var a=o+1;a<n;a++)s[a]=s[o]+a-o}return r(s,t)},t.matchN=function(e,n,r){if(!e)return;if(!n)return e;var i=[],s=e.length,o=[];for(var u=0;u<s;u++){var a=e.slice(0);a.splice(u,1),r&&(a=t.arrayDiff(a,o));var f=t.getNRandom(a,n);o=o.concat(f),f.splice(0,0,e[u]),i.push(f),f=[]}return i},t.rep=function(t,n){if(!t)return;if(!n)return t.slice(0);if(n<1){e.log("times must be greater or equal 1","ERR");return}var r=1,i=t.slice(0);for(;r<n;r++)i=i.concat(t);return i},t.stretch=function(n,r){if(!n)return;if(!r)return n.slice(0);if("number"==typeof r){if(r<1){e.log("times must be greater or equal 1","ERR");return}r=t.rep([r],n.length)}var i=[];for(var s=0;s<n.length;s++){var o=r[s%r.length];for(var u=0;u<o;u++)i.push(n[s])}return i},t.arrayIntersect=function(t,n){return t.filter(function(t){return e.in_array(t,n)})},t.arrayDiff=function(t,n){return t.filter(function(t){return!e.in_array(t,n)})},t.shuffle=function(e){if(!e)return;var t=e.slice(0),n=e.length-1,r,i;for(var s=n;s>0;s--)r=Math.floor(Math.random()*(s+1)),i=t[r],t[r]=t[s],t[s]=i;return t},t.getNRandom=function(e,n){return t.shuffle(e).slice(0,n)},t.distinct=function(e){var n=[];return e?(t.each(e,function(e){t.in_array(e,n)||n.push(e)}),n):n},t.transpose=function(e){if(!e)return;var n,r,i,s,o=[];n=e.length||0,r=t.isArray(e[0])?e[0].length:0;if(n===0||r===0)return o;for(i=0;i<r;i++){o[i]=[];for(s=0;s<n;s++)o[i][s]=e[s][i]}return o},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.write=function(t,n){if(!t)return;if(!n)return;var r=!e.isNode(n)||!e.isElement(n)?document.createTextNode(n):n;return t.appendChild(r),r},t.writeln=function(e,n,r){if(!e)return;var i=this.addBreak(e,r);return n?t.write(e,n):i},t.sprintf=function(t,n,r){var i,s,o,u,a,f,l,c={};if(!n)return document.createTextNode(t);r=r||document.createElement("span");for(var h in n)if(n.hasOwnProperty(h)){if(u===-1)continue;switch(h[0]){case"%":u=t.indexOf(h),f=u+h.length,a=t.indexOf(h,f);if(a===-1){e.log("Error. Could not find closing key: "+h);continue}c[u]=h;break;case"@":t=t.replace(h,escape(n[h]));break;case"!":t=t.replace(h,n[h]);break;default:e.log("Identifier not in [!,@,%]: "+h[0])}}if(!e.size(c))return document.createTextNode(t);l=e.keys(c).sort(function(e,t){return e-t}),a=0;for(var p=0;p<l.length;p++)h=c[l[p]],u=t.indexOf(h),a!==u-1&&r.appendChild(document.createTextNode(t.substring(a,u))),f=u+h.length,a=t.indexOf(h,f),o=W.getElement("span",null,n[h]),i=t.substring(f,a),o.appendChild(document.createTextNode(i)),r.appendChild(o),a+=h.length;return a!==t.length&&r.appendChild(document.createTextNode(t.substring(a))),r},t.isNode=function(e){return typeof Node=="object"?e instanceof Node:typeof e=="object"&&typeof e.nodeType=="number"&&typeof e.nodeName=="string"},t.isElement=function(e){return typeof HTMLElement=="object"?e instanceof HTMLElement:typeof e=="object"&&e.nodeType===1&&typeof e.nodeName=="string"},t.getElement=function(e,t,n){var r=document.createElement(e);return"undefined"!=typeof t&&(r.id=t),this.addAttributes2Elem(r,n)},t.addElement=function(e,t,n,r){var i=this.getElement(e,n,r);return t.appendChild(i)},t.addAttributes2Elem=function(t,n){if(!t||!n)return t;if("object"!=typeof n)return t;var r=["id","label"];for(var i in n)n.hasOwnProperty(i)&&(e.in_array(i,r)?i==="id"&&(t.id=n[i]):t.setAttribute(i,n[i]));return t},t.populateSelect=function(e,t){if(!e||!t)return;for(var n in t)if(t.hasOwnProperty(n)){var r=document.createElement("option");r.value=t[n],r.appendChild(document.createTextNode(n)),e.appendChild(r)}},t.removeChildrenFromNode=function(e){if(!e)return!1;while(e.hasChildNodes())e.removeChild(e.firstChild);return!0},t.insertAfter=function(e,t){t.insertBefore(e,t.nextSibling)},t.generateUniqueId=function(t){function r(t){var r=!0;while(r)for(var i=0;i<n.length;i++){r=n[i].document.getElementById(t);if(r){t=""+t+"_"+e.randomInt(0,1e3);break}}return t}var n=[window];return window.frames&&(n=n.concat(window.frames)),r(t+"_"+e.randomInt(0,1e7))},t.getBlankPage=function(){var e=document.createElement("html");return e.appendChild(document.createElement("body")),e},t.getButton=function(e,t,n){var r=document.createElement("button");return r.id=e,r.appendChild(document.createTextNode(t||"Send")),this.addAttributes2Elem(r,n)},t.addButton=function(e,t,n,r){var i=this.getButton(t,n,r);return e.appendChild(i)},t.getFieldset=function(e,t,n){var r=this.getElement("fieldset",e,n),i=document.createElement("Legend");return i.appendChild(document.createTextNode(t)),r.appendChild(i),r},t.addFieldset=function(e,t,n,r){var i=this.getFieldset(t,n,r);return e.appendChild(i)},t.getTextInput=function(e,t){var n=document.createElement("input");return"undefined"!=typeof e&&(n.id=e),n.setAttribute("type","text"),this.addAttributes2Elem(n,t)},t.addTextInput=function(e,t,n){var r=this.getTextInput(t,n);return e.appendChild(r)},t.getTextArea=function(e,t){var n=document.createElement("textarea");return"undefined"!=typeof e&&(n.id=e),this.addAttributes2Elem(n,t)},t.addTextArea=function(e,t,n){var r=this.getTextArea(t,n);return e.appendChild(r)},t.getCanvas=function(e,t){var n=document.createElement("canvas"),r=n.getContext("2d");return r?(n.id=e,this.addAttributes2Elem(n,t)):(alert("Canvas is not supported"),!1)},t.addCanvas=function(e,t,n){var r=this.getCanvas(t,n);return e.appendChild(r)},t.getSlider=function(e,t){var n=document.createElement("input");return n.id=e,n.setAttribute("type","range"),this.addAttributes2Elem(n,t)},t.addSlider=function(e,t,n){var r=this.getSlider(t,n);return e.appendChild(r)},t.getRadioButton=function(e,t){var n=document.createElement("input");return n.id=e,n.setAttribute("type","radio"),this.addAttributes2Elem(n,t)},t.addRadioButton=function(e,t,n){var r=this.getRadioButton(t,n);return e.appendChild(r)},t.getLabel=function(e,t,n,r){if(!e)return!1;var i=document.createElement("label");return i.id=t,i.appendChild(document.createTextNode(n)),"undefined"==typeof e.id&&(e.id=this.generateUniqueId()),i.setAttribute("for",e.id),this.addAttributes2Elem(i,r),i},t.addLabel=function(e,t,n,r,i){if(!e||!t||!r)return!1;var s=this.getLabel(t,n,r,i);return e.insertBefore(s,t),s},t.getSelect=function(e,t){return this.getElement("select",e,t)},t.addSelect=function(e,t,n){return this.addElement("select",e,t,n)},t.getIFrame=function(e,t){var t={name:e};return this.getElement("iframe",e,t)},t.addIFrame=function(e,t,n){var r=this.getIFrame(t,n);return e.appendChild(r)},t.addBreak=function(e,t){var n=t||"br",r=document.createElement(n);return e.appendChild(r)},t.getDiv=function(e,t){return this.getElement("div",e,t)},t.addDiv=function(e,t,n){return this.addElement("div",e,t,n)},t.addCSS=function(t,n,r,i){var t=t||document.head||document.body||document;return t?(i=i||{},i=e.merge(i,{rel:"stylesheet",type:"text/css",href:n}),this.addElement("link",t,r,i)):!1},t.addJS=function(t,n,r,i){var t=t||document.head||document.body||document;return t?(i=i||{},i=e.merge(i,{charset:"utf-8",type:"text/javascript",src:n}),this.addElement("script",t,r,i)):!1},t.highlight=function(e,t){if(!e)return;switch(t){case"OK":var n="green";break;case"WARN":var n="yellow";break;case"ERR":var n="red";break;default:if(t[0]==="#")var n=t;else var n="red"}return this.addBorder(e,n)},t.addBorder=function(e,t,n,r){if(!e)return;var t=t||"red",i=i||"5px",r=r||"solid",s={border:i+" "+r+" "+t};return this.style(e,s)},t.style=function(e,n){if(!e||!n)return;if(!t.isElement(e))return;var r="";for(var i in n)r+=i+": "+n[i]+"; ";return e.setAttribute("style",r)},t.removeClass=function(e,t){if(!e||!t)return;var n="/(?:^|s)"+t+"(?!S)/",r=e.className=e.className.replace(n,"");return e},t.addClass=function(e,t){if(!e||!t)return;return t instanceof Array&&(t=t.join(" ")),"undefined"==typeof e.className?e.className=t:e.className+=" "+t,e},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){function EVAL(){}EVAL.eval=function(str,context){if(!str)return;context=context||this;var func=function(str){return eval(str)};return func.call(context,str)},JSUS.extend(EVAL)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}var n=null;"undefined"!=typeof e.compatibility&&(n=e.compatibility()),t.equals=function(e,n){var r=typeof e,i=typeof n;if(r!==i)return!1;if("undefined"===r||"undefined"===i)return e===n;if(e===null||n===null)return e===n;if("number"===r&&isNaN(e)&&"number"===i&&isNaN(n))return isNaN(e)&&isNaN(n);var s={number:"",string:"","boolean":""};if(r in s)return e===n;if("function"===r)return e.toString()===n.toString();for(var o in e)if(e.hasOwnProperty(o)){if("undefined"==typeof n[o]&&"undefined"!=typeof e[o])return!1;if(!n[o]&&e[o])return!1;switch(typeof e[o]){case"function":if(e[o].toString()!==n[o].toString())return!1;default:if(!t.equals(e[o],n[o]))return!1}}for(o in n)if(n.hasOwnProperty(o)){if("undefined"==typeof e[o]&&"undefined"!=typeof n[o])return!1;if(!e[o]&&n[o])return!1}return!0},t.isEmpty=function(e){if("undefined"==typeof e)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},t.size=t.getListSize=function(e){if(!e)return 0;if("number"==typeof e)return 0;if("string"==typeof e)return 0;var t=0;for(var n in e)e.hasOwnProperty(n)&&t++;return t},t._obj2Array=function(e,n,r,i){if("object"!=typeof e)return[e];if(r){i="undefined"!=typeof i?i:1;if(i>r)return[e];i+=1}var s=[];for(var o in e)e.hasOwnProperty(o)&&(n&&s.push(o),"object"==typeof e[o]?s=s.concat(t._obj2Array(e[o],n,r,i)):s.push(e[o]));return s},t.obj2Array=function(e,n){return t._obj2Array(e,!1,n)},t.obj2KeyedArray=t.obj2KeyArray=function(e,n){return t._obj2Array(e,!0,n)},t.keys=t.objGetAllKeys=function(e,n,r){if(!e)return[];n="number"==typeof n&&n>=0?n:0,r="number"==typeof r&&r>=0?r:0;var i=[];for(var s in e)e.hasOwnProperty(s)&&(i.push(s),r<n&&"object"==typeof e[s]&&(i=i.concat(t.objGetAllKeys(e[s],r+1))));return i},t.implode=t.implodeObj=function(e){if(!e)return[];var t=[];for(var n in e)if(e.hasOwnProperty(n)){var r={};r[n]=e[n],t.push(r)}return t},t.clone=function(e){if(!e)return e;if("number"==typeof e)return e;if("string"==typeof e)return e;if("boolean"==typeof e)return e;if(e===NaN)return e;if(e===Infinity)return e;var r;"function"==typeof e?r=function(){return e.apply(r,arguments)}:r=Object.prototype.toString.call(e)==="[object Array]"?[]:{};for(var i in e){var s;e[i]&&"object"==typeof e[i]?Object.prototype.toString.call(e[i])==="[object Array]"?s=e[i].slice(0):s=t.clone(e[i]):s=e[i];if(e.hasOwnProperty(i))r[i]=s;else if(n&&n.defineProperty)Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0});else try{Object.defineProperty(r,i,{value:s,writable:!0,configurable:!0})}catch(o){r[i]=s}}return r},t.join=function(e,n){var r=t.clone(e);if(!n)return r;for(var i in r)r.hasOwnProperty(i)&&"undefined"!=typeof n[i]&&("object"==typeof n[i]?r[i]=t.join(r[i],n[i]):r[i]=n[i]);return r},t.merge=function(e,n){if(!e&&!n)return!1;if(!e)return t.clone(n);if(!n)return t.clone(e);var r=t.clone(e);for(var i in n)n.hasOwnProperty(i)&&(n[i]&&"object"==typeof n[i]?("object"!=typeof r[i]&&(Object.prototype.toString.call(n[i])==="[object Array]"?r[i]=[]:r[i]={}),r[i]=t.merge(r[i],n[i])):r[i]=n[i]);return r},t.mixin=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]=t[n]},t.mixout=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]||(e[n]=t[n])},t.mixcommon=function(e,t){if(!e&&!t)return;if(!e)return t;if(!t)return e;for(var n in t)e[n]&&(e[n]=t[n])},t.mergeOnKey=function(e,n,r){var i=t.clone(e);if(!n||!r)return i;for(var s in n)if(n.hasOwnProperty(s)){if(!i[s]||"object"!=typeof i[s])i[s]={};i[s][r]=n[s]}return i},t.subobj=function(e,n){if(!e)return!1;var r={};if(!n)return r;n instanceof Array||(n=[n]);for(var i=0;i<n.length;i++){var s=n[i];t.hasOwnNestedProperty(s,e)&&t.setNestedValue(s,t.getNestedValue(s,e),r)}return r},t.skim=function(e,n){if(!e)return!1;var r=t.clone(e);if(!n)return r;n instanceof Array||(n=[n]);for(var i=0;i<n.length;i++)t.deleteNestedKey(n[i],r);return r},t.setNestedValue=function(n,r,i){if(!n)return e.log("Cannot set value of undefined property","ERR"),!1;i="object"==typeof i?i:{};var s=n.split(".");if(s.length===1)return i[n]=r,i;var o=s.shift();return i[o]=t.setNestedValue(s.join("."),r,i[o]),i},t.getNestedValue=function(e,n){if(!n)return;var r=e.split(".");if(r.length===1)return n[e];var i=r.shift();return t.getNestedValue(r.join("."),n[i])},t.deleteNestedKey=function(e,n){if(!n)return;var r=e.split(".");if(r.length===1)return delete n[e],!0;var i=r.shift();return"undefined"==typeof n[i]?!1:t.deleteNestedKey(r.join("."),n[i])},t.hasOwnNestedProperty=function(e,n){if(!n)return!1;var r=e.split(".");if(r.length===1)return n.hasOwnProperty(e);var i=r.shift();return t.hasOwnNestedProperty(r.join("."),n[i])},t.split=function(t,n){if(!t)return;if(!n||"object"!=typeof t[n])return e.clone(t);var r=[],i=e.clone(t);i[n]={};var s=function(t){for(var o in t){var u=e.clone(i);t.hasOwnProperty(o)&&("object"==typeof t[o]?r=r.concat(s(t[o])):(u[n][o]=t[o],r.push(u)))}return r};return s(t[n])},t.melt=function(e,t){var n={},r=t.length;for(var i=0;i<e.length;i++)n[e[i]]=t[i%r];return n},t.uniqueKey=function(t,n,r){if(!t){e.log("Cannot find unique name in undefined object","ERR");return}n=n||""+Math.floor(Math.random()*1e10),r=r||1e6;var i=1;while(t[n]){n=n+""+i,i++;if(i>r)return}return n},t.augment=function(e,n,r){var i,s,r=r||t.keys(e);for(i=0;i<r.length;i++)s=r[i],"undefined"!=typeof e[s]&&Object.prototype.toString.call(e[s])!=="[object Array]"&&(e[s]=[e[s]]),"undefined"!==n[s]&&(e[s]||(e[s]=[]),e[s].push(n[s]))},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.random=function(e,t){e="undefined"==typeof e?0:e,t="undefined"==typeof t?0:t;if(e===t)return e;if(t<e){var n=e;e=t,t=n}return Math.random()*(t-e)+e},t.randomInt=function(e,n){return e===n?e:Math.floor(t.random(e,n)+1)},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e){function t(){}t.getDate=t.getFullDate=function(){var e=new Date,t=e.getUTCDate()+"-"+(e.getUTCMonth()+1)+"-"+e.getUTCFullYear()+" "+e.getHours()+":"+e.getMinutes()+":"+e.getSeconds()+" "+e.getMilliseconds();return t},t.getTime=function(){var e=new Date,t=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();return t},t.parseMilliseconds=function(e){if("number"!=typeof e)return;var t=[],n=e/1e3;t[4]=n;var r=n%60;t[3]=Math.floor(r);var n=n/60,i=n%60;t[2]=Math.floor(i);var n=n/60,s=n%24;t[1]=Math.floor(s);var n=n/24,o=n;return t[1]=Math.floor(o),t},e.extend(t)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(JSUS){function PARSE(){}PARSE.stringify_prefix="!?_",PARSE.marker_func=PARSE.stringify_prefix+"function",PARSE.marker_null=PARSE.stringify_prefix+"null",PARSE.marker_und=PARSE.stringify_prefix+"undefined",PARSE.marker_nan=PARSE.stringify_prefix+"NaN",PARSE.marker_inf=PARSE.stringify_prefix+"Infinity",PARSE.marker_minus_inf=PARSE.stringify_prefix+"-Infinity",PARSE.getQueryString=function(e){var t=window.location.search.substring(1);if("undefined"==typeof e)return t;var n=t.split("&");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(i[0]===e)return unescape(i[1])}return!1},PARSE.tokenize=function(e,t,n){if(!e)return;if(!t||!t.length)return[e];n=n||{};var r="[";JSUS.each(t,function(e){e===" "&&(e="\\s"),r+=e}),r+="]+";var i=new RegExp(r);return e.split(i,n.limit)},PARSE.stringify=function(e,t){return JSON.stringify(e,function(e,t){var n=typeof t;return"function"===n?PARSE.stringify_prefix+t.toString():"undefined"===n?PARSE.marker_und:t===null?PARSE.marker_null:"number"===n&&isNaN(t)?PARSE.marker_nan:t==Number.POSITIVE_INFINITY?PARSE.marker_inf:t==Number.NEGATIVE_INFINITY?PARSE.marker_minus_inf:t},t)},PARSE.stringifyAll=function(e,t){for(var n in e)e.hasOwnProperty(n)||("object"==typeof e[n]?e[n]=PARSE.stringifyAll(e[n]):e[n]=e[n]);return PARSE.stringify(e)},PARSE.parse=function(str){function walker(e){if("object"!=typeof e)return reviver(e);for(var t in e)e.hasOwnProperty(t)&&("object"==typeof e[t]?walker(e[t]):e[t]=reviver(e[t]));return e}function reviver(value){var type=typeof value;if(type==="string"){if(value.substring(0,len_prefix)!==PARSE.stringify_prefix)return value;if(value.substring(0,len_func)===PARSE.marker_func)return eval("("+value.substring(len_prefix)+")");if(value.substring(0,len_null)===PARSE.marker_null)return null;if(value.substring(0,len_und)===PARSE.marker_und)return undefined;if(value.substring(0,len_nan)===PARSE.marker_nan)return NaN;if(value.substring(0,len_inf)===PARSE.marker_inf)return Infinity;if(value.substring(0,len_inf)===PARSE.marker_minus_inf)return-Infinity}return value}var len_prefix=PARSE.stringify_prefix.length,len_func=PARSE.marker_func.length,len_null=PARSE.marker_null.length,len_und=PARSE.marker_und.length,len_nan=PARSE.marker_nan.length,len_inf=PARSE.marker_inf.length,len_inf=PARSE.marker_minus_inf.length,o=JSON.parse(str);return walker(o)},JSUS.extend(PARSE)}("undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS),function(e,t,n){function r(e,n){e=e||{};if(!t)throw new Error("JSUS not found.");this.db=[],this.tags={},this.hooks={insert:[],remove:[],update:[]},this.nddb_pointer=0,r.compatibility.getter?this.__defineGetter__("length",function(){return this.db.length}):this.length=null,this.query=new d,this.__C={},this.__H={},this.__I={},this.__V={},this.__update={},this.__update.pointer=!1,this.__update.indexes=!1,this.__update.sort=!1,this.init(e),this.importDB(n)}function i(e,t){if(e===null)return;var n=typeof e;if(n==="undefined")return;if(n==="string")return;if(n==="number")return;this.db.push(e),t&&(this._indexIt(e,this.db.length-1),this._hashIt(e),this._viewIt(e)),this.emit("insert",e)}function s(e,n){return t.obj2Array(e,1)}function o(e,n){return t.obj2KeyedArray(e,1)}function u(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return t.obj2Array(r,1)}function a(e,n){var r=t.subobj(e,n);if(!t.isEmpty(r))return t.obj2Array(r,1)}function f(e,n){var r=t.getNestedValue(n,e);if("undefined"!=typeof r)return n.split(".").concat(t.obj2KeyedArray(r))}function l(e,n){var r=t.subobj(e,n);if(!t.isEmpty(r))return t.obj2KeyedArray(r)}function d(){this.operators={},this.registerDefaultOperators(),this.reset()}function v(e,t){this.idx=e,this.nddb=t,this.resolve={}}r.compatibility=t.compatibility(),e.NDDB=r,r.log=console.log,r.decycle=function(e){return JSON&&JSON.decycle&&"function"==typeof JSON.decycle&&(e=JSON.decycle(e)),e},r.retrocycle=function(e){return JSON&&JSON.retrocycle&&"function"==typeof JSON.retrocycle&&(e=JSON.retrocycle(e)),e},r.prototype.init=function(e){e=e||{},this.__options=e,e.log&&(r.log=e.log),e.C&&(this.__C=e.C),e.H&&(this.__H=e.H),e.I&&(this.__I=e.I),e.V&&(this.__V=e.V),e.tags&&(this.tags=e.tags),e.nddb_pointer>0&&(this.nddb_pointer=e.nddb_pointer),e.hooks&&(this.hooks=e.hooks),e.update&&("undefined"!=typeof e.update.pointer&&(this.__update.pointer=e.update.pointer),"undefined"!=typeof e.update.indexes&&(this.__update.indexes=e.update.indexes),"undefined"!=typeof e.update.sort&&(this.__update.sort=e.update.sort));if("object"==typeof e.operators)for(var t in e.operators)this.query.registerOperator(t,e.operators[t])},r.prototype.globalCompare=function(e,t){return"undefined"==typeof e&&"undefined"==typeof t?0:"undefined"==typeof t?-1:"undefined"==typeof e?1:-1},r.prototype._autoUpdate=function(e){var n=e?t.merge(this.__update,e):this.__update;n.pointer&&(this.nddb_pointer=this.db.length-1),n.sort&&this.sort(),n.indexes&&this.rebuildIndexes()},r.prototype.importDB=function(e){if(!e)return;for(var t=0;t<e.length;t++)i.call(this,e[t],this.__update.indexes);this._autoUpdate({indexes:!1})},r.prototype.insert=function(e){i.call(this,e,this.__update.indexes),this._autoUpdate({indexes:!1})},r.prototype.breed=function(e){return e=e||this.db,new this.constructor(this.cloneSettings(),e)},r.prototype.cloneSettings=function(){var e=this.__options||{};return e.H=this.__H,e.I=this.__I,e.C=this.__C,e.V=this.__V,e.tags=this.tags,e.update=this.__update,e.hooks=this.hooks,t.clone(e)},r.prototype.toString=function(){var e="";for(var t=0;t<this.db.length;t++)e+=this.db[t]+"\n";return e},r.prototype.stringify=function(e){if(!this.length)return"[]";e="undefined"==typeof e?!0:e;var n=e?0:4,i="[";return this.each(function(e){e=r.decycle(e),i+=t.stringify(e)+", "}),i=i.replace(/, $/,"]"),i},r.prototype.comparator=function(e,t){return!e||!t?(r.log("Cannot set empty property or empty comparator","ERR"),!1):(this.__C[e]=t,!0)},r.prototype.c=r.prototype.comparator,r.prototype.getComparator=function(e){return"undefined"!=typeof this.__C[e]?this.__C[e]:function(n,r){if("undefined"==typeof n&&"undefined"==typeof r)return 0;if("undefined"==typeof n)return 1;if("undefined"==typeof r)return-1;var i=t.getNestedValue(e,n),s=t.getNestedValue(e,r);return"undefined"==typeof i&&"undefined"==typeof s?0:"undefined"==typeof i?1:"undefined"==typeof s?-1:i>s?1:s>i?-1:0}},r.prototype.isReservedWord=function(e){return this[e]?!0:!1},r.prototype._isValidIndex=function(e){if("undefined"==typeof e)return r.log("A valid index name must be provided","ERR"),!1;if(this.isReservedWord(e)){var t="A reserved word have been selected as an index. ";return t+="Please select another one: "+e,r.log(t,"ERR"),!1}return!0},r.prototype.index=function(e,t){return!t||!this._isValidIndex(e)?!1:(this.__I[e]=t,this[e]=new v(e,this),!0)},r.prototype.i=r.prototype.index,r.prototype.view=function(e,t){return!t||!this._isValidIndex(e)?!1:(this.__V[e]=t,this[e]=new this.constructor,!0)},r.prototype.hash=function(e,t){return!t||!this._isValidIndex(e)?!1:(this.__H[e]=t,this[e]={},!0)},r.prototype.h=r.prototype.hash,r.prototype.resetIndexes=function(e){var n=e||t.merge({h:!0,v:!0,i:!0},e),r;if(n.h)for(r in this.__H)this.__H.hasOwnProperty(r)&&(this[r]={});if(n.v)for(r in this.__V)this.__V.hasOwnProperty(r)&&(this[r]=new this.constructor);if(n.v)for(r in this.__I)this.__I.hasOwnProperty(r)&&(this[r]=new v(r,this))},r.prototype.rebuildIndexes=function(){var e=!t.isEmpty(this.__H),n=!t.isEmpty(this.__I),r=!t.isEmpty(this.__V),i,s;if(!e&&!n&&!r)return;this.resetIndexes({h:e,v:r,i:n}),e&&!n&&!r?i=this._hashIt:!e&&n&&!r?i=this._indexIt:!e&&!n&&r?i=this._viewIt:e&&n&&!r?i=function(e,t){this._hashIt(e),this._indexIt(e,t)}:!e&&n&&r?i=function(e,t){this._indexIt(e,t),this._viewIt(e)}:e&&!n&&r?i=function(e,t){this._hashIt(e),this._viewIt(e)}:i=function(e,t){this._indexIt(e,t),this._hashIt(e),this._viewIt(e)};for(s=0;s<this.db.length;s++)i.call(this,this.db[s],s)},r.prototype._indexIt=function(e,n){if(!e||t.isEmpty(this.__I))return;var r,i,s;for(var o in this.__I)if(this.__I.hasOwnProperty(o)){r=this.__I[o],s=r(e);if("undefined"==typeof s)continue;this[o]||(this[o]=new v(o,this)),this[o]._add(s,n)}},r.prototype._viewIt=function(e){if(!e||t.isEmpty(this.__V))return;var n,r,i;for(var s in this.__V)if(this.__V.hasOwnProperty(s)){n=this.__V[s],i=n(e);if("undefined"==typeof i)continue;this[s]||(this[s]=new this.constructor),this[s].insert(e)}},r.prototype._hashIt=function(e){if(!e||t.isEmpty(this.__H))return!1;var n,r,i;for(var s in this.__H)if(this.__H.hasOwnProperty(s)){n=this.__H[s],i=n(e);if("undefined"==typeof i)continue;this[s]||(this[s]={}),this[s][i]||(this[s][i]=new this.constructor),this[s][i].insert(e)}},r.prototype.on=function(e,t){if(!e||!t||!this.hooks[e])return;return this.hooks[e].push(t),!0},r.prototype.off=function(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;if(!t)return this.hooks[e]=[],!0;for(var n=0;n<this.hooks[e].length;n++)if(this.hooks[e][n]==t)return this.hooks[e].splice(n,1),!0;return!1},r.prototype.emit=function(e,t){if(!e||!this.hooks[e]||!this.hooks[e].length)return;for(var n=0;n<this.hooks[e].length;n++)this.hooks[e][n].call(this,t)},r.prototype._analyzeQuery=function(e,n,i){var s=function(e,t,n){var i="(?)",s="Malformed query: "+e||i+" "+t||i+" "+n||i;return r.log(s,"WARN"),!1};"undefined"==typeof e&&s(e,n,i);if("undefined"!=typeof n){n==="="&&(n="==");if(!(n in this.query.operators))return r.log("Query error. Invalid operator detected: "+n,"WARN"),!1;if(t.in_array(n,["><","<>","in","!in"])){i instanceof Array||(r.log("Range-queries need an array as third parameter","WARN"),s(e,n,i));if(n==="<>"||n==="><")i[0]=t.setNestedValue(e,i[0]),i[1]=t.setNestedValue(e,i[1])}else t.in_array(n,[">","==",">=","<","<="])&&("undefined"==typeof i&&s(e,n,i),i=t.setNestedValue(e,i))}else"undefined"!=typeof i?s(e,n,i):(n="E",i="");return{d:e,op:n,value:i}},r.prototype.distinct=function(){return this.breed(t.distinct(this.db))},r.prototype.select=function(e,t,n){return this.query.reset(),arguments.length?this.and(e,t,n):this},r.prototype.and=function(e,t,n){var r=this._analyzeQuery(e,t,n);return r?(this.query.addCondition("AND",r,this.getComparator(e)),this):!1},r.prototype.or=function(e,t,n){var r=this._analyzeQuery(e,t,n);return r?(this.query.addCondition("OR",r,this.getComparator(e)),this):!1},r.prototype.selexec=function(e,t,n){return this.select(e,t,n).execute()},r.prototype.execute=function(){return this.filter(this.query.get.call(this.query))},r.prototype.exists=function(e){if(!e)return!1;for(var n=0;n<this.db.length;n++)if(t.equals(this.db[n],e))return!0;return!1},r.prototype.limit=function(e){e=e||0;if(e===0)return this.breed();var t=e>0?this.db.slice(0,e):this.db.slice(e);return this.breed(t)},r.prototype.reverse=function(){return this.db.reverse(),this},r.prototype.sort=function(e){if(!e)var t=this.globalCompare;else if("function"==typeof e)var t=e;else if(e instanceof Array)var n=this,t=function(t,r){for(var i=0;i<e.length;i++){var s=n.getComparator(e[i]).call(n,t,r);if(s!==0)return s}return s};else var t=this.getComparator(e);return this.db.sort(t),this},r.prototype.shuffle=function(){return this.db=t.shuffle(this.db),this},r.prototype.filter=function(e){return this.breed(this.db.filter(e))},r.prototype.each=r.prototype.forEach=function(){if(arguments.length===0)return;var e=arguments[0],t;for(t=0;t<this.db.length;t++)arguments[0]=this.db[t],e.apply(this,arguments)},r.prototype.map=function(){if(arguments.length===0)return;var e=arguments[0],t=[],n,r;for(r=0;r<this.db.length;r++)arguments[0]=this.db[r],n=e.apply(this,arguments),"undefined"!=typeof n&&t.push(n);return t},r.prototype.update=function(e){if(!this.db.length||!e)return this;for(var n=0;n<this.db.length;n++)t.mixin(this.db[n],e),this.emit("update",this.db[n]);return this._autoUpdate(),this},r.prototype.remove=function(){return this.length?(this.emit("remove",this.db),this.db=[],this._autoUpdate(),this):this},r.prototype.clear=function(e){if(e){this.db=[],this.tags={},this.query.reset(),this.nddb_pointer=0;var t;for(t in this.__H)this[t]&&delete this[t];for(t in this.__C)this[t]&&delete this[t];for(var t in this.__I)this[t]&&delete this[t]}else r.log("Do you really want to clear the current dataset? Please use clear(true)","WARN");return e},r.prototype.join=function(e,n,r,i){return this._join(e,n,t.equals,r,i)},r.prototype.concat=function(e,t,n,r){return this._join(e,t,function(){return!0},n,r)},r.prototype._join=function(e,n,r,i,s){if(!e||!n)return this.breed([]);r=r||t.equals,i="undefined"!=typeof i?i:"joined",s&&(s=s instanceof Array?s:[s]);var o=[],u=[],a,f;for(var l=0;l<this.db.length;l++){a=t.getNestedValue(e,this.db[l]);if("undefined"!=typeof a)for(var c=l+1;c<this.db.length;c++){f=t.getNestedValue(n,this.db[c]);if("undefined"!=typeof f&&r(a,f)){var h=t.clone(this.db[l]),p=s?t.subobj(this.db[c],s):this.db[c];h[i]=p,o.push(h)}}}return this.breed(o)},r.prototype.split=function(e){var n=[],r;for(r=0;r<this.db.length;r++)n=n.concat(t.split(this.db[r],e));return this.breed(n)},r.prototype.fetch=function(){return this.db},r.prototype.fetchSubObj=function(e){if(!e)return[];var n,r,i=[];for(n=0;n<this.db.length;n++)r=t.subobj(this.db[n],e),t.isEmpty(r)||i.push(r);return i},r.prototype.fetchValues=function(e){var n,r,i,s;s=typeof e,i={};if(s==="undefined")for(r=0;r<this.db.length;r++)t.augment(i,this.db[r],t.keys(this.db[r]));else if(s==="string"){i[e]=[];for(r=0;r<this.db.length;r++)n=t.getNestedValue(e,this.db[r]),"undefined"!=typeof n&&i[e].push(n)}else if(t.isArray(e)){i=t.melt(e,t.rep([],e.length));for(r=0;r<this.db.length;r++)n=t.subobj(this.db[r],e),t.isEmpty(n)||t.augment(i,n)}return i},r.prototype._fetchArray=function(e,t){var n,r,i,c;t?e?"string"==typeof e?n=f:n=l:n=o:e?"string"==typeof e?n=u:n=a:n=s,r=[];for(c=0;c<this.db.length;c++)i=n.call(this.db[c],this.db[c],e),"undefined"!=typeof i&&r.push(i);return r},r.prototype.fetchArray=function(e){return this._fetchArray(e)},r.prototype.fetchKeyArray=function(e){return this._fetchArray(e,!0)},r.prototype.groupBy=function(e){if(!e)return this.db;var n=[],r=[],i,s,o;for(i=0;i<this.db.length;i++){s=t.getNestedValue(e,this.db[i]);if("undefined"==typeof s)continue;t.in_array(s,n)||(n.push(s),o=this.filter(function(n){if(t.equals(t.getNestedValue(e,n),s))return this}),o.nddb_pointer=0,r.push(o))}return r},r.prototype.count=function(e){if("undefined"==typeof e)return this.db.length;var n=0;for(var r=0;r<this.db.length;r++)t.hasOwnNestedProperty(e,this.db[r])&&n++;return n},r.prototype.sum=function(e){if("undefined"==typeof e)return!1;var n=0;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);isNaN(i)||(n+=i)}return n},r.prototype.mean=function(e){if("undefined"==typeof e)return!1;var n=0,r=0;for(var i=0;i<this.db.length;i++){var s=t.getNestedValue(e,this.db[i]);isNaN(s)||(n+=s,r++)}return r===0?0:n/r},r.prototype.stddev=function(e){if("undefined"==typeof e)return!1;var n=this.mean(e);if(isNaN(n))return!1;var r=0;return this.each(function(i){var s=t.getNestedValue(e,i);isNaN(s)||(r+=Math.pow(s-n,2))}),r!==0?Math.sqrt(r):0},r.prototype.min=function(e){if("undefined"==typeof e)return!1;var n=!1;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);!isNaN(i)&&(i<n||n===!1)&&(n=i)}return n},r.prototype.max=function(e){if("undefined"==typeof e)return!1;var n=!1;for(var r=0;r<this.db.length;r++){var i=t.getNestedValue(e,this.db[r]);!isNaN(i)&&(i>n||n===!1)&&(n=i)}return n},r.prototype.skim=function(e){return e?this.breed(this.map(function(n){var r=t.skim(n,e);if(!t.isEmpty(r))return r})):this},r.prototype.keep=function(e){return e?this.breed(this.map(function(n){var r=t.subobj(n,e);if(!t.isEmpty(r))return r})):this.breed([])},r.prototype.diff=function(e){return!e||!e.length?this:("object"==typeof e&&(e instanceof r||e instanceof this.constructor)&&(e=e.db),this.breed(t.arrayDiff(this.db,e)))},r.prototype.intersect=function(e){if(!e||!e.length)return this;if("object"==typeof e)if(e instanceof r||e instanceof this.constructor)var e=e.db;return this.breed(t.arrayIntersect(this.db,e))},r.prototype.get=function(e){return"undefined"==typeof e||e<0||e>this.db.length-1?!1:this.db[e]},r.prototype.current=function(){return this.nddb_pointer<0||this.nddb_pointer>this.db.length-1?!1:this.db[this.nddb_pointer]},r.prototype.next=function(){this.nddb_pointer++;var e=r.prototype.current.call(this);return e||this.nddb_pointer--,e},r.prototype.previous=function(){this.nddb_pointer--;var e=r.prototype.current.call(this);return e||this.nddb_pointer++,e},r.prototype.first=function(e){var t=this.fetch(e);return t.length?(this.nddb_pointer=0,t[0]):undefined},r.prototype.last=function(e){var t=this.fetch(e);return t.length?(this.nddb_pointer=t.length-1,t[t.length-1]):undefined},r.prototype.tag=function(e,t){if("undefined"==typeof e)return r.log("Cannot register empty tag.","ERR"),!1;var n=null,i=typeof t;if(i==="undefined")n=this.db[this.nddb_pointer];else if(i==="number"){if(t>this.length||t<0)return r.log("Invalid index provided for tag registration","ERR"),!1;n=this.db[t]}else n=t;return this.tags[e]=n,n},r.prototype.resolveTag=function(e){return"undefined"==typeof e?(r.log("Cannot resolve empty tag.","ERR"),!1):this.tags[e]};var c=function(){return"function"==typeof n};r.prototype.save=function(e,i,s){return e?(s=s||!1,t.isNodeJS()?(h.writeFileSync(e,this.stringify(s),"utf-8"),i&&i(),!0):c()?(n(e,this.stringify(s)),i&&i(),!0):(r.log("No support for persistent storage found.","ERR"),!1)):(r.log("You must specify a valid file / id.","ERR"),!1)},r.prototype.load=function(e,i,s){if(!e)return r.log("You must specify a valid file / id.","ERR"),!1;if(!t.isNodeJS()){if(!c())return r.log("No support for persistent storage found.","ERR"),!1;var o=n(e);return this.importDB(o),i&&i(),!0}var u=function(e){var n=t.parse(e),i;for(i=0;i<n.length;i++)n[i]=r.retrocycle(n[i]);this.importDB(n)},a=h.readFileSync(e,"utf-8");return u.call(this,a),!0};if(t.isNodeJS()){require("./external/cycle.js");var h=require("fs"),p=require("ya-csv");r.prototype.load.csv=function(e,t,n){if(!e)return r.log("You must specify a valid CSV file.","ERR"),!1;n=n||{},"undefined"==typeof n.columnsFromHeader&&(n.columnsFromHeader=!0);var i=p.createCsvStreamReader(e,n);return n.columnNames&&i.setColumnNames(n.columnNames),i.addListener("data",function(e){this.insert(e)}),i.addListener("end",function(e){t&&callback()}),!0}}d.prototype.addCondition=function(e,t,n){t.type=e,t.comparator=n,this.query[this.pointer].push(t)},d.prototype.registerOperator=function(e,t){this.operators[e]=t},d.prototype.registerDefaultOperators=function(){this.operators.E=function(e,n,r){return function(n){if("undefined"!=typeof t.getNestedValue(e,n))return n}},this.operators["=="]=function(e,t,n){return function(e){if(n(e,t)===0)return e}},this.operators[">"]=function(e,t,n){return function(e){var r=n(e,t);if(r===1||r===0)return e}},this.operators["<"]=function(e,t,n){return function(e){if(n(e,t)===-1)return e}},this.operators["<="]=function(e,t,n){return function(e){var r=n(e,t);if(r===-1||r===0)return e}},this.operators["><"]=function(e,t,n){return function(e){if(n(e,t[0])>0&&n(e,t[1])<0)return e}},this.operators["<>"]=function(e,t,n){return function(e){if(n(e,t[0])<0&&n(e,t[1]>0))return e}},this.operators["in"]=function(e,n,r){return function(r){if(t.in_array(t.getNestedValue(e,r),n))return r}},this.operators["!in"]=function(e,n,r){return function(r){if(!t.in_array(t.getNestedValue(e,r),n))return r}}},d.prototype.addBreak=function(){this.pointer++,this.query[this.pointer]=[]},d.prototype.reset=function(){this.query=[],this.pointer=0,this.query[this.pointer]=[]},d.prototype.get=function(){function c(e,t){var n=e.d,r=e.op,i=e.value,s=e.comparator;return t[r](n,i,s)}var e,t,n,r,i,s,o,u,a=this.query,f=this.pointer,l=this.operators;if(f===0){e=a[f],t=e.length;if(t===1)return c(e[0],l);if(t===2){n=c(e[0],l),r=c(e[1],l),s=e[1].type;switch(s){case"OR":return function(e){if("undefined"!=typeof n(e))return e;if("undefined"!=typeof r(e))return e};case"AND":return function(e){if("undefined"!=typeof n(e)&&"undefined"!=typeof r(e))return e};case"NOT":return function(e){if("undefined"!=typeof n(e)&&"undefined"==typeof r(e))return e}}}else{if(t!==3)return function(n){var r,i,s,o,u="OR",a=!0;for(r=t-1;r>-1;r--){i=c(e[r],l),s=e[r].type,o="undefined"!=typeof i(n);if(s==="OR"){if(o)return n}else if(s==="AND"){if(!o)return;if(u==="OR"&&!a)return}u=s,a=s==="AND"?o:o||a}return n};n=c(e[0],l),r=c(e[1],l),i=c(e[2],l),s=e[1].type,o=e[2].type,s=s+"_"+o;switch(s){case"OR_OR":return function(e){if("undefined"!=typeof n(e))return e;if("undefined"!=typeof r(e))return e;if("undefined"!=typeof i(e))return e};case"OR_AND":return function(e){if("undefined"==typeof i(e))return;if("undefined"!=typeof r(e))return e;if("undefined"!=typeof n(e))return e};case"AND_OR":return function(e){if("undefined"!=typeof i(e))return e;if("undefined"==typeof r(e))return;if("undefined"!=typeof n(e))return e};case"AND_AND":return function(e){if("undefined"==typeof i(e))return;if("undefined"==typeof r(e))return;if("undefined"!=typeof n(e))return e}}}}},v.prototype._add=function(e,t){this.resolve[e]=t},v.prototype._remove=function(e){delete this.resolve[e]},v.prototype.size=function(){return t.size(this.resolve)},v.prototype.get=function(e){return"undefined"==typeof this.resolve[e]?!1:this.nddb.db[this.resolve[e]]},v.prototype.pop=function(e){var t,n;n=this.resolve[e];if("undefined"==typeof n)return!1;t=this.nddb.db[n];if("undefined"==typeof t)return;return this.nddb.db.splice(n,1),delete this.resolve[e],this.nddb.emit("remove",t),this.nddb._autoUpdate(),t},v.prototype.update=function(e,n){var r,i;return i=this.resolve[e],"undefined"==typeof i?!1:(r=this.nddb.db[i],t.mixin(r,n),this.nddb.emit("update",r),this.nddb._autoUpdate(),r)},v.prototype.getAllKeys=function(){return t.keys(this.resolve)},v.prototype.getAllKeyElements=function(){var e={},t;for(t in this.resolve)this.resolve.hasOwnProperty(t)&&(e[t]=this.nddb.db[this.resolve[t]]);return e}}("undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports:window,"undefined"!=typeof JSUS?JSUS:module.parent.exports.JSUS||require("JSUS").JSUS,"object"==typeof module&&"function"==typeof require?module.parent.exports.store||require("shelf.js/build/shelf-fs.js").store:this.store),function(e){e.version="0.6.3",e.log=function(){},e.events={},e.msg={},e.socket={},e.session={},e.player={},e.game={},e.game.memory=null,e.game.stateLevel=null,e.store=function(){},e.setup=function(){},e.conf={},e.support={},"object"==typeof module&&"function"==typeof require?(require("./lib/modules/log.js"),require("./lib/modules/variables.js"),require("./lib/modules/stepper.js"),require("./init.node.js"),require("./lib/nodegame.js"),require("./lib/modules/fs.js"),require("./lib/modules/setup.js"),require("./lib/modules/alias.js"),require("./lib/modules/random.js"),require("./lib/sockets/SocketIo.js"),require("./lib/sockets/SocketDirect.js"),require("./listeners/incoming.js"),require("./listeners/internal.js")):("undefined"!=typeof JSUS&&(e.JSUS=JSUS),"undefined"!=typeof NDDB&&(e.NDDB=NDDB),"undefined"!=typeof store&&(e.store=store),e.support=JSUS.compatibility())}("object"==typeof module?module.exports:window.node={}),function(e,t){t.verbosity_levels={ALWAYS:-(Number.MIN_VALUE+1),ERR:-1,WARN:0,INFO:1,SILLY:10,DEBUG:100,NEVER:Number.MIN_VALUE-1},t.verbosity=t.verbosity_levels.WARN,t.remoteVerbosity=t.verbosity_levels.WARN,t.log=function(e,n,r){if("undefined"==typeof e)return!1;n=n||0,r="undefined"==typeof r?"ng> ":r,"string"==typeof n&&(n=t.verbosity_levels[n]),t.verbosity>n&&console.log(r+e)},t.info=function(e,n){n=(n?"ng|"+n:"ng")+"> info - ",t.log(e,t.verbosity_levels.INFO,n)},t.warn=function(e,n){n=(n?"ng|"+n:"ng")+"> warn - ",t.log(e,t.verbosity_levels.WARN,n)},t.err=function(e,n){n=(n?"ng|"+n:"ng")+"> error - ",t.log(e,t.verbosity_levels.ERR,n)},t.silly=function(e,n){n=(n?"ng|"+n:"ng")+"> silly - ",t.log(e,t.verbosity_levels.SILLY,n)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){t.action={},t.action.SET="set",t.action.GET="get",t.action.SAY="say",t.target={},t.target.DATA="DATA",t.target.HI="HI",t.target.HI_AGAIN="HI_AGAIN",t.target.PCONNECT="PCONNECT",t.target.PDISCONNECT="PDISCONNECT",t.target.MCONNECT="MCONNECT",t.target.MDISCONNECT="MDISCONNECT",t.target.PLIST="PLIST",t.target.MLIST="MLIST",t.target.STATE="STATE",t.target.STAGE="STAGE",t.target.STAGE_LEVEL="STAGE_LEVEL",t.target.REDIRECT="REDIRECT",t.target.SETUP="SETUP",t.target.GAMECOMMAND="GAMECOMMAND",t.target.JOIN="JOIN",t.target.LOG="LOG",t.target.TXT="TXT",t.target.BYE="BYE",t.target.ACK="ACK",t.target.WARN="WARN",t.target.ERR="ERR",t.gamecommand={start:"start",pause:"pause",resume:"resume",stop:"stop",restart:"restart",goto_stage:"goto_stage"},t.IN="in.",t.OUT="out.",t.is={},t.is.UNKNOWN=0,t.is.INITIALIZING=1,t.is.INITIALIZED=5,t.is.GAMELOADED=10,t.is.DEAD=-1,t.is.LOADING=10,t.is.LOADED=25,t.is.PLAYING=50,t.is.DONE=100,t.stateLevels={UNINITIALIZED:0,STARTING:1,INITIALIZING:2,INITIALIZED:5,STAGE_INIT:10,STEP_INIT:20,PLAYING_STEP:30,FINISHING:40,GAMEOVER:100,RUNTIME_ERROR:-1},t.stageLevels={UNINITIALIZED:0,INITIALIZING:1,INITIALIZED:5,LOADING:30,LOADED:40,PLAYING:50,PAUSING:55,PAUSED:60,RESUMING:65,RESUMED:70,DONE:100}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){return n}function i(e){return n[e]}function s(e,r){"undefined"==typeof e?t.err("stepper rule id cannot be undefined"):"function"!=typeof r?t.err("stepping rule is not a function"):n[e]=r}function o(){n.SYNC_ALL=function(e,n,r,i){return n===t.stageLevels.DONE&&r.isStageDone(e)},n.SOLO=function(e,n,r,i){return n===t.stageLevels.DONE},n.WAIT=function(e,t,n,r){return!1},n.SYNC_STAGE=function(e,n,r,i){var s=n===t.stageLevels.DONE;return i.plot.stepsToNextStage()>1?s:s&&r.isStepDone(e)}}function u(){n={}}var n={};o(),t.stepRules={getRules:r,get:i,register:s,clear:u,addDefaultRules:o}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){Error.apply(this,arguments),this.stack=(new Error).stack}function i(){Error.apply(this,arguments),this.stack=(new Error).stack}function s(){Error.apply(this,arguments),this.stack=(new Error).stack}var n=t.JSUS;t.NodeGameRuntimeError=r,t.NodeGameStageCallbackError=i,t.NodeGameMisconfiguredGameError=s,r.prototype=new Error,r.prototype.constructor=r,r.prototype.name="NodeGameRuntimeError",i.prototype=new Error,i.prototype.constructor=i,i.prototype.name="NodeGameStageCallbackError",s.prototype=new Error,s.prototype.constructor=s,s.prototype.name="NodeGameMisconfiguredGameError",n.isNodeJS()||(window.onerror=function(e,n,r){return t.err(n+" "+r+": "+e),!t.debug})}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){this.name="undefined"!=typeof e?e:"EE",this.events={},this.history=new o}function s(){this.ee={},this.createEE("ng"),this.createEE("game"),this.createEE("stage"),this.createEE("step"),this.createEEGroup("game","step","stage","game"),this.createEEGroup("stage","stage","game")}function o(){this.history=new n,this.history.h("stage",function(e){if(!e)return;var n="object"==typeof e.stage?e.stage:t.game.stage;return t.GameStage.toHash(n,"S.s.r")})}function u(e){e=e||{},this.event=e.event,this.listener=e.listener,this.priority=e.priority||0,this.stage=e.stage||t.game.stage,this.ttl="undefined"!=typeof e.ttl?e.ttl:-1,this.target=e.target||undefined}var n=t.NDDB;e.EventEmitter=r,e.EventEmitterManager=s,r.prototype.on=function(e,n){if("undefined"==typeof e||!n){t.err(this.name+": trying to add invalid event-listener pair");return}this.events[e]?typeof this.events[e]=="object"?this.events[e].push(n):this.events[e]=[this.events[e],n]:this.events[e]=n,t.silly(this.name+": added Listener: "+e+" "+n)},r.prototype.once=function(e,n){function r(){this.remove(e,r),n.apply(t.game,arguments)}this.on(e,r)},r.prototype.emit=function(){var e,n,r,i,s,o;o=arguments[0],e=this.events[o];if("undefined"==typeof e)return!1;t.conf.events.dumpEvents&&t.log("F: "+o);if("function"==typeof e)switch(arguments.length){case 1:e.call(t.game);break;case 2:e.call(t.game,arguments[1]);break;case 3:e.call(t.game,arguments[1],arguments[2]);break;case 4:e.call(t.game,arguments[1],arguments[2],arguments[3]);break;default:n=arguments.length,r=new Array(n-1);for(i=1;i<n;i++)r[i-1]=arguments[i];e.apply(t.game,r)}else if("object"==typeof e){n=arguments.length,r=new Array(n-1);for(i=1;i<n;i++)r[i-1]=arguments[i];s=e.slice(),n=s.length;for(i=0;i<n;i++)s[i].apply(t.game,r)}t.conf&&t.conf.events&&t.conf.events.history&&this.history.insert({stage:t.game.getCurrentGameStage(),args:arguments})},r.prototype.remove=function(e,n){var r,i,s,e;if(!this.events[e])return t.warn("attempt to remove unexisting event "+e,this.name),!1;if(!n)return delete this.events[e],t.silly("Removed listener "+e),!0;if(n&&"function"!=typeof n)throw TypeError("listener must be a function",this.name);if("function"==typeof this.events[e]&&r==n)return r.splice(s,1),t.silly("removed listener "+e+" "+n,this.name),!0;r=this.events[e],i=r.length;for(s=0;s<i;s++)if(r[s]==n)return r.splice(s,1),t.silly("Removed listener "+e+" "+n,this.name),!0;return!1},r.prototype.clear=function(){this.events={}},r.prototype.printAll=function(){for(var e in this.events)this.events.hasOwnProperty(e)&&console.log(e+": "+e.length?e.length:"1 listener/s")},s.prototype.createEEGroup=function(e){var t,n,r;t=arguments.length,n=this;if(!t)throw new Error("EEGroup needs a name and valid members");if(t===1)throw new Error("EEGroup needs at least one member");for(i=1;i<t;i++){if("string"!=typeof arguments[i])throw new TypeError("EventEmitter name must be a string");if(!this.ee[arguments[i]])throw new Error("non-existing EventEmitter in group "+e+": "+arguments[i])}r=new Array(t-1);for(i=1;i<t;i++)r[i-1]=arguments[i];switch(t){case 2:this[e]=this.ee[r[0]];break;case 3:this[e]={emit:function(){n.ee[r[0]].emit(arguments),n.ee[r[1]].emit(arguments)},on:this.ee[r[0]].on,once:this.ee[r[1]].once,clear:function(){n.ee[r[0]].clear(),n.ee[r[1]].clear()},remove:function(){n.ee[r[0]].remove(arguments),n.ee[r[1]].remove(arguments)},printAll:function(){n.ee[r[0]].printAll(),n.ee[r[1]].printAll()}};break;case 4:this[e]={emit:function(){n.ee[r[0]].emit(arguments),n.ee[r[1]].emit(arguments),n.ee[r[2]].emit(arguments)},on:this.ee[r[0]].on,once:this.ee[r[1]].once,clear:function(){n.ee[r[0]].clear(),n.ee[r[1]].clear(),n.ee[r[2]].clear()},remove:function(){n.ee[r[0]].remove(arguments),n.ee[r[1]].remove(arguments),n.ee[r[2]].remove(arguments)},printAll:function(){n.ee[r[0]].printAll(),n.ee[r[1]].printAll(),n.ee[r[2]].printAll()}};break;default:t=r.len,this[e]={emit:function(){for(i=0;i<t;i++)n.ee[r[i]].emit(arguments)},on:this.ee[r[0]].on,once:this.ee[r[1]].once,clear:function(){for(i=0;i<t;i++)n.ee[r[i]].clear()},remove:function(){for(i=0;i<t;i++)n.ee[r[i]].remove(arguments)},printAll:function(){for(i=0;i<t;i++)n.ee[r[i]].printAll()}}}return this[e]},s.prototype.createEE=function(e){return this.ee[e]=new r(e),this[e]=this.ee[e],this.ee[e]},s.prototype.destroyEE=function(e){var n;n=this.ee[e];if(!n)return t.warn("cannot destroy undefined EventEmitter"),!1;delete this[e],delete this.ee[e]},s.prototype.clear=function(){for(i in this.ee)this.ee.hasOwnProperty(i)&&this.ee[i].clear()},s.prototype.emit=function(){var e,n;n=arguments[0];if("undefined"==typeof n)return t.warn("cannot emit undefined event"),!1;for(e in this.ee)this.ee.hasOwnProperty(e)&&this.ee[e].emit.apply(this.ee[e],arguments)},s.prototype.remove=function(e,n){var r;if("undefined"==typeof e)return t.err("cannot remove listener of undefined event"),!1;if(n&&"function"==typeof n)return t.err("listener must be of type function"),!1;for(r in this.ee)this.ee.hasOwnProperty(r)&&this.ee[r].remove(e,n)},o.prototype.remit=function(e,n,r){var i,s,o;if(!this.history.count())return t.log("no event history was found to remit","WARN"),!1;t.silly("remitting "+t.events.history.count()+" events");if(e){this.history.rebuildIndexes(),i=(new GameStage(session.stage)).toHash("S.s.r");if(!this.history.stage)return t.silly("no old events to re-emit were found during session recovery"),!1;if(!this.history.stage[i])return t.silly("the current stage "+i+" has no events to re-emit"),!1;s=this.history.stage[i]}else s=this.history;return n&&s.select("event","in",n).remove(),r&&(s=s.select("event","in",r)),s.count()?(o=function(){t.silly("re-emitting "+s.count()+" events"),s.each(function(e){t.emit(e.event,e.p1,e.p2,e.p3)})},t.game.isReady()?o.call(t.game):t.on("LOADED",function(){o.call(t.game)}),!0):(t.silly("no valid events to re-emit after cleanup"),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){this.stage=0,this.step=1,this.round=1;if(!e||"undefined"==typeof e)this.stage=0,this.step=0,this.round=0;else if("string"==typeof e){var t=e.split("."),n=parseInt(t[0],10),r=parseInt(t[1],10),i=parseInt(t[2],10);t[0]&&(this.stage=isNaN(n)?t[0]:n),"undefined"!=typeof t[1]&&(this.step=isNaN(r)?t[1]:r),"undefined"!=typeof t[2]&&(this.round=i)}else"object"==typeof e&&("undefined"!=typeof e.stage&&(this.stage=e.stage),"undefined"!=typeof e.step&&(this.step=e.step),"undefined"!=typeof e.round&&(this.round=e.round))}var n=t.JSUS;e.GameStage=r,r.defaults={},r.defaults.hash="S.s.r",r.prototype.toString=function(){return this.toHash("S.s.r")},r.prototype.toHash=function(e){return r.toHash(this,e)},r.toHash=function(e,t){if(!e||"object"!=typeof e)return!1;if(!t||!t.length)return e.toString();var n="",r="Ssr",i=["stage","step","round"];for(var s=0;s<t.length;s++){var o=r.indexOf(t[s]);n+=o<0?t[s]:e[i[o]]}return n},r.compare=function(e,t){var n;return"undefined"==typeof e&&"undefined"==typeof t?0:"undefined"==typeof t?1:"undefined"==typeof e?-1:("string"==typeof e&&(e=new r(e)),"string"==typeof t&&(t=new r(t)),n=e.stage-t.stage,n===0&&"undefined"!=typeof e.round&&(n=e.round-t.round,n===0&&"undefined"!=typeof e.step&&(n=e.step-t.step)),n)},r.stringify=function(e){if(!e)return;var t=(new r(e)).toHash("(r) S.s_i");return t}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function o(e,n){e=e||{},e.log||(e.log=t.log),e.update||(e.update={}),"undefined"==typeof e.update.indexes&&(e.update.indexes=!0),r.call(this,e,n),this.globalCompare=o.comparePlayers,this.id||this.index("id",function(e){return e.id}),this.pcounter=this.db.length||0}function u(e){e=e||{},this.id=e.id||this.sid,this.sid=e.sid,this.count=e.count,this.admin=!!e.admin,this.disconnected=!!e.disconnected,this.ip=e.ip,this.name=e.name,this.stage=e.stage||new i,this.stageLevel=e.stageLevel||t.stageLevels.UNINITIALIZED;for(var n in e)e.hasOwnProperty(n)&&"function"!=typeof e[n]&&(this.hasOwnProperty(n)||(this[n]=e[n]))}var n=t.JSUS,r=t.NDDB,i=t.GameStage,s=t.Game;e.PlayerList=o,o.prototype=new r,o.prototype.constructor=o,o.comparePlayers=function(e,t){return e.id===t.id?0:e.count<t.count?1:e.count>t.count?-1:0},o.prototype.add=function(e){return!e||"undefined"==typeof e.id?(t.err("Player id not found, cannot add object to player list."),!1):this.exist(e.id)?(t.err("Attempt to add a new player already in the player list: "+e.id),!1):(this.insert(e),e.count=this.pcounter,this.pcounter++,e)},o.prototype.get=function(e){if("undefined"==typeof e)return!1;var n=this.id.get(e);return n?n:(t.warn("Attempt to access a non-existing player from the the player list. id: "+e),!1)},o.prototype.remove=function(e){if("undefined"==typeof e)return!1;var n=this.id.pop(e);return n?n:(t.err("Attempt to remove a non-existing player from the the player list. id: "+e),!1)},o.prototype.pop=o.prototype.remove,o.prototype.exist=function(e){return this.id.get(e)?!0:!1},o.prototype.updatePlayerStage=function(e,n){return this.exist(e)?"undefined"==typeof n?(t.warn("Attempt to assign to a player an undefined stage"),!1):this.id.update(e,{stage:n}):(t.warn("Attempt to access a non-existing player from the the player list "+e),!1)},o.prototype.updatePlayerStageLevel=function(e,n){return this.exist(e)?"undefined"==typeof n?(t.warn("Attempt to assign to a player an undefined stage"),!1):this.id.update(e,{stageLevel:n}):(t.warn("Attempt to access a non-existing player from the the player list "+e),!1)},o.prototype.isStepDone=function(e){var n,r;if(!e)return!1;for(r=0;r<this.db.length;r++){n=this.db[r];if(i.compare(e,n.stage)!==0)continue;if(n.stageLevel!==t.stageLevels.DONE)return!1}return!0},o.prototype.toString=function(e){var t="",n=e||"\n",r;return this.forEach(function(e){t+=e.id+": "+e.name,r=new i(e.stage),t+=": "+r+n}),t},o.prototype.getNGroups=function(e){if(!e)return;var t=n.getNGroups(this.db,e);return o.array2Groups(t)},o.prototype.getGroupsSizeN=function(e){if(!e)return;var t=n.getGroupsSizeN(this.db,e);return o.array2Groups(t)},o.prototype.getRandom=function(e){return e||(e=1),e<1?(t.err("N must be an integer >= 1"),!1):(this.shuffle(),this.limit(e).fetch())},e.Player=u,u.prototype.toString=function(){return(this.name||"")+" ("+this.id+") "+new i(this.stage)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function i(e){e=e||{};var n=e.id||Math.floor(Math.random()*1e6);t.support.defineProperty?Object.defineProperty(this,"id",{value:n,enumerable:!0}):this.id=n;var i=e.session;t.support.defineProperty?Object.defineProperty(this,"session",{value:i,enumerable:!0}):this.session=i,this.stage=e.stage,this.action=e.action,this.target=e.target,this.from=e.from,this.to=e.to,this.text=e.text,this.data=e.data,this.priority=e.priority,this.reliable=e.reliable,this.created=r.getDate(),this.forward=0}var n=t.GameStage,r=t.JSUS;e.GameMsg=i,i.clone=function(e){return new i(e)},i.prototype.stringify=function(){return JSON.stringify(this)},i.prototype.toString=function(){var e=",	",t="\n",r='"',i=new n(this.stage),s=this.created+e;return s+=this.id+e,s+=this.session+e,s+=this.action+e,s+=this.target+e,s+=this.from+e,s+=this.to+e,s+=r+this.text+r+e,s+=r+this.data+r+e,s+=this.reliable+e,s+=this.priority+t,s},i.prototype.toSMS=function(){var e=/\w+/,t=e.exec(this.created),n="["+this.from+"]->["+this.to+"]	";return n+="|"+this.action+"."+this.target+"|"+"	",n+=" "+this.text+" ",n},i.prototype.toInEvent=function(){return"in."+this.toEvent()},i.prototype.toOutEvent=function(){return"out."+this.toEvent()},i.prototype.toEvent=function(){return this.action+"."+this.target}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){e?this.setState(e):this.clear()}e.Stager=n,n.prototype.clear=function(){return this.steps={},this.stages={},this.sequence=[],this.generalNextFunction=null,this.nextFunctions={},this.setDefaultStepRule(),this.defaultGlobals={},this.defaultProperties={},this.onInit=null,this.onGameover=null,this},n.prototype.registerGeneralNext=function(e){return e!==null&&"function"!=typeof e?(t.warn("registerGeneralNext didn't receive function parameter"),!1):(this.generalNextFunction=e,!0)},n.prototype.registerNext=function(e,n){return"function"!=typeof n?(t.warn("registerNext didn't receive function parameter"),!1):this.stages[e]?(this.nextFunctions[e]=n,!0):(t.warn("registerNext received nonexistent stage id"),!1)},n.prototype.setDefaultStepRule=function(e){if(e){if("function"!=typeof e)return t.warn("setDefaultStepRule didn't receive function parameter"),!1;this.defaultStepRule=e}else this.defaultStepRule=t.stepRules.get("SOLO");return!0},n.prototype.getDefaultStepRule=function(){return this.defaultStepRule},n.prototype.setDefaultGlobals=function(e){return!e||"object"!=typeof e?(t.warn("setDefaultGlobals did not receive an object as parameter"),!1):(this.defaultGlobals=e,!0)},n.prototype.getDefaultGlobals=function(){return this.defaultGlobals},n.prototype.setDefaultProperties=function(e){return!e||"object"!=typeof e?(t.warn("setDefaultProperties did not receive an object as parameter"),!1):(this.defaultProperties=e,!0)},n.prototype.getDefaultProperties=function(){return this.defaultProperties},n.prototype.setOnInit=function(e){return e!==null&&"function"!=typeof e?(t.warn("setOnInit did not receive a function as parameter"),!1):(this.onInit=e,!0)},n.prototype.getOnInit=function(e){return this.onInit},n.prototype.setOnGameover=function(e){return e!==null&&"function"!=typeof e?(t.warn("setOnGameover did not receive a function as parameter"),!1):(this.onGameover=e,!0)},n.prototype.setOnGameOver=n.prototype.setOnGameover,n.prototype.getOnGameover=function(e){return this.onGameover},n.prototype.addStep=function(e){return this.checkStepValidity(e)?(this.steps[e.id]=e,!0):(t.warn("addStep received invalid step"),!1)},n.prototype.addStage=function(e){return this.checkStepValidity(e)?this.addStep(e)?this.addStage({id:e.id,steps:[e.id]})?!0:!1:!1:this.checkStageValidity(e)?(this.stages[e.id]=e,!0):(t.warn("addStage received invalid stage"),!1)},n.prototype.init=function(){return this.sequence=[],this},n.prototype.gameover=function(){return this.sequence.push({type:"gameover"}),this},n.prototype.next=function(e){var n=this.handleAlias(e);return n===null?(t.warn("next received invalid stage name"),null):(this.sequence.push({type:"plain",id:n}),this)},n.prototype.repeat=function(e,n){var r=this.handleAlias(e);return r===null?(t.warn("repeat received invalid stage name"),null):"number"!=typeof n?(t.warn("repeat received invalid number of repetitions"),null):(this.sequence.push({type:"repeat",id:r,num:n}),this)},n.prototype.loop=function(e,n){var r=this.handleAlias(e);return r===null?(t.warn("loop received invalid stage name"),null):"function"!=typeof n?(t.warn("loop received invalid callback"),null):(this.sequence.push({type:"loop",id:r,cb:n}),this)},n.prototype.doLoop=function(e,n){var r=this.handleAlias(e);return r===null?(t.warn("doLoop received invalid stage name"),null):"function"!=typeof n?(t.warn("doLoop received invalid callback"),null):(this.sequence.push({type:"doLoop",id:r,cb:n}),this)},n.prototype.getSequence=function(e){var n,r,i,s,o=!1;switch(e){case"hstages":n=[];for(r in this.sequence)if(this.sequence.hasOwnProperty(r)){i=this.sequence[r];switch(i.type){case"gameover":n.push("[game over]");break;case"plain":n.push(i.id);break;case"repeat":n.push(i.id+" [x"+i.num+"]");break;case"loop":n.push(i.id+" [loop]");break;case"doLoop":n.push(i.id+" [doLoop]");break;default:return t.warn("unknown sequence object type"),null}}break;case"hsteps":n=[];for(r in this.sequence)if(this.sequence.hasOwnProperty(r)){i=this.sequence[r],s=i.id+".";switch(i.type){case"gameover":n.push("[game over]");break;case"plain":this.stages[i.id].steps.map(function(e){n.push(s+e)});break;case"repeat":this.stages[i.id].steps.map(function(e){n.push(s+e+" [x"+i.num+"]")});break;case"loop":this.stages[i.id].steps.map(function(e){n.push(s+e+" [loop]")});break;case"doLoop":this.stages[i.id].steps.map(function(e){n.push(s+e+" [doLoop]")});break;default:return t.warn("unknown sequence object type"),null}}break;case"o":n=this.sequence;break;default:return t.warn("getSequence got invalid format characters"),null}return n},n.prototype.getStepsFromStage=function(e){return this.stages[e]?this.stages[e].steps:null},n.prototype.setState=function(e,n){var r,i,s;if(!n||n==="replace")this.clear();else if(n!=="append")throw new t.NodeGameMisconfiguredGameError("setState got invalid updateRule");if(!e)throw new t.NodeGameMisconfiguredGameError("setState got invalid stateObj");for(r in e.steps)if(e.steps.hasOwnProperty(r)&&!this.addStep(e.steps[r]))throw new t.NodeGameMisconfiguredGameError("setState got invalid steps");for(r in e.stages){i=e.stages[r];if(e.stages.hasOwnProperty(r)&&i.id===r&&!this.addStage(i))throw new t.NodeGameMisconfiguredGameError("setState got invalid stages")}for(r in e.stages)i=e.stages[r],e.stages.hasOwnProperty(r)&&i.id!==r&&(this.stages[r]=this.stages[i.id]);if(e.hasOwnProperty("sequence"))for(r=0;r<e.sequence.length;r++){s=e.sequence[r];switch(s.type){case"gameover":this.gameover();break;case"plain":if(!this.next(s.id))throw new t.NodeGameMisconfiguredGameError("setState got invalid sequence");break;case"repeat":if(!this.repeat(s.id,s.num))throw new t.NodeGameMisconfiguredGameError("setState got invalid sequence");break;case"loop":if(!this.loop(s.id,s.cb))throw new t.NodeGameMisconfiguredGameError("setState got invalid sequence");break;case"doLoop":if(!this.doLoop(s.id,s.cb))throw new t.NodeGameMisconfiguredGameError("setState got invalid sequence");break;default:throw new t.NodeGameMisconfiguredGameError("setState got invalid sequence")}}if(e.hasOwnProperty("generalNextFunction")&&!this.registerGeneralNext(e.generalNextFunction))throw new t.NodeGameMisconfiguredGameError("setState got invalid general next-decider");for(r in e.nextFunctions)if(e.nextFunctions.hasOwnProperty(r)&&!this.registerNext(r,e.nextFunctions[r]))throw new t.NodeGameMisconfiguredGameError("setState got invalid specific next-deciders");if(e.hasOwnProperty("defaultStepRule")&&!this.setDefaultStepRule(e.defaultStepRule))throw new t.NodeGameMisconfiguredGameError("setState got invalid default step-rule");if(e.hasOwnProperty("defaultGlobals")&&!this.setDefaultGlobals(e.defaultGlobals))throw new t.NodeGameMisconfiguredGameError("setState got invalid default globals");if(e.hasOwnProperty("defaultProperties")&&!this.setDefaultProperties(e.defaultProperties))throw new t.NodeGameMisconfiguredGameError("setState got invalid default properties");if(e.hasOwnProperty("onInit")&&!this.setOnInit(e.onInit))throw new t.NodeGameMisconfiguredGameError("setState got invalid onInit");if(e.hasOwnProperty("onGameover")&&!this.setOnGameover(e.onGameover))throw new t.NodeGameMisconfiguredGameError("setState got invalid onGameover")},n.prototype.getState=function(){return{steps:this.steps,stages:this.stages,sequence:this.sequence,generalNextFunction:this.generalNextFunction,nextFunctions:this.nextFunctions,defaultStepRule:this.defaultStepRule,defaultGlobals:this.defaultGlobals,defaultProperties:this.defaultProperties,onInit:this.onInit,onGameover:this.onGameover}},n.prototype.extractStage=function(e,t){var n={steps:{},stages:{},sequence:[]},r,i,s,o,u,a;if(e instanceof Array)u=e;else{if("string"!=typeof e)return null;u=[e]}t=t===!1?!1:!0;for(a in u)if(u.hasOwnProperty(a)){id=u[a],o=this.stages[id];if(!o)return null;for(r in o.steps)o.steps.hasOwnProperty(r)&&(i=o.steps[r],n.steps[i]=this.steps[i]);s=o.id,n.stages[s]=o,s!==id&&(n.stages[id]=o),t&&n.sequence.push({type:"plain",id:s})}return n},n.prototype.seqTestRun=function(e,n){var r,i,s;console.log("* Commencing sequence test run!");if(!e){for(s in this.sequence)if(this.sequence.hasOwnProperty(s)){r=this.sequence[s],console.log("** num: "+s+", type: "+r.type);switch(r.type){case"gameover":console.log("* Game Over.");return;case"plain":this.stageTestRun(r.id);break;case"repeat":for(var o=0;o<r.num;o++)this.stageTestRun(r.id);break;case"loop":while(r.cb())this.stageTestRun(r.id);break;case"doLoop":do this.stageTestRun(r.id);while(r.cb());break;default:t.warn("unknown sequence object type")}}}else{n?i=n:this.generalNextFunction?i=this.generalNextFunction():i=null;while(i)this.stageTestRun(i),this.nextFunctions[i]?i=this.nextFunctions[i]():this.generalNextFunction?i=this.generalNextFunction():i=null,i!==null&&!this.stages[i]&&(t.warn("next-deciding callback yielded invalid stage"),i=null)}},n.prototype.stageTestRun=function(e){var t=this.stages[e].steps,n;for(var r in t)t.hasOwnProperty(r)&&(n=t[r],this.steps[n].cb())},n.prototype.checkStepValidity=function(e){return e?"string"!=typeof e.id?!1:"function"!=typeof e.cb?!1:!0:!1},n.prototype.checkStageValidity=function(e){if(!e)return!1;if("string"!=typeof e.id)return!1;if(!e.steps&&!e.steps.length)return!1;for(var t in e.steps)if(e.steps.hasOwnProperty(t)&&!this.steps[e.steps[t]])return!1;return!0},n.prototype.handleAlias=function(e){var n=e.split(" AS "),r=n[0].trim(),i=n[1]?n[1].trim():undefined,s=i||r,o;if(!this.stages[r])return t.warn("handleAlias received nonexistent stage id"),null;for(o in this.sequence)if(this.sequence.hasOwnProperty(o)&&this.sequence[o].id===s)return t.warn("handleAlias received non-unique stage name"),null;return i?(this.stages[i]=this.stages[r],i):r}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e){this.init(e)}e.GamePlot=s;var n=t.Stager,r=t.GameStage,i=t.JSUS;s.GAMEOVER="NODEGAME_GAMEOVER",s.END_SEQ="NODEGAME_END_SEQ",s.NO_SEQ="NODEGAME_NO_SEQ",s.prototype.init=function(e){if(e){if("object"!=typeof e)throw new t.NodeGameMisconfiguredGameError("init called with invalid stager");this.stager=e}else this.stager=null},s.prototype.next=function(e){if(!this.stager)return s.NO_SEQ;var n=this.stager.sequence.length===0,i,o=null,u,a,f,l=null,c=null;e=new r(e);if(n)return e.stage===0?(this.stager.generalNextFunction&&(c=this.stager.generalNextFunction()),c?new r({stage:c,step:1,round:1}):s.END_SEQ):(u=this.stager.stages[e.stage],"undefined"==typeof u?(t.warn("next received nonexistent stage: "+e.stage),null):("number"==typeof e.step?f=e.step:f=u.steps.indexOf(e.step)+1,f<1?(t.warn("next received nonexistent step: "+u.id+"."+e.step),null):f+1<=u.steps.length?new r({stage:u.id,step:f+1,round:1}):(this.stager.nextFunctions[u.id]?c=this.stager.nextFunctions[u.id]():this.stager.generalNextFunction&&(c=this.stager.generalNextFunction()),c===s.GAMEOVER?s.GAMEOVER:c?new r({stage:c,step:1,round:1}):s.END_SEQ)));if(e.stage===0)return new r({stage:1,step:1,round:1});l=this.normalizeGameStage(e);if(l===null)return t.warn("next received invalid stage: "+e),null;a=l.stage,f=l.step,o=this.stager.sequence[a-1];if(o.type==="gameover")return s.GAMEOVER;u=this.stager.stages[o.id];if(f+1<=u.steps.length)return new r({stage:a,step:f+1,round:l.round});if(o.type==="repeat"&&l.round+1<=o.num)return new r({stage:a,step:1,round:l.round+1});if(o.type!=="doLoop"&&o.type!=="loop"||!o.cb()){if(a<this.stager.sequence.length){while(this.stager.sequence[a].type==="loop"&&!this.stager.sequence[a].cb()){a++;if(a>=this.stager.sequence.length)return s.END_SEQ}return this.stager.sequence[a].type==="gameover"?s.GAMEOVER:new r({stage:a+1,step:1,round:1})}return s.END_SEQ}return new r({stage:a,step:1,round:l.round+1})},s.prototype.previous=function(e){if(!this.stager)return s.NO_SEQ;var n,i,o=null,u=null,a,f,l,c;e=new r(e),n=this.normalizeGameStage(e);if(n===null)return t.warn("previous received invalid stage: "+e),null;f=n.stage,l=n.step,o=this.stager.sequence[f-1];if(l>1)return new r({stage:f,step:l-1,round:e.round});if("undefined"!=typeof o.id){u=this.stager.stages[o.id];if(e.round>1)return new r({stage:f,step:u.steps.length,round:e.round-1});if((o.type==="doLoop"||o.type==="loop")&&o.cb())return new r({stage:f,step:u.steps.length,round:1})}if(f<=1)return new r({stage:0,step:0,round:0});while(this.stager.sequence[f-2].type==="loop"&&!this.stager.sequence[f-2].cb()){f--;if(f<=1)return new r({stage:0,step:0,round:0})}return a=this.stager.sequence[f-2],c=this.stager.stages[a.id].steps.length,a.type==="repeat"?new r({stage:f-1,step:c,round:a.num}):new r({stage:f-1,step:c,round:1})},s.prototype.jump=function(e,t){if(t<0)while(t<0){e=this.previous(e),t++;if(!(e instanceof r)||e.stage===0)return e}else while(t>0){e=this.next(e),t--;if(!(e instanceof r))return e}return e},s.prototype.stepsToNextStage=function(e){var t,n;return e=new r(e),e.stage===0?1:(t=this.getStage(e),t?("number"==typeof e.step?n=e.step:n=t.steps.indexOf(e.step)+1,n<1||n>t.steps.length?null:1+t.steps.length-n):null)},s.prototype.stepsToPreviousStage=function(e){var t,n;return e=new r(e),t=this.getStage(e),t?("number"==typeof e.step?n=e.step:n=t.steps.indexOf(e.step)+1,n<1||n>t.steps.length?null:n):null},s.prototype.getStage=function(e){var t;return this.stager?(e=new r(e),"number"==typeof e.stage?(t=this.stager.sequence[e.stage-1],t?this.stager.stages[t.id]:null):this.stager.stages[e.stage]||null):null},s.prototype.getStep=function(e){var t;return this.stager?(e=new r(e),"number"==typeof e.step?(t=this.getStage(e),t?this.stager.steps[t.steps[e.step-1]]:null):this.stager.steps[e.step]||null):null},s.prototype.getStepRule=function(e){var t=this.getStage(e),n=this.getStep(e);return!t||!n?null:"function"==typeof n.steprule?n.steprule:"function"==typeof t.steprule?t.steprule:this.stager.defaultStepRule},s.prototype.getGlobal=function(e,t){var n,i,s,o,u;e=new r(e),n=this.getStep(e);if(n){s=n.globals;if(s&&s.hasOwnProperty(t))return s[t]}i=this.getStage(e);if(i){o=i.globals;if(o&&o.hasOwnProperty(t))return o[t]}if(this.stager){u=this.stager.getDefaultGlobals();if(u&&u.hasOwnProperty(t))return u[t]}return null},s.prototype.getProperty=function(e,t){var n,i,s;e=new r(e),n=this.getStep(e);if(n&&n.hasOwnProperty(t))return n[t];i=this.getStage(e);if(i&&i.hasOwnProperty(t))return i[t];if(this.stager){s=this.stager.getDefaultProperties();if(s&&s.hasOwnProperty(t))return s[t]}return null},s.prototype.isReady=function(){debugger;return this.stager&&(this.stager.sequence.length>0||this.stager.generalNextFunction!==null||!i.isEmpty(this.stager.nextFunctions))},s.prototype.getName=function(e){var t=this.getStep(e);return t?t.name:t},s.prototype.getAllParams=s.prototype.getStep,s.prototype.normalizeGameStage=function(e){var n,i,s,o;if(!e||"object"!=typeof e)return null;if("number"==typeof e.stage)n=e.stage;else{for(s=0;s<this.stager.sequence.length;s++)if(this.stager.sequence[s].id===e.stage)break;n=s+1}return n<1||n>this.stager.sequence.length?(t.warn("normalizeGameStage received nonexistent stage: "+e.stage),null):(o=this.stager.sequence[n-1],o?o.type==="gameover"?new r({stage:n,step:1,round:e.round}):(stageObj=this.stager.stages[o.id],stageObj?("number"==typeof e.step?i=e.step:i=stageObj.steps.indexOf(e.step)+1,i<1?(t.warn("normalizeGameStage received nonexistent step: "+stageObj.id+"."+e.step),null):"number"!=typeof e.round?null:new r({stage:n,step:i,round:e.round})):null):null)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function a(){}var n=t.GameMsg,r=t.GameStage,i=t.Player,s=t.JSUS,o=t.target,u=t.action;e.GameMsgGenerator=a,a.create=function(e){return new n({session:"undefined"!=typeof e.session?e.session:t.socket.session,stage:"undefined"!=typeof e.stage?e.stage:t.game.stage,action:e.action||u.SAY,target:e.target||o.DATA,from:t.player.sid,to:"undefined"!=typeof e.to?e.to:"SERVER",text:e.text||null,data:e.data||null,priority:e.priority||null,reliable:e.reliable||1})}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){var t=e;return t=new e,t.send?t.connect?!0:(console.log("no connect"),!1):(console.log("no send"),!1)}function i(){return n}function s(e,t){var r=n[e];return r?new r(t):null}function o(e,i){if(!e||!i)return;r(i)?n[e]=i:t.err("cannot register invalid Socket class: "+e)}var n={};e.SocketFactory={checkContract:r,getTypes:i,get:s,register:o}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function f(e){this.buffer=[],this.session=null,this.user_options={},this.socket=null,this.url=null}e.Socket=f;var n=t.GameMsg,r=t.GameStage,i=t.Player,s=t.GameMsgGenerator,o=t.SocketFactory,u=t.action,a=t.JSUS;f.prototype.setup=function(e){var t;e=e?a.clone(e):{},t=e.type,delete e.type,this.user_options=e,t&&this.setSocketType(t,e)},f.prototype.setSocketType=function(e,t){return this.socket=o.get(e,t),this.socket},f.prototype.connect=function(e){if(!this.socket)return t.err("cannot connet to "+e+" . No open socket."),!1;this.url=e,t.log("connecting to "+e),this.socket.connect(e,this.user_options)},f.prototype.onDisconnect=function(){t.session.store(),t.log("closed")},f.prototype.onMessage=function(e){e=this.secureParse(e);if(!e)return;var n;e.target==="HI"&&(this.attachMsgListeners(),this.startSession(e),n=t.store(e.session),t.store(e.session,t.session.save()),this.send(t.msg.create({target:"HI",to:"ALL",data:t.player})))},f.prototype.attachMsgListeners=function(){this.onMessage=this.onMessageFull,t.emit("NODEGAME_READY")},f.prototype.onMessageFull=function(e){e=this.secureParse(e),e&&(e.priority>0||t.game.isReady&&t.game.isReady()?t.emit(e.toInEvent(),e):(t.silly("buffering: "+e),this.buffer.push(e)))},f.prototype.registerServer=function(e){this.servername=e.from,this.serverid=e.from},f.prototype.secureParse=function(e){var r;try{r=n.clone(JSON.parse(e)),t.info("R: "+r)}catch(i){return l("malformed msg received",i)}return this.session&&r.session!==this.session?l("local session id does not match incoming message session id"):r},f.prototype.clearBuffer=function(){var e,n,r;e=this.buffer.length;for(r=0;r<e;r++)n=this.buffer.shift(),n&&(t.emit(n.toInEvent(),n),t.silly("Debuffered "+n))},f.prototype.startSession=function(e){var n;return this.registerServer(e),n={id:e.data,sid:e.data},t.createPlayer(n),this.session=e.session,!0},f.prototype.send=function(e){return this.socket?(this.socket.send(e),t.info("S: "+e),!0):(t.err("socket cannot send message. No open socket."),!1)};var l=function(e,n){e=e||"Generic error while parsing a game message";var r=n?e+": "+n:e;return t.log(r,"ERR"),t.emit("LOG","E: "+r),!1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){function o(e){this.socket=null}var r=t.GameMsg,i=t.Player,s=t.GameMsgGenerator;e.SocketIo=o,o.prototype.connect=function(e,r){var i;return e?(i=this,this.socket=n.connect(e,r),this.socket.on("connect",function(e){t.info("socket.io connection open"),i.socket.on("message",function(e){t.socket.onMessage(e)})}),this.socket.on("disconnect",t.socket.onDisconnect),!0):(t.err("cannot connect to empty url.","ERR"),!1)},o.prototype.send=function(e){this.socket.send(e.stringify())},t.SocketFactory.register("SocketIo",o)}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof io?io:module.parent.exports.io),function(e,t){function s(e,t,n){e=e||{},e.update||(e.update={}),e.update.indexes=!0,r.call(this,e,t,n),this.c("stage",o.compareState),this.player||this.h("player",function(e){return e.player}),this.stage||this.h("stage",function(e){return i.toHash(e.stage,"S.s.r")}),this.key||this.h("key",function(e){return e.key})}function o(e){this.stage=e.stage,this.player=e.player,this.key=e.key,this.value=e.value,this.time=Date?Date.now():null}var n=t.JSUS,r=t.NDDB,i=t.GameStage;s.prototype=new r,s.prototype.constructor=s,e.GameDB=s,e.GameBit=o,s.prototype.add=function(e,n,r,i){return e?(i=i||t.game.stage,r=r||t.player,this.insert(new o({player:r,key:e,value:n,stage:i})),!0):!1},o.prototype.toString=function(){return this.player+", "+i.stringify(this.stage)+", "+this.key+", "+this.value},o.equals=function(e,t,n){return!e||!t?!1:(n=n||!1,o.comparePlayer(e,t)!==0?!1:o.compareState(e,t)!==0?!1:o.compareKey(e,t)!==0?!1:n&&e.value&&o.compareValue(e,t)!==0?!1:!0)},o.comparePlayer=function(e,t){return!e&&!t?0:e?t?e.player===t.player?0:e.player>t.player?1:-1:-1:1},o.compareState=function(e,t){return i.compare(e.stage,t.stage)},o.compareKey=function(e,t){return!e&&!t?0:e?t?e.key===t.key?0:e.key<t.key?-1:1:-1:1},o.compareValue=function(e,t){return!e&&!t?0:e?t?n.equals(e.value,t.value)?0:e.value>t.value?1:-1:-1:1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function c(e){this.setStateLevel(t.stateLevels.UNINITIALIZED),this.setStageLevel(t.stageLevels.UNINITIALIZED),e=e||{},this.metadata={name:e.name||"A nodeGame game",description:e.description||"No Description",version:e.version||"0",session:e.session||"0"},this.settings={observer:!!e.observer,auto_wait:!!e.auto_wait,minPlayers:e.minPlayers||1,maxPlayers:e.maxPlayers||1e3},this.pl=new o,this.ml=new o,this.memory=new i,this.plot=new s(new a(e.stages)),this.setCurrentGameStage(new n),this.paused=!1,this.setStateLevel(t.stateLevels.STARTING)}var n=t.GameStage,r=t.GameMsg,i=t.GameDB,s=t.GamePlot,o=t.PlayerList,u=t.Player,a=t.Stager,f=t.JSUS,l=t.action;e.Game=c,c.prototype.start=function(){var e,r;if(this.getStateLevel()>=t.stateLevels.INITIALIZING)return t.warn("game.start called on a running game"),!1;if(!this.plot.isReady())throw new t.NodeGameMisconfiguredGameError("game.start called with unready plot");return this.plot&&this.plot.stager&&(e=this.plot.stager.getOnInit(),e&&(this.setStateLevel(t.stateLevels.INITIALIZING),e.call(t.game))),this.setStateLevel(t.stateLevels.INITIALIZED),this.setCurrentGameStage(new n),r=this.step(),t.log("game started"),r},c.prototype.gameover=function(){var e;if(this.getStateLevel()>=t.stateLevels.FINISHING){t.warn("game.gameover called on a finishing game");return}t.emit("GAMEOVER"),this.plot&&this.plot.stager&&(e=this.plot.stager.getOnGameover(),e&&(this.setStateLevel(t.stateLevels.FINISHING),e.call(t.game))),this.setStateLevel(t.stateLevels.GAMEOVER),this.setStageLevel(t.stageLevels.DONE)},c.prototype.pause=function(){this.paused=!0},c.prototype.resume=function(){this.paused=!1},c.prototype.shouldStep=function(){var e;e=this.plot.getStepRule(this.getCurrentGameStage());if("function"!=typeof e)throw new NodeGameMisconfiguredGameError("step rule is not a function");return e(this.getCurrentGameStage(),this.getStageLevel(),this.pl,this)?this.step():null},c.prototype.step=function(){var e,n,r,i,o;n=this.getCurrentGameStage(),e=this.plot.next(n),t.silly("Next stage ---> "+e),t.events.ee.step.clear();if("string"==typeof e)return e===s.GAMEOVER?(this.gameover(),null):null;this.setCurrentGameStage(e);if(this.plot.stepsToNextStage(n)===1){i=this.plot.getStage(e);if(!i)return!1;t.events.ee.stage.clear(),i.hasOwnProperty("init")&&(this.setStateLevel(t.stateLevels.STAGE_INIT),this.setStageLevel(t.stageLevels.INITIALIZING),i.init.call(t.game));for(o in i.on)i.on.hasOwnProperty(o)&&t.events.ee.stage.on(o,nextStageObjs.on[o])}r=this.plot.getStep(e);if(!r)return!1;r.hasOwnProperty("init")&&(this.setStateLevel(t.stateLevels.STEP_INIT),this.setStageLevel(t.stageLevels.INITIALIZING),r.init.call(t.game)),this.setStateLevel(t.stateLevels.PLAYING_STEP),this.setStageLevel(t.stageLevels.INITIALIZED);for(o in r.on)r.on.hasOwnProperty(o)&&t.events.ee.step.on(o,nextStepObjs.on[o]);return this.execStep(this.getCurrentStep())},c.prototype.execStep=function(e){var n,r;if(!e||"object"!=typeof e)throw new t.NodeGameRuntimeError("game.execStep requires a valid object");n=e.cb,this.setStageLevel(t.stageLevels.LOADING);try{r=n.call(t.game)}catch(i){throw t.debug?i:(t.err("An error occurred while executing a custom callback"),new t.NodeGameRuntimeError(i))}return this.setStageLevel(t.stageLevels.LOADED),this.isReady()&&t.emit("LOADED"),r===!1&&t.err("A non fatal error occurred while executing the callback of stage "+this.getCurrentGameStage()),r},c.prototype.getStateLevel=function(){return this.stateLevel},c.prototype.getStageLevel=function(){return this.stageLevel},c.prototype.getCurrentStep=function(){return this.plot.getStep(this.getCurrentGameStage())},c.prototype.getCurrentGameStage=function(){return this.currentGameStage},c.prototype.setStateLevel=function(e){if("number"!=typeof e)throw new t.NodeGameMisconfiguredGameError("setStateLevel called with invalid parameter: "+e);this.stateLevel=e},c.prototype.setStageLevel=function(e){if("number"!=typeof e)throw new t.NodeGameMisconfiguredGameError("setStageLevel called with invalid parameter: "+e);this.publishStageLevelUpdate(e),this.stageLevel=e},c.prototype.setCurrentGameStage=function(e){e=new n(e),this.publishGameStageUpdate(e),this.currentGameStage=e},c.prototype.publishStageLevelUpdate=function(e){!this.observer&&this.stageLevel!==e&&t.socket.send(t.msg.create({target:t.target.STAGE_LEVEL,data:e,to:"ALL"}))},c.prototype.publishGameStageUpdate=function(e){!this.observer&&this.currentGameStage!==e&&t.socket.send(t.msg.create({target:t.target.STAGE,data:e,to:"ALL"}))},c.prototype.isReady=function(){return this.getStageLevel()===t.stageLevels.LOADING?!1:t.window?t.window.state>=t.is.LOADED:!0}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function o(){u.call(this),this.register("player",{set:function(e){t.createPlayer(e)},get:function(){return t.player}}),this.register("game.memory",{set:function(e){t.game.memory.clear(!0),t.game.memory.importDB(e)},get:function(){return t.game.memory?t.game.memory.fetch():null}}),this.register("events.history",{set:function(e){t.events.history.history.clear(!0),t.events.history.history.importDB(e)},get:function(){return t.events.history?t.events.history.history.fetch():null}}),this.register("game.currentStepObj",{set:o.restoreStage,get:function(){return t.game.getCurrentStep()}}),this.register("node.env")}function u(){this.session={}}var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS;e.GameSession=o,e.GameSession.SessionManager=u,o.prototype=new u,o.prototype.constructor=o,o.prototype.restoreStage=function(e){try{t.game.execStage(t.plot.getStep(e));var n=["LOG","STATECHANGE","WINDOW_LOADED","BEFORE_LOADING","LOADED","in.say.STATE","UPDATED_PLIST","NODEGAME_READY","out.say.STATE","out.set.STATE","in.say.PLIST","STAGEDONE","out.say.HI"];return t.events.history.remit(t.game.getStateLevel(),n),t.info("game stage restored"),!0}catch(r){return t.err("could not restore game stage. An error has occurred: "+r),!1}},u.getVariable=function(e){s.getNestedValue(e,t)},u.setVariable=function(e,n){s.setNestedValue(e,n,t)},u.prototype.register=function(e,n){return e?(this.session[e]={get:n&&n.get?n.get:function(){return s.getNestedValue(e,t)},set:n&&n.set?n.set:function(n){s.setNestedValue(e,n,t)}},!0):(t.err("cannot add an empty path to session"),!1)},u.prototype.unregister=function(e){return e?this.session[e]?(delete this.session[e],!0):(t.err(e+" is not registered in the session"),!1):(t.err("cannot delete an empty path from session"),!1)},u.prototype.get=function(e){var t={};if(e)return this.session[e]?this.session[e].get():undefined;for(e in this.session)this.session.hasOwnProperty(e)&&(t[e]=this.session[e].get());return t},u.prototype.save=function(){var e={};for(var t in this.session)this.session.hasOwnProperty(t)&&(e[t]={value:this.session[t].get(),get:this.session[t].get,set:this.session[t].set});return e},u.prototype.load=function(e){for(var t in e)e.hasOwnProperty(t)&&this.register(t,e[t])},u.prototype.clear=function(){this.session={}},u.prototype.restore=function(e){if(!e){t.err("cannot restore empty session object");return}for(var n in e)e.hasOwnProperty(n)&&e[n].set(e[n].value);return!0},u.prototype.store=function(){},u.prototype.store=function(){}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){}function i(e){this.groups=[],this.maxIteration=10,this.doneCounter=0}function s(){this.elements=[],this.matched=[],this.leftOver=[],this.pointer=0,this.matches={},this.matches.total=0,this.matches.requested=0,this.matches.done=!1,this.rowLimit=3,this.noSelf=!0,this.pool=[],this.shuffle=!0,this.stretch=!0}function u(){var e=[],t=n.shuffle(o);return e.push(t.splice(0,n.randomInt(0,t.length))),e.push(t.splice(0,n.randomInt(0,t.length))),e.push(t),n.shuffle(e)}function a(){var e=n.shuffle(o);out=[];var t=e.splice(0,n.randomInt(0,e.length/2)),r=e.splice(0,n.randomInt(0,e.length/2)),i=e,s=t.splice(0,n.randomInt(0,t.length));t=n.shuffle([s,t]);var u=r.splice(0,n.randomInt(0,r.length));r=n.shuffle([u,r]);var a=i.splice(0,n.randomInt(0,i.length));return i=n.shuffle([a,i]),n.shuffle([t,r,i])}function f(e){for(var t=0;t<e;t++){var n=new i,r=u(),s=a();n.init(r,s);var o=n.match();n.allGroupsDone()||(console.log("ERROR"),console.log(n.options.elements),console.log(n.options.pools),console.log(o));for(var f=0;f<n.groups.length;f++){var l=n.groups[f];for(var c=0;c<l.elements.length;c++)l.matched[c].length!==l.rowLimit&&(console.log("Wrong match: "+c),console.log(n.options.elements),console.log(n.options.pools),console.log(o))}}}var n=t.JSUS;e.GroupManager=r,e.RMatcher=i,i.prototype.init=function(e,t){var n,r;for(n=0;n<e.length;n++)r=new s,r.init(e[n],t[n]),this.addGroup(r);this.options={elements:e,pools:t}},i.prototype.addGroup=function(e){if(!e)return;this.groups.push(e)},i.prototype.match=function(){var e;for(e=0;e<this.groups.length;e++)this.groups[e].match(),this.groups[e].matches.done&&this.doneCounter++;return this.allGroupsDone()||this.assignLeftOvers(),this.allGroupsDone()||this.switchBetweenGroups(),n.map(this.groups,function(e){return e.matched})},i.prototype.invertMatched=function(){var e,t=[],r=[];return n.each(this.groups,function(n){t=t.concat(n.elements),e=n.invertMatched();for(var i=0;i<e.length;i++)r[i]=(r[i]||[]).concat(e[i])}),{elements:t,inverted:r}},i.prototype.allGroupsDone=function(){return this.doneCounter===this.groups.length},i.prototype.tryOtherLeftOvers=function(e){var t,r,i=n.seq(0,this.groups.length-1);i=n.shuffle(i);for(var s=0;s<i.length;s++){r=i[s];if(r===e)continue;t=this.groups[r],leftOver=[];if(t.leftOver.length){t.leftOver=this.groups[e].matchBatch(t.leftOver);if(this.groups[e].matches.done)return this.doneCounter++,!0}}},i.prototype.assignLeftOvers=function(){var e,t;for(t=0;t<this.groups.length;t++)e=this.groups[t],e.matches.done||this.tryOtherLeftOvers(t)},i.prototype.collectLeftOver=function(){return n.map(this.groups,function(e){return e.leftOver})},i.prototype.switchFromGroup=function(e,t,n,r){var i,s,o,u,a,f;for(i=0;i<e.elements.length;i++)for(s=0;s<r.length;s++)for(o=0;o<r[s].length;o++){u=r[s][o];if(e.canSwitchIn(u,i))for(a=0;a<e.matched[i].length;a++){f=e.matched[i][a];if(t.canAdd(f,n))return e.matched[i][a]=u,t.addToRow(f,n),r[s].splice(o,1),t.matches.done&&this.doneCounter++,!0}}},i.prototype.trySwitchingBetweenGroups=function(e,t){var n=this.collectLeftOver(),r=this.groups[e],i,s;for(i=e+1;i<this.groups.length+e+1;i++){s=this.groups[i%this.groups.length];if(this.switchFromGroup(s,r,t,n)&&r.matches.done)return}return!1},i.prototype.switchBetweenGroups=function(){var e,t,n,r,i;for(e=0;e<this.groups.length;e++){t=this.groups[e];if(!t.matches.done)for(n=0;n<t.elements.length;n++){i=t.rowLimit-t.matched[n].length;if(i)for(r=0;r<i;r++){this.trySwitchingBetweenGroups(e,n);if(this.allGroupsDone())return!0}}}return!1},s.prototype.init=function(e,t){this.elements=e,this.pool=n.clone(t);for(var r=0;r<this.pool.length;r++)this.stretch&&(this.pool[r]=n.stretch(this.pool[r],this.rowLimit)),this.shuffle&&(this.pool[r]=n.shuffle(this.pool[r]));if(!e.length)this.matches.done=!0;else for(r=0;r<e.length;r++)this.matched[r]=[];this.matches.requested=this.elements.length*this.rowLimit},s.prototype.canSwitchIn=function(e,t){return n.in_array(e,this.matched[t])?!1:this.noSelf&&this.elements[t]===e?!1:!0},s.prototype.canAdd=function(e,t){return this.matched[t].length>=this.rowLimit?!1:this.canSwitchIn(e,t)},s.prototype.shouldSwitch=function(e,t){return this.leftOver.length?this.matched.length<2?!1:!0:!1},s.prototype.switchIt=function(){for(var e=0;e<this.elements.length;e++)this.matched[e].length<this.rowLimit&&this.completeRow(e)},s.prototype.completeRow=function(e,t){t=t||this.leftOver;var n=t.slice(0);for(var r=0;r<n.length;r++)for(var i=0;i<this.elements.length;i++){if(this.switchItInRow(n[r],i,e))return t.splice(r,1),!0;this.updatePointer()}return!1},s.prototype.switchItInRow=function(e,t,n){if(!this.canSwitchIn(e,t))return!1;for(var r=0;r<this.matched[t].length;r++){var i=this.matched[t][r];if(this.canAdd(i,n))return this.matched[t][r]=e,this.addToRow(i,n),!0}return!1},s.prototype.addToRow=function(e,t){this.matched[t].push(e),this.matches.total++,this.matches.total===this.matches.requested&&(this.matches.done=!0)},s.prototype.addIt=function(e){var t=0,n=!1;while(t<this.elements.length&&!n)this.canAdd(e,this.pointer)&&(this.addToRow(e,this.pointer),n=!0),this.updatePointer(),t++;return n},s.prototype.matchBatch=function(e){var t=[];for(var n=0;n<e.length;n++)(this.matches.done||!this.addIt(e[n]))&&t.push(e[n]);return t},s.prototype.match=function(e){e=e||this.pool,n.isArray(e)||(e=[e]);var t;for(var r=0;r<e.length;r++)t=this.matchBatch(e[r]),t.length&&(this.leftOver=this.leftOver.concat(t));this.shouldSwitch()&&this.switchIt()},s.prototype.updatePointer=function(){this.pointer=(this.pointer+1)%this.elements.length},s.prototype.summary=function(){console.log("elements: ",this.elements),console.log("pool: ",this.pool),console.log("left over: ",this.leftOver),console.log("hits: "+this.matches.total+"/"+this.matches.requested),console.log("matched: ",this.matched)},s.prototype.invertMatched=function(){return n.transpose(this.matched)};var o=[1,2,3,4,5,6,7,8,9]}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){}var n=t.JSUS;e.RoleMapper=r}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.EventEmitterManager,r=t.EventEmitter,s=t.Socket,o=t.GameStage,u=t.GameMsg,a=t.Game,f=t.Player,l=t.GameSession,c=t.JSUS;t.env=function(e,n,r,i){if(!e||!n||!t.env[e])return;r=r||t,i=i||[],n.apply(r,i)},t.createPlayer=function(e){e=new f(e);if(t.conf&&t.conf.player){var n=t.conf.player;for(var r in n)if(n.hasOwnProperty(r)){if(c.inArray(r,["id","sid","ip"]))continue;t.support.defineProperty?Object.defineProperty(e,r,{value:n[r],enumerable:!0}):e[r]=n[r]}}return t.support.defineProperty?Object.defineProperty(t,"player",{value:e,enumerable:!0}):t.player=e,t.emit("PLAYER_CREATED",e),e},t.connect=function(e){t.socket.connect(e)&&t.emit("NODEGAME_CONNECTED")},t.play=function(){t.game.start()},t.replay=function(e){e&&t.game.memory.clear(!0),t.game.execStep(t.plot.getStep("1.1.1"))},t.emit=function(){t.events.emit.apply(t.events,arguments)},t.say=function(e,n,r){var i;if("undefined"==typeof e)return t.err("cannot say empty message"),!1;i=t.msg.create({target:t.target.DATA,to:n||"SERVER",text:e,data:r}),this.socket.send(i)},t.set=function(e,n,r){var i;if("undefined"==typeof e)return t.err("cannot set undefined key"),!1;i=t.msg.create({action:t.action.SET,target:t.target.DATA,to:r||"SERVER",reliable:1,text:e,data:n}),this.socket.send(i)},t.get=function(e,n,r){function s(r){r.text===e&&(n.call(t.game,r.data),o.remove("in.say.DATA",s))}var i,s,o;if("undefined"==typeof e)return t.err("cannot get empty key"),!1;if("function"!=typeof n)return t.err("node.get requires a valid callback function"),!1;i=t.msg.create({action:t.action.GET,target:t.target.DATA,to:r||"SERVER",reliable:1,text:e}),o=t.getCurrentEventEmitter(),o.on("in.say.DATA",s)},t.on=function(e,n){var r;r=t.getCurrentEventEmitter(),r.on(e,n)},t.done=function(){var e,n;switch(arguments.length){case 0:t.emit("DONE");break;case 1:t.emit("DONE",arguments[0]);break;case 2:t.emit("DONE",arguments[0],arguments[1]);break;default:n=arguments.length,e=new Array(n-1);for(i=1;i<n;i++)e[i-1]=arguments[i];t.emit.apply("DONE",e)}},t.getCurrentEventEmitter=function(){return!t.game||!t.game.getCurrentGameStage()?t.events.ee.ng:o.compare(t.game.getCurrentGameStage(),new o)===0?t.events.ee.game:t.events.ee.step},t.once=function(e,n){if(!e||!n)return;t.on(e,n),t.on(e,function(e,n){t.events.remove(e,n)})},t.off=function(e,n){return t.events.remove(e,n)},t.redirect=function(e,n){var r;return"string"!=typeof e?(t.err("redirect requires a valid string"),!1):"undefined"==typeof n?(t.err("redirect requires a valid recipient"),!1):(r=t.msg.create({target:t.target.REDIRECT,data:e,to:n}),t.socket.send(r),!0)},t.remoteCommand=function(e,n,r){var i;return e?"undefined"==typeof n?(t.err("remoteCommand requires a valid recipient"),!1):(i=t.msg.create({target:t.target.GAMECOMMAND,text:e,data:r,to:n}),t.socket.send(i)):(t.err("remoteCommand requires a valid command"),!1)},t.info(t.version+" loaded"),t.events=new n,t.msg=t.GameMsgGenerator,t.session=new l,t.socket=new s,t.game=new a}(this,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.GameMsg,r=t.Player,i=t.Game,s=t.GamePlot,o=t.Stager,u=t.GameMsgGenerator,a=t.JSUS,f=!1;t.setup=function(n){var r;return f?(t.err("nodeGame configuration is frozen. No modification allowed."),!1):n==="register"?(t.warn('cannot setup property "register"'),!1):t.setup[n]?(r=t.setup[n].apply(e,Array.prototype.slice.call(arguments,1)),n!=="nodegame"&&(t.conf[n]=r),!0):(t.warn("no such property to configure: "+n),!1)},t.setup.register=function(e,n){return!e||!n?(t.err("cannot register empty setup function"),!1):e==="register"?(t.err("cannot overwrite register function"),!1):(t.setup[e]=n,!0)},t.setup.register("nodegame",function(n){for(var r in t.setup)t.setup.hasOwnProperty(r)&&r!=="register"&&r!=="nodegame"&&(t.conf[r]=t.setup[r].call(e,n[r]))}),t.setup.register("socket",function(e){if(!e)return;return t.socket.setup(e),e}),t.setup.register("host",function(e){var t;return e||"undefined"!=typeof window&&"undefined"!=typeof window.location&&(e=window.location.href),e&&(t=e.split("/").slice(0,-2),t.length>1&&(e=t.join("/")),e.lastIndexOf("/")!==e.length&&(e+="/")),e}),t.setup.register("verbosity",function(e){return"undefined"!=typeof e&&(t.verbosity=e),e}),t.setup.register("debug",function(e){e=e||!1;if("boolean"!=typeof e)throw new TypeError("node.debug must be of type boolean");return t.debug=e,e}),t.setup.register("env",function(e){if("undefined"!=typeof e)for(var n in e)e.hasOwnProperty(n)&&(t.env[n]=e[n]);return e}),t.setup.register("events",function(e){return e=e||{},"undefined"==typeof e.history&&(e.history=!1),"undefined"==typeof e.dumpEvents&&(e.dumpEvents=!1),e}),t.setup.register("window",function(e){if(!t.window){t.warn("node.window not found, cannot configure it.");return}return e=e||{},"undefined"==typeof e.promptOnleave&&(e.promptOnleave=!1),"undefined"==typeof e.noEscape&&(e.noEscape=!0),t.window.init(e),e}),t.setup.register("game_settings",function(e){if(!t.game)throw t.warn("register('game_settings') called before node.game was initialized"),new NodeGameMisconfiguredGameError("node.game non-existent");return e&&a.mixin(t.game.settings,e),t.game.settings}),t.setup.register("game_metadata",function(e){if(!t.game)throw t.warn("register('game_metadata') called before node.game was initialized"),new NodeGameMisconfiguredGameError("node.game non-existent");return e&&a.mixin(t.game.metadata,e),t.game.metadata}),t.setup.register("player",t.createPlayer),t.setup.register("plot",function(e,n){if(!t.game)throw t.warn("register('plot') called before node.game was initialized"),new NodeGameMisconfiguredGameError("node.game non-existent");return e=e||{},t.game.plot||(t.game.plot=new s),t.game.plot.stager||(t.game.plot.stager=new o),t.game.plot.stager.setState(e,n),t.game.plot}),t.setup.register("plist",function(e,n){if(!t.game||!t.game.pl)throw t.warn("register('plist') called before node.game was initialized"),new NodeGameMisconfiguredGameError("node.game non-existent");if(e){if(!n||n==="replace")t.game.pl.clear(!0);else if(n!=="append")throw new NodeGameMisconfiguredGameError("register('plist') got invalid updateRule");t.game.pl.importDB(e)}return t.game.pl}),t.remoteSetup=function(e,n){var r,i;return e?n?(i=a.stringifyAll(Array.prototype.slice.call(arguments,2)),i?(r=t.msg.create({target:t.target.SETUP,to:n,text:e,data:i}),t.socket.send(r)):(t.err("an error occurred while stringifying payload for remote setup"),!1)):(t.err("cannot send remote setup: empty recipient"),!1):(t.err("cannot send remote setup: empty property"),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof io?io:module.parent.exports.io),function(e,t){var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS;t.alias=function(e,n,r){if(!e||!n){t.err("undefined alias or events");return}s.isArray(n)||(n=[n]),s.each(n,function(n){t.on[e]=function(e){t.on(n,r?function(){e.call(t.game,r.apply(t.game,arguments))}:function(){e.apply(t.game,arguments)})}})},t.alias("txt","in.say.TXT"),t.alias("data",["in.say.DATA","in.set.DATA"]),t.alias("state","in.set.STATE"),t.alias("stage","in.set.STAGE"),t.alias("plist",["in.set.PLIST","in.say.PLIST"]),t.alias("pconnect","in.say.PCONNECT",function(e){return e.data})}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS;t.random={},t.random.emit=function(e,n){n=n||6e3,setTimeout(function(e){t.emit(e)},Math.random()*n,e)},t.random.exec=function(e,t){t=t||6e3,setTimeout(function(e){e.call()},Math.random()*t,e)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){var t=e.GameMsg,n=e.GameStage,r=e.PlayerList,i=e.Player,s=e.JSUS,o=e.action,u=e.target,a=o.SAY+".",f=o.SET+".",l=o.GET+".",c=e.IN;e.events.ng.on(c+a+"PCONNECT",function(t){if(!t.data)return;e.game.pl.add(new i(t.data)),e.emit("UPDATED_PLIST")}),e.events.ng.on(c+a+"PDISCONNECT",function(t){if(!t.data)return;e.game.pl.remove(t.data.id),e.emit("UPDATED_PLIST")}),e.events.ng.on(c+a+"MCONNECT",function(t){if(!t.data)return;e.game.ml.add(new i(t.data)),e.emit("UPDATED_MLIST")}),e.events.ng.on(c+a+"MDISCONNECT",function(t){if(!t.data)return;e.game.ml.remove(t.data.id),e.emit("UPDATED_MLIST")}),e.events.ng.on(c+a+"PLIST",function(t){if(!t.data)return;e.game.pl=new r({},t.data),e.emit("UPDATED_PLIST")}),e.events.ng.on(c+a+"MLIST",function(t){if(!t.data)return;e.game.ml=new r({},t.data),e.emit("UPDATED_MLIST")}),e.events.ng.on(c+l+"DATA",function(t){t.text==="LOOP"&&e.socket.sendDATA(o.SAY,e.game.plot,t.from,"GAME")}),e.events.ng.on(c+f+"STATE",function(t){e.game.memory.add(t.text,t.data,t.from)}),e.events.ng.on(c+f+"DATA",function(t){e.game.memory.add(t.text,t.data,t.from)}),e.events.ng.on(c+a+"STAGE",function(t){e.game.pl.exist(t.from)?(e.game.pl.updatePlayerStage(t.from,t.data),e.emit("UPDATED_PLIST"),e.game.shouldStep()):e.game.execStep(e.game.plot.getStep(t.data))}),e.events.ng.on(c+a+"STAGE_LEVEL",function(t){e.game.pl.exist(t.from)&&(e.game.pl.updatePlayerStageLevel(t.from,t.data),e.emit("UPDATED_PLIST"),e.game.shouldStep())}),e.events.ng.on(c+a+"REDIRECT",function(t){if(!t.data)return;if("undefined"==typeof window||!window.location)return e.err("window.location not found. Cannot redirect"),!1;window.location=t.data}),e.events.ng.on(c+a+"SETUP",function(t){if(!t.text)return;var n=t.text,r=JSUS.parse(t.data);if(!r)return e.err("error while parsing incoming remote setup message"),!1;e.setup.apply(this,[n].concat(r))}),e.events.ng.on(c+a+"GAMECOMMAND",function(t){if(!t.text||!e.gamecommand[t.text]){e.err("unknown game command received: "+t.text);return}e.emit("NODEGAME_GAMECOMMAND_"+t.text,t.data)}),e.events.ng.on(c+a+"JOIN",function(t){if(!t.text)return;e.connect(t.text)}),e.log("incoming listeners added")}("undefined"!=typeof node?node:module.parent.exports),function(e){var t=e.action,n=e.target,r=e.GameMsg,i=e.GameStage,s=e.Game,o=t.SAY+".",u=t.SET+".",a=t.GET+".",f=e.IN,l=e.OUT;e.events.ng.on("DONE",function(t,n,r){var i=!0,s=e.game.getCurrentStep().done;s&&(i=s.call(e.game,t,n,r));if(!i)return;e.game.setStageLevel(e.stageLevels.DONE),e.emit("BEFORE_DONE"),e.game.auto_wait&&e.window&&e.emit("WAITING..."),e.game.shouldStep()}),e.events.ng.on("WINDOW_LOADED",function(){e.game.isReady()&&e.emit("LOADED")}),e.events.ng.on("GAME_LOADED",function(){e.game.isReady()&&e.emit("LOADED")}),e.events.ng.on("LOADED",function(){e.emit("BEFORE_LOADING"),e.game.setStageLevel(e.stageLevels.PLAYING),e.socket.clearBuffer()}),e.events.ng.on("NODEGAME_GAMECOMMAND_"+e.gamecommand.start,function(t){e.emit("BEFORE_GAMECOMMAND",e.gamecommand.start,t);if(e.game.getCurrentStep()&&e.game.getCurrentStep().stage!==0){e.err("Game already started. Use restart if you want to start the game again");return}e.game.start()}),e.log("internal listeners added")}("undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){e=e||{},this.status=r.UNINITIALIZED,this.options=e,this.timer=null,this.timeLeft=null,this.timePassed=0,this.update=1e3,this.timeup="TIMEUP",this.hooks=[],this.init(),this.listeners()}e.GameTimer=r;var n=t.JSUS;r.STOPPED=-5,r.PAUSED=-3,r.UNINITIALIZED=-1,r.INITIALIZED=0,r.LOADING=3,r.RUNNING=5,r.prototype.init=function(e){e=e||this.options,this.status=r.UNINITIALIZED,this.timer&&clearInterval(this.timer),this.milliseconds=e.milliseconds||0,this.timeLeft=this.milliseconds,this.timePassed=0,this.update=e.update||1e3,this.timeup=e.timeup||"TIMEUP";if(e.hooks)for(var t=0;t<e.hooks.length;t++)this.addHook(e.hooks[t]);this.status=r.INITIALIZED},r.prototype.fire=function(e){if(!e&&!e.hook)return;var n=e.hook||e;if("function"==typeof n){var r=e.ctx||t.game;n.call(r)}else t.emit(n)},r.prototype.start=function(){this.status=r.LOADING;if(this.options.milliseconds===0){t.emit(this.timeup);return}var e=this;this.timer=setInterval(function(){e.status=r.RUNNING,t.log("interval started: "+e.timeLeft,"DEBUG","GameTimer: "),e.timePassed=e.timePassed+e.update,e.timeLeft=e.milliseconds-e.timePassed;for(var n=e.hooks.length;n>0;n--)e.fire(e.hooks[n-1]);e.timeLeft<=0&&(e.stop(),e.fire(e.timeup),t.log("time is up: "+e.timeup,"DEBUG","GameTimer: "))},this.update)},r.prototype.addHook=function(e,n){if(!e)return;var n=n||t.game;if(e.hook){n=e.ctx||n;var e=e.hook}this.hooks.push({hook:e,ctx:n})},r.prototype.pause=function(){this.status>0&&(this.status=r.PAUSED,clearInterval(this.timer))},r.prototype.resume=function(){if(this.status!==r.PAUSED)return;var e=n.extend({milliseconds:this.milliseconds-this.timePassed},this.options);this.restart(e)},r.prototype.stop=function(){if(this.status===r.UNINITIALIZED)return;if(this.status===r.INITIALIZED)return;if(this.status===r.STOPPED)return;this.status=r.STOPPED,clearInterval(this.timer),this.timePassed=0,this.timeLeft=null},r.prototype.restart=function(e){this.init(e),this.start()},r.prototype.listeners=function(){var e=this}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){this.triggers=[],this.options=e||{};var r=n.first;Object.defineProperty(this,"returnAt",{set:function(e){return!e||e!==n.first&&e!==n.last?(t.log("Invalid returnAt type: "+e),!1):(r=e,e)},get:function(){return r},configurable:!0,enumerable:!0}),Object.defineProperty(this,"length",{set:function(){},get:function(){return this.triggers.length},configurable:!0}),this.init()}e.TriggerManager=n,n.first="first",n.last="last",n.prototype.init=function(e){this.options=e||this.options;if(this.options.returnAt===n.first||this.options.returnAt===n.last)this.returnAt=this.options.returnAt;this.resetTriggers()},n.prototype.initTriggers=function(e){if(!e)return;e instanceof Array||(e=[e]);for(var t=0;t<e.length;t++)this.triggers.push(e[t])},n.prototype.resetTriggers=function(){this.triggers=[],this.initTriggers(this.options.triggers)},n.prototype.clear=function(e){return e?(this.triggers=[],e):(t.log("Do you really want to clear the current TriggerManager obj? Please use clear(true)","WARN"),!1)},n.prototype.addTrigger=function(e,t){return e?"function"!=typeof e?!1:(t?this.triggers.splice(t,0,e):this.triggers.push(e),!0):!1},n.prototype.removeTrigger=function(e){if(!e)return!1;for(var t=0;t<this.triggers.length;t++)if(this.triggers[t]==e)return this.triggers.splice(t,1);return!1},n.prototype.pullTriggers=function(e){if("undefined"==typeof e)return;if(!this.length)return e;for(var t=this.triggers.length;t>0;t--){var r=this.triggers[t-1].call(this,e);if("undefined"!=typeof r&&this.returnAt===n.first)return r}return"undefined"!=typeof r?r:e},n.prototype.size=function(){return this.triggers.length}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function a(){var n=this;if("undefined"==typeof e)throw new Error("nodeWindow: no DOM found. Are we in a browser? Aborting.");"undefined"==typeof t&&t.log("nodeWindow: nodeGame not found","ERR"),t.log("nodeWindow: loading..."),this.frame=null,this.mainframe="mainframe",this.root=null,this.conf={},this.state=t.is.LOADED,this.areLoading=0,this.cache={},this.currentURIs={},this.globalLibs=[],this.frameLibs={},this.init()}function f(e){var t=e.contentDocument?e.contentDocument:e.contentWindow.document,n,r,i;n=t.getElementsByClassName("injectedlib");for(r=0;r<n.length;++r)i=n[r],i.parentNode.removeChild(i)}function l(e){var t=e.contentDocument?e.contentDocument:e.contentWindow.document,n=t.getElementsByTagName("head")[0],r,i,s,o,u,a;i=t.getElementsByTagName("script");for(s=0;s<i.length;++s){r=i[s],r.parentNode.removeChild(r),o=document.createElement("script"),r.innerHTML&&(o.innerHTML=r.innerHTML);for(u=0;u<r.attributes.length;++u)a=r.attributes[u],o.setAttribute(a.name,a.value);n.appendChild(o)}}function c(e,t){var n=e.contentDocument?e.contentDocument:e.contentWindow.document,r=n.getElementsByTagName("head")[0],i,s,o;for(s=0;s<t.length;++s)o=t[s],i=document.createElement("script"),i.className="injectedlib",i.src=o,r.appendChild(i)}function h(e,t,n,r){var i=document.getElementById(t),s=(i.contentDocument?i.contentDocument:i.contentWindow.document).documentElement;n&&(s.innerHTML=this.cache[e].contents),f(i),n&&l(i),c(i,this.globalLibs.concat(e in this.frameLibs?this.frameLibs[e]:[])),r&&(this.cache[e].contents=s.innerHTML)}var n=t.JSUS,r=t.Player,i=t.PlayerList,s=t.GameMsg,o=t.GameMsgGenerator,u=n.get("DOM");if(!u)throw new Error("DOM object not found. Aborting");a.prototype=u,a.prototype.constructor=a,a.defaults={},a.defaults.promptOnleave=!0,a.defaults.noEscape=!0,a.defaults.cacheDefaults={loadCache:!0,storeCacheNow:!1,storeCacheLater:!1},a.prototype.init=function(e){e=e||{},this.conf=n.merge(a.defaults,e),this.conf.promptOnleave?this.promptOnleave():this.conf.promptOnleave===!1&&this.restoreOnleave(),this.conf.noEscape?this.noEscape():this.conf.noEscape===!1&&this.restoreEscape()},a.prototype.getElementById=function(e){var t=null;return this.frame&&this.frame.getElementById&&(t=this.frame.getElementById(e)),t||(t=document.getElementById(e)),t},a.prototype.getElementsByTagName=function(e){return this.frame?this.frame.getElementsByTagName(e):document.getElementsByTagName(e)},a.prototype.setup=function(n){this.root||(this.root=document.body);switch(n){case"MONITOR":t.widgets.append("NextPreviousState"),t.widgets.append("GameSummary"),t.widgets.append("StateDisplay"),t.widgets.append("StateBar"),t.widgets.append("DataBar"),t.widgets.append("MsgBar"),t.widgets.append("GameBoard"),t.widgets.append("ServerInfoDisplay"),t.widgets.append("Wall"),t.conf.host&&this.addCSS(document.body,t.conf.host+"/stylesheets/monitor.css");break;case"PLAYER":this.header=this.generateHeader();var r=this.addIFrame(this.root,"mainframe");t.game.vs=t.widgets.append("VisualState",this.header),t.game.timer=t.widgets.append("VisualTimer",this.header),t.game.sd=t.widgets.append("StateDisplay",this.header),t.widgets.append("WaitScreen"),t.conf.host&&this.addCSS(document.body,t.conf.host+"/stylesheets/player.css"),this.frame=e.frames[this.mainframe];var i=this.getBlankPage();this.conf.noEscape,e.frames[this.mainframe].src=i}},a.prototype.initLibs=function(e,t){this.globalLibs=e||[],this.frameLibs=t||{}},a.prototype.preCache=function(t,n){if(!t||!t.length){n&&n();return}var r=this,i=0;for(var s=0;s<t.length;++s){var o=t[s],u=document.createElement("iframe");u.style.visibility="hidden";var a="tmp_iframe_"+s;u.id=a,u.name=a,document.body.appendChild(u),u.onload=function(e,s){return function(){var o=(s.contentDocument?s.contentDocument:s.contentWindow.document).documentElement;r.cache[e]={contents:o.innerHTML,cacheOnClose:!1},document.body.removeChild(s),++i,i>=t.length&&n&&n()}}(o,u),e.frames[a].location=o}},a.prototype.load=a.prototype.loadFrame=function(n,r,i){if(!n)return;var s=this.mainframe,o=a.defaults.cacheDefaults.loadCache,u=a.defaults.cacheDefaults.storeCacheNow,f=a.defaults.cacheDefaults.storeCacheLater;i&&(i.frame&&(s=i.frame),i.cache&&(i.cache.loadMode==="reload"?o=!1:i.cache.loadMode==="cache"&&(o=!0),i.cache.storeMode==="off"?(u=!1,f=!1):i.cache.storeMode==="onLoad"?(u=!0,f=!1):i.cache.storeMode==="onClose"&&(u=!1,f=!0)));var l=document.getElementById(s),c,p,d=l.contentWindow.document.readyState;d=d==="interactive"||d==="complete";var v=this.currentURIs[s];v in this.cache&&this.cache[v].cacheOnClose&&(c=document.getElementById(s),p=(c.contentDocument?c.contentDocument:c.contentWindow.document).documentElement,this.cache[v].contents=p.innerHTML),n in this.cache||(this.cache[n]={contents:null,cacheOnClose:!1}),this.cache[n].cacheOnClose=f,this.cache[n].contents===null&&(o=!1),this.currentURIs[s]=n,this.state=t.is.LOADING,this.areLoading++;var m=this;l.onload=function(){m.conf.noEscape,h.call(m,n,s,o,u),m.updateStatus(r,s)},o?d&&(h.call(this,n,s,o,u),this.updateStatus(r,s)):e.frames[s].location=n,e.frames[s].window.node=t},a.prototype.updateStatus=function(n,r){this.frame=e.frames[r].document,n&&n.call(t.game),this.areLoading--,this.areLoading===0?(this.state=t.is.LOADED,t.emit("WINDOW_LOADED")):t.log("Attempt to update state, before the window object was loaded","DEBUG")},a.prototype.generateHeader=function(){return this.header&&(this.header.innerHTML="",this.header=null),this.addElement("div",this.root,"gn_header")},a.prototype._write=u.write,a.prototype._writeln=u.writeln,a.prototype.write=function(e,n){return n=n||this.getScreen(),n?this._write(n,e):(t.log("Could not determine where writing","ERR"),!1)},a.prototype.writeln=function(e,n,r){return n=n||this.getScreen(),n?this._writeln(n,e,r):(t.log("Could not determine where writing","ERR"),!1)},a.prototype.toggleInputs=function(e,t){var n;"undefined"!=typeof e&&(n=this.getElementById(e)),"undefined"==typeof n&&(n=this.frame.body);var r=["button","select","textarea","input"],i=0;for(;i<r.length;i++){var s=n.getElementsByTagName(r[i]),o=0,u=s.length;for(;o<u;o++)state="undefined"!=typeof t?t:s[o].disabled?!1:!0,state?s[o].disabled=state:s[o].removeAttribute("disabled")}},a.prototype._generateRoot=function(e,t){return e=e||document.body||document.lastElementChild,e||(this.addElement("body",document),e=document.body),this.root=this.addElement("div",e,t),this.root},a.prototype.generateNodeGameRoot=function(e){return this._generateRoot(e,"nodegame")},a.prototype.generateRandomRoot=function(e,t){return this._generateRoot(e,this.generateUniqueId())},a.prototype.getEventButton=function(e,n,r,i){if(!e)return;var s=this.getButton(r,n,i);return s.onclick=function(){t.emit(e)},s},a.prototype.addEventButton=function(e,t,n,r,i){if(!e)return;n||(n=this.getScreen());var s=this.getEventButton(e,t,r,i);return n.appendChild(s)},a.prototype.getRecipientSelector=function(e){var t=document.createElement("select");return"undefined"!=typeof e&&(t.id=e),this.addStandardRecipients(t),t},a.prototype.addRecipientSelector=function(e,t){if(!e)return!1;var n=this.getRecipientSelector(t);return e.appendChild(n)},a.prototype.addStandardRecipients=function(e){var t=document.createElement("option");t.value="ALL",t.appendChild(document.createTextNode("ALL")),e.appendChild(t),t=document.createElement("option"),t.value="SERVER",t.appendChild(document.createTextNode("SERVER")),e.appendChild(t)},a.prototype.populateRecipientSelector=function(e,t){if("object"!=typeof t||"object"!=typeof e)return;this.removeChildrenFromNode(e),this.addStandardRecipients(e);var r,i;r=t.db||t,n.each(r,function(t){i=document.createElement("option"),i.value=t.id,i.appendChild(document.createTextNode(t.name||t.id)),e.appendChild(i)})},a.prototype.getActionSelector=function(e){var n=document.createElement("select");return"undefined"!=typeof e&&(n.id=e),this.populateSelect(n,t.actions),n},a.prototype.addActionSelector=function(e,t){if(!e)return;var n=this.getActionSelector(t);return e.appendChild(n)},a.prototype.getTargetSelector=function(e){var n=document.createElement("select");return"undefined"!=typeof e&&(n.id=e),this.populateSelect(n,t.targets),n},a.prototype.addTargetSelector=function(e,t){if(!e)return;var n=this.getTargetSelector(t);return e.appendChild(n)},a.prototype.getStateSelector=function(e){var t=this.getTextInput(e);return t},a.prototype.addStateSelector=function(e,t){if(!e)return;var n=this.getStateSelector(t);return e.appendChild(n)},a.prototype.generateUniqueId=function(e){var t=""+(e||n.randomInt(0,1e3)),r=this.getElementById(t);while(r)t=""+e+"_"+n.randomInt(0,1e3),r=this.getElementById(t);return t},a.prototype.noEscape=function(t){t=t||e,t.document.onkeydown=function(t){var n=e.event?event.keyCode:t.keyCode;if(n===27)return!1}},a.prototype.restoreEscape=function(t){t=t||e,t.document.onkeydown=null},a.prototype.promptOnleave=function(t,n){t=t||e,n="undefined"==typeof n?this.conf.textOnleave:n,t.onbeforeunload=function(t){return t=t||e.event,t&&(t.returnValue=n),n}},a.prototype.restoreOnleave=function(t){t=t||e,t.onbeforeunload=null},a.prototype.getScreen=function(){var e=this.frame;return e?e=this.frame.body||e:e=document.body||document.lastElementChild,e},a.prototype.getFrame=function(){return this.frame=e.frames.mainframe.document},t.window=new a,"undefined"!=typeof e&&(e.W=t.window)}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e,t){e.on("NODEGAME_GAME_CREATED",function(){t.init(e.conf.window)}),e.on("HIDE",function(n){var r=t.getElementById(n);if(!r){e.log("Cannot hide element "+n);return}r.style.visibility="hidden"}),e.on("SHOW",function(n){var r=t.getElementById(n);if(!r){e.log("Cannot show element "+n);return}r.style.visibility="visible"}),e.on("TOGGLE",function(n){var r=t.getElementById(n);if(!r){e.log("Cannot toggle element "+n);return}r.style.visibility==="visible"?r.style.visibility="hidden":r.style.visibility="visible"}),e.on("INPUT_DISABLE",function(e){t.toggleInputs(e,!0)}),e.on("INPUT_ENABLE",function(e){t.toggleInputs(e,!1)}),e.on("INPUT_TOGGLE",function(e){t.toggleInputs(e)}),e.log("node-window: listeners added")}("undefined"!=typeof node?node:undefined,"undefined"!=typeof node.window?node.window:undefined),function(e){function t(e){this.canvas=e,this.ctx=e.getContext("2d"),this.centerX=e.width/2,this.centerY=e.height/2,this.width=e.width,this.height=e.height}e.Canvas=t,t.prototype={constructor:t,drawOval:function(e){var t=e.x/e.scale_x,n=e.y/e.scale_y,r=e.radius||100;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.scale(e.scale_x,e.scale_y),this.ctx.beginPath(),this.ctx.arc(t,n,r,0,Math.PI*2,!1),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},drawLine:function(e){var t=e.x,n=e.y,r=e.length,i=e.angle,s=-Math.cos(i)*r+e.x,o=Math.sin(i)*r+e.y;this.ctx.lineWidth=e.lineWidth||1,this.ctx.strokeStyle=e.color||"#000000",this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(t,n),this.ctx.lineTo(s,o),this.ctx.stroke(),this.ctx.closePath(),this.ctx.restore()},scale:function(e,t){this.ctx.scale(e,t),this.centerX=this.canvas.width/2/e,this.centerY=this.canvas.height/2/t},clear:function(){this.ctx.clearRect(0,0,this.width,this.height);var e=this.canvas.width;this.canvas.width=1,this.canvas.width=e}}}(node.window),function(e,t,n){function o(e){this.options=e||{},this.tm=new s,this.init(this.options)}function u(e){e=e||{},this.content="undefined"!=typeof e.content?e.content:"",this.className="undefined"!=typeof e.style?e.style:null}var r=t.document,i=n.JSUS,s=n.TriggerManager;e.HTMLRenderer=o,e.HTMLRenderer.Entity=u,o.prototype.init=function(e){e=e||this.options,this.options=e,this.reset(),e.returnAt&&(this.tm.returnAt=e.returnAt),e.pipeline&&this.tm.initTriggers(e.pipeline)},o.prototype.reset=function(){this.clear(!0),this.addDefaultPipeline()},o.prototype.addDefaultPipeline=function(){this.tm.addTrigger(function(e){return r.createTextNode(e.content)}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&"object"==typeof e.content){var t=r.createElement("div");for(var n in e.content)if(e.content.hasOwnProperty(n)){var i=n+":	"+e.content[n];t.appendChild(r.createTextNode(i)),t.appendChild(r.createElement("br"))}return t}}),this.tm.addTrigger(function(e){if(!e)return;if(e.content&&e.content.parse&&"function"==typeof e.content.parse){var t=e.content.parse();if(i.isElement(t)||i.isNode(t))return t}}),this.tm.addTrigger(function(e){if(!e)return;if(i.isElement(e.content)||i.isNode(e.content))return e.content})},o.prototype.clear=function(e){return this.tm.clear(e)},o.prototype.addRenderer=function(e,t){return this.tm.addTrigger(e,t)},o.prototype.removeRenderer=function(e){return this.tm.removeTrigger(e)},o.prototype.render=function(e){return this.tm.pullTriggers(e)},o.prototype.size=function(){return this.tm.triggers.length}}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(e,t){function o(e,t){e=e||{},this.options=e,r.call(this,e,t),this.id=e.id||"list_"+Math.round(Math.random()*1e3),this.DL=null,this.auto_update=this.options.auto_update||!1,this.htmlRenderer=null,this.lifo=!1,this.init(this.options)}function u(e){s.call(this,e),this.dt="undefined"!=typeof e.dt?e.dt:null,"undefined"!=typeof e.dd&&(this.dd=e.dd)}var n=t.JSUS,r=t.NDDB,i=t.window.HTMLRenderer,s=t.window.HTMLRenderer.Entity;e.List=o,o.prototype=new r,o.prototype.constructor=o,o.prototype.init=function(e){e=e||this.options,this.FIRST_LEVEL=e.first_level||"dl",this.SECOND_LEVEL=e.second_level||"dt",this.THIRD_LEVEL=e.third_level||"dd",this.last_dt=0,this.last_dd=0,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:this.auto_update;var t=this.lifo="undefined"!=typeof e.lifo?e.lifo:this.lifo;this.globalCompare=function(e,n){if(!e&&!n)return 0;if(!n)return 1;if(!e)return-1;if(!t){if(e.dt<n.dt)return-1;if(e.dt>n.dt)return 1}else{if(e.dt<n.dt)return 1;if(e.dt>n.dt)return-1}if(e.dt===n.dt){if("undefined"==typeof e.dd)return-1;if("undefined"==typeof n.dd)return 1;if(e.dd<n.dd)return-1;if(e.dd>n.dd)return 1;if(e.nddbid<n.nddbid)return 1;if(e.nddbid>n.nddbid)return-1}return 0},this.DL=e.list||document.createElement(this.FIRST_LEVEL),this.DL.id=e.id||this.id,e.className&&(this.DL.className=e.className),this.options.title&&this.DL.appendChild(document.createTextNode(e.title)),this.htmlRenderer=new i({render:e.render})},o.prototype._add=function(e){if(!e)return;this.insert(e),this.auto_update&&this.parse()},o.prototype.addDT=function(e,t){if("undefined"==typeof e)return;this.last_dt++,t="undefined"!=typeof t?t:this.last_dt,this.last_dd=0;var n=new u({dt:t,content:e});return this._add(n)},o.prototype.addDD=function(e,t,n){if("undefined"==typeof e)return;t="undefined"!=typeof t?t:this.last_dt,n="undefined"!=typeof n?n:this.last_dd++;var r=new u({dt:t,dd:n,content:e});return this._add(r)},o.prototype.parse=function(){this.sort();var e=null,t=null,n=function(){var n=document.createElement(this.SECOND_LEVEL);return this.DL.appendChild(n),t=null,e=n,n},r=function(){var e=document.createElement(this.THIRD_LEVEL);return this.DL.appendChild(e),e};if(this.DL){while(this.DL.hasChildNodes())this.DL.removeChild(this.DL.firstChild);this.options.title&&this.DL.appendChild(document.createTextNode(this.options.title))}for(var i=0;i<this.db.length;i++){var s=this.db[i],o;"undefined"==typeof s.dd?o=n.call(this):o=r.call(this);var u=this.htmlRenderer.render(s);o.appendChild(u)}return this.DL},o.prototype.getRoot=function(){return this.DL},u.prototype=new s,u.prototype.constructor=u}("undefined"!=typeof node?"undefined"!=typeof node.window?node.window:node:module.parent.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){function a(e,t,n){e=e||{},a.log=e.log||a.log,this.defaultDim1=e.defaultDim1||"x",this.defaultDim2=e.defaultDim2||"y",this.defaultDim3=e.defaultDim3||"z",this.table=e.table||r.createElement("table"),this.id=e.id||"table_"+Math.round(Math.random()*1e3),this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:!1,this.missing=e.missing||"missing",this.pointers={x:e.pointerX||0,y:e.pointerY||0,z:e.pointerZ||0},this.header=[],this.footer=[],this.left=[],this.right=[],s.call(this,e,t,n),this.options=this.__options}function f(e){u.call(this,e),this.x="undefined"!=typeof e.x?e.x:null,this.y="undefined"!=typeof e.y?e.y:null,this.z="undefined"!=typeof e.z?e.z:null}var r=t.document;e.Table=a,e.Table.Cell=f;var i=n.JSUS,s=n.NDDB,o=n.window.HTMLRenderer,u=n.window.HTMLRenderer.Entity;a.prototype=i.clone(s.prototype),a.prototype.constructor=a,a.H=["x","y","z"],a.V=["y","x","z"],a.log=n.log,a.prototype.init=function(e){s.prototype.init.call(this,e),e=e||this.options,"undefined"!=typeof e.id&&(this.table.id=e.id,this.id=e.id),e.className&&(this.table.className=e.className),this.initRenderer(e.render)},a.prototype.initRenderer=function(e){e=e||{},this.htmlRenderer=new o(e),this.htmlRenderer.addRenderer(function(e){if("object"==typeof e.content){var t=new a;for(var n in e.content)e.content.hasOwnProperty(n)&&t.addRow([n,e.content[n]]);return t.parse()}},2)},a.prototype.get=function(e,t){var n=this;return"undefined"!=typeof e&&(n=this.select("x","=",e)),"undefined"!=typeof t&&(n=n.select("y","=",t)),n.fetch()},a.prototype.addClass=function(e){if(!e)return;return e instanceof Array&&(e=e.join(" ")),this.forEach(function(t){n.window.addClass(t,e)}),this.auto_update&&this.parse(),this},a.prototype.removeClass=function(e){if(!e)return;var t;return e instanceof Array?t=function(e,t){for(var r=0;r<t.length;r++)n.window.removeClass(e,t[r])}:t=n.window.removeClass,this.forEach(function(n){t.call(this,n,e)}),this.auto_update&&this.parse(),this},a.prototype._addSpecial=function(e,t){if(!e)return;t=t||"header";if("object"!=typeof e)return{content:e,type:t};var n=[];for(var r=0;r<e.length;r++)n.push({content:e[r],type:t});return n},a.prototype.setHeader=function(e){this.header=this._addSpecial(e)},a.prototype.add2Header=function(e){this.header=this.header.concat(this._addSpecial(e))},a.prototype.setLeft=function(e){this.left=this._addSpecial(e,"left")},a.prototype.add2Left=function(e){this.left=this.left.concat(this._addSpecial(e,"left"))},a.prototype.setFooter=function(e){this.footer=this._addSpecial(e,"footer")},a._checkDim123=function(e){var t=a.H.slice(0);for(var n=0;n<e.length;n++)if(!i.removeElement(e[n],t))return!1;return!0},a.prototype.updatePointer=function(e,t){if(!e)return!1;if(!i.in_array(e,a.H))return a.log("Cannot update invalid pointer: "+e,"ERR"),!1;if(t>this.pointers[e])return this.pointers[e]=t,!0},a.prototype._add=function(e,t,n,r,i){if(!e)return!1;if(t){if(!a._checkDim123(t))return a.log("Invalid value for dimensions. Accepted only: x,y,z."),!1}else t=a.H;var s=function(e){var n={};n[t[0]]=u,n[t[1]]=l?r+l:r,n[t[2]]=c?i+c:i,n.content=e,this.insert(new f(n)),this.updatePointer(t[0],n[t[0]]),this.updatePointer(t[1],n[t[1]]),this.updatePointer(t[2],n[t[2]])};n=n||this.pointers[t[0]],r=r||this.pointers[t[1]]+1,i=i||this.pointers[t[2]],"object"!=typeof e&&(e=[e]);var o=null;for(var u=0;u<e.length;u++)if(e[u]instanceof Array){for(var l=0;l<e[u].length;l++)if(e[u][l]instanceof Array){for(var c=0;c<e[u][l].length;c++)s.call(this,e[u][l][c]);c=0}else s.call(this,e[u][l]);l=0}else s.call(this,e[u]);this.auto_update&&this.parse(!0)},a.prototype.add=function(e,t,n){if(!e)return;var r=e instanceof f?e:new f({x:t,y:n,content:e}),i=this.insert(r);return i&&(this.updatePointer("x",t),this.updatePointer("y",n)),i},a.prototype.addColumn=function(e,t,n){return e?this._add(e,a.V,t,n):!1},a.prototype.addRow=function(e,t,n){return e?this._add(e,a.H,t,n):!1},a.prototype.parse=function(){var e=function(e,t){if(!e)return;t=t||"td";var n=r.createElement(t),i=this.htmlRenderer.render(e);return n.appendChild(i),e.className&&(n.className=e.className),n};if(this.table)while(this.table.hasChildNodes())this.table.removeChild(this.table.firstChild);var t=this.table,n,i,s;if(this.header&&this.header.length>0){var o=r.createElement("thead");n=r.createElement("tr"),this.left&&this.left.length>0&&n.appendChild(r.createElement("th"));for(s=0;s<this.header.length;s++)n.appendChild(e.call(this,this.header[s],"th"));o.appendChild(n),s=0,t.appendChild(o)}if(this.length){var u=r.createElement("tbody");this.sort(["y","x"]);var a=-1,f=this.first(),l=f.x,c=0;for(s=0;s<this.db.length;s++){a!==this.db[s].y&&(n=r.createElement("tr"),u.appendChild(n),a=this.db[s].y,l=f.x-1,this.left&&this.left.length&&(i=r.createElement("td"),n.appendChild(e.call(this,this.left[c])),c++));if(this.db[s].x>l+1){var h=this.db[s].x-(l+1);for(var p=0;p<h;p++)i=r.createElement("td"),i.className=this.missing,n.appendChild(i)}n.appendChild(e.call(this,this.db[s])),l=this.db[s].x}t.appendChild(u)}if(this.footer&&this.footer.length>0){var d=r.createElement("tfoot");n=r.createElement("tr");for(s=0;s<this.header.length;s++)n.appendChild(e.call(this,this.footer[s]));d.appendChild(n),t.appendChild(d)}return t},a.prototype.resetPointers=function(e){e=e||{},this.pointers={x:e.pointerX||0,y:e.pointerY||0,z:e.pointerZ||0}},a.prototype.clear=function(e){s.prototype.clear.call(this,e)&&this.resetPointers()},f.prototype=new u,f.prototype.constructor=f}("undefined"!=typeof node?node.window||node:module.exports,"undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof node?node:module.parent.exports.node),function(e){function t(){this.root=null}e.Widget=t,t.prototype.dependencies={},t.prototype.defaults={},t.prototype.defaults.fieldset={legend:"Widget"},t.prototype.listeners=function(){},t.prototype.getRoot=function(){return this.root},t.prototype.getValues=function(){},t.prototype.append=function(){},t.prototype.init=function(){},t.prototype.getRoot=function(){},t.prototype.listeners=function(){},t.prototype.getAllValues=function(){},t.prototype.highlight=function(){}}("undefined"!=typeof node?node:module.parent.exports.node),function(e,t){function r(){this.widgets={},this.root=t.window.root||document.body}var n=t.JSUS;r.prototype.register=function(e,r){if(!e||!r)return t.err("Could not register widget: "+e,"nodegame-widgets: "),!1;for(var i in t.Widget.prototype)!r[i]&&!r.prototype[i]&&(!r.prototype.__proto__||!r.prototype.__proto__[i])&&(r.prototype[i]=n.clone(t.Widget.prototype[i]));return this.widgets[e]=r,this.widgets[e]},r.prototype.get=function(e,r){function s(e,t,n){if(!e||!t||!n)return;e.getRoot()[t]=function(){n.call(e)}}function o(e,t){if(!e||!t)return;var r=!1;for(var i in e)e.hasOwnProperty(i)&&(r=n.in_array(i,["onclick","onfocus","onblur","onchange","onsubmit","onload","onunload","onmouseover"]),r&&"function"==typeof e[i]&&s(t,i,e[i]))}if(!e)return;var i=this;r=r||{};var u=n.getNestedValue(e,this.widgets),a;if(!u){t.err("widget "+e+" not found.","node-widgets: ");return}t.info("registering "+u.name+" v."+u.version,"node-widgets: ");if(!this.checkDependencies(u))return!1;n.mixout(r,n.clone(u.defaults));try{a=new u(r),a.defaults=r,a.listeners.call(a),o(r,a)}catch(f){throw new Error("Error while loading widget "+u.name+": "+f)}return a},r.prototype.append=r.prototype.add=function(e,t,n){function i(e,t,n){if(!t)return e;var r=t.id||n.id+"_fieldset",i=t.legend||n.legend;return W.addFieldset(e,r,i,t.attributes)}if(!e)return;var r=this;return t=t||this.root,n=n||{},"object"!=typeof e&&(e=this.get(e,n)),e?(t=i(t,n.fieldset||e.defaults.fieldset,e),e.append(t),e):!1},r.prototype.checkDependencies=function(r,i){if(!r.dependencies)return!0;var s=function(e,n){var r=e.name||e.id;t.log(n+" not found. "+r+" cannot be loaded.","ERR")},o=[e,t,this.widgets,t.window],u=r.dependencies;for(var a in u)if(u.hasOwnProperty(a)){var f=!1;for(var l=0;l<o.length;l++)if(n.getNestedValue(a,o[l])){var f=!0;break}if(!f)return i||s(r,a),!1}return!0},t.widgets=new r}("undefined"!=typeof window?window:module.parent.exports.window,"undefined"!=typeof window?window.node:module.parent.exports.node),function(e){function t(e){this.id=e.id,this.text="Waiting for other players to be done...",this.waitingDiv=null}e.widgets.register("WaitScreen",t),t.defaults={},t.defaults.id="waiting",t.defaults.fieldset=!1,t.name="WaitingScreen",t.version="0.3.2",t.description="Show a standard waiting screen",t.prototype.append=function(e){return e},t.prototype.getRoot=function(){return this.waitingDiv},t.prototype.listeners=function(){var t=this;e.on("WAITING...",function(n){t.waitingDiv||(t.waitingDiv=e.window.addDiv(document.body,t.id)),t.waitingDiv.style.display==="none"&&(t.waitingDiv.style.display=""),t.waitingDiv.innerHTML=n||t.text,e.game.pause()}),e.on("LOADED",function(e){t.waitingDiv&&t.waitingDiv.style.display===""&&(t.waitingDiv.style.display="none")})}}(node),function(e){function r(e){this.id=e.id,this.root=null,this.table=new n}e.widgets.register("VisualState",r);var t=e.JSUS,n=e.window.Table;r.defaults={},r.defaults.id="visualstate",r.defaults.fieldset={legend:"State",id:"visualstate_fieldset"},r.name="Visual State",r.version="0.2.1",r.description="Visually display current, previous and next state of the game.",r.dependencies={JSUS:{},Table:{}},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(e,t){var n=this,r=this.id+"_";return e.appendChild(this.table.table),this.writeState(),e},r.prototype.listeners=function(){var t=this;e.on("STATECHANGE",function(){t.writeState()})},r.prototype.writeState=function(){var t,n,r,i,s="-";e.game&&e.game.state?(i=e.game.plot.getStep(e.game.state),t=i?i.name:s,i=e.game.plot.getStep(e.game.previous()),n=i?i.name:s,i=e.game.plot.getStep(e.game.next()),r=i?i.name:s):(t="Uninitialized",n=s,r=s),this.table.clear(!0),this.table.addRow(["Previous: ",n]),this.table.addRow(["Current: ",t]),this.table.addRow(["Next: ",r]);var o=this.table.select("y","=",2);o.addClass("strong"),o.select("x","=",0).addClass("underline"),this.table.parse()}}(node),function(e){function r(e){this.id=e.id||r.id,this.mode=e.mode||r.defaults.mode,this.root=null,this.textarea_id=e.textarea_id||r.defaults.textarea_id,this.chat_id=e.chat_id||r.defaults.chat_id,this.submit_id=e.submit_id||r.defaults.submit_id,this.chat_event=e.chat_event||r.defaults.chat_event,this.submit_text=e.submit_text||r.defaults.submit_text,this.submit=n.getEventButton(this.chat_event,this.submit_text,this.submit_id),this.textarea=n.getElement("textarea",this.textarea_id),this.chat=n.getElement("div",this.chat_id),"undefined"!=typeof e.displayName&&(this.displayName=e.displayName);switch(this.mode){case r.modes.RECEIVER_ONLY:this.recipient={value:"SERVER"};break;case r.modes.MANY_TO_ONE:this.recipient={value:"ALL"};break;case r.modes.ONE_TO_ONE:this.recipient={value:"SERVER"};break;default:this.recipient=n.getRecipientSelector()}}e.widgets.register("Chat",r);var t=e.JSUS,n=e.window;r.defaults={},r.defaults.id="chat",r.defaults.fieldset={legend:"Chat"},r.defaults.mode="MANY_TO_MANY",r.defaults.textarea_id="chat_textarea",r.defaults.chat_id="chat_chat",r.defaults.chat_event="CHAT",r.defaults.submit_id="chat_submit",r.defaults.submit_text="chat",r.modes={MANY_TO_MANY:"MANY_TO_MANY",MANY_TO_ONE:"MANY_TO_ONE",ONE_TO_ONE:"ONE_TO_ONE",RECEIVER_ONLY:"RECEIVER_ONLY"},r.name="Chat",r.version="0.4",r.description="Offers a uni / bi-directional communication interface between players, or between players and the experimenter.",r.dependencies={JSUS:{}},r.prototype.append=function(e){return this.root=e,e.appendChild(this.chat),this.mode!==r.modes.RECEIVER_ONLY&&(n.writeln("",e),e.appendChild(this.textarea),n.writeln("",e),e.appendChild(this.submit),this.mode===r.modes.MANY_TO_MANY&&e.appendChild(this.recipient)),e},r.prototype.getRoot=function(){return this.root},r.prototype.displayName=function(e){return e},r.prototype.readTA=function(){var e=this.textarea.value;return this.textarea.value="",e},r.prototype.writeTA=function(e,r){t.sprintf(e,r,this.chat),n.writeln("",this.chat),this.chat.scrollTop=this.chat.scrollHeight},r.prototype.listeners=function(){var t=this;e.on(this.chat_event,function(){var n=t.readTA();if(!n)return;var r=t.recipient.value,i={"%s":{"class":"chat_me"},"%msg":{"class":"chat_msg"},"!txt":n};t.writeTA("%sMe%s: %msg!txt%msg",i),e.say(n.trim(),t.chat_event,r)}),this.mode===r.modes.MANY_TO_MANY&&e.on("UPDATED_PLIST",function(){n.populateRecipientSelector(t.recipient,e.game.pl.fetch())}),e.onDATA(this.chat_event,function(n){if(n.from===e.player.id||n.from===e.player.sid)return;if(this.mode===r.modes.ONE_TO_ONE&&n.from===this.recipient.value)return;var i=t.displayName(n.from),s={"%s":{"class":"chat_others"},"%msg":{"class":"chat_msg"},"!txt":n.data,"!from":i};t.writeTA("%s!from%s: %msg!txt%msg",s)})}}(node),function(e){function s(e,t){r.call(this,e,t),this.options=e,this.id=e.id,this.name=e.name||"Dynamic Table",this.fieldset={legend:this.name,id:this.id+"_fieldset"},this.root=null,this.bindings={},this.init(this.options)}var t=e.GameStage,n=e.PlayerList,r=e.window.Table,i=e.window.HTMLRenderer;e.widgets.register("DynamicTable",s),s.prototype=new r,s.prototype.constructor=r,s.id="dynamictable",s.name="Dynamic Table",s.version="0.3.1",s.dependencies={Table:{},JSUS:{},HTMLRenderer:{}},s.prototype.init=function(e){this.options=e,this.name=e.name||this.name,this.auto_update="undefined"!=typeof e.auto_update?e.auto_update:!0,this.replace=e.replace||!1,this.htmlRenderer=new i({renderers:e.renderers}),this.c("state",t.compare),this.setLeft([]),this.parse(!0)},s.prototype.bind=function(t,n){if(!t||!n)return;var i=this;e.on(t,function(e){if(n.x||n.y){var t;i.replace?t=function(t,s){var o=i.get(t,s);if(o.length!==0)for(var u=0;u<o.length;u++)n.cell.call(i,e,o[u]);else{var a=n.cell.call(i,e,new r.Cell({x:t,y:s}));i.add(a)}}:t=function(t,s){var o=n.cell.call(i,e,new r.Cell({x:t,y:s}));i.add(o,t,s)};var s=n.x.call(i,e),o=n.y.call(i,e);if(s&&o){s=s instanceof Array?s:[s],o=o instanceof Array?o:[o];for(var u=0;u<s.length;u++)for(var a=0;a<o.length;a++)t.call(i,s[u],o[a])}}if(n.header){var f=n.header.call(i,e);f=f instanceof Array?f:[f],i.setHeader(f)}if(n.left){var l=n.left.call(i,e);JSUS.in_array(l,i.left)||i.header.push(l)}i.auto_update&&i.parse()})},s.prototype.append=function(e){return this.root=e,e.appendChild(this.table),e},s.prototype.listeners=function(){}}(node),function(e){function r(e){this.id=e.id,this.root=null,this.table=new t}var t=e.window.Table,n=e.GameStage;e.widgets.register("StateDisplay",r),r.defaults={},r.defaults.id="statedisplay",r.defaults.fieldset={legend:"State Display"},r.name="State Display",r.version="0.4.2",r.description="Display basic information about player's status.",r.prototype.init=function(){},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(t){var n=this,r=this.id+"_",i=r+"fieldset",s=r+"player",o=r+"state",u=setInterval(function(t,r){e.player&&e.player.id&&(clearInterval(u),n.updateAll())},100);return t.appendChild(this.table.table),this.root=t,t},r.prototype.updateAll=function(){var t=e.game?new n(e.game.state):new n,r=e.player?e.player.id:"-",i=e.player&&e.player.name?e.player.name:"-";this.table.clear(!0),this.table.addRow(["Name: ",i]),this.table.addRow(["State: ",t.toString()]),this.table.addRow(["Id: ",r]),this.table.parse()},r.prototype.listeners=function(){var t=this;e.on("STATECHANGE",function(){t.updateAll()})}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.root=null,this.listRoot=null,this.fieldset=null,this.submit=null,this.changeEvent=this.id+"_change",this.init(e)}function r(e){n.call(this,e)}function i(e){n.call(this,e)}function s(t){n.call(this,t),this.groupName="undefined"!=typeof t.name?t.name:e.window.generateUniqueId()}e.widgets.register("Controls",n);var t={id:"controls"};n.defaults=t,n.Slider=r,n.jQuerySlider=i,n.Radio=s,n.name="Controls",n.version="0.2",n.description="Wraps a collection of user-inputs controls.",n.prototype.add=function(e,t,n){},n.prototype.getItem=function(e,t){},n.prototype.init=function(t){this.hasChanged=!1,"undefined"!=typeof t.change&&(t.change?this.changeEvent=t.change:this.changeEvent=!1),this.list=new e.window.List(t),this.listRoot=this.list.getRoot();if(!t.features)return;this.root||(this.root=this.listRoot),this.features=t.features,this.populate()},n.prototype.append=function(t){this.root=t;var n=this.listRoot;this.list.parse(),t.appendChild(this.listRoot);if(this.options.submit){var r="submit_"+this.id;this.options.submit.id&&(r=this.options.submit.id,delete this.options.submit.id),this.submit=e.window.addButton(t,r,this.options.submit,this.options.attributes);var i=this;this.submit.onclick=function(){i.options.change&&e.emit(i.options.change)}}return n},n.prototype.parse=function(){return this.list.parse()},n.prototype.populate=function(){var t=this;for(var n in this.features)if(this.features.hasOwnProperty(n)){var r=this.features[n],i=n;r.id&&(i=r.id,delete r.id);var s=document.createElement("div"),o=this.add(s,i,r);this.changeEvent&&(o.onchange=function(){e.emit(t.changeEvent)}),r.label&&e.window.addLabel(s,o,null,r.label),this.list.addDT(s)}},n.prototype.listeners=function(){var t=this;e.on(this.changeEvent,function(){t.hasChanged=!0})},n.prototype.refresh=function(){for(var t in this.features)if(this.features.hasOwnProperty(t)){var n=e.window.getElementById(t);n&&(n.value=this.features[t].value)}return!0},n.prototype.getAllValues=function(){var t={};for(var n in this.features)if(this.features.hasOwnProperty(n)){var r=e.window.getElementById(n);r&&(t[n]=Number(r.value))}return t},n.prototype.highlight=function(t){return e.window.highlight(this.listRoot,t)},r.prototype.__proto__=n.prototype,r.prototype.constructor=r,r.id="slidercontrols",r.name="Slider Controls",r.version="0.2",r.dependencies={Controls:{}},r.prototype.add=function(t,n,r){return e.window.addSlider(t,n,r)},r.prototype.getItem=function(t,n){return e.window.getSlider(t,n)},i.prototype.__proto__=n.prototype,i.prototype.constructor=i,i.id="jqueryslidercontrols",i.name="Experimental: jQuery Slider Controls",i.version="0.13",i.dependencies={jQuery:{},Controls:{}},i.prototype.add=function(e,t,n){var r=jQuery("<div/>",{id:t}).slider(),i=r.appendTo(e);return i[0]},i.prototype.getItem=function(e,t){var n=jQuery("<div/>",{id:e}).slider();return n},s.prototype.__proto__=n.prototype,s.prototype.constructor=s,s.id="radiocontrols",s.name="Radio Controls",s.version="0.1.1",s.dependencies={Controls:{}},s.prototype.add=function(t,n,r){return"undefined"==typeof r.name&&(r.name=this.groupName),e.window.addRadioButton(t,n,r)},s.prototype.getItem=function(t,n){return"undefined"==typeof n.name&&(n.name=this.groupName),e.window.getRadioButton(t,n)},s.prototype.getAllValues=function(){for(var t in this.features)if(this.features.hasOwnProperty(t)){var n=e.window.getElementById(t);if(n.checked)return n.value}return!1}}(node),function(e){function n(e){this.id=e.id||n.defaults.id,this.status_id=this.id+"_statusbar",this.board=null,this.status=null,this.root=null}e.widgets.register("GameBoard",n);var t=e.PlayerList;n.defaults={},n.defaults.id="gboard",n.defaults.fieldset={legend:"Game Board"},n.name="GameBoard",n.version="0.4.0",n.description="Offer a visual representation of the state of all players in the game.",n.prototype.append=function(t){return this.root=t,this.status=e.window.addDiv(t,this.status_id),this.board=e.window.addDiv(t,this.id),this.updateBoard(e.game.pl),t},n.prototype.listeners=function(){var t=this;e.on("UPDATED_PLIST",function(){t.updateBoard(e.game.pl)})},n.prototype.printLine=function(t){var n="["+(t.name||t.id)+"]> 	";n+="("+t.state.round+") "+t.state.state+"."+t.state.step,n+=" ";switch(t.state.is){case e.is.UNKNOWN:n+="(unknown)";break;case e.is.LOADING:n+="(loading)";break;case e.is.LOADED:n+="(loaded)";break;case e.is.PLAYING:n+="(playing)";break;case e.is.DONE:n+="(done)";break;default:n+="("+t.state.is+")"}return t.state.paused&&(n+=" (P)"),n},n.prototype.printSeparator=function(e){return W.getElement("hr",null,{style:"color: #CCC;"})},n.prototype.updateBoard=function(t){var n=this;this.status.innerHTML="Updating...";var r,i;t.length&&(n.board.innerHTML="",t.forEach(function(e){r=n.printLine(e),W.write(r,n.board),i=n.printSeparator(e),W.write(i,n.board)})),this.status.innerHTML="Connected players: "+e.game.pl.length}}(node),function(e){function r(e){this.options=e,this.id=e.id,this.name=e.name||r.name,this.root=null,this.gtbl=null,this.plist=null,this.init(this.options)}var t=e.GameStage,n=e.PlayerList;e.widgets.register("GameTable",r),r.defaults={},r.defaults.id="gametable",r.defaults.fieldset={legend:"Game Table",id:"gametable_fieldset"},r.name="Game Table",r.version="0.2",r.dependencies={JSUS:{}},r.prototype.init=function(r){this.plist||(this.plist=new n),this.gtbl=new e.window.Table({auto_update:!0,id:r.id||this.id,render:r.render},e.game.memory.db),this.gtbl.c("state",t.compare),this.gtbl.setLeft([]),this.gtbl.parse(!0)},r.prototype.addRenderer=function(e){return this.gtbl.addRenderer(e)},r.prototype.resetRender=function(){return this.gtbl.resetRenderer()},r.prototype.removeRenderer=function(e){return this.gtbl.removeRenderer(e)},r.prototype.append=function(e){return this.root=e,e.appendChild(this.gtbl.table),e},r.prototype.listeners=function(){var t=this;e.onPLIST(function(e){if(!e.data.length)return;var r=new n({},e.data),i=r.diff(t.plist);i&&i.forEach(function(e){t.addPlayer(e)}),t.gtbl.parse(!0)}),e.on("in.set.DATA",function(n){t.addLeft(n.state,n.from);var r=t.player2x(n.from),i=t.state2y(e.game.state,n.text);t.gtbl.add(n.data,r,i),t.gtbl.parse(!0)})},r.prototype.addPlayer=function(e){this.plist.add(e);var t=this.plist.map(function(e){return e.name});this.gtbl.setHeader(t)},r.prototype.addLeft=function(e,n){if(!e)return;e=new t(e);if(!JSUS.in_array({content:e.toString(),type:"left"},this.gtbl.left))this.gtbl.add2Left(e.toString());else{var r=this.state2y(e),i=this.player2x(n);this.gtbl.select("y","=",r).select("x","=",i).count()>1&&this.gtbl.add2Left(e.toString())}},r.prototype.player2x=function(e){return e?this.plist.select("id","=",e).first().count:!1},r.prototype.x2Player=function(e){return e?this.plist.select("count","=",e).first().count:!1},r.prototype.state2y=function(t){return t?e.game.plot.indexOf(t):!1},r.prototype.y2State=function(n){return n?e.game.plot.jumpTo(new t,n):!1}}(node),function(e){function t(n){this.id=n.id||t.id,this.event=n.event||"D3",this.svg=null;var r=this;e.on(this.event,function(e){r.tick.call(r,e)})}function n(e){t.call(this,e);var r=this.options=JSUS.merge(n.defaults,e),i=this.n=r.n;this.data=[0],this.margin=r.margin;var s=this.width=r.width-this.margin.left-this.margin.right,o=this.height=r.height-this.margin.top-this.margin.bottom,u=this.x=d3.scale.linear().domain(r.domain.x).range(r.range.x),a=this.y=d3.scale.linear().domain(r.domain.y).range(r.range.y);this.line=d3.svg.line().x(function(e,t){return u(t)}).y(function(e,t){return a(e)})}e.widgets.register("D3",t),e.widgets.register("D3ts",n),t.prototype.__proto__=e.Widget.prototype,t.prototype.constructor=t,t.defaults={},t.defaults.id="D3",t.defaults.fieldset={legend:"D3 plot"},t.name="D3",t.version="0.1",t.description="Real time plots for nodeGame with d3.js",t.dependencies={d3:{},JSUS:{}},t.prototype.append=function(e){return this.root=e,this.svg=d3.select(e).append("svg"),e},t.prototype.tick=function(){},n.id="D3ts",n.name="D3ts",n.version="0.1",n.description="Time series plot for nodeGame with d3.js",n.dependencies={D3:{},JSUS:{}},n.prototype.__proto__=t.prototype,n.prototype.constructor=n,n.defaults={},n.defaults.width=400,n.defaults.height=200,n.defaults.margin={top:10,right:10,bottom:20,left:40},n.defaults.domain={x:[0,10],y:[0,1]},n.defaults.range={x:[0,n.defaults.width],y:[n.defaults.height,0]},n.prototype.init=function(e){console.log("init!");var t=this.x,n=this.y,r=this.height,i=this.width,s=this.margin;this.svg.attr("width",i+s.left+s.right).attr("height",r+s.top+s.bottom).append("g").attr("transform","translate("+s.left+","+s.top+")"),this.svg.append("defs").append("clipPath").attr("id","clip").append("rect").attr("width",i).attr("height",r),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+r+")").call(d3.svg.axis().scale(t).orient("bottom")),this.svg.append("g").attr("class","y axis").call(d3.svg.axis().scale(n).orient("left")),this.path=this.svg.append("g").attr("clip-path","url(#clip)").append("path").data([this.data]).attr("class","line").attr("d",this.line)},n.prototype.tick=function(e){this.alreadyInit=this.alreadyInit||!1,this.alreadyInit||(this.init(),this.alreadyInit=!0);var t=this.x;console.log("tick!"),this.data.push(e),this.path.attr("d",this.line).attr("transform",null),this.data.length>this.n&&(this.path.transition().duration(500).ease("linear").attr("transform","translate("+t(-1)+")"),this.data.shift())}}(node),function(e){function n(n){this.options=n,this.id=n.id,this.table=new t({id:"cf_table"}),this.root=n.root||document.createElement("div"),this.root.id=this.id,this.sc=e.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.dims=null,this.change="CF_CHANGE";var r=this;this.changeFunc=function(){r.draw(r.sc.getAllValues())},this.features=null,this.controls=null,this.init(this.options)}function r(t,r){this.canvas=new e.window.Canvas(t),this.scaleX=t.width/n.defaults.canvas.width,this.scaleY=t.height/n.defaults.canvas.heigth}function i(e){var e=e||{};this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1;for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(e.hasOwnProperty(t)?this[t]=e[t]:this[t]=i.defaults[t].value)}var t=e.window.Table;e.widgets.register("ChernoffFacesSimple",n),n.defaults={},n.defaults.id="ChernoffFaces",n.defaults.canvas={},n.defaults.canvas.width=100,n.defaults.canvas.heigth=100,n.name="Chernoff Faces",n.version="0.3",n.description="Display parametric data in the form of a Chernoff Face.",n.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},n.FaceVector=i,n.FacePainter=r,n.prototype.init=function(t){var s=this;this.id=t.id||this.id;var o=this.id+"_";this.features=t.features||this.features||i.random(),this.controls="undefined"!=typeof t.controls?t.controls:!0;var u=t.idCanvas?t.idCanvas:o+"canvas",a=t.idButton?t.idButton:o+"button";this.dims={width:t.width?t.width:n.defaults.canvas.width,height:t.height?t.height:n.defaults.canvas.heigth},this.canvas=e.window.getCanvas(u,this.dims),this.fp=new r(this.canvas),this.fp.draw(new i(this.features));var f={id:"cf_controls",features:JSUS.mergeOnKey(i.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=e.widgets.get("Controls.Slider",f),this.controls&&this.table.add(this.sc),"undefined"==typeof t.change?e.on(this.change,this.changeFunc):(t.change?e.on(t.change,this.changeFunc):e.removeListener(this.change,this.changeFunc),this.change=t.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},n.prototype.getRoot=function(){return this.root},n.prototype.getCanvas=function(){return this.canvas},n.prototype.append=function(e){return e.appendChild(this.root),this.table.parse(),this.root},n.prototype.listeners=function(){},n.prototype.draw=function(e){if(!e)return;var t=new i(e);this.fp.redraw(t),this.sc.init({features:JSUS.mergeOnKey(i.defaults,e,"value")}),this.sc.refresh()},n.prototype.getAllValues=function(){return this.fp.face},n.prototype.randomize=function(){var e=i.random();this.fp.redraw(e);var t={features:JSUS.mergeOnKey(i.defaults,e,"value"),change:this.change};return this.sc.init(t),this.sc.refresh(),!0},r.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY);var t=t||this.canvas.centerX,n=n||this.canvas.centerY;this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},r.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},r.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},r.prototype.fit2Canvas=function(e){if(!this.canvas){console.log("No canvas found");return}if(this.canvas.width>this.canvas.height)var t=this.canvas.width/e.head_radius*e.head_scale_x;else var t=this.canvas.height/e.head_radius*e.head_scale_y;e.scaleX=t/2,e.scaleY=t/2},r.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyes=function(e,t,n){var i=r.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:i,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawPupils=function(e,t,n){var i=e.pupil_radius,s=e.eye_spacing,o=r.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:i,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawEyebrow=function(e,t,n){var i=r.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:i,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:i,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},r.prototype.drawNose=function(e,t,n){var i=r.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=i+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,i),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},r.prototype.drawMouth=function(e,t,n){var i=r.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=i-e.mouth_top_y,a=i+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,u,o,i),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,i),this.canvas.ctx.quadraticCurveTo(t,a,o,i),this.canvas.ctx.stroke()},r.computeFaceOffset=function(e,t,n){var n=n||0,r=n-e.head_radius+e.head_radius*2*t;return r},r.computeEyebrowOffset=function(e,t){var t=t||0,n=2;return r.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},i.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},i.random=function(){var e={};for(var t in i.defaults)i.defaults.hasOwnProperty(t)&&(JSUS.in_array(t,["color","lineWidth","scaleX","scaleY"])||(e[t]=i.defaults[t].min+Math.random()*i.defaults[t].max));return e.scaleX=1,e.scaleY=1,e.color="green",e.lineWidth=1,new i(e)},i.prototype.shuffle=function(){for(var e in this)this.hasOwnProperty(e)&&i.defaults.hasOwnProperty(e)&&e!=="color"&&(this[e]=i.defaults[e].min+Math.random()*i.defaults[e].max)},i.prototype.distance=function(e){return i.distance(this,e)},i.distance=function(e,t){var n=0,r;for(var i in e)e.hasOwnProperty(i)&&(r=e[i]-t[i],n+=r*r);return Math.sqrt(n)},i.prototype.toString=function(){var e="Face: ";for(var t in this)this.hasOwnProperty(t)&&(e+=t+" "+this[t]);return e}}(node),function(e){function t(e){this.id=e.id}e.widgets.register("NextPreviousState",t),t.defaults={},t.defaults.id="nextprevious",t.defaults.fieldset={legend:"Rew-Fwd"},t.name="Next,Previous State",t.version="0.3.2",t.description="Adds two buttons to push forward or rewind the state of the game by one step.",t.prototype.getRoot=function(){return this.root},t.prototype.append=function(t){var n=this.id+"_button",r=this.id+"_button",i=e.window.addButton(t,n,"<<"),s=e.window.addButton(t,r,">>"),o=this,u=function(t){if(t){var n=e.IN+e.action.SAY+".STATE",r=e.msg.createSTATE(n,t);e.emit(n,r),n=e.OUT+e.action.SAY+".STATE",e.emit(n,t,"ALL")}else e.log("No next/previous state. Not sent","ERR")};return s.onclick=function(){u(e.game.next())},i.onclick=function(){u(e.game.previous())},this.root=t,t}}(node),function(e){function t(e){this.id=e.id,this.root=null,this.div=document.createElement("div"),this.table=null,this.button=null}e.widgets.register("ServerInfoDisplay",t),t.defaults={},t.defaults.id="serverinfodisplay",t.defaults.fieldset={legend:"Server Info",id:"serverinfo_fieldset"},t.name="Server Info Display",t.version="0.3",t.prototype.init=function(t){var n=this;this.div||(this.div=document.createElement("div")),this.div.innerHTML="Waiting for the reply from Server...",this.table||(this.table=new e.window.Table(t)),this.table.clear(!0),this.button=document.createElement("button"),this.button.value="Refresh",this.button.appendChild(document.createTextNode("Refresh")),this.button.onclick=function(){n.getInfo()},this.root.appendChild(this.button),this.getInfo()},t.prototype.append=function(e){return this.root=e,e.appendChild(this.div),e},t.prototype.getInfo=function(){var t=this;e.get("INFO",function(n){e.window.removeChildrenFromNode(t.div),t.div.appendChild(t.processInfo(n))})},t.prototype.processInfo=function(e){this.table.clear(!0);for(var t in e)e.hasOwnProperty(t)&&this.table.addRow([t,e[t]]);return this.table.parse()},t.prototype.listeners=function(){var t=this;e.on("NODEGAME_READY",function(){t.init()})}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.gameTimer=null,this.timerDiv=null,this.root=null,this.init(this.options)}e.widgets.register("VisualTimer",n);var t=e.JSUS;n.defaults={},n.defaults.id="visualtimer",n.defaults.fieldset={legend:"Time left",id:"visualtimer_fieldset"},n.name="Visual Timer",n.version="0.3.3",n.description="Display a timer for the game. Timer can trigger events. Only for countdown smaller than 1h.",n.dependencies={GameTimer:{},JSUS:{}},n.prototype.init=function(t){t=t||this.options;var n=this;(function(){t.hooks?!t.hooks instanceof Array&&(t.hooks=[t.hooks]):t.hooks=[],t.hooks.push({hook:n.updateDisplay,ctx:n})})(),this.gameTimer=t.gameTimer||new e.GameTimer,this.gameTimer?this.gameTimer.init(t):e.log("GameTimer object could not be initialized. VisualTimer will not work properly.","ERR"),this.timerDiv&&(this.timerDiv.className=t.className||"")},n.prototype.getRoot=function(){return this.root},n.prototype.append=function(t){return this.root=t,this.timerDiv=e.window.addDiv(t,this.id+"_div"),this.updateDisplay(),t},n.prototype.updateDisplay=function(){if(!this.gameTimer.milliseconds||this.gameTimer.milliseconds===0){this.timerDiv.innerHTML="00:00";return}var e=this.gameTimer.milliseconds-this.gameTimer.timePassed;e=t.parseMilliseconds(e);var n=e[2]<10?"0"+e[2]:e[2],r=e[3]<10?"0"+e[3]:e[3];this.timerDiv.innerHTML=n+":"+r},n.prototype.start=function(){this.updateDisplay(),this.gameTimer.start()},n.prototype.restart=function(e){this.init(e),this.start()},n.prototype.stop=function(e){this.gameTimer.stop()},n.prototype.resume=function(e){this.gameTimer.resume()},n.prototype.listeners=function(){var n=this;e.on("LOADED",function(){var r=e.game.getCurrentStep();if(!r)return;var i=r.timer;if(i){i=t.clone(i),n.timerDiv.className="";var s={},o=typeof i;switch(o){case"number":s.milliseconds=i;break;case"object":s=i;break;case"function":s.milliseconds=i;break;case"string":s.milliseconds=Number(i)}if(!s.milliseconds)return;"function"==typeof s.milliseconds&&(s.milliseconds=s.milliseconds.call(e.game)),s.timeup||(s.timeup="DONE"),n.gameTimer.init(s),n.start()}}),e.on("DONE",function(){n.gameTimer.stop(),n.timerDiv.className="strike"})}}(node),function(e){function t(e){this.summaryDiv=null}e.widgets.register("GameSummary",t),t.defaults={},t.defaults.id="gamesummary",t.defaults.fieldset={legend:"Game Summary"},t.name="Game Summary",t.version="0.3",t.description="Show the general configuration options of the game.",t.prototype.append=function(t){return this.root=t,this.summaryDiv=e.window.addDiv(t),this.writeSummary(),t},t.prototype.writeSummary=function(t,n){var r=document.createTextNode("Name: "+e.game.metadata.name),i=document.createTextNode("Descr: "+e.game.metadata.description),s=document.createTextNode("Min Pl.: "+e.game.minPlayers),o=document.createTextNode("Max Pl.: "+e.game.maxPlayers);this.summaryDiv.appendChild(r),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(i),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(s),this.summaryDiv.appendChild(document.createElement("br")),this.summaryDiv.appendChild(o),e.window.addDiv(this.root,this.summaryDiv,n)}}(node),function(e){function r(e){this.id=e.id||r.defaults.id,this.root=null,this.spanCurrency=document.createElement("span"),this.spanMoney=document.createElement("span"),this.currency="EUR",this.money=0,this.precision=2,this.init(e)}e.widgets.register("MoneyTalks",r);var t=e.JSUS;r.defaults={},r.defaults.id="moneytalks",r.defaults.fieldset={legend:"Earnings"},r.name="Money talks",r.version="0.1.0",r.description="Display the earnings of a player.",r.dependencies={JSUS:{}},r.prototype.init=function(e){this.currency=e.currency||this.currency,this.money=e.money||this.money,this.precision=e.precision||this.precision,this.spanCurrency.id=e.idCurrency||this.spanCurrency.id||"moneytalks_currency",this.spanMoney.id=e.idMoney||this.spanMoney.id||"moneytalks_money",this.spanCurrency.innerHTML=this.currency,this.spanMoney.innerHTML=this.money},r.prototype.getRoot=function(){return this.root},r.prototype.append=function(e,t){var n=this.id+"_";return e.appendChild(this.spanMoney),e.appendChild(this.spanCurrency),e},r.prototype.listeners=function(){var t=this;e.on("MONEYTALKS",function(e){t.update(e)})},r.prototype.update=function(e){if("number"!=typeof e){e=parseInt(e);if(isNaN(n)||!isFinite(n))return}this.money+=e,this.spanMoney.innerHTML=this.money.toFixed(this.precision)}}(node),function(e){function r(t){this.options=t,this.id=t.id,this.table=new n({id:"cf_table"}),this.root=t.root||document.createElement("div"),this.root.id=this.id,this.sc=e.widgets.get("Controls.Slider"),this.fp=null,this.canvas=null,this.change="CF_CHANGE";var r=this;this.changeFunc=function(){r.draw(r.sc.getAllValues())},this.features=null,this.controls=null,this.init(this.options)}function i(t,n){this.canvas=new e.window.Canvas(t),this.scaleX=t.width/r.defaults.canvas.width,this.scaleY=t.height/r.defaults.canvas.heigth}function s(e){e=e||{},this.scaleX=e.scaleX||1,this.scaleY=e.scaleY||1,this.color=e.color||"green",this.lineWidth=e.lineWidth||1;for(var t in s.defaults)s.defaults.hasOwnProperty(t)&&(e.hasOwnProperty(t)?this[t]=e[t]:this[t]=s.defaults[t].value)}var t=e.JSUS,n=e.window.Table;e.widgets.register("ChernoffFaces",r),r.defaults={},r.defaults.id="ChernoffFaces",r.defaults.canvas={},r.defaults.canvas.width=100,r.defaults.canvas.heigth=100,r.name="Chernoff Faces",r.version="0.3",r.description="Display parametric data in the form of a Chernoff Face.",r.dependencies={JSUS:{},Table:{},Canvas:{},"Controls.Slider":{}},r.FaceVector=s,r.FacePainter=i,r.prototype.init=function(n){var r=this;this.id=n.id||this.id;var o=this.id+"_";this.features=n.features||this.features||s.random(),this.controls="undefined"!=typeof n.controls?n.controls:!0;var u=n.idCanvas?n.idCanvas:o+"canvas",a=n.idButton?n.idButton:o+"button";this.canvas=e.window.getCanvas(u,n.canvas),this.fp=new i(this.canvas),this.fp.draw(new s(this.features));var f={id:"cf_controls",features:t.mergeOnKey(s.defaults,this.features,"value"),change:this.change,fieldset:{id:this.id+"_controls_fieldest",legend:this.controls.legend||"Controls"},submit:"Send"};this.sc=e.widgets.get("Controls.Slider",f),this.controls&&this.table.add(this.sc),"undefined"==typeof n.change?e.on(this.change,this.changeFunc):(n.change?e.on(n.change,this.changeFunc):e.removeListener(this.change,this.changeFunc),this.change=n.change),this.table.add(this.canvas),this.table.parse(),this.root.appendChild(this.table.table)},r.prototype.getCanvas=function(){return this.canvas},r.prototype.append=function(e){return e.appendChild(this.root),this.table.parse(),this.root},r.prototype.draw=function(e){if(!e)return;var n=new s(e);this.fp.redraw(n),this.sc.init({features:t.mergeOnKey(s.defaults,e,"value")}),this.sc.refresh()},r.prototype.getAllValues=function(){return this.fp.face},r.prototype.randomize=function(){var e=s.random();this.fp.redraw(e);var n={features:t.mergeOnValue(s.defaults,e),change:this.change};return this.sc.init(n),this.sc.refresh(),!0},i.prototype.draw=function(e,t,n){if(!e)return;this.face=e,this.fit2Canvas(e),this.canvas.scale(e.scaleX,e.scaleY),t=t||this.canvas.centerX,n=n||this.canvas.centerY,this.drawHead(e,t,n),this.drawEyes(e,t,n),this.drawPupils(e,t,n),this.drawEyebrow(e,t,n),this.drawNose(e,t,n),this.drawMouth(e,t,n)},i.prototype.redraw=function(e,t,n){this.canvas.clear(),this.draw(e,t,n)},i.prototype.scale=function(e,t){this.canvas.scale(this.scaleX,this.scaleY)},i.prototype.fit2Canvas=function(e){if(!this.canvas){console.log("No canvas found");return}var t;this.canvas.width>this.canvas.height?ratio=this.canvas.width/e.head_radius*e.head_scale_x:ratio=this.canvas.height/e.head_radius*e.head_scale_y,e.scaleX=ratio/2,e.scaleY=ratio/2},i.prototype.drawHead=function(e,t,n){var r=e.head_radius;this.canvas.drawOval({x:t,y:n,radius:r,scale_x:e.head_scale_x,scale_y:e.head_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyes=function(e,t,n){var r=i.computeFaceOffset(e,e.eye_height,n),s=e.eye_spacing,o=e.eye_radius;this.canvas.drawOval({x:t-s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:r,radius:o,scale_x:e.eye_scale_x,scale_y:e.eye_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawPupils=function(e,t,n){var r=e.pupil_radius,s=e.eye_spacing,o=i.computeFaceOffset(e,e.eye_height,n);this.canvas.drawOval({x:t-s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawOval({x:t+s,y:o,radius:r,scale_x:e.pupil_scale_x,scale_y:e.pupil_scale_y,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawEyebrow=function(e,t,n){var r=i.computeEyebrowOffset(e,n),s=e.eyebrow_spacing,o=e.eyebrow_length,u=e.eyebrow_angle;this.canvas.drawLine({x:t-s,y:r,length:o,angle:u,color:e.color,lineWidth:e.lineWidth}),this.canvas.drawLine({x:t+s,y:r,length:0-o,angle:-u,color:e.color,lineWidth:e.lineWidth})},i.prototype.drawNose=function(e,t,n){var r=i.computeFaceOffset(e,e.nose_height,n),s=t+e.nose_width/2,o=r+e.nose_length,u=s-e.nose_width,a=o;this.canvas.ctx.lineWidth=e.lineWidth,this.canvas.ctx.strokeStyle=e.color,this.canvas.ctx.save(),this.canvas.ctx.beginPath(),this.canvas.ctx.moveTo(t,r),this.canvas.ctx.lineTo(s,o),this.canvas.ctx.lineTo(u,a),this.canvas.ctx.stroke(),this.canvas.ctx.restore()},i.prototype.drawMouth=function(e,t,n){var r=i.computeFaceOffset(e,e.mouth_height,n),s=t-e.mouth_width/2,o=t+e.mouth_width/2,u=r-e.mouth_top_y,a=r+e.mouth_bottom_y;this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,u,o,r),this.canvas.ctx.stroke(),this.canvas.ctx.moveTo(s,r),this.canvas.ctx.quadraticCurveTo(t,a,o,r),this.canvas.ctx.stroke()},i.computeFaceOffset=function(e,t,n){n=n||0;var r=n-e.head_radius+e.head_radius*2*t;return r},i.computeEyebrowOffset=function(e,t){t=t||0;var n=2;return i.computeFaceOffset(e,e.eye_height,t)-n-e.eyebrow_eyedistance},s.defaults={head_radius:{min:10,max:100,step:.01,value:30,label:"Face radius"},head_scale_x:{min:.2,max:2,step:.01,value:.5,label:"Scale head horizontally"},head_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale head vertically"},eye_height:{min:.1,max:.9,step:.01,value:.4,label:"Eye height"},eye_radius:{min:2,max:30,step:.01,value:5,label:"Eye radius"},eye_spacing:{min:0,max:50,step:.01,value:10,label:"Eye spacing"},eye_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale eyes horizontally"},eye_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale eyes vertically"},pupil_radius:{min:1,max:9,step:.01,value:1,label:"Pupil radius"},pupil_scale_x:{min:.2,max:2,step:.01,value:1,label:"Scale pupils horizontally"},pupil_scale_y:{min:.2,max:2,step:.01,value:1,label:"Scale pupils vertically"},eyebrow_length:{min:1,max:30,step:.01,value:10,label:"Eyebrow length"},eyebrow_eyedistance:{min:.3,max:10,step:.01,value:3,label:"Eyebrow from eye"},eyebrow_angle:{min:-2,max:2,step:.01,value:-0.5,label:"Eyebrow angle"},eyebrow_spacing:{min:0,max:20,step:.01,value:5,label:"Eyebrow spacing"},nose_height:{min:.4,max:1,step:.01,value:.4,label:"Nose height"},nose_length:{min:.2,max:30,step:.01,value:15,label:"Nose length"},nose_width:{min:0,max:30,step:.01,value:10,label:"Nose width"},mouth_height:{min:.2,max:2,step:.01,value:.75,label:"Mouth height"},mouth_width:{min:2,max:100,step:.01,value:20,label:"Mouth width"},mouth_top_y:{min:-10,max:30,step:.01,value:-2,label:"Upper lip"},mouth_bottom_y:{min:-10,max:30,step:.01,value:20,label:"Lower lip"}},s.random=function(){var e={};for(var n in s.defaults)s.defaults.hasOwnProperty(n)&&(t.in_array(n,["color","lineWidth","scaleX","scaleY"])||(e[n]=s.defaults[n].min+Math.random()*s.defaults[n].max));return e.scaleX=1,e.scaleY=1,e.color="green",e.lineWidth=1,new s(e)},s.prototype.shuffle=function(){for(var e in this)this.hasOwnProperty(e)&&s.defaults.hasOwnProperty(e)&&e!=="color"&&(this[e]=s.defaults[e].min+Math.random()*s.defaults[e].max)},s.prototype.distance=function(e){return s.distance(this,e)},s.distance=function(e,t){var n=0,r;for(var i in e)e.hasOwnProperty(i)&&(r=e[i]-t[i],n+=r*r);return Math.sqrt(n)},s.prototype.toString=function(){var e="Face: ";for(var t in this)this.hasOwnProperty(t)&&(e+=t+" "+this[t]);return e}}(node),function(e){function n(e){this.options=e,this.id=e.id,this.root=null,this.text="Send",this.button=document.createElement("button"),this.callback=null,this.init(this.options)}function r(e){e.event="DONE",e.text=e.text||"Done!",n.call(this,e)}var t=e.JSUS;e.widgets.register("EventButton",n),n.defaults={},n.defaults.id="eventbutton",n.defaults.fieldset=!1,n.name="Event Button",n.version="0.2",n.dependencies={JSUS:{}},n.prototype.init=function(t){t=t||this.options,this.button.id=t.id||this.id;var n=t.text||this.text;while(this.button.hasChildNodes())this.button.removeChild(this.button.firstChild);this.button.appendChild(document.createTextNode(n)),this.event=t.event||this.event,this.callback=t.callback||this.callback;var r=this;this.event&&(this.button.onclick=function(){var n=!0;this.callback&&(n=t.callback.call(e.game)),n&&e.emit(r.event)})},n.prototype.append=function(e){return this.root=e,e.appendChild(this.button),e},n.prototype.listeners=function(){},e.widgets.register("DoneButton",r),r.prototype.__proto__=n.prototype,r.prototype.constructor=r,r.id="donebutton",r.version="0.1",r.name="Done Button",r.dependencies={EventButton:{}}}(node),function(e){function n(t){this.id=t.id||n.id,this.name=t.name||this.name,this.buffer=[],this.counter=0,this.wall=e.window.getElement("pre",this.id)}e.widgets.register("Wall",n);var t=e.JSUS;n.defaults={},n.defaults.id="wall",n.defaults.fieldset={legend:"Game Log"},n.name="Wall",n.version="0.3",n.description="Intercepts all LOG events and prints them ",n.description+="into a DIV element with an ordinal number and a timestamp.",n.dependencies={JSUS:{}},n.prototype.init=function(e){e=e||{},this.counter=e.counter||this.counter},n.prototype.append=function(e){return e.appendChild(this.wall)},n.prototype.getRoot=function(){return this.wall},n.prototype.listeners=function(){var t=this;e.on("LOG",function(e){t.debuffer(),t.write(e)})},n.prototype.write=function(e){if(document.readyState!=="complete")this.buffer.push(s);else{var n=this.counter++ +") "+t.getTime()+" ";this.wall.innerHTML=n+e+"\n"+this.wall.innerHTML}},n.prototype.debuffer=function(){if(document.readyState==="complete"&&this.buffer.length>0){for(var e=0;e<this.buffer.length;e++)this.write(this.buffer[e]);this.buffer=[]}}}(node),function(e){function r(e){this.id=e.id,this.recipient=null,this.actionSel=null,this.targetSel=null,this.table=new n,this.init()}var t=e.GameMsg,n=e.window.Table;e.widgets.register("MsgBar",r),r.defaults={},r.defaults.id="msgbar",r.defaults.fieldset={legend:"Send MSG"},r.name="Msg Bar",r.version="0.4",r.description="Send a nodeGame message to players",r.prototype.init=function(){var n=this,r=new t,i=0;for(var s in r)if(r.hasOwnProperty(s)){var o=this.id+"_"+s;this.table.add(s,0,i),this.table.add(e.window.getTextInput(o),1,i),s==="target"?(this.targetSel=e.window.getTargetSelector(this.id+"_targets"),this.table.add(this.targetSel,2,i),this.targetSel.onchange=function(){e.window.getElementById(n.id+"_target").value=n.targetSel.value}):s==="action"?(this.actionSel=e.window.getActionSelector(this.id+"_actions"),this.table.add(this.actionSel,2,i),this.actionSel.onchange=function(){e.window.getElementById(n.id+"_action").value=n.actionSel.value}):s==="to"&&(this.recipient=e.window.getRecipientSelector(this.id+"recipients"),this.table.add(this.recipient,2,i),this.recipient.onchange=function(){e.window.getElementById(n.id+"_to").value=n.recipient.value}),i++}this.table.parse()},r.prototype.append=function(t){var n=e.window.addButton(t),r=e.window.addButton(t,"stub","Add Stub"),i=this;return n.onclick=function(){var t=i.parse();e.gsc.send(t)},r.onclick=function(){i.addStub()},t.appendChild(this.table.table),this.root=t,t},r.prototype.getRoot=function(){return this.root},r.prototype.listeners=function(){var t=this;e.onPLIST(function(n){e.window.populateRecipientSelector(t.recipient,n.data)})},r.prototype.parse=function(){var n={},r=this,i=null,s=null;this.table.forEach(function(e){if(e.x===0)i=e.content,n[i]="";else if(e.x===1){s=e.content.value;if(i==="state"||i==="data")try{s=JSON.parse(e.content.value)}catch(t){s=e.content.value}n[i]=s}});var o=new t(n);return e.info(o,"MsgBar sent: "),o},r.prototype.addStub=function(){e.window.getElementById(this.id+"_from").value=e.player?e.player.id:"undefined",e.window.getElementById(this.id+"_to").value=this.recipient.value,e.window.getElementById(this.id+"_forward").value=0,e.window.getElementById(this.id+"_reliable").value=1,e.window.getElementById(this.id+"_priority").value=0,e.gsc&&e.gsc.session&&(e.window.getElementById(this.id+"_session").value=e.gsc.session),e.window.getElementById(this.id+"_state").value=JSON.stringify(e.state),e.window.getElementById(this.id+"_action").value=this.actionSel.value,e.window.getElementById(this.id+"_target").value=this.targetSel.value}}(node),function(e){function t(e){this.id=e.id,this.recipient=null}e.widgets.register("StateBar",t),t.defaults={},t.defaults.id="statebar",t.defaults.fieldset={legend:"Change Game State"},t.name="State Bar",t.version="0.3.2",t.description="Provides a simple interface to change the state of the game.",t.prototype.getRoot=function(){return this.root},t.prototype.append=function(t){var n=this.id+"_",r=n+"sendButton",i=n+"stateSel",s=n+"recipient",o=e.window.addButton(t,r),u=e.window.addStateSelector(t,i);this.recipient=e.window.addRecipientSelector(t,s);var a=this;return e.on("UPDATED_PLIST",function(){e.window.populateRecipientSelector(a.recipient,e.game.pl)}),o.onclick=function(){var t=a.recipient.value,n=/^(\d+)(?:\.(\d+))?(?::(\d+))?$/,r=n.exec(u.value),i,s,o,f,l;r!==null?(i=r[1],s=r[2]||1,o=r[3]||1,e.log("Parsed State: "+r.join("|")),i=new e.GameStage({state:i,step:s,round:o}),t==="ALL"&&(f=e.IN+e.action.SAY+".STATE",l=e.msg.createSTATE(f,i),e.emit(f,l)),f=e.OUT+e.action.SAY+".STATE",e.emit(f,i,t)):(e.err("Not valid state. Not sent."),e.socket.sendTXT("E: not valid state. Not sent"))},this.root=t,t}}(node),function(e){function i(e){this.options=e,this.nddb=null,this.commandsDiv=document.createElement("div"),this.id=e.id,"undefined"!=typeof this.id&&(this.commandsDiv.id=this.id),this.info=null,this.init(this.options)}e.widgets.register("NDDBBrowser",i);var t=e.JSUS,n=e.NDDB,r=e.TriggerManager;i.defaults={},i.defaults.id="nddbbrowser",i.defaults.fieldset=!1,i.name="NDDBBrowser",i.version="0.1.2",i.description="Provides a very simple interface to control a NDDB istance.",i.dependencies={JSUS:{},NDDB:{},TriggerManager:{}},i.prototype.init=function(t){function i(){var t=this.id;e.window.addEventButton(t+"_GO_TO_FIRST","<<",this.commandsDiv,"go_to_first"),e.window.addEventButton(t+"_GO_TO_PREVIOUS","<",this.commandsDiv,"go_to_previous"),e.window.addEventButton(t+"_GO_TO_NEXT",">",this.commandsDiv,"go_to_next"),e.window.addEventButton(t+"_GO_TO_LAST",">>",this.commandsDiv,"go_to_last"),e.window.addBreak(this.commandsDiv)}function s(){var e=this.commandsDiv.appendChild(document.createElement("span"));return e}i.call(this),this.info=s.call(this),this.tm=new r,this.tm.init(t.triggers),this.nddb=t.nddb||new n({auto_update_pointer:!0})},i.prototype.append=function(e){return this.root=e,e.appendChild(this.commandsDiv),e},i.prototype.getRoot=function(e){return this.commandsDiv},i.prototype.add=function(e){return this.nddb.insert(e)},i.prototype.sort=function(e){return this.nddb.sort(e)},i.prototype.addTrigger=function(e){return this.tm.addTrigger(e)},i.prototype.removeTrigger=function(e){return this.tm.removeTrigger(e)},i.prototype.resetTriggers=function(){return this.tm.resetTriggers()},i.prototype.listeners=function(){function r(t,r){t?(e.emit(n+"_GOT",t),this.writeInfo(this.nddb.nddb_pointer+1+"/"+this.nddb.length)):this.writeInfo("No element found")}var t=this,n=this.id;e.on(n+"_GO_TO_FIRST",function(){var e=t.tm.pullTriggers(t.nddb.first());r.call(t,e)}),e.on(n+"_GO_TO_PREVIOUS",function(){var e=t.tm.pullTriggers(t.nddb.previous());r.call(t,e)}),e.on(n+"_GO_TO_NEXT",function(){var e=t.tm.pullTriggers(t.nddb.next());r.call(t,e)}),e.on(n+"_GO_TO_LAST",function(){var e=t.tm.pullTriggers(t.nddb.last());r.call(t,e)})},i.prototype.writeInfo=function(e){this.infoTimeout&&clearTimeout(this.infoTimeout),this.info.innerHTML=e;var t=this;this.infoTimeout=setTimeout(function(){t.info.innerHTML=""},2e3)}}(node),function(e){function t(e){this.bar=null,this.root=null,this.recipient=null}e.widgets.register("DataBar",t),t.defaults={},t.defaults.id="databar",t.defaults.fieldset={legend:"Send DATA to players"},t.name="Data Bar",t.version="0.3",t.description="Adds a input field to send DATA messages to the players",t.prototype.append=function(t){var n,r,i;n=W.addButton(t),W.writeln("Text"),r=W.addTextInput(t,"data-bar-text"),W.writeln("Data"),i=W.addTextInput(t,"data-bar-data"),this.recipient=W.addRecipientSelector(t);var s=this;return n.onclick=function(){var t,n,o;t=s.recipient.value,o=r.value,n=i.value,e.log("Parsed Data: "+JSON.stringify(n)),e.say(n,o,t)},e.on("UPDATED_PLIST",function(){e.window.populateRecipientSelector(s.recipient,e.game.pl)}),t}}(node)