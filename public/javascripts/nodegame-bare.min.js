/**
 * # nodeGame
 * 
 * Social Experiments in the Browser
 * 
 * Copyright(c) 2012 Stefano Balietti
 * MIT Licensed 
 * 
 * nodeGame is a free, open source, event-driven javascript framework for on line, 
 * multiplayer games in the browser.
 * 
 * 
 */
(function(e){e.version="0.6.3",e.log=function(){},e.events={},e.msg={},e.socket=e.gsc={},e.session={},e.player={},e.game={},e.game.memory=null,e.game.state=null,e.store=function(){},e.setup=function(){},e.conf={},e.support={},"object"==typeof module&&"function"==typeof require?(require("./lib/modules/log.js"),require("./lib/modules/variables.js"),require("./init.node.js"),require("./lib/nodegame.js"),require("./lib/modules/fs.js"),require("./lib/modules/setup.js"),require("./lib/modules/alias.js"),require("./lib/modules/random.js"),require("./lib/sockets/SocketIo.js"),require("./lib/sockets/SocketDirect.js"),require("./listeners/incoming.js"),require("./listeners/internal.js"),require("./listeners/outgoing.js")):("undefined"!=typeof JSUS&&(e.JSUS=JSUS),"undefined"!=typeof NDDB&&(e.NDDB=NDDB),"undefined"!=typeof store&&(e.store=store),e.support=JSUS.compatibility())})("object"==typeof module?module.exports:window.node={}),function(e,t){t.verbosity_levels={ALWAYS:-(Number.MIN_VALUE+1),ERR:-1,WARN:0,INFO:1,DEBUG:100,NEVER:Number.MIN_VALUE-1},t.verbosity=t.verbosity_levels.WARN,t.remoteVerbosity=t.verbosity_levels.WARN,t.log=function(e,n,r){if("undefined"==typeof e)return!1;n=n||0,r="undefined"==typeof r?"ng> ":r,"string"==typeof n&&(n=t.verbosity_levels[n]),t.verbosity>n&&console.log(r+e)},t.info=function(e,n){t.log(e,t.verbosity_levels.INFO,n)},t.warn=function(e,n){t.log(e,t.verbosity_levels.WARN,n)},t.err=function(e,n){t.log(e,t.verbosity_levels.ERR,n)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){t.action={},t.action.SET="set",t.action.GET="get",t.action.SAY="say",t.target={},t.target.DATA="DATA",t.target.HI="HI",t.target.HI_AGAIN="HI_AGAIN",t.target.PCONNECT="PCONNECT",t.target.PDISCONNECT="PDISCONNECT",t.target.MCONNECT="MCONNECT",t.target.MDISCONNECT="MDISCONNECT",t.target.PLIST="PLIST",t.target.MLIST="MLIST",t.target.STATE="STATE",t.target.STAGE="STAGE",t.target.REDIRECT="REDIRECT",t.target.SETUP="SETUP",t.target.GAMECOMMAND="GAMECOMMAND",t.target.JOIN="JOIN",t.target.LOG="LOG",t.target.TXT="TXT",t.target.BYE="BYE",t.target.ACK="ACK",t.target.WARN="WARN",t.target.ERR="ERR",t.gamecommand={start:"start",pause:"pause",resume:"resume",stop:"stop",restart:"restart",goto_stage:"goto_stage"},t.IN="in.",t.OUT="out.",t.is={},t.is.UNKNOWN=0,t.is.INITIALIZING=1,t.is.INITIALIZED=5,t.is.GAMELOADED=10,t.is.DEAD=-1,t.is.LOADING=10,t.is.LOADED=25,t.is.PLAYING=50,t.is.DONE=100}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){Error.apply(this,arguments),this.stack=(new Error).stack}function i(){Error.apply(this,arguments),this.stack=(new Error).stack}var n=t.JSUS;t.debug=!1,e.NodeGameRuntimeError=r,e.NodeGameStageCallbackError=i,r.prototype=new Error,r.prototype.constructor=r,r.prototype.name="NodeGameRuntimeError",i.prototype=new Error,i.prototype.constructor=i,i.prototype.name="NodeGameStageCallbackError",n.isNodeJS()?process.on("uncaughtException",function(e){console.log("Caught exception: "+e)}):window.onerror=function(e,n,r){return t.err(n+" "+r+": "+e),!t.debug}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){this.global=this._listeners={},this.local=this._localListeners={},this.history=new i}function i(){this.history=new n,this.history.h("stage",function(e){if(!e)return;var n="object"==typeof e.stage?e.stage:t.game.stage;return t.GameStage.toHash(n,"S.s.r")})}function s(e){e=e||{},this.event=e.event,this.listener=e.listener,this.priority=e.priority||0,this.stage=e.stage||t.game.stage,this.ttl="undefined"!=typeof e.ttl?e.ttl:-1,this.target=e.target||undefined}var n=t.NDDB;e.EventEmitter=r,r.prototype={constructor:r,add:function(e,n){if(!e||!n)return;"undefined"==typeof this.global[e]&&(this.global[e]=[]),t.log("Added Listener: "+e+" "+n,"DEBUG"),this.global[e].push(n)},addLocal:function(e,n){if(!e||!n)return;"undefined"==typeof this.local[e]&&(this.local[e]=[]),t.log("Added Local Listener: "+e+" "+n,"DEBUG"),this.local[e].push(n)},emit:function(e,n,r,i){var s;if(!e)return;"string"==typeof e&&(e={type:e}),e.target||(e.target=this);if(!e.type)throw new Error("Event object missing 'type' property.");if(t.conf&&t.conf.events){if(t.conf.events.history){var o={event:e.type,stage:t.game.stage,p1:n,p2:r,p3:i};this.history.insert(o)}t.conf.events.dumpEvents&&t.log("F: "+e.type)}if(this.global[e.type]instanceof Array){s=this.global[e.type];for(var u=0,a=s.length;u<a;u++)s[u].call(this.game,n,r,i)}if(this.local[e.type]instanceof Array){s=this.local[e.type];for(var u=0,a=s.length;u<a;u++)s[u].call(this.game,n,r,i)}},remove:function(e,n){function r(e,n,r){if(r[e]instanceof Array){if(!n)return delete r[e],!0;var i=r[e],s=i.length;for(var o=0;o<s;o++)if(i[o]==n)return i.splice(o,1),t.log("Removed listener "+e+" "+n,"DEBUG"),!0}return!1}var i=r(e,n,this.global),s=r(e,n,this.local);return i||s},clearStage:function(e){return this.clearLocal(),!0},clearLocal:function(){t.log("Cleaning Local Listeners","DEBUG");for(var e in this.local)this.local.hasOwnProperty(e)&&this.remove(e,this.local[e]);this.local={}},printAll:function(){var e;t.log("nodeGame:	PRINTING ALL LISTENERS","DEBUG");for(e in this.global)this.global.hasOwnProperty(e)&&console.log(e+" "+e.length);for(e in this.local)this.local.hasOwnProperty(e)&&console.log(e+" "+e.length)}},i.prototype.remit=function(e,n,r){if(!this.history.count())return t.log("no event history was found to remit","WARN"),!1;t.log("remitting "+t.events.history.count()+" events","DEBUG");var i,s;if(e){this.history.rebuildIndexes(),i=(new GameStage(session.stage)).toHash("S.s.r");if(!this.history.stage)return t.log("no old events to re-emit were found during session recovery","DEBUG"),!1;if(!this.history.stage[i])return t.log("the current stage "+i+" has no events to re-emit","DEBUG"),!1;s=this.history.stage[i]}else s=this.history;n&&s.select("event","in",n).remove(),r&&(s=s.select("event","in",r));if(!s.count())return t.log("no valid events to re-emit after cleanup","DEBUG"),!1;var o=function(){t.log("re-emitting "+s.count()+" events","DEBUG"),s.each(function(e){t.emit(e.event,e.p1,e.p2,e.p3)})};return t.game.isReady()?o.call(t.game):t.on("LOADED",function(){o.call(t.game)}),!0}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){this.stage=0,this.step=1,this.round=1;if(!e||"undefined"==typeof e)this.stage=0,this.step=0,this.round=0;else if("string"==typeof e){var t=e.split("."),n=parseInt(t[0],10),r=parseInt(t[1],10),i=parseInt(t[2],10);t[0]&&(this.stage=isNaN(n)?t[0]:n),"undefined"!=typeof t[1]&&(this.step=isNaN(r)?t[1]:r),"undefined"!=typeof t[2]&&(this.round=i)}else"object"==typeof e&&("undefined"!=typeof e.stage&&(this.stage=e.stage),"undefined"!=typeof e.step&&(this.step=e.step),"undefined"!=typeof e.round&&(this.round=e.round))}var n=t.JSUS;e.GameStage=r,r.defaults={},r.defaults.hash="S.s.r",r.prototype.toString=function(){var e=this.toHash("S.s.r");return e},r.prototype.toHash=function(e){return r.toHash(this,e)},r.toHash=function(e,t){if(!e||"object"!=typeof e)return!1;if(!t||!t.length)return e.toString();var n="",r="Ssr",i=["stage","step","round"];for(var s=0;s<t.length;s++){var o=r.indexOf(t[s]);n+=o<0?t[s]:e[i[o]]}return n},r.compare=function(e,t){if(!e&&!t)return 0;if(!t)return 1;if(!e)return-1;"string"==typeof e&&(e=new r(e)),"string"==typeof t&&(t=new r(t));var n=e.stage-t.stage;return n===0&&"undefined"!=typeof e.round&&(n=e.round-t.round,n===0&&"undefined"!=typeof e.step&&(n=e.step-t.step)),n},r.stringify=function(e){if(!e)return;var t=(new r(e)).toHash("(r) S.s_i");return t}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e,n){e=e||{},e.log||(e.log=t.log),e.update||(e.update={}),"undefined"==typeof e.update.indexes&&(e.update.indexes=!0),r.call(this,e,n),this.globalCompare=s.comparePlayers,this.id||this.index("id",function(e){return e.id}),this.pcounter=this.db.length||0}function o(e){e=e||{};var n=e.sid;t.support.defineProperty?Object.defineProperty(this,"sid",{value:n,enumerable:!0}):this.sid=n;var r=e.id||n;t.support.defineProperty?Object.defineProperty(this,"id",{value:r,enumerable:!0}):this.id=r;var s=e.count;t.support.defineProperty?Object.defineProperty(this,"count",{value:s,enumerable:!0}):this.count=s;var o=!!e.admin;t.support.defineProperty?Object.defineProperty(this,"admin",{value:o,enumerable:!0}):this.admin=o;var u=!!e.disconnected;t.support.defineProperty?Object.defineProperty(this,"disconnected",{value:u,enumerable:!0}):this.disconnected=u,this.ip=e.ip,this.name=e.name,this.stage=e.stage||new i;for(var a in e)e.hasOwnProperty(a)&&"function"!=typeof e[a]&&(this.hasOwnProperty(a)||(this[a]=e[a]))}var n=t.JSUS,r=t.NDDB,i=t.GameStage;e.PlayerList=s,s.prototype=new r,s.prototype.constructor=s,s.comparePlayers=function(e,t){return e.id===t.id?0:e.count<t.count?1:e.count>t.count?-1:0},s.prototype.add=function(e){return!e||"undefined"==typeof e.id?(t.err("Player id not found, cannot add object to player list."),!1):this.exist(e.id)?(t.err("Attempt to add a new player already in the player list: "+e.id),!1):(this.insert(e),e.count=this.pcounter,this.pcounter++,e)},s.prototype.get=function(e){if("undefined"==typeof e)return!1;var n=this.id.get(e);return n?n:(t.warn("Attempt to access a non-existing player from the the player list. id: "+e),!1)},s.prototype.remove=function(e){if("undefined"==typeof e)return!1;var n=this.id.pop(e);return n?n:(t.err("Attempt to remove a non-existing player from the the player list. id: "+e),!1)},s.prototype.pop=s.prototype.remove,s.prototype.exist=function(e){return this.id.get(e)?!0:!1},s.prototype.updatePlayerStage=function(e,n){return this.exist(e)?"undefined"==typeof n?(t.warn("Attempt to assign to a player an undefined stage"),!1):this.id.update(e,{stage:n}):(t.warm("Attempt to access a non-existing player from the the player list "+player.id),!1)},s.prototype.isStageDone=function(e){if(!e)return!1;var n=!1;for(var r=0;r<this.db.length;r++){if(i.compare(e,p.stage,!1)!==0)continue;if(p.stageLevel!==t.Game.stageLevels.DONE)return!1;n=!0}return n},s.prototype.toString=function(e){var t="",n=e||"\n",r;return this.forEach(function(e){t+=e.id+": "+e.name,r=new i(e.stage),t+=": "+r+n}),t},s.prototype.getNGroups=function(e){if(!e)return;var t=n.getNGroups(this.db,e);return s.array2Groups(t)},s.prototype.getGroupsSizeN=function(e){if(!e)return;var t=n.getGroupsSizeN(this.db,e);return s.array2Groups(t)},s.prototype.getRandom=function(e){return e||(e=1),e<1?(t.err("N must be an integer >= 1"),!1):(this.shuffle(),this.limit(e).fetch())},e.Player=o,o.prototype.toString=function(){return(this.name||"")+" ("+this.id+") "+new i(this.stage)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function i(e){e=e||{};var n=e.id||Math.floor(Math.random()*1e6);t.support.defineProperty?Object.defineProperty(this,"id",{value:n,enumerable:!0}):this.id=n;var i=e.session;t.support.defineProperty?Object.defineProperty(this,"session",{value:i,enumerable:!0}):this.session=i,this.stage=e.stage,this.action=e.action,this.target=e.target,this.from=e.from,this.to=e.to,this.text=e.text,this.data=e.data,this.priority=e.priority,this.reliable=e.reliable,this.created=r.getDate(),this.forward=0}var n=t.GameStage,r=t.JSUS;e.GameMsg=i,i.clone=function(e){return new i(e)},i.prototype.stringify=function(){return JSON.stringify(this)},i.prototype.toString=function(){var e=",	",t="\n",r='"',i=new n(this.stage),s=this.created+e;return s+=this.id+e,s+=this.session+e,s+=this.action+e,s+=this.target+e,s+=this.from+e,s+=this.to+e,s+=r+this.text+r+e,s+=r+this.data+r+e,s+=this.reliable+e,s+=this.priority+t,s},i.prototype.toSMS=function(){var e=/\w+/,t=e.exec(this.created),n="["+this.from+"]->["+this.to+"]	";return n+="|"+this.action+"."+this.target+"|"+"	",n+=" "+this.text+" ",n},i.prototype.toInEvent=function(){return"in."+this.toEvent()},i.prototype.toOutEvent=function(){return"out."+this.toEvent()},i.prototype.toEvent=function(){return this.action+"."+this.target}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(){this.clear()}e.Stager=n,n.prototype.clear=function(){return this.steps={},this.stages={},this.sequence=[],this.generalNextFunction=null,this.nextFunctions={},this},n.prototype.registerGeneralNext=function(e){if("function"!=typeof e){t.warn("registerGeneralNext didn't receive function parameter");return}this.generalNextFunction=e},n.prototype.registerNext=function(e,n){if("function"!=typeof n){t.warn("registerNext didn't receive function parameter");return}if(!this.stages[e]){t.warn("registerNext received nonexistent stage id");return}this.nextFunctions[e]=n},n.prototype.addStep=function(e){return this.checkStepValidity(e)?(this.steps[e.id]=e,!0):(t.warn("addStep received invalid step"),!1)},n.prototype.addStage=function(e){return this.checkStepValidity(e)?this.addStep(e)?this.addStage({id:e.id,steps:[e.id]})?!0:!1:!1:this.checkStageValidity(e)?(this.stages[e.id]=e,!0):(t.warn("addStage received invalid stage"),!1)},n.prototype.init=function(){return this.sequence=[],this},n.prototype.gameover=function(){return this.sequence.push({type:"gameover"}),this},n.prototype.next=function(e){var n=this.handleAlias(e);return n===null?(t.warn("next received invalid stage name"),null):(this.sequence.push({type:"plain",id:n}),this)},n.prototype.repeat=function(e,n){var r=this.handleAlias(e);return r===null?(t.warn("repeat received invalid stage name"),null):(this.sequence.push({type:"repeat",id:r,num:n}),this)},n.prototype.loop=function(e,n){var r=this.handleAlias(e);return r===null?(t.warn("loop received invalid stage name"),null):(this.sequence.push({type:"loop",id:r,cb:n}),this)},n.prototype.doLoop=function(e,n){var r=this.handleAlias(e);return r===null?(t.warn("doLoop received invalid stage name"),null):(this.sequence.push({type:"doLoop",id:r,cb:n}),this)},n.prototype.getSequence=function(e){var n,r,i,s,o=!1;switch(e){case"hstages":n=[];for(r in this.sequence)if(this.sequence.hasOwnProperty(r)){i=this.sequence[r];switch(i.type){case"gameover":n.push("[game over]");break;case"plain":n.push(i.id);break;case"repeat":n.push(i.id+" [x"+i.num+"]");break;case"loop":n.push(i.id+" [loop]");break;case"doLoop":n.push(i.id+" [doLoop]");break;default:t.warn("unknown sequence object type")}}break;case"hsteps":n=[];for(r in this.sequence)if(this.sequence.hasOwnProperty(r)){i=this.sequence[r],s=i.id+".";switch(i.type){case"gameover":n.push("[game over]");break;case"plain":this.stages[i.id].steps.map(function(e){n.push(s+e)});break;case"repeat":this.stages[i.id].steps.map(function(e){n.push(s+e+" [x"+i.num+"]")});break;case"loop":this.stages[i.id].steps.map(function(e){n.push(s+e+" [loop]")});break;case"doLoop":this.stages[i.id].steps.map(function(e){n.push(s+e+" [doLoop]")});break;default:t.warn("unknown sequence object type")}}break;case"o":n=this.sequence;break;default:return t.warn("getSequence got invalid format characters"),null}return n},n.prototype.getStepsFromStage=function(e){return this.stages[e].steps},n.prototype.seqTestRun=function(e,n){var r,i,s;console.log("* Commencing sequence test run!");if(!e){for(s in this.sequence)if(this.sequence.hasOwnProperty(s)){r=this.sequence[s],console.log("** num: "+s+", type: "+r.type);switch(r.type){case"gameover":console.log("* Game Over.");return;case"plain":this.stageTestRun(r.id);break;case"repeat":for(var o=0;o<r.num;o++)this.stageTestRun(r.id);break;case"loop":while(r.cb())this.stageTestRun(r.id);break;case"doLoop":do this.stageTestRun(r.id);while(r.cb());break;default:t.warn("unknown sequence object type")}}}else{n?i=n:this.generalNextFunction?i=this.generalNextFunction():i=null;while(i)this.stageTestRun(i),this.nextFunctions[i]?i=this.nextFunctions[i]():this.generalNextFunction?i=this.generalNextFunction():i=null,i!==null&&!this.stages[i]&&(t.warn("next-deciding callback yielded invalid stage"),i=null)}},n.prototype.stageTestRun=function(e){var t=this.stages[e].steps,n;for(var r in t)t.hasOwnProperty(r)&&(n=t[r],this.steps[n].cb())},n.prototype.checkStepValidity=function(e){return e?"string"!=typeof e.id?!1:"function"!=typeof e.cb?!1:!0:!1},n.prototype.checkStageValidity=function(e){if(!e)return!1;if("string"!=typeof e.id)return!1;if(!e.steps&&!e.steps.length)return!1;for(var t in e.steps)if(e.steps.hasOwnProperty(t)&&!this.steps[e.steps[t]])return!1;return!0},n.prototype.handleAlias=function(e){var n=e.split(" AS "),r=n[0].trim(),i=n[1]?n[1].trim():undefined,s=i||r,o;if(!this.stages[r])return t.warn("handleAlias received nonexistent stage id"),null;for(o in this.sequence)if(this.sequence.hasOwnProperty(o)&&this.sequence[o].id===s)return t.warn("handleAlias received non-unique stage name"),null;return i?(this.stages[i]=this.stages[r],i):r}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function i(e){this.plot=e||null}e.GameLoop=i;var n=t.Stager,r=t.GameStage;i.GAMEOVER="NODEGAME_GAMEOVER",i.END_SEQ="NODEGAME_END_SEQ",i.NO_SEQ="NODEGAME_NO_SEQ",i.prototype.init=function(e){this.plot=e},i.prototype.next=function(e){if(!this.plot)return i.NO_SEQ;var n=this.plot.sequence.length===0,s,o=null,u,a,f,l=null,c=null;e=new r(e);if(n)return e.stage===0?(this.plot.generalNextFunction&&(c=this.plot.generalNextFunction()),c?new r({stage:c,step:1,round:1}):i.END_SEQ):(u=this.plot.stages[e.stage],"undefined"==typeof u?(t.warn("next received nonexistent stage: "+e.stage),null):("number"==typeof e.step?f=e.step:f=u.steps.indexOf(e.step)+1,f<1?(t.warn("next received nonexistent step: "+u.id+"."+e.step),null):f+1<=u.steps.length?new r({stage:u.id,step:f+1,round:1}):(this.plot.nextFunctions[u.id]?c=this.plot.nextFunctions[u.id]():this.plot.generalNextFunction&&(c=this.plot.generalNextFunction()),c===i.GAMEOVER?i.GAMEOVER:c?new r({stage:c,step:1,round:1}):i.END_SEQ)));if(e.stage===0)return new r({stage:1,step:1,round:1});l=this.normalizeGameStage(e);if(l===null)return t.warn("next received invalid stage: "+e),null;a=l.stage,f=l.step,o=this.plot.sequence[a-1];if(o.type==="gameover")return i.GAMEOVER;u=this.plot.stages[o.id];if(f+1<=u.steps.length)return new r({stage:a,step:f+1,round:l.round});if(o.type==="repeat"&&l.round+1<=o.num)return new r({stage:a,step:1,round:l.round+1});if(o.type!=="doLoop"&&o.type!=="loop"||!o.cb()){if(a<this.plot.sequence.length){while(this.plot.sequence[a].type==="loop"&&!this.plot.sequence[a].cb()){a++;if(a>=this.plot.sequence.length)return i.END_SEQ}return this.plot.sequence[a].type==="gameover"?i.GAMEOVER:new r({stage:a+1,step:1,round:1})}return i.END_SEQ}return new r({stage:a,step:1,round:l.round+1})},i.prototype.previous=function(e){if(!this.plot)return i.NO_SEQ;var n,s,o=null,u=null,a,f,l,c;e=new r(e),n=this.normalizeGameStage(e);if(n===null)return t.warn("previous received invalid stage: "+e),null;f=n.stage,l=n.step,o=this.plot.sequence[f-1];if(l>1)return new r({stage:f,step:l-1,round:e.round});if("undefined"!=typeof o.id){u=this.plot.stages[o.id];if(e.round>1)return new r({stage:f,step:u.steps.length,round:e.round-1});if((o.type==="doLoop"||o.type==="loop")&&o.cb())return new r({stage:f,step:u.steps.length,round:1})}if(f<=1)return new r({stage:0,step:0,round:0});while(this.plot.sequence[f-2].type==="loop"&&!this.plot.sequence[f-2].cb()){f--;if(f<=1)return new r({stage:0,step:0,round:0})}return a=this.plot.sequence[f-2],c=this.plot.stages[a.id].steps.length,a.type==="repeat"?new r({stage:f-1,step:c,round:a.num}):new r({stage:f-1,step:c,round:1})},i.prototype.jump=function(e,t){if(t<0)while(t<0){e=this.previous(e),t++;if(!(e instanceof r)||e.stage===0)return e}else while(t>0){e=this.next(e),t--;if(!(e instanceof r))return e}return e},i.prototype.getStage=function(e){if(!this.plot)return null;var t;return e=new r(e),"number"==typeof e.stage?(t=this.plot.sequence[e.stage-1],t?this.plot.stages[t.id]:null):this.plot.stages[e.stage]},i.prototype.getStep=function(e){if(!this.plot)return null;var t,e=new r(e);return"number"==typeof e.step?(t=this.getStage(e),t?this.plot.steps[t.steps[e.step-1]]:null):this.plot.steps[e.step]},i.prototype.getName=function(e){var t=this.getStep(e);return t?t.name:t},i.prototype.getAllParams=i.prototype.getStep,i.prototype.normalizeGameStage=function(e){var n,i,s,o;if("number"==typeof e.stage)n=e.stage;else{for(s=0;s<this.plot.sequence.length;s++)if(this.plot.sequence[s].id===e.stage)break;n=s+1}return n<1||n>this.plot.sequence.length?(t.warn("normalizeGameStage received nonexistent stage: "+e.stage),null):(o=this.plot.sequence[n-1],o.type==="gameover"?new r({stage:n,step:1,round:e.round}):(stageObj=this.plot.stages[o.id],"number"==typeof e.step?i=e.step:i=stageObj.steps.indexOf(e.step)+1,i<1?(t.warn("normalizeGameStage received nonexistent step: "+stageObj.id+"."+e.step),null):new r({stage:n,step:i,round:e.round})))}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function a(){}var n=t.GameMsg,r=t.GameStage,i=t.Player,s=t.JSUS,o=t.target,u=t.action;e.GameMsgGenerator=a,a.create=function(e){var r={session:"undefined"!=typeof e.session?e.session:t.socket.session,stage:e.stage||t.game.stage,action:e.action||u.SAY,target:e.target||o.DATA,from:t.player.sid,to:"undefined"!=typeof e.to?e.to:"SERVER",text:e.text||null,data:e.data||null,priority:e.priority||null,reliable:e.reliable||1};return new n(r)},a.createHI=function(e,r,s){return e=e||t.player,e?(s=s||1,new n({session:t.gsc.session,stage:t.game.stage,action:u.SAY,target:o.HI,from:t.player.sid,to:r,text:new i(e)+" ready.",data:e,priority:null,reliable:s})):!1},a.sayPLIST=function(e,t,n){return this.createPLIST(u.SAY,e,t,n)},a.setPLIST=function(e,t,n){return this.createPLIST(u.SET,e,t,n)},a.getPLIST=function(e,t,n){return this.createPLIST(u.GET,e,t,n)},a.createPLIST=function(e,r,i,s){return r=r||!t.game||t.game.pl,!e||!r?!1:(i=i||"SERVER",s=s||1,new n({session:t.gsc.session,stage:t.game.stage,action:e,target:o.PLIST,from:t.player.sid,to:i,text:"List of Players: "+r.length,data:r.pl,priority:null,reliable:s}))},a.createTXT=function(e,r,i){return e?(i=i||0,new n({session:t.gsc.session,stage:t.game.stage,action:u.SAY,target:o.TXT,from:t.player.sid,to:r,text:e,data:null,priority:null,reliable:i})):!1},a.sayDATA=function(e,t,n,r){return this.createDATA(u.SAY,e,t,n,r)},a.setDATA=function(e,t,n,r){return this.createDATA(u.SET,e,t,n,r)},a.getDATA=function(e,t,n,r){return this.createDATA(u.GET,e,t,n,r)},a.createDATA=function(e,r,i,s,u){return e?(u=u||1,s=s||"data msg",new n({session:t.gsc.session,stage:t.game.stage,action:e,target:o.DATA,from:t.player.sid,to:i,text:s,data:r,priority:null,reliable:u})):!1},a.createACK=function(e,r,i){if(!e)return!1;i=i||0;var s=new n({session:t.gsc.session,stage:t.game.stage,action:u.SAY,target:o.ACK,from:t.player.sid,to:r,text:"Msg "+e.id+" correctly received",data:e.id,priority:null,reliable:i});return e.forward&&(s.forward=1),s}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){var t=e;return t=new e,t.send?t.connect?!0:(console.log("no connect"),!1):(console.log("no send"),!1)}function i(){return n}function s(e,t){var r=n[e];return r?new r(t):null}function o(e,i){if(!e||!i)return;r(i)?n[e]=i:t.err("cannot register invalid Socket class: "+e)}var n={};e.SocketFactory={checkContract:r,getTypes:i,get:s,register:o}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function l(e){a=[],t.support.defineProperty?Object.defineProperty(this,"buffer",{value:a,enumerable:!0}):this.buffer=a,f=null,t.support.defineProperty?Object.defineProperty(this,"session",{value:f,enumerable:!0}):this.session=f,this.socket=null,this.url=null}e.Socket=l;var n=t.GameMsg,r=t.GameStage,i=t.Player,s=t.GameMsgGenerator,o=t.SocketFactory,u=t.action,a,f;l.prototype.setup=function(e){e=e||{},e.type&&this.setSocketType(e.type,e)},l.prototype.setSocketType=function(e,t){var n=o.get(e,t);return n?(this.socket=n,!0):!1},l.prototype.connect=function(e,n){if(!this.socket)return t.err("cannot connet to "+e+" . No open socket."),!1;this.url=e,t.log("connecting to "+e),this.socket.connect(e,n)},l.prototype.onDisconnect=function(){t.session.store(),t.log("closed")},l.prototype.onMessage=function(e){e=this.secureParse(e);if(!e)return;var n;e.target==="HI"&&(this.attachMsgListeners(),this.startSession(e),n=t.store(e.session),t.store(e.session,t.session.save()),this.sendHI(t.player,"ALL"))},l.prototype.attachMsgListeners=function(){this.onMessage=this.onMessageFull,t.emit("NODEGAME_READY")},l.prototype.onMessageFull=function(e){e=this.secureParse(e),e&&(t.game.isReady&&t.game.isReady()?t.emit(e.toInEvent(),e):(console.log("BUFFERING"),t.log("buffering: "+e,"DEBUG"),a.push(e)))},l.prototype.registerServer=function(e){this.servername=e.from,this.serverid=e.from},l.prototype.secureParse=secureParse=function(e){var r;try{r=n.clone(JSON.parse(e)),t.info("R: "+r)}catch(i){return c("malformed msg received",i)}return this.session&&r.session!==this.session?c("local session id does not match incoming message session id"):r},l.prototype.clearBuffer=function(){var e=a.length,n;for(var r=0;r<e;r++)n=this.buffer.shift(),n&&(t.emit(n.toInEvent(),n),t.log("Debuffered "+n,"DEBUG"))},l.prototype.startSession=function(e){this.registerServer(e);var n={id:e.data,sid:e.data};return t.createPlayer(n),this.session=e.session,!0},l.prototype.send=function(e){return this.socket?(this.socket.send(e),t.info("S: "+e),!0):(t.err("socket cannot send message. No open socket."),!1)},l.prototype.sendHI=function(e,n){e=e||t.player,n=n||"SERVER";var r=t.msg.createHI(e,n);this.send(r)},l.prototype.sendSTAGE=function(e,n,r){var i=t.msg.create({action:t.action.SAY,target:t.target.STAGE,data:n,to:r});this.send(i)},l.prototype.sendTXT=function(e,n){var r=t.msg.createTXT(e,n);this.send(r)},l.prototype.sendDATA=function(e,r,i,s){e=e||n.say,i=i||"SERVER",s=s||"DATA";var o=t.msg.createDATA(e,r,i,s);this.send(o)};var c=function(e,n){e=e||"Generic error while parsing a game message";var r=n?e+": "+n:e;return t.log(r,"ERR"),t.emit("LOG","E: "+r),!1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){function o(e){this.socket=null}var r=t.GameMsg,i=t.Player,s=t.GameMsgGenerator;e.SocketIo=o,o.prototype.connect=function(e,r){if(!e)return t.err("cannot connect to empty url.","ERR"),!1;var i=this;return this.socket=n.connect(e,r),this.socket.on("connect",function(e){t.info("socket.io connection open"),i.socket.on("message",function(e){t.socket.onMessage(e)})}),this.socket.on("disconnect",t.socket.onDisconnect),!0},o.prototype.send=function(e){console.log(e),this.socket.send(e.stringify())},t.SocketFactory.register("SocketIo",o)}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof io?io:module.parent.exports.io),function(e,t){function s(e,t,n){e=e||{},e.update||(e.update={}),e.update.indexes=!0,r.call(this,e,t,n),this.c("stage",o.compareState),this.player||this.h("player",function(e){return e.player}),this.stage||this.h("stage",function(e){return i.toHash(e.stage,"S.s.r")}),this.key||this.h("key",function(e){return e.key})}function o(e){this.stage=e.stage,this.player=e.player,this.key=e.key,this.value=e.value,this.time=Date?Date.now():null}var n=t.JSUS,r=t.NDDB,i=t.GameStage;s.prototype=new r,s.prototype.constructor=s,e.GameDB=s,e.GameBit=o,s.prototype.add=function(e,n,r,i){return e?(i=i||t.game.stage,r=r||t.player,this.insert(new o({player:r,key:e,value:n,stage:i})),!0):!1},o.prototype.toString=function(){return this.player+", "+i.stringify(this.stage)+", "+this.key+", "+this.value},o.equals=function(e,t,n){return!e||!t?!1:(n=n||!1,o.comparePlayer(e,t)!==0?!1:o.compareState(e,t)!==0?!1:o.compareKey(e,t)!==0?!1:n&&e.value&&o.compareValue(e,t)!==0?!1:!0)},o.comparePlayer=function(e,t){return!e&&!t?0:e?t?e.player===t.player?0:e.player>t.player?1:-1:-1:1},o.compareState=function(e,t){return i.compare(e.stage,t.stage)},o.compareKey=function(e,t){return!e&&!t?0:e?t?e.key===t.key?0:e.key<t.key?-1:1:-1:1},o.compareValue=function(e,t){return!e&&!t?0:e?t?n.equals(e.value,t.value)?0:e.value>t.value?1:-1:-1:1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function m(e){e=e||{},this.updateGameState(m.levels.UNINITIALIZED),c=e.name||"A nodeGame game",t.support.defineProperty?Object.defineProperty(this,"name",{value:c,enumerable:!0}):this.name=c,h=e.description||"No Description",t.support.defineProperty?Object.defineProperty(this,"description",{value:h,enumerable:!0}):this.description=h,d=new o,t.support.defineProperty?Object.defineProperty(this,"pl",{value:d,enumerable:!0,configurable:!0,writable:!0}):this.pl=d,v=new o,t.support.defineProperty?Object.defineProperty(this,"ml",{value:v,enumerable:!0,configurable:!0,writable:!0}):this.ml=v,t.support.getter?Object.defineProperty(this,"ready",{set:function(){},get:this.isReady,enumerable:!0}):this.ready=null,this.observer="undefined"!=typeof e.observer?e.observer:!1,this.auto_step="undefined"!=typeof e.auto_step?e.auto_step:!0,this.auto_wait="undefined"!=typeof e.auto_wait?e.auto_wait:!1,this.solo_mode="undefined"!=typeof e.solo_mode?e.solo_mode:!1,this.minPlayers=e.minPlayers||1,this.maxPlayers=e.maxPlayers||1e3,this.memory=new i,this.gameLoop=this.stager=new s(e.stages),this.currentStep=new n,this.currentStepObj=new n,e.init&&(this.init=function(){this.updateGameState(m.levels.INITIALIZING),e.init.call(t.game),this.updateGameState(m.levels.INITIALIZED)}),this.player=null,this.paused=!1}var n=t.GameStage,r=t.GameMsg,i=t.GameDB,s=t.GameLoop,o=t.PlayerList,u=t.Player,a=t.Stager,f=t.JSUS,l=t.action;e.Game=m;var c,h,p,d,v;m.levels={UNINITIALIZED:0,INITIALIZING:1,INITIALIZED:5,READY:7,ONGOING:50,GAMEOVER:100,RUNTIME_ERROR:-1},m.stageLevels={LOADING:1,LOADED:2,PLAYING:50,PAUSING:55,PAUSED:60,RESUMING:65,RESUMED:70,DONE:100},m.prototype.init=function(){this.updateGameState(m.levels.INITIALIZING),this.updateGameState(m.levels.INITIALIZED)},m.prototype.gameover=function(){},m.prototype.start=function(){this.init(),this.step(),t.log("game started")},m.prototype.pause=function(){this.paused=!0},m.prototype.resume=function(){this.paused=!1},m.prototype.shouldStep=function(){return this.step()},m.prototype.step=function(){var e;return e=this.stager.next(this.currentStep),console.log("NEXT",e),"string"==typeof e?e===s.GAMEOVER?(t.emit("GAMEOVER"),this.gameover()):null:(this.currentStep=e,this.currentStepObj=this.stager.getStep(e),this.execStage(this.currentStepObj))},m.prototype.execStage=function(e){var n,r;n=e.cb,t.events.clearStage(this.currentStep),this.updateStageLevel("LOADING");try{return r=n.call(t.game),this.updateStageLevel("LOADED"),this.isReady()&&t.emit("LOADED"),r===!1,r}catch(i){var s,o;s="An error occurred while executing a custom callback",t.err(s);if(t.debug)throw o=t.NodeGameRuntimeError,console.log(o),console.log(o.trace),o;return!0}},m.prototype.getGameState=function(){return this.state},m.prototype.getStageLevel=function(){return this.state},m.prototype.getStep=function(){return this.currentStepObj},m.prototype.updateGameState=function(e){this.state=e},m.prototype.updateStageLevel=function(e){this.stageState=e},m.prototype.publishUpdate=function(){if(!this.observer){var e=t.OUT+l.SAY+".STATE";t.emit(e,this.state,"ALL")}},m.prototype.isReady=function(){return console.log(this.getGameState()),console.log(this.getStageLevel()),!0},m.prototype._isReadyToStep=function(e,t,n){var r=this._getStepperCallback(e,t),i=this.getStageLevel();return r(i,n)},m.prototype.isReadyToStep=function(){return this._isReadyToStep(this.currentStep,this.stager,this.pl)},m.prototype._getStepperCallback=function(e,t){return function(){return!0}},m.prototype.getStepperCallback=function(){return this._getStepperCallback(this.currentStep,this.stager)},m.prototype.next=function(e){return e?this.gameLoop.jump(this.state,Math.abs(e)):this.gameLoop.next(this.state)},m.prototype.previous=function(e){return e?this.gameLoop.jump(this.state,-Math.abs(e)):this.gameLoop.previous(this.state)},m.prototype.jumpTo=function(e){if(!e)return!1;var t=this.gameLoop.jump(this.state,e);return t?this.updateStage(t):!1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function o(){u.call(this),this.register("player",{set:function(e){t.createPlayer(e)},get:function(){return t.player}}),this.register("game.memory",{set:function(e){t.game.memory.clear(!0),t.game.memory.importDB(e)},get:function(){return t.game.memory?t.game.memory.fetch():null}}),this.register("events.history",{set:function(e){t.events.history.history.clear(!0),t.events.history.history.importDB(e)},get:function(){return t.events.history?t.events.history.history.fetch():null}}),this.register("game.currentStepObj",{set:o.restoreStage}),this.register("node.env")}function u(){this.session={}}var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS;e.GameSession=o,e.GameSession.SessionManager=u,o.prototype=new u,o.prototype.constructor=o,o.prototype.restoreStage=function(e){try{t.game.execStage(t.gameLoop.getStep(e));var n=["LOG","STATECHANGE","WINDOW_LOADED","BEFORE_LOADING","LOADED","in.say.STATE","UPDATED_PLIST","NODEGAME_READY","out.say.STATE","out.set.STATE","in.say.PLIST","STAGEDONE","out.say.HI"];return t.events.history.remit(t.game.state,n),t.info("game stage restored"),!0}catch(r){return t.err("could not restore game stage. An error has occurred: "+r),!1}},u.getVariable=function(e){s.getNestedValue(e,t)},u.setVariable=function(e,n){s.setNestedValue(e,n,t)},u.prototype.register=function(e,n){return e?(this.session[e]={get:n&&n.get?n.get:function(){return s.getNestedValue(e,t)},set:n&&n.set?n.set:function(n){s.setNestedValue(e,n,t)}},!0):(t.err("cannot add an empty path to session"),!1)},u.prototype.unregister=function(e){return e?this.session[e]?(delete this.session[e],!0):(t.err(e+" is not registered in the session"),!1):(t.err("cannot delete an empty path from session"),!1)},u.prototype.get=function(e){var t={};if(e)return this.session[e]?this.session[e].get():undefined;for(e in this.session)this.session.hasOwnProperty(e)&&(t[e]=this.session[e].get());return t},u.prototype.save=function(){var e={};for(var t in this.session)this.session.hasOwnProperty(t)&&(e[t]={value:this.session[t].get(),get:this.session[t].get,set:this.session[t].set});return e},u.prototype.load=function(e){for(var t in e)e.hasOwnProperty(t)&&this.register(t,e[t])},u.prototype.clear=function(){this.session={}},u.prototype.restore=function(e){if(!e){t.err("cannot restore empty session object");return}for(var n in e)e.hasOwnProperty(n)&&e[n].set(e[n].value);return!0},u.prototype.store=function(){},u.prototype.store=function(){}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){}function i(e){this.groups=[],this.maxIteration=10,this.doneCounter=0}function s(){this.elements=[],this.matched=[],this.leftOver=[],this.pointer=0,this.matches={},this.matches.total=0,this.matches.requested=0,this.matches.done=!1,this.rowLimit=3,this.noSelf=!0,this.pool=[],this.shuffle=!0,this.stretch=!0}function u(){var e=[],t=n.shuffle(o);return e.push(t.splice(0,n.randomInt(0,t.length))),e.push(t.splice(0,n.randomInt(0,t.length))),e.push(t),n.shuffle(e)}function a(){var e=n.shuffle(o);out=[];var t=e.splice(0,n.randomInt(0,e.length/2)),r=e.splice(0,n.randomInt(0,e.length/2)),i=e,s=t.splice(0,n.randomInt(0,t.length));t=n.shuffle([s,t]);var u=r.splice(0,n.randomInt(0,r.length));r=n.shuffle([u,r]);var a=i.splice(0,n.randomInt(0,i.length));return i=n.shuffle([a,i]),n.shuffle([t,r,i])}function f(e){for(var t=0;t<e;t++){var n=new i,r=u(),s=a();n.init(r,s);var o=n.match();n.allGroupsDone()||(console.log("ERROR"),console.log(n.options.elements),console.log(n.options.pools),console.log(o));for(var f=0;f<n.groups.length;f++){var l=n.groups[f];for(var c=0;c<l.elements.length;c++)l.matched[c].length!==l.rowLimit&&(console.log("Wrong match: "+c),console.log(n.options.elements),console.log(n.options.pools),console.log(o))}}}var n=t.JSUS;e.GroupManager=r,e.RMatcher=i,i.prototype.init=function(e,t){var n,r;for(n=0;n<e.length;n++)r=new s,r.init(e[n],t[n]),this.addGroup(r);this.options={elements:e,pools:t}},i.prototype.addGroup=function(e){if(!e)return;this.groups.push(e)},i.prototype.match=function(){var e;for(e=0;e<this.groups.length;e++)this.groups[e].match(),this.groups[e].matches.done&&this.doneCounter++;return this.allGroupsDone()||this.assignLeftOvers(),this.allGroupsDone()||this.switchBetweenGroups(),n.map(this.groups,function(e){return e.matched})},i.prototype.invertMatched=function(){var e,t=[],r=[];return n.each(this.groups,function(n){t=t.concat(n.elements),e=n.invertMatched();for(var i=0;i<e.length;i++)r[i]=(r[i]||[]).concat(e[i])}),{elements:t,inverted:r}},i.prototype.allGroupsDone=function(){return this.doneCounter===this.groups.length},i.prototype.tryOtherLeftOvers=function(e){var t,r,i=n.seq(0,this.groups.length-1);i=n.shuffle(i);for(var s=0;s<i.length;s++){r=i[s];if(r===e)continue;t=this.groups[r],leftOver=[];if(t.leftOver.length){t.leftOver=this.groups[e].matchBatch(t.leftOver);if(this.groups[e].matches.done)return this.doneCounter++,!0}}},i.prototype.assignLeftOvers=function(){var e,t;for(t=0;t<this.groups.length;t++)e=this.groups[t],e.matches.done||this.tryOtherLeftOvers(t)},i.prototype.collectLeftOver=function(){return n.map(this.groups,function(e){return e.leftOver})},i.prototype.switchFromGroup=function(e,t,n,r){var i,s,o,u,a,f;for(i=0;i<e.elements.length;i++)for(s=0;s<r.length;s++)for(o=0;o<r[s].length;o++){u=r[s][o];if(e.canSwitchIn(u,i))for(a=0;a<e.matched[i].length;a++){f=e.matched[i][a];if(t.canAdd(f,n))return e.matched[i][a]=u,t.addToRow(f,n),r[s].splice(o,1),t.matches.done&&this.doneCounter++,!0}}},i.prototype.trySwitchingBetweenGroups=function(e,t){var n=this.collectLeftOver(),r=this.groups[e],i,s;for(i=e+1;i<this.groups.length+e+1;i++){s=this.groups[i%this.groups.length];if(this.switchFromGroup(s,r,t,n)&&r.matches.done)return}return!1},i.prototype.switchBetweenGroups=function(){var e,t,n,r,i;for(e=0;e<this.groups.length;e++){t=this.groups[e];if(!t.matches.done)for(n=0;n<t.elements.length;n++){i=t.rowLimit-t.matched[n].length;if(i)for(r=0;r<i;r++){this.trySwitchingBetweenGroups(e,n);if(this.allGroupsDone())return!0}}}return!1},s.prototype.init=function(e,t){this.elements=e,this.pool=n.clone(t);for(var r=0;r<this.pool.length;r++)this.stretch&&(this.pool[r]=n.stretch(this.pool[r],this.rowLimit)),this.shuffle&&(this.pool[r]=n.shuffle(this.pool[r]));if(!e.length)this.matches.done=!0;else for(r=0;r<e.length;r++)this.matched[r]=[];this.matches.requested=this.elements.length*this.rowLimit},s.prototype.canSwitchIn=function(e,t){return n.in_array(e,this.matched[t])?!1:this.noSelf&&this.elements[t]===e?!1:!0},s.prototype.canAdd=function(e,t){return this.matched[t].length>=this.rowLimit?!1:this.canSwitchIn(e,t)},s.prototype.shouldSwitch=function(e,t){return this.leftOver.length?this.matched.length<2?!1:!0:!1},s.prototype.switchIt=function(){for(var e=0;e<this.elements.length;e++)this.matched[e].length<this.rowLimit&&this.completeRow(e)},s.prototype.completeRow=function(e,t){t=t||this.leftOver;var n=t.slice(0);for(var r=0;r<n.length;r++)for(var i=0;i<this.elements.length;i++){if(this.switchItInRow(n[r],i,e))return t.splice(r,1),!0;this.updatePointer()}return!1},s.prototype.switchItInRow=function(e,t,n){if(!this.canSwitchIn(e,t))return!1;for(var r=0;r<this.matched[t].length;r++){var i=this.matched[t][r];if(this.canAdd(i,n))return this.matched[t][r]=e,this.addToRow(i,n),!0}return!1},s.prototype.addToRow=function(e,t){this.matched[t].push(e),this.matches.total++,this.matches.total===this.matches.requested&&(this.matches.done=!0)},s.prototype.addIt=function(e){var t=0,n=!1;while(t<this.elements.length&&!n)this.canAdd(e,this.pointer)&&(this.addToRow(e,this.pointer),n=!0),this.updatePointer(),t++;return n},s.prototype.matchBatch=function(e){var t=[];for(var n=0;n<e.length;n++)(this.matches.done||!this.addIt(e[n]))&&t.push(e[n]);return t},s.prototype.match=function(e){e=e||this.pool,n.isArray(e)||(e=[e]);var t;for(var r=0;r<e.length;r++)t=this.matchBatch(e[r]),t.length&&(this.leftOver=this.leftOver.concat(t));this.shouldSwitch()&&this.switchIt()},s.prototype.updatePointer=function(){this.pointer=(this.pointer+1)%this.elements.length},s.prototype.summary=function(){console.log("elements: ",this.elements),console.log("pool: ",this.pool),console.log("left over: ",this.leftOver),console.log("hits: "+this.matches.total+"/"+this.matches.requested),console.log("matched: ",this.matched)},s.prototype.invertMatched=function(){return n.transpose(this.matched)};var o=[1,2,3,4,5,6,7,8,9]}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){}var n=t.JSUS;e.RoleMapper=r}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.EventEmitter,r=t.Socket,i=t.GameStage,s=t.GameMsg,o=t.Game,u=t.Player,a=t.GameSession,f=t.JSUS;t.env=function(e,n,r,i){if(!e||!n||!t.env[e])return;r=r||t,i=i||[],n.apply(r,i)},t.createPlayer=function(e){e=new u(e);if(t.conf&&t.conf.player){var n=t.conf.player;for(var r in n)if(n.hasOwnProperty(r)){if(f.inArray(r,["id","sid","ip"]))continue;t.support.defineProperty?Object.defineProperty(e,r,{value:n[r],enumerable:!0}):e[r]=n[r]}}return t.support.defineProperty?Object.defineProperty(t,"player",{value:e,enumerable:!0}):t.player=e,t.emit("PLAYER_CREATED",e),e},t.connect=function(e){t.socket.connect(e)&&t.emit("NODEGAME_CONNECTED")},t.play=function(e){e&&t.setup.game(e),t.game.start()},t.replay=function(e){e&&t.game.memory.clear(!0),t.game.execStage(t.gameLoop.getStep("1.1.1"))},t.emit=function(e,n,r,i){t.events.emit(e,n,r,i)},t.say=function(e,n,r){t.events.emit("out.say.DATA",e,r,n)},t.set=function(e,n){t.events.emit("out.set.DATA",n,null,e)},t.get=function(e,n){if(!e||!n)return;t.events.emit("out.get.DATA",e);var r=function(i){i.text===e&&(n.call(t.game,i.data),t.events.remove("in.say.DATA",r))};t.on("in.say.DATA",r)},t.on=function(e,n){if(!e){t.err("undefined event");return}if("function"!=typeof n){t.err("callback must be of time function");return}!t.game||!t.game.currentStepObj||i.compare(t.game.currentStepObj,new i,!0)===0?t.events.add(e,n):t.events.addLocal(e,n)},t.once=function(e,n){if(!e||!n)return;t.on(e,n),t.on(e,function(e,n){t.events.remove(e,n)})},t.off=t.removeListener=function(e,n){return t.events.remove(e,n)},t.redirect=function(e,n){if(!e||!n)return!1;var r=t.msg.create({target:t.target.REDIRECT,data:e,to:n});return t.socket.send(r),!0},t.remoteCommand=function(e,n,r){if(!e||!n)return!1;var i=t.msg.create({target:t.target.GAMECOMMAND,text:e,data:r,to:n});return t.socket.send(i)},t.info(t.version+" loaded"),t.events=new n,t.msg=t.GameMsgGenerator,t.session=new a,t.socket=t.gsc=new r,t.game=new o}(this,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.GameMsg,r=t.Player,i=t.Game,s=t.GameMsgGenerator,o=t.JSUS,u=!1;t.setup=function(n,r){if(u)return t.err("nodeGame configuration is frozen. No modification allowed."),!1;if(n==="register")return t.warn('cannot setup property "register"'),!1;if(!t.setup[n])return t.warn("no such property to configure: "+n),!1;var i=t.setup[n].call(e,r);return n!=="nodegame"&&(t.conf[n]=i),!0},t.setup.register=function(e,n){return!e||!n?(t.err("cannot register empty setup function"),!1):e==="register"?(t.err("cannot overwrite register function"),!1):(t.setup[e]=n,!0)},t.setup.register("nodegame",function(n){for(var r in t.setup)t.setup.hasOwnProperty(r)&&r!=="register"&&r!=="nodegame"&&(t.conf[r]=t.setup[r].call(e,n[r]))}),t.setup.register("socket",function(e){if(!e)return;return t.socket.setup(e),e}),t.setup.register("host",function(e){e||"undefined"!=typeof window&&"undefined"!=typeof window.location&&(e=window.location.href);if(e){var t=e.split("/").slice(0,-2);t.length>1&&(e=t.join("/")),e.lastIndexOf("/")!==e.length&&(e+="/")}return e}),t.setup.register("verbosity",function(e){return"undefined"!=typeof e&&(t.verbosity=e),e}),t.setup.register("env",function(e){if("undefined"!=typeof e)for(var n in e)e.hasOwnProperty(n)&&(t.env[n]=e[n]);return e}),t.setup.register("events",function(e){return e=e||{},"undefined"==typeof e.history&&(e.history=!1),"undefined"==typeof e.dumpEvents&&(e.dumpEvents=!1),e}),t.setup.register("window",function(e){if(!t.window){t.warn("node.window not found, cannot configure it.");return}return e=e||{},"undefined"==typeof e.promptOnleave&&(e.promptOnleave=!1),"undefined"==typeof e.noEscape&&(e.noEscape=!0),t.window.init(e),e}),t.setup.register("game",function(e){return e?("string"==typeof e&&(e=o.parse(e)),"function"==typeof e&&(e=new e),t.game=new i(e),t.emit("NODEGAME_GAME_CREATED"),t.game):{}}),t.setup.register("player",t.createPlayer),t.remoteSetup=function(e,n,r){var i,s;return e?r?(s=o.stringify(n),s?(i=t.msg.create({target:t.target.SETUP,to:r,text:e,data:s}),t.socket.send(i)):(t.err("an error occurred while stringifying payload for remote setup"),!1)):(t.err("cannot send remote setup: empty recipient"),!1):(t.err("cannot send remote setup: empty property"),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS;t.alias=function(e,n,r){if(!e||!n){t.err("undefined alias or events");return}s.isArray(n)||(n=[n]),s.each(n,function(n){t.on[e]=function(e){t.on(n,function(n){e.call(t.game,r?r(n):n)})}})},t.DONE=function(e){t.emit("DONE",e)},t.TXT=function(e,n){t.emit("out.say.TXT",e,n)},t.alias("txt","in.say.TXT"),t.alias("data",["in.say.DATA","in.set.DATA"]),t.alias("state","in.set.STATE"),t.alias("stage","in.set.STAGE"),t.alias("plist",["in.set.PLIST","in.say.PLIST"]),t.alias("pconnect","in.say.PCONNECT",function(e){return e.data}),t.onTXT=function(e){if(!e)return;t.on("",function(n){e.call(t.game,n)})},t.onDATA=function(e,n){if(!e||!n)return;t.on("in.say.DATA",function(r){r.text===e&&n.call(t.game,r)}),t.on("in.set.DATA",function(r){r.text===e&&n.call(t.game,r)})},t.onSTATE=function(e){t.on("in.set.STATE",function(n){e.call(t.game,n)})},t.onSTAGE=function(e){t.on("in.set.STAGE",function(n){e.call(t.game,n)})},t.onPLIST=function(e){t.on("in.set.PLIST",function(n){e.call(t.game,n)}),t.on("in.say.PLIST",function(n){e.call(t.game,n)})}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS;t.random={},t.random.emit=function(e,n){n=n||6e3,setTimeout(function(e){t.emit(e)},Math.random()*n,e)},t.random.exec=function(e,t){t=t||6e3,setTimeout(function(e){e.call()},Math.random()*t,e)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){if(!e)return console.log("nodeGame not found. Cannot add incoming listeners"),!1;var t=e.GameMsg,n=e.GameStage,r=e.PlayerList,i=e.Player,s=e.JSUS,o=e.action,u=e.target,a=o.SAY+".",f=o.SET+".",l=o.GET+".",c=e.IN;e.on(c+a+"PCONNECT",function(t){if(!t.data)return;e.game.pl.add(new i(t.data)),e.emit("UPDATED_PLIST")}),e.on(c+a+"PDISCONNECT",function(t){if(!t.data)return;e.game.pl.remove(t.data.id),e.emit("UPDATED_PLIST")}),e.on(c+a+"MCONNECT",function(t){if(!t.data)return;e.game.ml.add(new i(t.data)),e.emit("UPDATED_MLIST")}),e.on(c+a+"MDISCONNECT",function(t){if(!t.data)return;e.game.ml.remove(t.data.id),e.emit("UPDATED_MLIST")}),e.on(c+a+"PLIST",function(t){if(!t.data)return;e.game.pl=new r({},t.data),e.emit("UPDATED_PLIST")}),e.on(c+a+"MLIST",function(t){if(!t.data)return;e.game.ml=new r({},t.data),e.emit("UPDATED_MLIST")}),e.on(c+l+"DATA",function(t){t.text==="LOOP"&&e.socket.sendDATA(o.SAY,e.game.gameLoop,t.from,"GAME")}),e.on(c+f+"STATE",function(t){e.game.memory.add(t.text,t.data,t.from)}),e.on(c+f+"DATA",function(t){e.game.memory.add(t.text,t.data,t.from)}),e.on(c+a+"STAGE",function(t){e.socket.serverid&&t.from===e.socket.serverid,e.game.pl.exist(t.from)?(e.game.pl.updatePlayerStage(t.from,t.data),e.emit("UPDATED_PLIST"),e.game.pl.checkStage()):e.game.execStage(e.gameLoop.getStep(t.data))}),e.on(c+a+"REDIRECT",function(t){if(!t.data)return;if("undefined"==typeof window||!window.location)return e.log("window.location not found. Cannot redirect","err"),!1;window.location=t.data}),e.on(c+a+"SETUP",function(t){if(!t.text)return;var n=t.text,r=JSUS.parse(t.data);if(!r)return e.err("error while parsing incoming remote setup message"),!1;e.setup(n,r)}),e.on(c+a+"GAMECOMMAND",function(t){if(!t.text||!e.gamecommand[t.text]){e.err("unknown game command received: "+t.text);return}e.emit("NODEGAME_GAMECOMMAND_"+t.text,t.data)}),e.on(c+a+"JOIN",function(t){if(!t.text)return;e.connect(t.text)}),e.log("incoming listeners added")}("undefined"!=typeof node?node:module.parent.exports),function(e){if(!e)return console.log("nodeGame not found. Cannot add outgoing listeners"),!1;var t=e.GameMsg,n=e.GameState,r=e.action,i=e.target,s=r.SAY+".",o=r.SET+".",u=r.GET+".",a=e.OUT;e.on(a+s+"STAGE",function(t,n){e.socket.sendSTAGE(r.SAY,t,n)}),e.on(a+s+"STAGE",function(t,n){e.socket.sendSTAGE(r.SAY,t,n)}),e.on(a+s+"TXT",function(t,n){e.socket.sendTXT(t,n)}),e.on(a+s+"DATA",function(t,n,i){e.socket.sendDATA(r.SAY,t,n,i)}),e.on(a+o+"STAGE",function(t,n){e.socket.sendSTAGE(r.SET,t,n)}),e.on(a+o+"DATA",function(t,n,i){e.socket.sendDATA(r.SET,t,n,i)}),e.on(a+u+"DATA",function(t,n,i){e.socket.sendDATA(r.GET,t,n,t)}),e.log("outgoing listeners added")}("undefined"!=typeof node?node:module.parent.exports),function(e){if(!e)return console.log("nodeGame not found. Cannot add internal listeners"),!1;var t=e.action,n=e.target,r=e.GameMsg,i=e.GameStage,s=e.Game,o=t.SAY+".",u=t.SET+".",a=t.GET+".",f=e.IN,l=e.OUT;e.on("STAGEDONE",function(){if(e.game.solo_mode)return;if(e.game.auto_step&&!e.game.observer){e.log("We play AUTO","DEBUG");var t="undefined"!=typeof e.game.minPlayers?e.game.minPlayers-e.game.pl.count():0;e.log("Additional player required: "+t>0?MorePlayers:0,"DEBUG"),t>0?(e.emit(l+o+n.TXT,t+" player/s still needed to play the game"),e.log(t+" player/s still needed to play the game")):(e.emit(l+o+n.TXT,e.game.minPlayers+" players ready. Game can proceed"),e.log(e.game.pl.count()+" players ready. Game can proceed"),e.game.step())}else e.log("Waiting for monitor to step","DEBUG")}),e.on("DONE",function(t,n,r){var i=!0,o=e.game.currentStepObj.done;o&&(i=o.call(e.game,t,n,r));if(!i)return;e.game.updateStageLevel(s.stageLevels.DONE),e.emit("BEFORE_DONE"),e.game.auto_wait&&e.window&&e.emit("WAITING..."),e.game.publishUpdate(),e.game.shouldStep()}),e.on("WINDOW_LOADED",function(){e.game.ready&&e.emit("LOADED")}),e.on("GAME_LOADED",function(){e.game.ready&&e.emit("LOADED")}),e.on("LOADED",function(){e.emit("BEFORE_LOADING"),e.game.updateStageLevel("PLAYING"),e.socket.clearBuffer()}),e.on("NODEGAME_GAMECOMMAND_"+e.gamecommand.start,function(t){e.emit("BEFORE_GAMECOMMAND",e.gamecommand.start,t);if(e.game.currentStepObj&&e.game.currentStepObj.stage!==0){e.err("Game already started. Use restart if you want to start the game again");return}e.game.start()}),e.log("internal listeners added")}("undefined"!=typeof node?node:module.parent.exports)