/**
 * # nodeGame
 *
 * Social Experiments in the Browser
 *
 * Copyright(c) 2013 Stefano Balietti
 * MIT Licensed
 *
 * nodeGame is a free, open source, event-driven javascript framework for on line,
 * multiplayer games in the browser.
 */
(function(e){"undefined"!=typeof JSUS&&(e.JSUS=JSUS),"undefined"!=typeof NDDB&&(e.NDDB=NDDB),"undefined"!=typeof store&&(e.store=store),e.support=JSUS.compatibility()})("object"==typeof module?module.exports:window.node={}),function(e){var t=e.constants={};t.version="1.0.0-beta",t.verbosity_levels={ALWAYS:-(Number.MIN_VALUE+1),ERR:-1,WARN:0,INFO:1,SILLY:10,DEBUG:100,NEVER:Number.MIN_VALUE-1},t.verbosity=t.verbosity_levels.WARN,t.remoteVerbosity=t.verbosity_levels.WARN,t.action={},t.action.SET="set",t.action.GET="get",t.action.SAY="say",t.target={},t.target.DATA="DATA",t.target.HI="HI",t.target.HI_AGAIN="HI_AGAIN",t.target.PCONNECT="PCONNECT",t.target.PDISCONNECT="PDISCONNECT",t.target.MCONNECT="MCONNECT",t.target.MDISCONNECT="MDISCONNECT",t.target.PLIST="PLIST",t.target.MLIST="MLIST",t.target.PLAYER_UPDATE="PLAYER_UPDATE",t.target.STATE="STATE",t.target.STAGE="STAGE",t.target.STAGE_LEVEL="STAGE_LEVEL",t.target.REDIRECT="REDIRECT",t.target.SETUP="SETUP",t.target.GAMECOMMAND="GAMECOMMAND",t.target.JOIN="JOIN",t.target.LOG="LOG",t.target.TXT="TXT",t.target.BYE="BYE",t.target.ACK="ACK",t.target.WARN="WARN",t.target.ERR="ERR",t.gamecommand={start:"start",pause:"pause",resume:"resume",stop:"stop",restart:"restart",goto_stage:"goto_stage"},t.IN="in.",t.OUT="out.",t.is={},t.is.UNKNOWN=0,t.is.INITIALIZING=1,t.is.INITIALIZED=5,t.is.GAMELOADED=10,t.is.DEAD=-1,t.is.LOADING=10,t.is.LOADED=25,t.is.PLAYING=50,t.is.DONE=100,t.stateLevels={UNINITIALIZED:0,STARTING:1,INITIALIZING:2,INITIALIZED:5,STAGE_INIT:10,STEP_INIT:20,PLAYING_STEP:30,FINISHING:40,GAMEOVER:100,RUNTIME_ERROR:-1},t.stageLevels={UNINITIALIZED:0,INITIALIZING:1,INITIALIZED:5,LOADING:30,LOADED:40,PLAYING:50,PAUSING:55,PAUSED:60,RESUMING:65,RESUMED:70,DONE:100},t.UNDEFINED_PLAYER=-1}("undefined"!=typeof node?node:module.exports),function(e,t){e.stepRules={};var n=t;e.stepRules.SYNC_STEP=function(e,t,r,i){return t===n.constants.stageLevels.DONE&&r.isStepDone(e)},e.stepRules.SOLO=function(e,t,r,i){return t===n.constants.stageLevels.DONE},e.stepRules.WAIT=function(e,t,n,r){return!1},e.stepRules.SYNC_STAGE=function(e,t,r,i){var s=t===n.constants.stageLevels.DONE;return console.log(),console.log("*** myStageLevel: "+t+" (iamdone: "+s+")"),console.log("*** stepsToNextStage: "+i.plot.stepsToNextStage(e)),console.log("*** isStepDone [upTo]: "+r.isStepDone(e,!0)),i.plot.stepsToNextStage(e)>1?s:s&&r.isStepDone(e,!0)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){throw this.msg=e,this.stack=(new Error).stack,new Error("Runtime: "+e)}function i(e){throw this.msg=e,this.stack=(new Error).stack,"StageCallback: "+e}function s(e){throw this.msg=e,this.stack=(new Error).stack,"MisconfiguredGame: "+e}function o(e){throw this.msg=e,this.stack=(new Error).stack,"IllegalOperation: "+e}var n=t.JSUS;t.NodeGameRuntimeError=r,t.NodeGameStageCallbackError=i,t.NodeGameMisconfiguredGameError=s,t.NodeGameIllegalOperationError=o,r.prototype=new Error,r.prototype.constructor=r,r.prototype.name="NodeGameRuntimeError",i.prototype=new Error,i.prototype.constructor=i,i.prototype.name="NodeGameStageCallbackError",s.prototype=new Error,s.prototype.constructor=s,s.prototype.name="NodeGameMisconfiguredGameError",o.prototype=new Error,o.prototype.constructor=o,o.prototype.name="NodeGameIllegalOperationError",n.isNodeJS()}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e,t){this.node=t,this.name="undefined"!=typeof e?e:"EE",this.events={},this.history=new u(this.node)}function o(e){this.node=e,this.ee={},this.createEE("ng"),this.createEE("game"),this.createEE("stage"),this.createEE("step"),this.createEEGroup("game","step","stage","game"),this.createEEGroup("stage","stage","game")}function u(e){this.node=e,this.history=new n,this.history.h("stage",function(t){var n;if(!t)return;return n="object"==typeof t.stage?t.stage:this.node.game.stage,e.GameStage.toHash(n,"S.s.r")})}var n=t.NDDB,r=t.GameStage;e.EventEmitter=s,e.EventEmitterManager=o,s.prototype.on=function(e,t){if("string"!=typeof e)throw TypeError("EventEmitter.on: type must be a string");if("function"!=typeof t)throw TypeError("EventEmitter.remove: listener must be a function");this.events[e]?typeof this.events[e]=="object"?this.events[e].push(t):this.events[e]=[this.events[e],t]:this.events[e]=t,this.node.silly("ee."+this.name+" added listener: "+e+" "+t)},s.prototype.once=function(e,t){function r(){this.remove(e,r),t.apply(n.game,arguments)}var n=this.node;this.on(e,r)},s.prototype.emit=function(){var e,t,n,r,i,s,o,u;s=arguments[0],e=this.events[s];if("undefined"==typeof e)return!1;u=this.node,o=u.game,this.node.conf.events.dumpEvents&&this.node.log("F: "+s);if("function"==typeof e)switch(arguments.length){case 1:e.call(o);break;case 2:e.call(o,arguments[1]);break;case 3:e.call(o,arguments[1],arguments[2]);break;case 4:e.call(o,arguments[1],arguments[2],arguments[3]);break;default:t=arguments.length,n=new Array(t-1);for(r=1;r<t;r++)n[r-1]=arguments[r];e.apply(o,n)}else if("object"==typeof e){t=arguments.length,n=new Array(t-1);for(r=1;r<t;r++)n[r-1]=arguments[r];i=e.slice(),t=i.length;for(r=0;r<t;r++)i[r].apply(u.game,n)}u.conf&&u.conf.events&&u.conf.events.history&&this.history.insert({stage:u.game.getCurrentGameStage(),args:arguments})},s.prototype.remove=function(e,t){var n,r,i,e,s;s=this.node;if("string"!=typeof e)throw TypeError("EventEmitter.remove ("+this.name+"): type must be a string");if(!this.events[e])return s.warn("EventEmitter.remove ("+this.name+"): unexisting event "+e),!1;if(!t)return delete this.events[e],s.silly("Removed listener "+e),!0;if(t&&"function"!=typeof t)throw TypeError("EventEmitter.remove ("+this.name+"): listener must be a function");if("function"==typeof this.events[e]){if(n==t)return n.splice(i,1),s.silly("ee."+this.name+" removed listener: "+e+" "+t),!0}else{n=this.events[e],r=n.length;for(i=0;i<r;i++)if(n[i]==t)return n.splice(i,1),s.silly("ee."+this.name+"removed listener: "+e+" "+t),!0}return s.warn("EventEmitter.remove ("+this.name+"): no listener-match found for event "+e),!1},s.prototype.clear=function(){this.events={}},s.prototype.printAll=function(){for(var e in this.events)this.events.hasOwnProperty(e)&&console.log(e+": "+e.length?e.length:"1 listener/s")},o.prototype.createEEGroup=function(e){var t,n,r;t=arguments.length,n=this;if(!t)throw new Error("EEGroup needs a name and valid members");if(t===1)throw new Error("EEGroup needs at least one member");for(i=1;i<t;i++){if("string"!=typeof arguments[i])throw new TypeError("EventEmitter name must be a string");if(!this.ee[arguments[i]])throw new Error("non-existing EventEmitter in group "+e+": "+arguments[i])}r=new Array(t-1);for(i=1;i<t;i++)r[i-1]=arguments[i];switch(t){case 2:this[e]=this.ee[r[0]];break;case 3:this[e]={emit:function(){n.ee[r[0]].emit(arguments),n.ee[r[1]].emit(arguments)},on:this.ee[r[0]].on,once:this.ee[r[1]].once,clear:function(){n.ee[r[0]].clear(),n.ee[r[1]].clear()},remove:function(){n.ee[r[0]].remove(arguments),n.ee[r[1]].remove(arguments)},printAll:function(){n.ee[r[0]].printAll(),n.ee[r[1]].printAll()}};break;case 4:this[e]={emit:function(){n.ee[r[0]].emit(arguments),n.ee[r[1]].emit(arguments),n.ee[r[2]].emit(arguments)},on:this.ee[r[0]].on,once:this.ee[r[1]].once,clear:function(){n.ee[r[0]].clear(),n.ee[r[1]].clear(),n.ee[r[2]].clear()},remove:function(){n.ee[r[0]].remove(arguments),n.ee[r[1]].remove(arguments),n.ee[r[2]].remove(arguments)},printAll:function(){n.ee[r[0]].printAll(),n.ee[r[1]].printAll(),n.ee[r[2]].printAll()}};break;default:t=r.len,this[e]={emit:function(){for(i=0;i<t;i++)n.ee[r[i]].emit(arguments)},on:this.ee[r[0]].on,once:this.ee[r[1]].once,clear:function(){for(i=0;i<t;i++)n.ee[r[i]].clear()},remove:function(){for(i=0;i<t;i++)n.ee[r[i]].remove(arguments)},printAll:function(){for(i=0;i<t;i++)n.ee[r[i]].printAll()}}}return this[e]},o.prototype.createEE=function(e){return this.ee[e]=new s(e,this.node),this[e]=this.ee[e],this.ee[e]},o.prototype.destroyEE=function(e){var t;t=this.ee[e];if(!t)return this.node.warn("cannot destroy undefined EventEmitter"),!1;delete this[e],delete this.ee[e]},o.prototype.clear=function(){for(i in this.ee)this.ee.hasOwnProperty(i)&&this.ee[i].clear()},o.prototype.emit=function(){var e,t;t=arguments[0];if("undefined"==typeof t)return this.node.warn("cannot emit undefined event"),!1;for(e in this.ee)this.ee.hasOwnProperty(e)&&this.ee[e].emit.apply(this.ee[e],arguments)},o.prototype.remove=function(e,t){var n;if("string"!=typeof e)return this.node.err("EventEmitterManager.remove: event must be string."),!1;if(t&&"function"!=typeof t)return this.node.err("EventEmitterManager.remove: listener must be function."),!1;for(n in this.ee)this.ee.hasOwnProperty(n)&&this.ee[n].remove(e,t)},u.prototype.remit=function(e,t,n){var i,s,o,u;u=this.node;if(!this.history.count())return u.log("no event history was found to remit","WARN"),!1;u.silly("remitting "+u.events.history.count()+" events");if(e){this.history.rebuildIndexes(),i=(new r(session.stage)).toHash("S.s.r");if(!this.history.stage)return u.silly("no old events to re-emit were found during session recovery"),!1;if(!this.history.stage[i])return u.silly("the current stage "+i+" has no events to re-emit"),!1;s=this.history.stage[i]}else s=this.history;return t&&s.select("event","in",t).remove(),n&&(s=s.select("event","in",n)),s.count()?(o=function(){u.silly("re-emitting "+s.count()+" events"),s.each(function(e){u.emit(e.event,e.p1,e.p2,e.p3)})},u.game.isReady()?o.call(u.game):u.on("LOADED",function(){o.call(u.game)}),!0):(u.silly("no valid events to re-emit after cleanup"),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function n(e){this.stage=0,this.step=1,this.round=1;if(!e||"undefined"==typeof e)this.stage=0,this.step=0,this.round=0;else if("string"==typeof e){var t=e.split("."),n=parseInt(t[0],10),r=parseInt(t[1],10),i=parseInt(t[2],10);t[0]&&(this.stage=isNaN(n)?t[0]:n),"undefined"!=typeof t[1]&&(this.step=isNaN(r)?t[1]:r),"undefined"!=typeof t[2]&&(this.round=i)}else"object"==typeof e&&("undefined"!=typeof e.stage&&(this.stage=e.stage),"undefined"!=typeof e.step&&(this.step=e.step),"undefined"!=typeof e.round&&(this.round=e.round))}e.GameStage=n,n.defaults={},n.defaults.hash="S.s.r",n.prototype.toString=function(){return this.toHash("S.s.r")},n.prototype.toHash=function(e){return n.toHash(this,e)},n.toHash=function(e,t){if(!e||"object"!=typeof e)return!1;if(!t||!t.length)return e.toString();var n="",r="Ssr",i=["stage","step","round"];for(var s=0;s<t.length;s++){var o=r.indexOf(t[s]);n+=o<0?t[s]:e[i[o]]}return n},n.compare=function(e,t){var r;return"undefined"==typeof e&&"undefined"==typeof t?0:"undefined"==typeof t?1:"undefined"==typeof e?-1:("string"==typeof e&&(e=new n(e)),"string"==typeof t&&(t=new n(t)),r=e.stage-t.stage,r===0&&"undefined"!=typeof e.round&&(r=e.round-t.round,r===0&&"undefined"!=typeof e.step&&(r=e.step-t.step)),r)},n.stringify=function(e){if(!e)return;var t=(new n(e)).toHash("(r) S.s_i");return t}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function f(e,t){e=e||{},e.update||(e.update={}),"undefined"==typeof e.update.indexes&&(e.update.indexes=!0),e.I||(e.I={}),"undefined"==typeof e.I.id&&(e.I.id=function(e){return e.id}),this.id||this.index("id",function(e){return e.id}),r.call(this,e,t),this.globalCompare=f.comparePlayers,this.pcounter=this.db.length||0}function l(e){var t;if(!e||!e.id)throw new TypeError("Player: invalid player parameter");this.id=e.id,this.sid=e.sid,this.count=e.count,this.admin=!!e.admin,this.disconnected=!!e.disconnected,this.ip=e.ip,this.name=e.name,this.stage=e.stage||new i,this.stageLevel=e.stageLevel||u.UNINITIALIZED,this.stateLevel=e.stateLevel||a.UNINITIALIZED;for(t in e)e.hasOwnProperty(t)&&"function"!=typeof e[t]&&(this.hasOwnProperty(t)||(this[t]=e[t]))}e.PlayerList=f;var n=t.JSUS,r=t.NDDB,i=t.GameStage,s=t.Game,o=t.NodeGameRuntimeError,u=t.constants.stageLevels,a=t.constants.stateLevels;f.prototype=new r,f.prototype.constructor=f,f.comparePlayers=function(e,t){return e.id===t.id?0:e.count<t.count?1:e.count>t.count?-1:0},f.prototype.importDB=function(e){var t;if(!e)return;for(t=0;t<e.length;t++)this.add(e[t])},f.prototype.add=function(e){if(!(e instanceof l)){if(!e||"undefined"==typeof e.id)throw new o("PlayerList.add: player.id was not given");e=new l(e)}if(this.exist(e.id))throw new o("PlayerList.add: Player already exists (id "+e.id+")");return this.insert(e),e.count=this.pcounter,this.pcounter++,e},f.prototype.get=function(e){var t;if("undefined"==typeof e)throw new o("PlayerList.get: id was not given");t=this.id.get(e);if(!t)throw new o("PlayerList.get: Player not found (id "+e+")");return t},f.prototype.remove=function(e){var t;if("undefined"==typeof e)throw new o("PlayerList.remove: id was not given");t=this.id.pop(e);if(!t)throw new o("PlayerList.remove: Player not found (id "+e+")");return t},f.prototype.pop=f.prototype.remove,f.prototype.exist=function(e){return this.id.get(e)?!0:!1},f.prototype.updatePlayer=function(e,t){if(!this.exist(e))throw new o("PlayerList.updatePlayer: Player not found (id "+e+")");if("undefined"==typeof t)throw new o("PlayerList.updatePlayer: Attempt to assign to a player an undefined playerState");return this.id.update(e,t)},f.prototype.updatePlayerStage=function(e,t){if(!this.exist(e))throw new o("PlayerList.updatePlayerStage: Player not found (id "+e+")");if("undefined"==typeof t)throw new o("PlayerList.updatePlayerStage: Attempt to assign to a player an undefined stage");return this.id.update(e,{stage:t})},f.prototype.updatePlayerStageLevel=function(e,t){if(!this.exist(e))throw new o("PlayerList.updatePlayerStageLevel: Player not found (id "+e+")");if("undefined"==typeof t)throw new o("PlayerList.updatePlayerStageLevel: Attempt to assign to a player an undefined stage");return this.id.update(e,{stageLevel:t})},f.prototype.isStepDone=function(e,t){var n,r,s;if(!e)return!1;t=!!t;for(r=0;r<this.db.length;r++){n=this.db[r],s=i.compare(e,n.stage);if(t){if(e.stage!==n.stage.stage)continue;if(s<0)continue;if(s>0)return!1}else if(s!==0)continue;if(n.stageLevel!==u.DONE)return!1}return!0},f.prototype.toString=function(e){var t="",n=e||"\n",r;return this.forEach(function(e){t+=e.id+": "+e.name,r=new i(e.stage),t+=": "+r+n}),t},f.prototype.getNGroups=function(e){if(!e)return;var t=n.getNGroups(this.db,e);return f.array2Groups(t)},f.prototype.getGroupsSizeN=function(e){if(!e)return;var t=n.getGroupsSizeN(this.db,e);return f.array2Groups(t)},f.prototype.getRandom=function(e){e||(e=1);if(e<1)throw new o("PlayerList.getRandom: N must be an integer >= 1");return this.shuffle(),this.limit(e).fetch()},e.Player=l,l.prototype.toString=function(){return(this.name||"")+" ("+this.id+") "+new i(this.stage)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function i(e){e=e||{};var n=e.id||Math.floor(Math.random()*1e6);t.support.defineProperty?Object.defineProperty(this,"id",{value:n,enumerable:!0}):this.id=n;var i=e.session;t.support.defineProperty?Object.defineProperty(this,"session",{value:i,enumerable:!0}):this.session=i,this.stage=e.stage,this.action=e.action,this.target=e.target,this.from=e.from,this.to=e.to,this.text=e.text,this.data=e.data,this.priority=e.priority,this.reliable=e.reliable,this.created=r.getDate(),this.forward=0}var n=t.GameStage,r=t.JSUS;e.GameMsg=i,i.clone=function(e){return new i(e)},i.prototype.stringify=function(){return JSON.stringify(this)},i.prototype.toString=function(){var e,t,r,i,s,o;return e=",	",t="	",r='"',s='"unknown"	',i=this.created+e,i+=this.id+e,i+=this.session+e,i+=this.action+e,i+=this.target?this.target.length<6?this.target+e+t:this.target+e:s,i+=this.from?this.from.length<6?this.from+e+t:this.from+e:UKNOWN,i+=this.to?this.to.length<6?this.to+e+t:this.to+e:s,this.text?(o=this.text.toString(),o.length>9?i+=r+o.substr(0,9)+"..."+r+e:o.length<6?i+=r+o+r+e+t:i+=r+o+r+e):i+='"no text"'+e,this.data?(o=this.data.toString(),o.length>9?i+=r+o.substr(0,9)+"..."+r+e:o.length<6?i+=r+o+r+e+t:i+=r+o+r+e):i+='"no data"'+e,i+=new n(this.stage)+e,i+=this.reliable+e,i+=this.priority,i},i.prototype.toSMS=function(){var e=/\w+/,t=e.exec(this.created),n="["+this.from+"]->["+this.to+"]	";return n+="|"+this.action+"."+this.target+"|"+"	",n+=" "+this.text+" ",n},i.prototype.toInEvent=function(){return"in."+this.toEvent()},i.prototype.toOutEvent=function(){return"out."+this.toEvent()},i.prototype.toEvent=function(){return this.action+"."+this.target}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(e){e?this.setState(e):this.clear()}function i(e,t,n){var r=this.handleAlias(t);if(r===null)throw new Error("Stager."+e+": received invalid stage name.");"undefined"==typeof n&&(n=function(){return!0});if("function"!=typeof n)throw new Error("Stager."+e+": received invalid callback.");return this.sequence.push({type:e,id:r,cb:n}),this}e.Stager=r;var n=t.stepRules;r.prototype.clear=function(){return this.steps={},this.stages={},this.sequence=[],this.generalNextFunction=null,this.nextFunctions={},this.setDefaultStepRule(),this.defaultGlobals={},this.defaultProperties={},this.onInit=null,this.onGameover=null,this},r.prototype.registerGeneralNext=function(e){return e!==null&&"function"!=typeof e?(this.log("Stager.registerGeneralNext: expecting a function as parameter."),!1):(this.generalNextFunction=e,!0)},r.prototype.registerNext=function(e,t){return"function"!=typeof t?(this.log("Stager.registerNext: expecting a function as parameter."),!1):this.stages[e]?(this.nextFunctions[e]=t,!0):(this.log("Stager.registerNext: received nonexistent stage id"),!1)},r.prototype.setDefaultStepRule=function(e){if(e){if("function"!=typeof e)throw new Error("Stager.setDefaultStepRule: expecting a function as parameter.");this.defaultStepRule=e}else this.defaultStepRule=n.SOLO;return!0},r.prototype.getDefaultStepRule=function(){return this.defaultStepRule},r.prototype.setDefaultGlobals=function(e){return!e||"object"!=typeof e?(this.log("Stager.setDefaultGlobals: expecting an object as parameter."),!1):(this.defaultGlobals=e,!0)},r.prototype.getDefaultGlobals=function(){return this.defaultGlobals},r.prototype.setDefaultProperties=function(e){if(!e||"object"!=typeof e)throw new Error("Stager.setDefaultProperties: expecting an object as parameter.");return this.defaultProperties=e,!0},r.prototype.getDefaultProperties=function(){return this.defaultProperties},r.prototype.setOnInit=function(e){if(e!==null&&"function"!=typeof e)throw new Error("Stager.setOnInit: expecting a function as parameter.");return this.onInit=e,!0},r.prototype.getOnInit=function(e){return this.onInit},r.prototype.setOnGameover=function(e){if(e!==null&&"function"!=typeof e)throw new Error("Stager.setOnGameover: expecting a function as parameter.");return this.onGameover=e,!0},r.prototype.setOnGameOver=r.prototype.setOnGameover,r.prototype.getOnGameover=function(e){return this.onGameover},r.prototype.addStep=function(e){if(!this.checkStepValidity(e))throw new Error("Stager.addStep: invalid step received.");return this.steps[e.id]=e,!0},r.prototype.addStage=function(e){if(this.checkStepValidity(e))return this.addStep(e)?this.addStage({id:e.id,steps:[e.id]})?!0:!1:!1;if(!this.checkStageValidity(e))throw new Error("Stager.addStage: invalid stage received.");return this.stages[e.id]=e,!0},r.prototype.init=function(){return this.sequence=[],this},r.prototype.gameover=function(){return this.sequence.push({type:"gameover"}),this},r.prototype.next=function(e){var t=this.handleAlias(e);if(t===null)throw new Error("Stager.next: invalid stage name received.");return this.sequence.push({type:"plain",id:t}),this},r.prototype.repeat=function(e,t){var n=this.handleAlias(e);if(n===null)throw new Error("Stager.repeat: received invalid stage name.");if("number"!=typeof t)throw new Error("Stager.repeat: received invalid number of repetitions.");return this.sequence.push({type:"repeat",id:n,num:t}),this},r.prototype.loop=function(e,t){return i.call(this,"loop",e,t)},r.prototype.doLoop=function(e,t){return i.call(this,"doLoop",e,t)},r.prototype.getSequence=function(e){var t,n,r,i,s=!1;switch(e){case"hstages":t=[];for(n in this.sequence)if(this.sequence.hasOwnProperty(n)){r=this.sequence[n];switch(r.type){case"gameover":t.push("[game over]");break;case"plain":t.push(r.id);break;case"repeat":t.push(r.id+" [x"+r.num+"]");break;case"loop":t.push(r.id+" [loop]");break;case"doLoop":t.push(r.id+" [doLoop]");break;default:throw new Error("Stager.getSequence: unknown sequence object type.")}}break;case"hsteps":t=[];for(n in this.sequence)if(this.sequence.hasOwnProperty(n)){r=this.sequence[n],i=r.id+".";switch(r.type){case"gameover":t.push("[game over]");break;case"plain":this.stages[r.id].steps.map(function(e){t.push(i+e)});break;case"repeat":this.stages[r.id].steps.map(function(e){t.push(i+e+" [x"+r.num+"]")});break;case"loop":this.stages[r.id].steps.map(function(e){t.push(i+e+" [loop]")});break;case"doLoop":this.stages[r.id].steps.map(function(e){t.push(i+e+" [doLoop]")});break;default:throw new Error("Stager.getSequence: unknown sequence object type.")}}break;case"o":t=this.sequence;break;default:throw new Error("Stager.getSequence: invalid format.")}return t},r.prototype.getStepsFromStage=function(e){return this.stages[e]?this.stages[e].steps:null},r.prototype.setState=function(e,t){var n,r,i;if(!t||t==="replace")this.clear();else if(t!=="append")throw new Error("Stager.setState: invalid updateRule.");if(!e)throw new Error("Stager.setState: invalid stateObj.");for(n in e.steps)if(e.steps.hasOwnProperty(n)&&!this.addStep(e.steps[n]))throw new Error("Stager.setState: invalid steps.");for(n in e.stages){r=e.stages[n];if(e.stages.hasOwnProperty(n)&&r.id===n&&!this.addStage(r))throw new Error("Stager.setState: invalid stages.")}for(n in e.stages)r=e.stages[n],e.stages.hasOwnProperty(n)&&r.id!==n&&(this.stages[n]=this.stages[r.id]);if(e.hasOwnProperty("sequence"))for(n=0;n<e.sequence.length;n++){i=e.sequence[n];switch(i.type){case"gameover":this.gameover();break;case"plain":if(!this.next(i.id))throw new Error("Stager.setState: invalid sequence.");break;case"repeat":if(!this.repeat(i.id,i.num))throw new Error("Stager.setState: invalid sequence.");break;case"loop":if(!this.loop(i.id,i.cb))throw new Error("Stager.setState: invalid sequence.");break;case"doLoop":if(!this.doLoop(i.id,i.cb))throw new Error("Stager.setState: invalid sequence.");break;default:throw new Error("Stager.setState: invalid sequence.")}}if(e.hasOwnProperty("generalNextFunction")&&!this.registerGeneralNext(e.generalNextFunction))throw new Error("Stager.setState: invalid general next-decider.");for(n in e.nextFunctions)if(e.nextFunctions.hasOwnProperty(n)&&!this.registerNext(n,e.nextFunctions[n]))throw new Error("Stager.setState: invalid specific next-deciders.");if(e.hasOwnProperty("defaultStepRule")&&!this.setDefaultStepRule(e.defaultStepRule))throw new Error("Stager.setState: invalid default step-rule.");if(e.hasOwnProperty("defaultGlobals")&&!this.setDefaultGlobals(e.defaultGlobals))throw new Error("Stager.setState: invalid default globals.");if(e.hasOwnProperty("defaultProperties")&&!this.setDefaultProperties(e.defaultProperties))throw new Error("Stager.setState: invalid default properties.");if(e.hasOwnProperty("onInit")&&!this.setOnInit(e.onInit))throw new Error("Stager.setState: invalid onInit.");if(e.hasOwnProperty("onGameover")&&!this.setOnGameover(e.onGameover))throw new Error("Stager.setState: invalid onGameover.")},r.prototype.getState=function(){return{steps:this.steps,stages:this.stages,sequence:this.sequence,generalNextFunction:this.generalNextFunction,nextFunctions:this.nextFunctions,defaultStepRule:this.defaultStepRule,defaultGlobals:this.defaultGlobals,defaultProperties:this.defaultProperties,onInit:this.onInit,onGameover:this.onGameover}},r.prototype.extractStage=function(e,t){var n={steps:{},stages:{},sequence:[]},r,i,s,o,u,a;if(e instanceof Array)u=e;else{if("string"!=typeof e)return null;u=[e]}t=t===!1?!1:!0;for(a in u)if(u.hasOwnProperty(a)){id=u[a],o=this.stages[id];if(!o)return null;for(r in o.steps)o.steps.hasOwnProperty(r)&&(i=o.steps[r],n.steps[i]=this.steps[i]);s=o.id,n.stages[s]=o,s!==id&&(n.stages[id]=o),t&&n.sequence.push({type:"plain",id:s})}return n},r.prototype.checkStepValidity=function(e){return e?"string"!=typeof e.id?!1:"function"!=typeof e.cb?!1:!0:!1},r.prototype.checkStageValidity=function(e){if(!e)return!1;if("string"!=typeof e.id)return!1;if(!e.steps&&!e.steps.length)return!1;for(var t in e.steps)if(e.steps.hasOwnProperty(t)&&!this.steps[e.steps[t]])return!1;return!0},r.prototype.handleAlias=function(e){var t=e.split(" AS "),n=t[0].trim(),r=t[1]?t[1].trim():undefined,i=r||n,s;if(!this.stages[n])throw new Error("Stager.handleAlias: received nonexistent stage id.");for(s in this.sequence)if(this.sequence.hasOwnProperty(s)&&this.sequence[s].id===i)throw new Error("Stager.handleAlias: received non-unique stage name.");return r?(this.stages[r]=this.stages[n],r):n}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function u(e){this.init(e),this.log=console.log}e.GamePlot=u;var n=t.Stager,r=t.GameStage,i=t.JSUS,s=t.NodeGameMisconfiguredGameError,o=t.NodeGameRuntimeError;u.GAMEOVER="NODEGAME_GAMEOVER",u.END_SEQ="NODEGAME_END_SEQ",u.NO_SEQ="NODEGAME_NO_SEQ",u.prototype.init=function(e){if(e){if("object"!=typeof e)throw new s("GamePlot.init: called with invalid stager");this.stager=e}else this.stager=null},u.prototype.next=function(e){if(!this.stager)return u.NO_SEQ;var t=this.stager.sequence.length===0,n,i=null,s,o,a,f=null,l=null;e=new r(e);if(t){if(e.stage===0)return this.stager.generalNextFunction&&(l=this.stager.generalNextFunction()),l?new r({stage:l,step:1,round:1}):u.END_SEQ;s=this.stager.stages[e.stage];if("undefined"==typeof s)throw new NodeGameRunTimeError("GamePlot.next: received nonexistent stage: "+e.stage);"number"==typeof e.step?a=e.step:a=s.steps.indexOf(e.step)+1;if(a<1)throw new NodeGameRunTimeError("GamePlot.next: received nonexistent step: "+s.id+"."+e.step);return a+1<=s.steps.length?new r({stage:s.id,step:a+1,round:1}):(this.stager.nextFunctions[s.id]?l=this.stager.nextFunctions[s.id]():this.stager.generalNextFunction&&(l=this.stager.generalNextFunction()),l===u.GAMEOVER?u.GAMEOVER:l?new r({stage:l,step:1,round:1}):u.END_SEQ)}if(e.stage===0)return new r({stage:1,step:1,round:1});f=this.normalizeGameStage(e);if(f===null)throw new("next received invalid stage: "+e);o=f.stage,a=f.step,i=this.stager.sequence[o-1];if(i.type==="gameover")return u.GAMEOVER;s=this.stager.stages[i.id];if(a+1<=s.steps.length)return new r({stage:o,step:a+1,round:f.round});if(i.type==="repeat"&&f.round+1<=i.num)return new r({stage:o,step:1,round:f.round+1});if(i.type!=="doLoop"&&i.type!=="loop"||!i.cb()){if(o<this.stager.sequence.length){while(this.stager.sequence[o].type==="loop"&&!this.stager.sequence[o].cb()){o++;if(o>=this.stager.sequence.length)return u.END_SEQ}return this.stager.sequence[o].type==="gameover"?u.GAMEOVER:new r({stage:o+1,step:1,round:1})}return u.END_SEQ}return new r({stage:o,step:1,round:f.round+1})},u.prototype.previous=function(e){if(!this.stager)return u.NO_SEQ;var t,n,i=null,s=null,o,a,f,l;e=new r(e),t=this.normalizeGameStage(e);if(t===null)return node.warn("previous received invalid stage: "+e),null;a=t.stage,f=t.step,i=this.stager.sequence[a-1];if(f>1)return new r({stage:a,step:f-1,round:e.round});if("undefined"!=typeof i.id){s=this.stager.stages[i.id];if(e.round>1)return new r({stage:a,step:s.steps.length,round:e.round-1});if((i.type==="doLoop"||i.type==="loop")&&i.cb())return new r({stage:a,step:s.steps.length,round:1})}if(a<=1)return new r({stage:0,step:0,round:0});while(this.stager.sequence[a-2].type==="loop"&&!this.stager.sequence[a-2].cb()){a--;if(a<=1)return new r({stage:0,step:0,round:0})}return o=this.stager.sequence[a-2],l=this.stager.stages[o.id].steps.length,o.type==="repeat"?new r({stage:a-1,step:l,round:o.num}):new r({stage:a-1,step:l,round:1})},u.prototype.jump=function(e,t){if(t<0)while(t<0){e=this.previous(e),t++;if(!(e instanceof r)||e.stage===0)return e}else while(t>0){e=this.next(e),t--;if(!(e instanceof r))return e}return e},u.prototype.stepsToNextStage=function(e){var t,n;return e=new r(e),e.stage===0?1:(t=this.getStage(e),t?("number"==typeof e.step?n=e.step:n=t.steps.indexOf(e.step)+1,n<1||n>t.steps.length?null:1+t.steps.length-n):null)},u.prototype.stepsToPreviousStage=function(e){var t,n;return e=new r(e),t=this.getStage(e),t?("number"==typeof e.step?n=e.step:n=t.steps.indexOf(e.step)+1,n<1||n>t.steps.length?null:n):null},u.prototype.getStage=function(e){var t;return this.stager?(e=new r(e),"number"==typeof e.stage?(t=this.stager.sequence[e.stage-1],t?this.stager.stages[t.id]:null):this.stager.stages[e.stage]||null):null},u.prototype.getStep=function(e){var t;return this.stager?(e=new r(e),"number"==typeof e.step?(t=this.getStage(e),t?this.stager.steps[t.steps[e.step-1]]:null):this.stager.steps[e.step]||null):null},u.prototype.getStepRule=function(e){var t,n,i;return e=new r(e),e.stage===0?function(){return!1}:(t=this.getStage(e),n=this.getStep(e),!t||!n?null:("string"==typeof n.steprule?i=node.stepRules.get(n.steprule):"function"==typeof n.steprule&&(i=n.steprule),"function"==typeof i?i:("string"==typeof t.steprule?i=node.stepRules.get(t.steprule):"function"==typeof t.steprule&&(i=t.steprule),"function"==typeof i?i:this.stager.defaultStepRule)))},u.prototype.getGlobal=function(e,t){var n,i,s,o,u;e=new r(e),n=this.getStep(e);if(n){s=n.globals;if(s&&s.hasOwnProperty(t))return s[t]}i=this.getStage(e);if(i){o=i.globals;if(o&&o.hasOwnProperty(t))return o[t]}if(this.stager){u=this.stager.getDefaultGlobals();if(u&&u.hasOwnProperty(t))return u[t]}return null},u.prototype.getProperty=function(e,t){var n,i,s;e=new r(e),n=this.getStep(e);if(n&&n.hasOwnProperty(t))return n[t];i=this.getStage(e);if(i&&i.hasOwnProperty(t))return i[t];if(this.stager){s=this.stager.getDefaultProperties();if(s&&s.hasOwnProperty(t))return s[t]}return null},u.prototype.isReady=function(){return this.stager&&(this.stager.sequence.length>0||this.stager.generalNextFunction!==null||!i.isEmpty(this.stager.nextFunctions))},u.prototype.getName=function(e){var t=this.getStep(e);return t?t.name:t},u.prototype.getAllParams=u.prototype.getStep,u.prototype.normalizeGameStage=function(e){var t,n,i,s;if(!e||"object"!=typeof e)return null;if("number"==typeof e.stage)t=e.stage;else{for(i=0;i<this.stager.sequence.length;i++)if(this.stager.sequence[i].id===e.stage)break;t=i+1}return t<1||t>this.stager.sequence.length?(node.warn("normalizeGameStage received nonexistent stage: "+e.stage),null):(s=this.stager.sequence[t-1],s?s.type==="gameover"?new r({stage:t,step:1,round:e.round}):(stageObj=this.stager.stages[s.id],stageObj?("number"==typeof e.step?n=e.step:n=stageObj.steps.indexOf(e.step)+1,n<1?(node.warn("normalizeGameStage received nonexistent step: "+stageObj.id+"."+e.step),null):"number"!=typeof e.round?null:new r({stage:t,step:n,round:e.round})):null):null)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function s(e){this.node=e}e.GameMsgGenerator=s;var n=t.GameMsg,r=t.GameStage,i=t.constants;s.prototype.create=function(e){var t,s;return s=this.node,e.stage?t=e.stage:t=s.game?s.game.getCurrentGameStage():new r("0.0.0"),new n({session:"undefined"!=typeof e.session?e.session:s.socket.session,stage:t,action:e.action||i.action.SAY,target:e.target||i.target.DATA,from:s.player?s.player.id:s.UNDEFINED_PLAYER,to:"undefined"!=typeof e.to?e.to:"SERVER",text:e.text||null,data:e.data||null,priority:e.priority||null,reliable:e.reliable||1})}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e){function n(e){var t;return t=new e,t.send?t.connect?!0:!1:!1}function r(){return t}function i(e,n,r){var i=t[n];return i?new i(e,r):null}function s(e,r){if(!e||!r)return;if(!n(r))throw new Error("Cannot register invalid Socket class: "+e);t[e]=r}var t={};e.SocketFactory={checkContract:n,getTypes:r,get:i,register:s}}("undefined"!=typeof node?node:module.exports),function(e,t){function o(e,t){this.buffer=[],this.session=null,this.user_options={},this.socket=null,this.url=null,this.node=e}e.Socket=o;var n=t.GameMsg,r=t.SocketFactory,i=t.JSUS,s=t.action;o.prototype.setup=function(e){var t;e=e?i.clone(e):{},t=e.type,delete e.type,this.user_options=e,t&&this.setSocketType(t,e)},o.prototype.setSocketType=function(e,t){return this.socket=r.get(this.node,e,t),this.socket},o.prototype.connect=function(e,t){var n=e||"local server";if(!this.socket)return this.node.err("Socket.connet: cannot connet to "+n+" . No open socket."),!1;this.url=e,this.node.log("connecting to "+n+"."),this.socket.connect(e,"undefined"!=typeof t?t:this.user_options)},o.prototype.onDisconnect=function(){this.node.session.store(),this.node.log("closed")},o.prototype.onMessage=function(e){e=this.secureParse(e);if(!e)return;var t;e.target==="HI"&&(this.attachMsgListeners(),this.startSession(e),t=this.node.store(e.session),this.node.store(e.session,this.node.session.save()))},o.prototype.attachMsgListeners=function(){this.onMessage=this.onMessageFull,this.node.emit("NODEGAME_READY")},o.prototype.onMessageFull=function(e){e=this.secureParse(e),e&&(e.priority>0||this.node.game.isReady&&this.node.game.isReady()?this.node.emit(e.toInEvent(),e):(this.node.silly("B: "+e),this.buffer.push(e)))},o.prototype.registerServer=function(e){this.servername=e.from,this.serverid=e.from},o.prototype.secureParse=function(e){var t;try{t=n.clone(JSON.parse(e)),this.node.info("R: "+t)}catch(r){return u("malformed msg received",r)}return this.session&&t.session!==this.session?u("local session id does not match incoming message session id"):t},o.prototype.shouldClearBuffer=function(){this.node.game.isReady&&this.node.game.isReady()&&this.clearBuffer()},o.prototype.clearBuffer=function(){var e,t,n;e=this.buffer.length;for(n=0;n<e;n++)t=this.buffer.shift(),t&&(this.node.emit(t.toInEvent(),t),this.node.silly("D: "+t))},o.prototype.startSession=function(e){return this.registerServer(e),this.node.createPlayer(e.data),this.session=e.session,!0},o.prototype.send=function(e){return this.socket?e.from===this.node.UNDEFINED_PLAYER?(this.node.err("Socket.send: cannot send message. Player undefined."),!1):(this.node.debug&&this.node.emit(e.toOutEvent(),e),this.socket.send(e),this.node.info("S: "+e),!0):(this.node.err("Socket.send: cannot send message. No open socket."),!1)};var u=function(e,t){e=e||"Generic error while parsing a game message";var n=t?e+": "+t:e;return this.node.log(n,"ERR"),this.node.emit("LOG","E: "+n),!1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t,n){function o(e,t){this.node=e,this.socket=null}var r=t.GameMsg,i=t.Player,s=t.GameMsgGenerator;e.SocketIo=o,o.prototype.connect=function(e,t){var r,i;return r=this.node,e?(i=n.connect(e,t),i.on("connect",function(e){r.info("socket.io connection open"),i.on("message",function(e){r.socket.onMessage(e)})}),i.on("disconnect",function(){r.socket.onDisconnect.call(r.socket)}),this.socket=i,!0):(r.err("cannot connect to empty url.","ERR"),!1)},o.prototype.send=function(e){this.socket.send(e.stringify())},t.SocketFactory.register("SocketIo",o)}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof io?io:require("socket.io-client")),function(e,t){function s(e,t){e=e||{},e.update||(e.update={}),e.update.indexes=!0,r.call(this,e,t),this.c("stage",o.compareState),this.player||this.h("player",function(e){return e.player}),this.stage||this.h("stage",function(e){return i.toHash(e.stage,"S.s.r")}),this.key||this.h("key",function(e){return e.key}),this.node=e.shared?e.shared.node?e.shared.node:null:null}function o(e){this.stage=e.stage,this.player=e.player,this.key=e.key,this.value=e.value,this.time=Date?Date.now():null}var n=t.JSUS,r=t.NDDB,i=t.GameStage;s.prototype=new r,s.prototype.constructor=s,e.GameDB=s,e.GameBit=o,s.prototype.syncWithNode=function(e){if("object"!=typeof e)throw new Error("GameDB.syncWithNode: invalid parameter received");this.node=e},s.prototype.add=function(e,t,n,r){return e?(this.node&&("undefined"==typeof n&&(n=node.player),"undefined"==typeof r&&(r=node.game.getCurrentGameStage())),this.insert(new o({player:n,key:e,value:t,stage:r})),!0):(this.log("GameDB.add: Missing mandatory attribute 'key'.","ERR"),!1)},o.prototype.toString=function(){return this.player+", "+i.stringify(this.stage)+", "+this.key+", "+this.value},o.equals=function(e,t,n){return!e||!t?!1:(n=n||!1,o.comparePlayer(e,t)!==0?!1:o.compareState(e,t)!==0?!1:o.compareKey(e,t)!==0?!1:n&&e.value&&o.compareValue(e,t)!==0?!1:!0)},o.comparePlayer=function(e,t){return!e&&!t?0:e?t?e.player===t.player?0:e.player>t.player?1:-1:-1:1},o.compareState=function(e,t){return i.compare(e.stage,t.stage)},o.compareKey=function(e,t){return!e&&!t?0:e?t?e.key===t.key?0:e.key<t.key?-1:1:-1:1},o.compareValue=function(e,t){return!e&&!t?0:e?t?n.equals(e.value,t.value)?0:e.value>t.value?1:-1:-1:1}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function a(e,t){this.node=e,this.setStateLevel(u.stateLevels.UNINITIALIZED,!0),this.setStageLevel(u.stageLevels.UNINITIALIZED,!0),t=t||{},this.metadata={name:t.name||"A nodeGame game",description:t.description||"No Description",version:t.version||"0",session:t.session||"0"},this.settings={observer:!!t.observer,minPlayers:t.minPlayers||1,maxPlayers:t.maxPlayers||1e3},this.pl=new s({log:this.node.log,logCtx:this.node}),this.ml=new s({log:this.node.log,logCtx:this.node}),this.memory=new r({log:this.node.log,logCtx:this.node,shared:{node:this.node}}),this.plot=new i(new o(t.stages),e),this.setCurrentGameStage(new n,!0),this.paused=!1,this.setStateLevel(u.stateLevels.STARTING)}e.Game=a;var n=t.GameStage,r=t.GameDB,i=t.GamePlot,s=t.PlayerList,o=t.Stager,u=t.constants;a.prototype.start=function(){var e,t,r;r=this.node;if(r.player.placeholder)throw new r.NodeGameMisconfiguredGameError("game.start called without a player.");if(this.getStateLevel()>=u.stateLevels.INITIALIZING)return r.warn("game.start called on a running game."),!1;if(!this.plot.isReady())throw new r.NodeGameMisconfiguredGameError("game.start called, but plot is not ready.");return this.plot&&this.plot.stager&&(e=this.plot.stager.getOnInit(),e&&(this.setStateLevel(u.stateLevels.INITIALIZING),r.emit("INIT"),e.call(r.game))),this.setStateLevel(u.stateLevels.INITIALIZED),this.setCurrentGameStage(new n),t=this.step(),r.log("game started."),t},a.prototype.restart=function(e){e&&this.memory.clear(!0),this.execStep(this.plot.getStep("1.1.1"))},a.prototype.gameover=function(){var e,t;t=this.node;if(this.getStateLevel()>=u.stateLevels.FINISHING){t.warn("game.gameover called on a finishing game");return}t.emit("GAMEOVER"),this.plot&&this.plot.stager&&(e=this.plot.stager.getOnGameover(),e&&(this.setStateLevel(u.stateLevels.FINISHING),e.call(t.game))),this.setStateLevel(u.stateLevels.GAMEOVER),this.setStageLevel(u.stageLevels.DONE)},a.prototype.pause=function(){this.paused=!0},a.prototype.resume=function(){this.paused=!1},a.prototype.shouldStep=function(){var e;e=this.plot.getStepRule(this.getCurrentGameStage());if("function"!=typeof e)throw new this.node.NodeGameMisconfiguredGameError("step rule is not a function");return e(this.getCurrentGameStage(),this.getStageLevel(),this.pl,this)?this.step():null},a.prototype.step=function(){var e,t,n,r,s,o;o=this.node;if(this.getStateLevel()<u.stateLevels.INITIALIZED)throw new o.NodeGameMisconfiguredGameError("game.step called before game.start");t=this.getCurrentGameStage(),e=this.plot.next(t),o.silly("Next stage ---> "+e),o.events.ee.step.clear(),o.socket.shouldClearBuffer();if("string"==typeof e)return e===i.GAMEOVER?(this.gameover(),o.socket.shouldClearBuffer(),o.emit("GAME_OVER"),null):null;o.emit("STEPPING"),this.setStageLevel(u.stageLevels.UNINITIALIZED),this.setCurrentGameStage(e);if(this.plot.stepsToNextStage(t)===1){r=this.plot.getStage(e);if(!r)return!1;o.events.ee.stage.clear(),r.hasOwnProperty("init")&&(this.setStateLevel(u.stateLevels.STAGE_INIT),this.setStageLevel(u.stageLevels.INITIALIZING),r.init.call(o.game));for(s in r.on)r.on.hasOwnProperty(s)&&o.events.ee.stage.on(s,nextStageObjs.on[s])}n=this.plot.getStep(e);if(!n)return!1;n.hasOwnProperty("init")&&(this.setStateLevel(u.stateLevels.STEP_INIT),this.setStageLevel(u.stageLevels.INITIALIZING),n.init.call(o.game)),this.setStateLevel(u.stateLevels.PLAYING_STEP),this.setStageLevel(u.stageLevels.INITIALIZED);for(s in n.on)n.on.hasOwnProperty(s)&&o.events.ee.step.on(s,nextStepObjs.on[s]);return o.socket.shouldClearBuffer(),this.execStep(this.getCurrentStep())},a.prototype.execStep=function(e){var t,n,r;r=this.node;if(!e||"object"!=typeof e)throw new r.NodeGameRuntimeError("game.execStep requires a valid object");t=e.cb,this.setStageLevel(u.stageLevels.LOADING);try{n=t.call(r.game)}catch(i){throw r.debug?i:(r.err("An error occurred while executing a custom callback"),new r.NodeGameRuntimeError(i))}return this.setStageLevel(u.stageLevels.LOADED),r.emit("STEP_CALLBACK_EXECUTED"),n===!1&&r.err("A non fatal error occurred while executing the callback of stage "+this.getCurrentGameStage()),(!r.window||r.window.state==r.constants.is.LOADED)&&r.emit("PLAYING"),n},a.prototype.getStateLevel=function(){return this.node.player.stateLevel},a.prototype.getStageLevel=function(){return this.node.player.stageLevel},a.prototype.getCurrentStep=function(){return this.plot.getStep(this.getCurrentGameStage())},a.prototype.getCurrentGameStage=function(){return this.node.player.stage},a.prototype.setStateLevel=function(e,t){var n;n=this.node;if("number"!=typeof e)throw new n.NodeGameMisconfiguredGameError("setStateLevel called with invalid parameter: "+e);n.player.stateLevel=e},a.prototype.setStageLevel=function(e,t){var n;n=this.node;if("number"!=typeof e)throw new n.NodeGameMisconfiguredGameError("setStageLevel called with invalid parameter: "+e);t||this.publishStageLevelUpdate(e),n.player.stageLevel=e},a.prototype.setCurrentGameStage=function(e,t){e=new n(e),t||this.publishGameStageUpdate(e),this.node.player.stage=e},a.prototype.publishStageLevelUpdate=function(e){var t;t=this.node,!this.settings.observer&&t.player.stageLevel!==e&&t.socket.send(t.msg.create({target:u.target.PLAYER_UPDATE,data:{stageLevel:e},to:"ALL"}))},a.prototype.publishGameStageUpdate=function(e){var t;t=this.node,!this.settings.observer&&t.player.stage!==e&&t.socket.send(t.msg.create({target:u.target.PLAYER_UPDATE,data:{stage:e},to:"ALL"}))},a.prototype.isReady=function(){var e,t,n;n=this.getStateLevel(),t=this.getStageLevel(),e=this.node;switch(n){case u.stateLevels.UNINITIALIZED:case u.stateLevels.INITIALIZING:case u.stateLevels.STAGE_INIT:case u.stateLevels.STEP_INIT:case u.stateLevels.FINISHING:return!1;case u.stateLevels.PLAYING_STEP:switch(t){case u.stageLevels.LOADING:case u.stageLevels.PAUSING:case u.stageLevels.RESUMING:return!1}}return e.window?e.window.state>=u.is.LOADED:!0}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function o(e){u.call(this),this.node=e,this.register("player",{set:function(t){e.createPlayer(t)},get:function(){return e.player}}),this.register("game.memory",{set:function(t){e.game.memory.clear(!0),e.game.memory.importDB(t)},get:function(){return e.game.memory?e.game.memory.fetch():null}}),this.register("events.history",{set:function(t){e.events.history.history.clear(!0),e.events.history.history.importDB(t)},get:function(){return e.events.history?e.events.history.history.fetch():null}}),this.register("game.currentStepObj",{set:o.restoreStage,get:function(){return e.game.getCurrentStep()}}),this.register("node.env")}function u(){this.session={}}var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS;e.GameSession=o,e.GameSession.SessionManager=u,o.prototype=new u,o.prototype.constructor=o,o.prototype.restoreStage=function(e){try{t.game.execStage(t.plot.getStep(e));var n=["LOG","STATECHANGE","WINDOW_LOADED","BEFORE_LOADING","LOADED","in.say.STATE","UPDATED_PLIST","NODEGAME_READY","out.say.STATE","out.set.STATE","in.say.PLIST","STAGEDONE","out.say.HI"];return t.events.history.remit(t.game.getStateLevel(),n),t.info("game stage restored"),!0}catch(r){return t.err("could not restore game stage. An error has occurred: "+r),!1}},u.getVariable=function(e){s.getNestedValue(e,t)},u.setVariable=function(e,n){s.setNestedValue(e,n,t)},u.prototype.register=function(e,n){return e?(this.session[e]={get:n&&n.get?n.get:function(){return s.getNestedValue(e,t)},set:n&&n.set?n.set:function(n){s.setNestedValue(e,n,t)}},!0):(t.err("cannot add an empty path to session"),!1)},u.prototype.unregister=function(e){return e?this.session[e]?(delete this.session[e],!0):(t.err(e+" is not registered in the session"),!1):(t.err("cannot delete an empty path from session"),!1)},u.prototype.get=function(e){var t={};if(e)return this.session[e]?this.session[e].get():undefined;for(e in this.session)this.session.hasOwnProperty(e)&&(t[e]=this.session[e].get());return t},u.prototype.save=function(){var e={};for(var t in this.session)this.session.hasOwnProperty(t)&&(e[t]={value:this.session[t].get(),get:this.session[t].get,set:this.session[t].set});return e},u.prototype.load=function(e){for(var t in e)e.hasOwnProperty(t)&&this.register(t,e[t])},u.prototype.clear=function(){this.session={}},u.prototype.restore=function(e){if(!e){t.err("cannot restore empty session object");return}for(var n in e)e.hasOwnProperty(n)&&e[n].set(e[n].value);return!0},u.prototype.store=function(){},u.prototype.store=function(){}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){}function i(e){this.groups=[],this.maxIteration=10,this.doneCounter=0}function s(){this.elements=[],this.matched=[],this.leftOver=[],this.pointer=0,this.matches={},this.matches.total=0,this.matches.requested=0,this.matches.done=!1,this.rowLimit=3,this.noSelf=!0,this.pool=[],this.shuffle=!0,this.stretch=!0}function u(){var e=[],t=n.shuffle(o);return e.push(t.splice(0,n.randomInt(0,t.length))),e.push(t.splice(0,n.randomInt(0,t.length))),e.push(t),n.shuffle(e)}function a(){var e=n.shuffle(o);out=[];var t=e.splice(0,n.randomInt(0,e.length/2)),r=e.splice(0,n.randomInt(0,e.length/2)),i=e,s=t.splice(0,n.randomInt(0,t.length));t=n.shuffle([s,t]);var u=r.splice(0,n.randomInt(0,r.length));r=n.shuffle([u,r]);var a=i.splice(0,n.randomInt(0,i.length));return i=n.shuffle([a,i]),n.shuffle([t,r,i])}function f(e){for(var t=0;t<e;t++){var n=new i,r=u(),s=a();n.init(r,s);var o=n.match();n.allGroupsDone()||(console.log("ERROR"),console.log(n.options.elements),console.log(n.options.pools),console.log(o));for(var f=0;f<n.groups.length;f++){var l=n.groups[f];for(var c=0;c<l.elements.length;c++)l.matched[c].length!==l.rowLimit&&(console.log("Wrong match: "+c),console.log(n.options.elements),console.log(n.options.pools),console.log(o))}}}var n=t.JSUS;e.GroupManager=r,e.RMatcher=i,i.prototype.init=function(e,t){var n,r;for(n=0;n<e.length;n++)r=new s,r.init(e[n],t[n]),this.addGroup(r);this.options={elements:e,pools:t}},i.prototype.addGroup=function(e){if(!e)return;this.groups.push(e)},i.prototype.match=function(){var e;for(e=0;e<this.groups.length;e++)this.groups[e].match(),this.groups[e].matches.done&&this.doneCounter++;return this.allGroupsDone()||this.assignLeftOvers(),this.allGroupsDone()||this.switchBetweenGroups(),n.map(this.groups,function(e){return e.matched})},i.prototype.invertMatched=function(){var e,t=[],r=[];return n.each(this.groups,function(n){t=t.concat(n.elements),e=n.invertMatched();for(var i=0;i<e.length;i++)r[i]=(r[i]||[]).concat(e[i])}),{elements:t,inverted:r}},i.prototype.allGroupsDone=function(){return this.doneCounter===this.groups.length},i.prototype.tryOtherLeftOvers=function(e){var t,r,i=n.seq(0,this.groups.length-1);i=n.shuffle(i);for(var s=0;s<i.length;s++){r=i[s];if(r===e)continue;t=this.groups[r],leftOver=[];if(t.leftOver.length){t.leftOver=this.groups[e].matchBatch(t.leftOver);if(this.groups[e].matches.done)return this.doneCounter++,!0}}},i.prototype.assignLeftOvers=function(){var e,t;for(t=0;t<this.groups.length;t++)e=this.groups[t],e.matches.done||this.tryOtherLeftOvers(t)},i.prototype.collectLeftOver=function(){return n.map(this.groups,function(e){return e.leftOver})},i.prototype.switchFromGroup=function(e,t,n,r){var i,s,o,u,a,f;for(i=0;i<e.elements.length;i++)for(s=0;s<r.length;s++)for(o=0;o<r[s].length;o++){u=r[s][o];if(e.canSwitchIn(u,i))for(a=0;a<e.matched[i].length;a++){f=e.matched[i][a];if(t.canAdd(f,n))return e.matched[i][a]=u,t.addToRow(f,n),r[s].splice(o,1),t.matches.done&&this.doneCounter++,!0}}},i.prototype.trySwitchingBetweenGroups=function(e,t){var n=this.collectLeftOver(),r=this.groups[e],i,s;for(i=e+1;i<this.groups.length+e+1;i++){s=this.groups[i%this.groups.length];if(this.switchFromGroup(s,r,t,n)&&r.matches.done)return}return!1},i.prototype.switchBetweenGroups=function(){var e,t,n,r,i;for(e=0;e<this.groups.length;e++){t=this.groups[e];if(!t.matches.done)for(n=0;n<t.elements.length;n++){i=t.rowLimit-t.matched[n].length;if(i)for(r=0;r<i;r++){this.trySwitchingBetweenGroups(e,n);if(this.allGroupsDone())return!0}}}return!1},s.prototype.init=function(e,t){this.elements=e,this.pool=n.clone(t);for(var r=0;r<this.pool.length;r++)this.stretch&&(this.pool[r]=n.stretch(this.pool[r],this.rowLimit)),this.shuffle&&(this.pool[r]=n.shuffle(this.pool[r]));if(!e.length)this.matches.done=!0;else for(r=0;r<e.length;r++)this.matched[r]=[];this.matches.requested=this.elements.length*this.rowLimit},s.prototype.canSwitchIn=function(e,t){return n.in_array(e,this.matched[t])?!1:this.noSelf&&this.elements[t]===e?!1:!0},s.prototype.canAdd=function(e,t){return this.matched[t].length>=this.rowLimit?!1:this.canSwitchIn(e,t)},s.prototype.shouldSwitch=function(e,t){return this.leftOver.length?this.matched.length<2?!1:!0:!1},s.prototype.switchIt=function(){for(var e=0;e<this.elements.length;e++)this.matched[e].length<this.rowLimit&&this.completeRow(e)},s.prototype.completeRow=function(e,t){t=t||this.leftOver;var n=t.slice(0);for(var r=0;r<n.length;r++)for(var i=0;i<this.elements.length;i++){if(this.switchItInRow(n[r],i,e))return t.splice(r,1),!0;this.updatePointer()}return!1},s.prototype.switchItInRow=function(e,t,n){if(!this.canSwitchIn(e,t))return!1;for(var r=0;r<this.matched[t].length;r++){var i=this.matched[t][r];if(this.canAdd(i,n))return this.matched[t][r]=e,this.addToRow(i,n),!0}return!1},s.prototype.addToRow=function(e,t){this.matched[t].push(e),this.matches.total++,this.matches.total===this.matches.requested&&(this.matches.done=!0)},s.prototype.addIt=function(e){var t=0,n=!1;while(t<this.elements.length&&!n)this.canAdd(e,this.pointer)&&(this.addToRow(e,this.pointer),n=!0),this.updatePointer(),t++;return n},s.prototype.matchBatch=function(e){var t=[];for(var n=0;n<e.length;n++)(this.matches.done||!this.addIt(e[n]))&&t.push(e[n]);return t},s.prototype.match=function(e){e=e||this.pool,n.isArray(e)||(e=[e]);var t;for(var r=0;r<e.length;r++)t=this.matchBatch(e[r]),t.length&&(this.leftOver=this.leftOver.concat(t));this.shouldSwitch()&&this.switchIt()},s.prototype.updatePointer=function(){this.pointer=(this.pointer+1)%this.elements.length},s.prototype.summary=function(){console.log("elements: ",this.elements),console.log("pool: ",this.pool),console.log("left over: ",this.leftOver),console.log("hits: "+this.matches.total+"/"+this.matches.requested),console.log("matched: ",this.matched)},s.prototype.invertMatched=function(){return n.transpose(this.matched)};var o=[1,2,3,4,5,6,7,8,9]}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function r(){}var n=t.JSUS;e.RoleMapper=r}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){function h(){function e(e,t,n){var r;if(!this.game)throw this.warn("updatePlayerList called before node.game was initialized"),new this.NodeGameMisconfiguredGameError("node.game non-existent");if(e==="pl")r=this.game.pl;else{if(e!=="ml")throw this.warn("updatePlayerList called with invalid dstListName"),new this.NodeGameMisconfiguredGameError("invalid dstListName");r=this.game.ml}if(!r)throw this.warn("updatePlayerList called before this.game was initialized"),new this.NodeGameMisconfiguredGameError("dstList non-existent");if(t){if(!n||n==="replace")r.clear(!0);else if(n!=="append")throw new this.NodeGameMisconfiguredGameError("register('plist') got invalid updateRule");r.importDB(t)}return r}this.verbosity_levels={ALWAYS:-(Number.MIN_VALUE+1),ERR:-1,WARN:0,INFO:1,SILLY:10,DEBUG:100,NEVER:Number.MIN_VALUE-1},this.verbosity=this.verbosity_levels.WARN,this.nodename="ng",this.remoteVerbosity=this.verbosity_levels.WARN,this.events=new n(this),this.msg=new i(this),this.socket=new s(this),this.session=new l(this),this.player={placeholder:!0},this.game=new a(this),this.store=function(){},this.conf={},this.support={},this.registerSetup("nodegame",function(e){e=e||{};for(var t in this.setup)this.setup.hasOwnProperty(t)&&t!=="register"&&t!=="nodegame"&&(this.conf[t]=this.setup[t].call(this,e[t]))}),this.registerSetup("socket",function(e){if(!e)return;return this.socket.setup(e),e}),this.registerSetup("host",function(e){var t;return e||"undefined"!=typeof window&&"undefined"!=typeof window.location&&(e=window.location.href),e&&(t=e.split("/").slice(0,-2),t.length>1&&(e=t.join("/")),e.lastIndexOf("/")!==e.length&&(e+="/")),e}),this.registerSetup("verbosity",function(e){return"undefined"!=typeof e&&(this.verbosity=e),e}),this.registerSetup("nodename",function(e){e=e||"ng";if("string"!=typeof e)throw new TypeError("node.nodename must be of type string");return this.nodename=e,e}),this.registerSetup("debug",function(e){e=e||!1;if("boolean"!=typeof e)throw new TypeError("node.debug must be of type boolean");return this.debug=e,e}),this.registerSetup("env",function(e){if("undefined"!=typeof e)for(var t in e)e.hasOwnProperty(t)&&(this.env[t]=e[t]);return e}),this.registerSetup("events",function(e){return e=e||{},"undefined"==typeof e.history&&(e.history=!1),"undefined"==typeof e.dumpEvents&&(e.dumpEvents=!1),e}),this.registerSetup("window",function(e){if(!this.window){this.warn("node.window not found, cannot configure it.");return}return e=e||{},"undefined"==typeof e.promptOnleave&&(e.promptOnleave=!1),"undefined"==typeof e.noEscape&&(e.noEscape=!0),this.window.init(e),e}),this.registerSetup("game_settings",function(e){if(!this.game)throw this.warn("register('game_settings') called before node.game was initialized"),new node.NodeGameMisconfiguredGameError("node.game non-existent");return e&&c.mixin(this.game.settings,e),this.game.settings}),this.registerSetup("game_metadata",function(e){if(!this.game)throw this.warn("register('game_metadata') called before node.game was initialized"),new node.NodeGameMisconfiguredGameError("node.game non-existent");return e&&c.mixin(this.game.metadata,e),this.game.metadata}),this.registerSetup("player",function(e){return e?this.createPlayer(e):null}),this.registerSetup("plot",function(e,t){if(!this.game)throw this.warn("register('plot') called before node.game was initialized"),new node.NodeGameMisconfiguredGameError("node.game non-existent");return e=e||{},this.game.plot||(this.game.plot=new GamePlot),this.game.plot.stager||(this.game.plot.stager=new Stager),this.game.plot.stager.setState(e,t),this.game.plot}),this.registerSetup("plist",function(t,n){e.call(this,"pl",t,n)}),this.registerSetup("mlist",function(t,n){e.call(this,"ml",t,n)}),this.alias("txt","in.say.TXT"),this.alias("data",["in.say.DATA","in.set.DATA"]),this.alias("state","in.set.STATE"),this.alias("stage","in.set.STAGE"),this.alias("plist",["in.set.PLIST","in.say.PLIST"]),this.alias("pconnect","in.say.PCONNECT",function(e){return e.data}),this.addDefaultIncomingListeners(),this.addDefaultInternalListeners()}e.NodeGameClient=h;var n=t.EventEmitterManager,r=t.EventEmitter,i=t.GameMsgGenerator,s=t.Socket,o=t.GameStage,u=t.GameMsg,a=t.Game,f=t.Player,l=t.GameSession,c=t.JSUS}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient,r=t.constants;n.prototype.log=function(e,t,n){if("undefined"==typeof e)return!1;t=t||0,n="undefined"==typeof n?this.nodename+"> ":n,"string"==typeof t&&(t=this.verbosity_levels[t]),this.verbosity>t&&console.log(n+e)},n.prototype.info=function(e,t){t=this.nodename+(t?"|"+t:"")+"> info - ",this.log(e,this.verbosity_levels.INFO,t)},n.prototype.warn=function(e,t){t=this.nodename+(t?"|"+t:"")+"> warn - ",this.log(e,this.verbosity_levels.WARN,t)},n.prototype.err=function(e,t){t=this.nodename+(t?"|"+t:"")+"> error - ",this.log(e,this.verbosity_levels.ERR,t)},n.prototype.silly=function(e,t){t=this.nodename+(t?"|"+t:"")+"> silly - ",this.log(e,this.verbosity_levels.SILLY,t)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.GameMsg,r=t.Player,i=t.Game,s=t.GamePlot,o=t.Stager,u=t.GameMsgGenerator,a=t.JSUS,f=t.NodeGameClient,l=!1;f.prototype.setup=function(e){var t;if("string"!=typeof e)throw new Error("node.setup: expects a string as first parameter.");if(l)throw new Error("nodeGame configuration is frozen. No modification allowed.");if(e==="register")throw new Error('cannot setup property "register"');if(!this.setup[e])throw new Error("no such property to configure: "+e);return t=this.setup[e].apply(this,Array.prototype.slice.call(arguments,1)),e!=="nodegame"&&(this.conf[e]=t),!0},f.prototype.registerSetup=function(e,t){return!e||!t?(this.err("cannot register empty setup function"),!1):(this.setup[e]=t,!0)},f.prototype.remoteSetup=function(e,t){var n,r;return e?t?(r=a.stringifyAll(Array.prototype.slice.call(arguments,2)),r?(n=this.msg.create({target:this.target.SETUP,to:t,text:e,data:r}),this.socket.send(n)):(this.err("an error occurred while stringifying payload for remote setup"),!1)):(this.err("cannot send remote setup: empty recipient"),!1):(this.err("cannot send remote setup: empty property"),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports,"undefined"!=typeof io?io:module.parent.exports.io),function(e,t){var n=t.GameMsg,r=t.Player,i=t.GameMsgGenerator,s=t.JSUS,o=t.NodeGameClient;o.prototype.alias=function(e,t,n){var r;if(!e||!t){this.err("undefined alias or events");return}s.isArray(t)||(t=[t]),r=this,s.each(t,function(t){r.on[e]=function(e){r.on(t,n?function(){e.call(r.game,n.apply(r.game,arguments))}:function(){e.apply(r.game,arguments)})}})}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient;n.prototype.connect=function(e,t){this.socket.connect(e,t)&&this.emit("NODEGAME_CONNECTED")}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient,r=t.Player,i=t.constants;n.prototype.createPlayer=function(e){if(this.player&&this.player.stateLevel>i.stateLevels.STARTING&&this.player.stateLevel!==i.stateLevels.GAMEOVER)throw new this.NodeGameIllegalOperationError("createPlayer: cannot create player while game is running");return e=new r(e),e.stateLevel=this.player.stateLevel,e.stageLevel=this.player.stageLevel,this.player&&this.player.id&&this.game.pl.remove(this.player.id),this.player=this.game.pl.add(e),this.emit("PLAYER_CREATED",this.player),this.player}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient,r=t.GameStage;n.prototype.getCurrentEventEmitter=function(){return!this.game||!this.game.getCurrentGameStage()?this.events.ee.ng:r.compare(this.game.getCurrentGameStage(),new r)===0?this.events.ee.game:this.events.ee.step},n.prototype.emit=function(){this.events.emit.apply(this.events,arguments)},n.prototype.on=function(e,t){var n;n=this.getCurrentEventEmitter(),n.on(e,t)},n.prototype.once=function(e,t){var n,r;r=function(){n.remove(e,t),n.remove(e,r)},n=this.getCurrentEventEmitter(),n.on(e,t),n.on(e,r)},n.prototype.off=function(e,t){return this.events.remove(e,t)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient;n.prototype.say=function(e,t,n){var r;if("undefined"==typeof e)return this.err("cannot say empty message"),!1;r=this.msg.create({target:this.constants.target.DATA,to:t||"SERVER",text:e,data:n});debugger;this.socket.send(r)},n.prototype.set=function(e,t,n){var r;if("undefined"==typeof e)return this.err("cannot set undefined key"),!1;r=this.msg.create({action:this.constants.action.SET,target:this.constants.target.DATA,to:n||"SERVER",reliable:1,text:e,data:t}),this.socket.send(r)},n.prototype.get=function(e,t,n){function i(n){n.text===e&&(t.call(this.game,n.data),s.remove("in.say.DATA",i))}var r,i,s;if("undefined"==typeof e)return this.err("cannot get empty key"),!1;if("function"!=typeof t)return this.err("this.get requires a valid callback function"),!1;r=this.msg.create({action:this.constants.action.GET,target:this.constants.target.DATA,to:n||"SERVER",reliable:1,text:e}),s=this.getCurrentEventEmitter(),s.on("in.say.DATA",i)},n.prototype.done=function(){var e,t;switch(arguments.length){case 0:this.emit("DONE");break;case 1:this.emit("DONE",arguments[0]);break;case 2:this.emit("DONE",arguments[0],arguments[1]);break;default:t=arguments.length,e=new Array(t-1);for(i=1;i<t;i++)e[i-1]=arguments[i];this.emit.apply("DONE",e)}}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient;n.prototype.redirect=function(e,t){var n;return"string"!=typeof e?(this.err("redirect requires a valid string"),!1):"undefined"==typeof t?(this.err("redirect requires a valid recipient"),!1):(n=this.msg.create({target:this.target.REDIRECT,data:e,to:t}),this.socket.send(n),!0)},n.prototype.remoteCommand=function(e,t,n){var r;return e?"undefined"==typeof t?(this.err("remoteCommand requires a valid recipient"),!1):(r=this.msg.create({target:this.target.GAMECOMMAND,text:e,data:n,to:t}),this.socket.send(r)):(this.err("remoteCommand requires a valid command"),!1)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient;n.prototype.env=function(e,t,n,r){if(!e||!t||!this.env[e])return;n=n||node,r=r||[],t.apply(n,r)},n.prototype.randomEmit=function(e,t){t=t||6e3,setTimeout(function(e){node.emit(e)},Math.random()*t,e)},n.prototype.randomExec=function(e,t){t=t||6e3,setTimeout(function(e){e.call()},Math.random()*t,e)},n.prototype.play=function(){this.game.start()},n.prototype.replay=function(e){e&&this.game.memory.clear(!0),this.game.execStep(this.plot.getStep("1.1.1"))}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient,r=t.GameMsg,i=t.GameStage,s=t.PlayerList,o=t.Player,u=t.JSUS,a=t.constants.action,f=t.constants.target,l=a.SAY+".",c=a.SET+".",h=a.GET+".",p=t.constants.IN;n.prototype.addDefaultIncomingListeners=function(e){var n=this;return n.incomingAdded&&!e?(n.err("Default incoming listeners already added once. Use the force flag to re-add."),!1):(n.events.ng.on(p+l+"PCONNECT",function(e){if(!e.data)return;n.game.pl.add(new o(e.data)),n.emit("UPDATED_PLIST")}),n.events.ng.on(p+l+"PDISCONNECT",function(e){if(!e.data)return;n.game.pl.remove(e.data.id),n.emit("UPDATED_PLIST")}),n.events.ng.on(p+l+"MCONNECT",function(e){if(!e.data)return;n.game.ml.add(new o(e.data)),n.emit("UPDATED_MLIST")}),n.events.ng.on(p+l+"MDISCONNECT",function(e){if(!e.data)return;n.game.ml.remove(e.data.id),n.emit("UPDATED_MLIST")}),n.events.ng.on(p+l+"PLIST",function(e){if(!e.data)return;n.game.pl=new s({},e.data),n.emit("UPDATED_PLIST")}),n.events.ng.on(p+l+"MLIST",function(e){if(!e.data)return;n.game.ml=new s({},e.data),n.emit("UPDATED_MLIST")}),n.events.ng.on(p+h+"DATA",function(e){e.text==="LOOP"&&n.socket.sendDATA(a.SAY,n.game.plot,e.from,"GAME")}),n.events.ng.on(p+c+"STATE",function(e){n.game.memory.add(e.text,e.data,e.from)}),n.events.ng.on(p+c+"DATA",function(e){n.game.memory.add(e.text,e.data,e.from)}),n.events.ng.on(p+l+"PLAYER_UPDATE",function(e){n.game.pl.updatePlayer(e.from,e.data),n.emit("UPDATED_PLIST"),n.game.shouldStep()}),n.events.ng.on(p+l+"STAGE",function(e){var t;if(!e.data){n.warn("Received in.say.STAGE msg with empty stage");return}t=n.game.plot.getStep(e.data);if(!t){n.err("Received in.say.STAGE msg with invalid stage");return}}),n.events.ng.on(p+l+"STAGE_LEVEL",function(e){}),n.events.ng.on(p+l+"REDIRECT",function(e){if(!e.data)return;if("undefined"==typeof window||!window.location)return n.err("window.location not found. Cannot redirect"),!1;window.location=e.data}),n.events.ng.on(p+l+"SETUP",function(e){console.log("* SETUP * ",e);if(!e.text)return;var t=e.text,r="string"==typeof e.data?u.parse(e.data):e.data;if(!r)return n.err("error while parsing incoming remote setup message"),!1;n.setup.apply(n,[t].concat(r))}),n.events.ng.on(p+l+"GAMECOMMAND",function(e){console.log("* GAMECOMMAND * ",e);if(!e.text||!t.constants.gamecommand[e.text]){n.err("unknown game command received: "+e.text);return}n.emit("NODEGAME_GAMECOMMAND_"+e.text,e.data)}),n.events.ng.on(p+l+"JOIN",function(e){if(!e.text)return;n.connect(e.text)}),n.incomingAdded=!0,n.silly("incoming listeners added"),!0)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(e,t){var n=t.NodeGameClient,r=t.GameMsg,i=t.GameStage,s=t.PlayerList,o=t.Player,u=t.JSUS,a=t.constants,f=a.action,l=a.target,c=f.SAY+".",h=f.SET+".",p=f.GET+".",d=a.OUT;n.prototype.addDefaultInternalListeners=function(e){var t=this;return this.internalAdded&&!e?(this.err("Default internal listeners already added once. Use the force flag to re-add."),!1):(this.events.ng.on("DONE",function(){var e=!0,n=t.game.getCurrentStep().done;n&&(e=n.apply(t.game,u.obj2Array(arguments)));if(!e)return;t.game.setStageLevel(a.stageLevels.DONE),t.emit("BEFORE_DONE"),t.game.shouldStep()}),this.events.ng.on("PLAYING",function(){t.game.setStageLevel(a.stageLevels.PLAYING),t.socket.clearBuffer(),t.emit("BEFORE_PLAYING")}),this.events.ng.on("NODEGAME_GAMECOMMAND_"+a.gamecommand.start,function(e){t.emit("BEFORE_GAMECOMMAND",a.gamecommand.start,e);if(t.game.getCurrentStep()&&t.game.getCurrentStep().stage!==0){t.err("Game already started. Use restart if you want to start the game again");return}t.game.start()}),this.incomingAdded=!0,this.silly("internal listeners added"),!0)}}("undefined"!=typeof node?node:module.exports,"undefined"!=typeof node?node:module.parent.exports),function(){var e=new window.node.NodeGameClient;JSUS.mixin(e,window.node),window.node=e}()