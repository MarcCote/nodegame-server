<!DOCTYPE html>
<html>
<head>
  <title>AdminServer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "lib/servers/AdminServer.js", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#adminserver">AdminServer</a>
      </div>
      <div class="heading h2">
        <a href="#global%20scope">Global scope</a>
      </div>
      <div class="heading h2">
        <a href="#adminserver%20constructor">AdminServer constructor</a>
      </div>
      <div class="heading h2">
        <a href="#adminserver%20methods">AdminServer methods</a>
      </div>
      <div class="heading h3">
        <a href="#adminserver.attachcustomlisteners">AdminServer.attachCustomListeners</a>
      </div>
      <div class="heading h3">
        <a href="#say.plist">say.PLIST</a>
      </div>
      <div class="heading h3">
        <a href="#say.pconnect">say.PCONNECT</a>
      </div>
      <div class="heading h3">
        <a href="#say.data">say.DATA</a>
      </div>
      <div class="heading h3">
        <a href="#say.txt">say.TXT</a>
      </div>
      <div class="heading h3">
        <a href="#say.redirect">say.REDIRECT</a>
      </div>
      <div class="heading h3">
        <a href="#say.setup">say.SETUP</a>
      </div>
      <div class="heading h3">
        <a href="#say.gamecommand">say.GAMECOMMAND</a>
      </div>
      <div class="heading h3">
        <a href="#say.alert">say.ALERT</a>
      </div>
      <div class="heading h3">
        <a href="#say.servercommand">say.SERVERCOMMAND</a>
      </div>
      <div class="heading h3">
        <a href="#set.lang">set.LANG</a>
      </div>
      <div class="heading h3">
        <a href="#get.servercommand">get.SERVERCOMMAND</a>
      </div>
      <div class="heading h3">
        <a href="#get.servercommand_disconnect">get.SERVERCOMMAND_DISCONNECT</a>
      </div>
      <div class="heading h3">
        <a href="#get.servercommand_roomcommand">get.SERVERCOMMAND_ROOMCOMMAND</a>
      </div>
      <div class="heading h3">
        <a href="#get.servercommand_startbot">get.SERVERCOMMAND_STARTBOT</a>
      </div>
      <div class="heading h3">
        <a href="#get.servercommand_startbot">get.SERVERCOMMAND_STARTBOT</a>
      </div>
      <div class="heading h3">
        <a href="#get.servercommand_info">get.SERVERCOMMAND_INFO</a>
      </div>
      <div class="heading h3">
        <a href="#get.servercommand_waitroomcommand">get.SERVERCOMMAND_WAITROOMCOMMAND</a>
      </div>
      <div class="heading h3">
        <a href="#get.gamecommand">get.GAMECOMMAND</a>
      </div>
      <div class="heading h3">
        <a href="#get.data">get.DATA</a>
      </div>
      <div class="heading h3">
        <a href="#set.data">set.DATA</a>
      </div>
      <div class="heading h3">
        <a href="#disconnect">disconnect</a>
      </div>
      <div class="heading h3">
        <a href="#shutdown">shutdown</a>
      </div>
      <div class="heading h3">
        <a href="#say.player_update">say.PLAYER_UPDATE</a>
      </div>
      <div class="heading h3">
        <a href="#adminserver.standardadminmsg">AdminServer.standardAdminMsg</a>
      </div>
      <div class="heading h3">
        <a href="#adminserver.standardadmin2playermsg">AdminServer.standardAdmin2PlayerMsg</a>
      </div>
      <div class="heading h3">
        <a href="#adminserver.standardgetmsg">AdminServer.standardGetMsg</a>
      </div>
      <div class="heading h2">
        <a href="#adminserver.notifyroomconnection">AdminServer.notifyRoomConnection</a>
      </div>
      <div class="heading h2">
        <a href="#adminserver.notifyroomdisconnection">AdminServer.notifyRoomDisconnection</a>
      </div>
      <div class="heading h1">
        <a href="#helper%20methods">Helper methods</a>
      </div>
      <div class="heading h2">
        <a href="#traversedirectory">traverseDirectory</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver">
  <h1>
    <a href="#adminserver" name="adminserver" class="pilcrow">&#182;</a>
    AdminServer
  </h1>
</div>


<p>Copyright(c) 2016 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p>GameServer for the administrators endpoint</p>

<p>Inherits from <code>GameServer</code> and attaches special listeners.</p>

<p>AdminServer removes the real client id of admin clients.</p>

<p>SET messages are ignored.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global%20scope">
  <h2>
    <a href="#global%20scope" name="global%20scope" class="pilcrow">&#182;</a>
    Global scope
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">AdminServer</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">GameServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./../GameServer&#39;</span><span class="p">),</span>
    <span class="nx">GameRoom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./../rooms/GameRoom&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">Logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./../Logger&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ngc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-client&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">action</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">action</span><span class="p">,</span>
    <span class="nx">target</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">constants</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">PlayerList</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">PlayerList</span><span class="p">,</span>
    <span class="nx">Player</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">Player</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">JSUS</span><span class="p">;</span>

<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">__proto__</span> <span class="o">=</span> <span class="nx">GameServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span>
<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">AdminServer</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver%20constructor">
  <h2>
    <a href="#adminserver%20constructor" name="adminserver%20constructor" class="pilcrow">&#182;</a>
    AdminServer constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates an instance of AdminServer</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>The configuration object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">AdminServer</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">GameServer</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ADMIN_SERVER</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="adminserver%20methods">
  <h2>
    <a href="#adminserver%20methods" name="adminserver%20methods" class="pilcrow">&#182;</a>
    AdminServer methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver.attachcustomlisteners">
  <h3>
    <a href="#adminserver.attachcustomlisteners" name="adminserver.attachcustomlisteners" class="pilcrow">&#182;</a>
    AdminServer.attachCustomListeners
  </h3>
</div>

  </div>
  <div class="body"><p>Implements <code>GameServer.attachCustomListeners</code></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">attachCustomListeners</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
        <span class="nx">sys</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">,</span>
        <span class="nx">say</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">SAY</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
        <span class="nx">set</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">SET</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span>
        <span class="nx">get</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">GET</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">registry</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>LISTENERS</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connecting&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">clientObj</span><span class="p">,</span> <span class="nx">roomName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">clientId</span><span class="p">;</span>

        <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">clientObj</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Incoming monitor: &#39;</span> <span class="o">+</span> <span class="nx">clientId</span><span class="p">);</span>
        <span class="nx">room</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">notifyRoomConnection</span><span class="p">(</span><span class="nx">clientObj</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>TODO: cleanup code, maybe merge with connecting.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;re-connecting&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">clientObj</span><span class="p">,</span> <span class="nx">roomName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">roomName</span><span class="p">,</span> <span class="nx">clientId</span><span class="p">;</span>

        <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">clientObj</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Returning admin: &#39;</span> <span class="o">+</span> <span class="nx">clientId</span><span class="p">);</span>

        <span class="nx">room</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>

        <span class="nx">msg</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;MRECONNECT&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span>   <span class="nx">clientObj</span><span class="p">,</span>
            <span class="nx">from</span><span class="o">:</span>   <span class="nx">clientId</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Unlike connect msgs, reconnect msgs are sent always just to admins.
Admins decides what to do with it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">that</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2group</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">admin</span><span class="p">,</span> <span class="nx">clientId</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.plist">
  <h3>
    <a href="#say.plist" name="say.plist" class="pilcrow">&#182;</a>
    say.PLIST
  </h3>
</div>


<p>Listens on say.PLIST messages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;PLIST&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdminMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.pconnect">
  <h3>
    <a href="#say.pconnect" name="say.pconnect" class="pilcrow">&#182;</a>
    say.PCONNECT
  </h3>
</div>


<p>Listens on say.PCONNECT messages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;PCONNECT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdminMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.data">
  <h3>
    <a href="#say.data" name="say.data" class="pilcrow">&#182;</a>
    say.DATA
  </h3>
</div>


<p>Listens on say.DATA messages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdminMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.txt">
  <h3>
    <a href="#say.txt" name="say.txt" class="pilcrow">&#182;</a>
    say.TXT
  </h3>
</div>


<p>Listens on say.TXT messages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;TXT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdminMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.redirect">
  <h3>
    <a href="#say.redirect" name="say.redirect" class="pilcrow">&#182;</a>
    say.REDIRECT
  </h3>
</div>


<p>Forwards a redirect msg (only for admin).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;REDIRECT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdmin2PlayerMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.setup">
  <h3>
    <a href="#say.setup" name="say.setup" class="pilcrow">&#182;</a>
    say.SETUP
  </h3>
</div>


<p>Forwards a redirect msg (only for admin).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;SETUP&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdmin2PlayerMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.gamecommand">
  <h3>
    <a href="#say.gamecommand" name="say.gamecommand" class="pilcrow">&#182;</a>
    say.GAMECOMMAND
  </h3>
</div>


<p>Forwards a gamecommand msg (only for admin).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;GAMECOMMAND&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdminMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.alert">
  <h3>
    <a href="#say.alert" name="say.alert" class="pilcrow">&#182;</a>
    say.ALERT
  </h3>
</div>


<p>Forwards a gamecommand msg (only for admin).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;ALERT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdmin2PlayerMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="say.servercommand">
  <h3>
    <a href="#say.servercommand" name="say.servercommand" class="pilcrow">&#182;</a>
    say.SERVERCOMMAND
  </h3>
</div>


<p>Re-emits a servercommand msg (only for admin).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;SERVERCOMMAND&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_&#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="set.lang">
  <h3>
    <a href="#set.lang" name="set.lang" class="pilcrow">&#182;</a>
    set.LANG
  </h3>
</div>


<p>Forwards a set language msg (only for admin).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">set</span> <span class="o">+</span> <span class="s1">&#39;LANG&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardAdmin2PlayerMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.servercommand">
  <h3>
    <a href="#get.servercommand" name="get.servercommand" class="pilcrow">&#182;</a>
    get.SERVERCOMMAND
  </h3>
</div>


<p>Re-emits a servercommand msg (only for admin).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">get</span> <span class="o">+</span> <span class="s1">&#39;SERVERCOMMAND&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_&#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.servercommand_disconnect">
  <h3>
    <a href="#get.servercommand_disconnect" name="get.servercommand_disconnect" class="pilcrow">&#182;</a>
    get.SERVERCOMMAND_DISCONNECT
  </h3>
</div>


<p>Disconnects a client from server</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_DISCONNECT&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">server</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_DISCONNECT: wrong data &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;parameter : &#39;</span> <span class="o">+</span> <span class="nx">data</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">||</span>
            <span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_DISCONNECT: data.id &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;anda data.sid must be string : &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Fetching the channel of the client to disconnect
(default: this channel).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">channel</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">channel</span> <span class="o">?</span>
            <span class="nx">data</span><span class="p">.</span><span class="nx">channel</span> <span class="o">:</span> <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Player or Admin server (default 'player').</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;admin&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">server</span> <span class="o">||</span>
            <span class="s1">&#39;player&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">server</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">server</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">server</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">server</span> <span class="o">=</span> <span class="s1">&#39;player&#39;</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_DISCONNECT: disconnecting &#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>

        <span class="nx">socket</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">[</span><span class="nx">server</span> <span class="o">+</span> <span class="s1">&#39;Server&#39;</span><span class="p">].</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_DISCONNECT: could not &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;find socket for client: &#39;</span> <span class="o">+</span> <span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">);</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_DISCONNECT: disconnected &#39;</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.servercommand_roomcommand">
  <h3>
    <a href="#get.servercommand_roomcommand" name="get.servercommand_roomcommand" class="pilcrow">&#182;</a>
    get.SERVERCOMMAND_ROOMCOMMAND
  </h3>
</div>


<p>Executes a command (startGame, pauseGame etc.) on a GameRoom.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_ROOMCOMMAND&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">rc</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">roomObj</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Look up room</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_ROOMCOMMAND: data has &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;invalid room field.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">roomObj</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Check data fields:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">rc</span> <span class="o">=</span> <span class="nx">GameRoom</span><span class="p">.</span><span class="nx">checkParams</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">doLogic</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">force</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">rc</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_ROOMCOMMAND: data has an &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;invalid field: &#39;</span> <span class="o">+</span> <span class="nx">rc</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;SETUP&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">roomObj</span><span class="p">.</span><span class="nx">setupGame</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span>
                              <span class="nx">data</span><span class="p">.</span><span class="nx">doLogic</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">force</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;START&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">roomObj</span><span class="p">.</span><span class="nx">startGame</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">doLogic</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">force</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;PAUSE&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">roomObj</span><span class="p">.</span><span class="nx">pauseGame</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">doLogic</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">force</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;RESUME&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">roomObj</span><span class="p">.</span><span class="nx">resumeGame</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">doLogic</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">force</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;STOP&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">roomObj</span><span class="p">.</span><span class="nx">stopGame</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">doLogic</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">clients</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">force</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_ROOMCOMMAND: data has &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;invalid type field.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.servercommand_startbot">
  <h3>
    <a href="#get.servercommand_startbot" name="get.servercommand_startbot" class="pilcrow">&#182;</a>
    get.SERVERCOMMAND_STARTBOT
  </h3>
</div>


<p>Starts a bot on the server using PhantomJS.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_JOINROOM&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">origRoom</span><span class="p">,</span> <span class="nx">newRoom</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newRoom</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomName</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">newRoom</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomName</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">newRoom</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_JOINROOM: room not found: &#39;</span> <span class="o">+</span>
                    <span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span> <span class="o">||</span> <span class="nx">data</span><span class="p">.</span><span class="nx">roomName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">origRoom</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">from</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">origRoom</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">channe</span><span class="p">.</span><span class="nx">placeClient</span><span class="p">(</span><span class="nx">from</span><span class="p">,</span> <span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.servercommand_startbot">
  <h3>
    <a href="#get.servercommand_startbot" name="get.servercommand_startbot" class="pilcrow">&#182;</a>
    get.SERVERCOMMAND_STARTBOT
  </h3>
</div>


<p>Starts a bot on the server using PhantomJS.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_STARTBOT&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">connectPhantom</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.servercommand_info">
  <h3>
    <a href="#get.servercommand_info" name="get.servercommand_info" class="pilcrow">&#182;</a>
    get.SERVERCOMMAND_INFO
  </h3>
</div>


<p>Sends information about the server.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_INFO&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">dataDir</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">replyData</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">chanObj</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">roomObj</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">gamesInfo</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">logicObj</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;CHANNELS&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Fill replyData with channel info:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">replyData</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">channels</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">extraInfo</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="nx">channel</span> <span class="k">in</span> <span class="nx">replyData</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">replyData</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">channel</span><span class="p">))</span> <span class="p">{</span>

                        <span class="nx">chanObj</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">channel</span><span class="p">];</span>
                        <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">nGameRooms</span> <span class="o">=</span>
                            <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">);</span>
                        <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">nConnClients</span> <span class="o">=</span>
                            <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getConnected</span><span class="p">());</span>
                        <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">nConnAdmins</span> <span class="o">=</span>
                            <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getConnectedAdmins</span><span class="p">());</span>
                        <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">nConnPlayers</span> <span class="o">=</span>
                            <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getConnectedPlayers</span><span class="p">());</span>
                        <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">nDisconnClients</span> <span class="o">=</span>
                            <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getDisconnected</span><span class="p">());</span>
                        <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">nDisconnAdmins</span> <span class="o">=</span>
                            <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getDisconnectedAdmins</span><span class="p">());</span>
                        <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">nDisconnPlayers</span> <span class="o">=</span>
                            <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getDisconnectedPlayers</span><span class="p">());</span>

                        <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">chanObj</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                            <span class="nx">replyData</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">ownChannel</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nx">that</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;INFO_CHANNELS&#39;</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="nx">replyData</span><span class="p">,</span>
                <span class="nx">to</span><span class="o">:</span>   <span class="nx">from</span>
            <span class="p">}));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;ROOMS&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">channels</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">channel</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_INFO.ROOMS: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;data.channel is invalid. Found: &#39;</span> <span class="o">+</span>
                        <span class="nx">data</span><span class="p">.</span><span class="nx">channel</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Fill replyData with room info:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">replyData</span> <span class="o">=</span> <span class="p">[];</span>

            <span class="nx">chanObj</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">channel</span><span class="p">];</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">room</span> <span class="k">in</span> <span class="nx">chanObj</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">chanObj</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">room</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">roomObj</span> <span class="o">=</span> <span class="nx">chanObj</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">room</span><span class="p">];</span>
                    <span class="nx">replyData</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                        <span class="nx">name</span><span class="o">:</span>       <span class="nx">room</span><span class="p">,</span>
                        <span class="nx">id</span><span class="o">:</span>         <span class="nx">roomObj</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                        <span class="nx">type</span><span class="o">:</span>       <span class="nx">roomObj</span><span class="p">.</span><span class="nx">roomType</span><span class="p">,</span>
                        <span class="nx">roomOpen</span><span class="o">:</span>   <span class="nx">roomObj</span><span class="p">.</span><span class="nx">roomOpen</span><span class="p">,</span>
                        <span class="nx">nClients</span><span class="o">:</span>   <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">db</span><span class="p">),</span>
                        <span class="nx">nPlayers</span><span class="o">:</span>   <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">db</span><span class="p">),</span>
                        <span class="nx">nAdmins</span><span class="o">:</span>    <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">db</span><span class="p">),</span>
                        <span class="nx">logicStage</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stage</span>
                    <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>TODO: connected/disconnected etc.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nx">that</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;INFO_ROOMS&#39;</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="nx">replyData</span><span class="p">,</span>
                <span class="nx">to</span><span class="o">:</span>   <span class="nx">from</span>
            <span class="p">}));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;CLIENTS&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Get room object:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.SERVERCOMMAND_INFO.CLIENTS: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;data.roomId is invalid. Found: &#39;</span> <span class="o">+</span>
                        <span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">roomObj</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">];</span>
            <span class="nx">logicObj</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClient</span><span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Fill replyData with client info:
TODO: Send only specific client data, not everything;
      send <em>paused</em> field</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

            <span class="nx">replyData</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">clients</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span>
                <span class="nx">logic</span><span class="o">:</span> <span class="p">{</span>
                    <span class="nx">stage</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stage</span><span class="p">,</span>
                    <span class="nx">stageLevel</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stageLevel</span><span class="p">,</span>
                    <span class="nx">stateLevel</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">stateLevel</span><span class="p">,</span>
                    <span class="nx">id</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                    <span class="nx">sid</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">sid</span><span class="p">,</span>
                    <span class="nx">admin</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                    <span class="nx">paused</span><span class="o">:</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">paused</span><span class="p">,</span>
                    <span class="nx">clientType</span><span class="o">:</span> <span class="nx">logicObj</span><span class="p">.</span><span class="nx">clientType</span><span class="p">,</span>
                    <span class="nx">lang</span><span class="o">:</span> <span class="nx">logicObj</span><span class="p">.</span><span class="nx">lang</span>
                <span class="p">}</span>
            <span class="p">};</span>

            <span class="nx">that</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;INFO_CLIENTS&#39;</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="nx">replyData</span><span class="p">,</span>
                <span class="nx">to</span><span class="o">:</span>   <span class="nx">from</span>
            <span class="p">}));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;GAMES&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gamesInfo</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">getGamesInfo</span><span class="p">();</span>
            <span class="nx">replyData</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Substitute the clientType functions with their keys.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">for</span> <span class="p">(</span><span class="nx">gameName</span> <span class="k">in</span> <span class="nx">gamesInfo</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">gamesInfo</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">gameName</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">replyData</span><span class="p">[</span><span class="nx">gameName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
                    <span class="k">for</span> <span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">gamesInfo</span><span class="p">[</span><span class="nx">gameName</span><span class="p">])</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">gamesInfo</span><span class="p">[</span><span class="nx">gameName</span><span class="p">].</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">p</span><span class="p">))</span> <span class="p">{</span>
                            <span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">===</span> <span class="s1">&#39;clientTypes&#39;</span><span class="p">)</span> <span class="p">{</span>
                                <span class="nx">replyData</span><span class="p">[</span><span class="nx">gameName</span><span class="p">].</span><span class="nx">clientTypes</span> <span class="o">=</span>
                                    <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span>
                                        <span class="nx">gamesInfo</span><span class="p">[</span><span class="nx">gameName</span><span class="p">].</span><span class="nx">clientTypes</span><span class="p">);</span>
                            <span class="p">}</span>
                            <span class="k">else</span> <span class="p">{</span>
                                <span class="nx">replyData</span><span class="p">[</span><span class="nx">gameName</span><span class="p">][</span><span class="nx">p</span><span class="p">]</span> <span class="o">=</span> <span class="nx">gamesInfo</span><span class="p">[</span><span class="nx">gameName</span><span class="p">][</span><span class="nx">p</span><span class="p">];</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="nx">that</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;INFO_GAMES&#39;</span><span class="p">,</span>
                <span class="nx">data</span><span class="o">:</span> <span class="nx">replyData</span><span class="p">,</span>
                <span class="nx">to</span><span class="o">:</span>   <span class="nx">from</span>
            <span class="p">}));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;RESULTS&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dataDir</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">getGameDir</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;data&#39;</span><span class="p">;</span>

            <span class="nx">replyData</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nx">lastModified</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
                <span class="nx">files</span><span class="o">:</span> <span class="p">[]</span>
            <span class="p">};</span>
            <span class="nx">traverseDirectory</span><span class="p">(</span><span class="nx">dataDir</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">d</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Save last modification date.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">d</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">replyData</span><span class="p">.</span><span class="nx">lastModified</span> <span class="o">||</span> <span class="nx">d</span> <span class="o">&gt;</span> <span class="nx">replyData</span><span class="p">.</span><span class="nx">lastModified</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">replyData</span><span class="p">.</span><span class="nx">lastModified</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">replyData</span><span class="p">.</span><span class="nx">files</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span>
                    <span class="p">{</span> <span class="nx">file</span><span class="o">:</span> <span class="nx">filePath</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">dataDir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">},</span>
                    <span class="p">{</span> <span class="nx">mtime</span><span class="o">:</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">mtime</span> <span class="p">}</span>
                <span class="p">]);</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Convert date and send.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">that</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;INFO_RESULTS&#39;</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span> <span class="nx">replyData</span><span class="p">,</span>
                    <span class="nx">to</span><span class="o">:</span>   <span class="nx">from</span>
                <span class="p">}));</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;LOGS&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">dataDir</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">logDir</span><span class="p">;</span>
            <span class="nx">replyData</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="nx">traverseDirectory</span><span class="p">(</span><span class="nx">dataDir</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;.log&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">replyData</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">basename</span><span class="p">(</span><span class="nx">filePath</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">},</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                    <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;INFO_LOGS&#39;</span><span class="p">,</span>
                    <span class="nx">data</span><span class="o">:</span> <span class="nx">replyData</span><span class="p">,</span>
                    <span class="nx">to</span><span class="o">:</span>   <span class="nx">from</span>
                <span class="p">}));</span>
            <span class="p">});</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>TODO: CLIENTS (admins or players),
      SERVERCONF,
      UPTIME</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.servercommand_waitroomcommand">
  <h3>
    <a href="#get.servercommand_waitroomcommand" name="get.servercommand_waitroomcommand" class="pilcrow">&#182;</a>
    get.SERVERCOMMAND_WAITROOMCOMMAND
  </h3>
</div>


<p>Listener to <code>WAITROOMCOMMAND</code> to OPEN, CLOSE and DISPATCH waitRoom</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
   <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SERVERCOMMAND_WAITROOMCOMMAND&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">from</span><span class="p">)</span> <span class="p">{</span>
       <span class="kd">var</span> <span class="nx">room</span><span class="p">;</span>

       <span class="nx">room</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">roomId</span><span class="p">]</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>open close wait room</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
       <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;CLOSE&#39;</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">room</span><span class="p">.</span><span class="nx">closeRoom</span><span class="p">();</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;OPEN&#39;</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">room</span><span class="p">.</span><span class="nx">openRoom</span><span class="p">();</span>
       <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>dispatch a new game</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
       <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;DISPATCH&#39;</span><span class="p">)</span> <span class="p">{</span>
           <span class="nx">room</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
               <span class="nx">msg</span><span class="o">:</span> <span class="p">{</span> <span class="nx">over</span><span class="o">:</span> <span class="s1">&#39;Monitor dispatched game.&#39;</span> <span class="p">},</span>
               <span class="nx">numberOfGames</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">numberOfGames</span><span class="p">,</span>
               <span class="nx">groupSize</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">groupSize</span><span class="p">,</span>
               <span class="nx">chosenTreatment</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">chosenTreatment</span>
           <span class="p">});</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
           <span class="nx">sys</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; unkwnon WAITROOMCOMMAND: &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
       <span class="p">}</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.gamecommand">
  <h3>
    <a href="#get.gamecommand" name="get.gamecommand" class="pilcrow">&#182;</a>
    get.GAMECOMMAND
  </h3>
</div>


<p>Listener on get.GAMECOMMAND
Important: the ID is not obfuscated.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">get</span> <span class="o">+</span> <span class="s1">&#39;GAMECOMMAND&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardGetMsg</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get.data">
  <h3>
    <a href="#get.data" name="get.data" class="pilcrow">&#182;</a>
    get.DATA
  </h3>
</div>


<p>Listener on get.DATA
Important: the ID is not obfuscated.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">get</span> <span class="o">+</span> <span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">standardGetMsg</span><span class="p">);</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="set.data">
  <h3>
    <a href="#set.data" name="set.data" class="pilcrow">&#182;</a>
    set.DATA
  </h3>
</div>


<p>Listens on set.DATA messages</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">set</span> <span class="o">+</span> <span class="s1">&#39;DATA&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Experimental</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="disconnect">
  <h3>
    <a href="#disconnect" name="disconnect" class="pilcrow">&#182;</a>
    disconnect
  </h3>
</div>


<p>Listens on admins disconnecting</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">monitor</span><span class="p">,</span> <span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">monitorName</span><span class="p">;</span>
        <span class="nx">monitorName</span> <span class="o">=</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39; (sid: &#39;</span> <span class="o">+</span> <span class="nx">monitor</span><span class="p">.</span><span class="nx">sid</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">;</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; client disconnected: &#39;</span> <span class="o">+</span> <span class="nx">monitorName</span><span class="p">);</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">notifyRoomDisconnection</span><span class="p">(</span><span class="nx">monitor</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="shutdown">
  <h3>
    <a href="#shutdown" name="shutdown" class="pilcrow">&#182;</a>
    shutdown
  </h3>
</div>


<p>Listens on server shutdown</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">sio</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;shutdown&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Admin server &#39;</span> <span class="o">+</span> <span class="nx">that</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; is shutting down.&#39;</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>TODO save the state to disk.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><p>TODO: monitors and admins connected remotely are not updated.
It could be set as an option, and should be considered also in
HostRoom, where, currently, some properties (like stage) are linked.</p>


<div class="pilwrap" id="say.player_update">
  <h3>
    <a href="#say.player_update" name="say.player_update" class="pilcrow">&#182;</a>
    say.PLAYER_UPDATE
  </h3>
</div>


<p>Listens on say.PLAYER_UPDATE messages</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">say</span> <span class="o">+</span> <span class="s1">&#39;PLAYER_UPDATE&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">clientObj</span><span class="p">;</span>
        <span class="nx">clientObj</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClient</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clientObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Admin server &#39;</span> <span class="o">+</span> <span class="nx">that</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; PLAYER_UPDATE msg from &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;unknwon client: &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span>
        <span class="nx">clientObj</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="p">]</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="p">];</span>
     <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>// ### say.STAGE
   // Listens on say.STAGE messages
   this.on(say + 'STAGE', function(msg) {
       var origFrom = msg.from;
       that.socketManager.broadcast(that.msg.obfuscate(msg), origFrom);
   });</p>

<p>// Transform in say
   this.on(set + 'STAGE', function(msg){
       //this.emit(say+'STAGE', msg);
   });</p>

<p>// ### say.STAGE_LEVEL
   // Listens on say.STAGE_LEVEL messages
   this.on(say + 'STAGE_LEVEL', function(msg) {
       var origFrom = msg.from;
       that.socketManager.broadcast(that.msg.obfuscate(msg), origFrom);
   });</p>

<p>// Transform in say
   this.on(set + 'STAGE_LEVEL', function(msg){
       //this.emit(say+'STAGE_LEVEL', msg);
   });</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


<span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver.standardadminmsg">
  <h3>
    <a href="#adminserver.standardadminmsg" name="adminserver.standardadminmsg" class="pilcrow">&#182;</a>
    AdminServer.standardAdminMsg
  </h3>
</div>

  </div>
  <div class="body"><p>Handles incoming messages to the Admin Server</p>

<p>Evaluates the <em>to</em> field and calls the right methods from the socket manager.</p>

<p>It is used for the following targets: PLIST, PCONNECT, DATA, TXT.</p>

<p>Note: it still possible to send messages to admin by specifying the direct
the client-id of the recipient.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">msg</span>
      <span class="dox_type">GameMsg</span>
      <span>The incoming game message</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">SocketManager
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">standardAdminMsg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">originalFrom</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">roomName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">admins</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>TODO: Obfuscate just for players.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">originalFrom</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
    <span class="nx">msg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">obfuscate</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ALL&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2all</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">originalFrom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;CHANNEL&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2ownChannel</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">originalFrom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ROOM&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2ownRoom</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">originalFrom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;CHANNEL_X&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2channel</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">_to</span><span class="p">,</span> <span class="nx">originalFrom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ROOM_X&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2room</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">_to</span><span class="p">,</span> <span class="nx">originalFrom</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;SERVER&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Send to admins in the room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">roomName</span> <span class="o">=</span>
                <span class="nx">msg</span><span class="p">.</span><span class="nx">_roomName</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">originalFrom</span><span class="p">);</span>
            <span class="nx">room</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.say.DATA: Could not &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;determine room of msg sender: &#39;</span> <span class="o">+</span> <span class="nx">originalFrom</span><span class="p">,</span>
                        <span class="s1">&#39;error&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">admins</span> <span class="o">=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">admin</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2group</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">admins</span><span class="p">,</span> <span class="nx">originalFrom</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>Send to single recipient.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver.standardadmin2playermsg">
  <h3>
    <a href="#adminserver.standardadmin2playermsg" name="adminserver.standardadmin2playermsg" class="pilcrow">&#182;</a>
    AdminServer.standardAdmin2PlayerMsg
  </h3>
</div>

  </div>
  <div class="body"><p>Handles incoming messages to the Admin Server directed to players only.</p>

<p>Evaluates the <em>to</em> field and calls the right methods from the socket manager.</p>

<p>It is used for the following targets: REDIRECT, GAMECOMMAND, ALERT, SETUP.</p>

<p>Note: it still possible to send messages to admin by specifying the direct
the client-id of the recipient.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">msg</span>
      <span class="dox_type">GameMsg</span>
      <span>The incoming game message</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">SocketManager
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">standardAdmin2PlayerMsg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">originalFrom</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">roomName</span><span class="p">,</span> <span class="nx">room</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;SERVER&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.&#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toEvent</span><span class="p">()</span> <span class="o">+</span>
                <span class="s1">&#39;: &quot;SERVER&quot; is not a valid recipient.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">originalFrom</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">;</span>
    <span class="nx">msg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">obfuscate</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ALL&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2allPlayers</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>

        <span class="nx">roomName</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">_roomName</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">originalFrom</span><span class="p">);</span>
        <span class="nx">room</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.&#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">toEvent</span><span class="p">()</span> <span class="o">+</span>
                    <span class="s1">&#39;: Could not determine room of msg sender: &#39;</span> <span class="o">+</span>
                    <span class="nx">originalFrom</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;CHANNEL&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2channelPlayers</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">room</span><span class="p">.</span><span class="nx">channel</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ROOM&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2roomPlayers</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">room</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;CHANNEL_X&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2channelPlayers</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">_to</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ROOM_X&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2roomPlayers</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">_to</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Send to single recipient (could be admin too).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver.standardgetmsg">
  <h3>
    <a href="#adminserver.standardgetmsg" name="adminserver.standardgetmsg" class="pilcrow">&#182;</a>
    AdminServer.standardGetMsg
  </h3>
</div>

  </div>
  <div class="body"><p>Handles incoming GET messages to the Admin Server</p>

<p>Special restrictions applies to the <code>text</code> field of the message:
  - must be a non-empty string
  - cannot contains the dot (.) character</p>

<p>Evaluates the <em>to</em> field and calls the right methods from the socket manager.</p>

<p>Note: it still possible to send messages to admin by specifying the direct
the client-id of the recipient.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">msg</span>
      <span class="dox_type">GameMsg</span>
      <span>The incoming game message</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">SocketManager
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">standardGetMsg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">roomName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">admins</span><span class="p">,</span> <span class="nx">oldAdmins</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">J</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.get.DATA: discarded invalid msg without &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;label.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.get.DATA: discarded invalid msg with &quot;.&quot; &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;character in the label.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ALL&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2all</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;CHANNEL&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2ownChannel</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ROOM&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2ownRoom</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;CHANNEL_X&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2channel</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">_to</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;ROOM_X&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2room</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">_to</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">to</span> <span class="o">===</span> <span class="s1">&#39;SERVER&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Send to admins in the room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">roomName</span> <span class="o">=</span>
                <span class="nx">msg</span><span class="p">.</span><span class="nx">_roomName</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">);</span>
            <span class="nx">room</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">sys</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;AdminServer.on.get.DATA: Could not determine &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;room of msg sender: &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">from</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">admins</span> <span class="o">=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">admin</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">broadcast2group</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">admins</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>Send to single recipient.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver.notifyroomconnection">
  <h2>
    <a href="#adminserver.notifyroomconnection" name="adminserver.notifyroomconnection" class="pilcrow">&#182;</a>
    AdminServer.notifyRoomConnection
  </h2>
</div>

  </div>
  <div class="body"><p>Implements GameServer.notifyRoomConnection</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">notifyRoomConnection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">clientObj</span><span class="p">,</span> <span class="nx">roomObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">players</span><span class="p">,</span> <span class="nx">admins</span><span class="p">,</span> <span class="nx">oldAdmins</span><span class="p">,</span> <span class="nx">clientId</span><span class="p">;</span>

    <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">clientObj</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="nx">players</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">;</span>
    <span class="nx">admins</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">admin</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">admins</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">oldAdmins</span> <span class="o">=</span> <span class="nx">admins</span><span class="p">.</span><span class="nx">breed</span><span class="p">();</span>
        <span class="nx">oldAdmins</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">clientId</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>Notifies other admins that a new one monitor connected.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2group</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;MCONNECT&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span>   <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">clientId</span> <span class="p">},</span>
            <span class="nx">from</span><span class="o">:</span>   <span class="nx">clientId</span>
        <span class="p">}),</span> <span class="nx">oldAdmins</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Send the list of connected admins to the new admin.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;SETUP&#39;</span><span class="p">,</span>
            <span class="nx">to</span><span class="o">:</span>     <span class="nx">clientId</span><span class="p">,</span>
            <span class="nx">text</span><span class="o">:</span>   <span class="s1">&#39;mlist&#39;</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span>   <span class="p">[</span><span class="nx">oldAdmins</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">]</span>
        <span class="p">}));</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Send the list of connected players to the new admin.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2client</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;SETUP&#39;</span><span class="p">,</span>
        <span class="nx">to</span><span class="o">:</span>     <span class="nx">clientId</span><span class="p">,</span>
        <span class="nx">text</span><span class="o">:</span>   <span class="s1">&#39;plist&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span>   <span class="p">[</span><span class="nx">players</span><span class="p">.</span><span class="nx">db</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">]</span>
    <span class="p">}));</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="adminserver.notifyroomdisconnection">
  <h2>
    <a href="#adminserver.notifyroomdisconnection" name="adminserver.notifyroomdisconnection" class="pilcrow">&#182;</a>
    AdminServer.notifyRoomDisconnection
  </h2>
</div>

  </div>
  <div class="body"><p>Implements GameServer.notifyRoomDisconnection</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">AdminServer</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">notifyRoomDisconnection</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">clientObj</span><span class="p">,</span> <span class="nx">roomObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">msg</span><span class="p">;</span>
    <span class="nx">msg</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
        <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;MDISCONNECT&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">clientObj</span><span class="p">.</span><span class="nx">id</span> <span class="p">}</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send2roomAdmins</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">roomObj</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods">
  <h1>
    <a href="#helper%20methods" name="helper%20methods" class="pilcrow">&#182;</a>
    Helper methods
  </h1>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="traversedirectory">
  <h2>
    <a href="#traversedirectory" name="traversedirectory" class="pilcrow">&#182;</a>
    traverseDirectory
  </h2>
</div>

  </div>
  <div class="body"><p>Applies callback to each file in directory recursively</p>

<p>The first time is called without the depth parameter.</p>

<p>Maximum depth of recursion is equal to 10.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The directory to explore</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">The</span>
      <span class="dox_type">function</span>
      <span>callback to apply to each path</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">The</span>
      <span class="dox_type">function</span>
      <span>callback to apply when all files in all directories
   have been scanned.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">depth</span>
      <span class="dox_type">number</span>
      <span>Optional. The current level of depth</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">traverseDirectory</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">callback</span><span class="p">,</span> <span class="nx">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">attemptDone</span><span class="p">,</span> <span class="nx">pending</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">depth</span><span class="p">,</span> <span class="nx">limit</span><span class="p">;</span>

    <span class="nx">limit</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="nx">depth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Start with one directory pending (data/).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="nx">attemptDone</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">filePath</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">done</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">stat</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="nx">pending</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="nx">done</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="kd">function</span> <span class="nx">recurse</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">depth</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">depth</span> <span class="o">&gt;=</span> <span class="nx">limit</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">attemptDone</span><span class="p">();</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">readdir</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>TODO: if directory does not exist, an
error will be thrown.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">files</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">filePath</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Ignore hidden files/dirs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
                <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Every file must be processed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">pending</span><span class="o">++</span><span class="p">;</span>
                <span class="nx">fs</span><span class="p">.</span><span class="nx">stat</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">stat</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>Recurse.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">stat</span> <span class="o">&amp;&amp;</span> <span class="nx">stat</span><span class="p">.</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
                        <span class="nx">recurse</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">attemptDone</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="nx">stat</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>Directory scanned (was a file in previous scan).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">pending</span><span class="o">--</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">recurse</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">depth</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
