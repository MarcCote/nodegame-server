<!DOCTYPE html>
<html>
<head>
  <title>WaitingRoom.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../", thisFile = "lib/rooms/WaitingRoom.js", defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#waitinroom">WaitinRoom</a>
      </div>
      <div class="heading h2">
        <a href="#global%20scope">Global scope</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.sortingcallbacks">WaitingRoom.sortingCallbacks</a>
      </div>
      <div class="heading h3">
        <a href="#timesnotselected">timesNotSelected</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.treatmentcallbacks">WaitingRoom.treatmentCallbacks</a>
      </div>
      <div class="heading h3">
        <a href="#treatment_rotate">treatment_rotate</a>
      </div>
      <div class="heading h3">
        <a href="#random">random</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.dispatchstates">WaitingRoom.dispatchStates</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom%20constructor">WaitingRoom constructor</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.roomopen">WaitingRoom.roomOpen</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.dispatching">WaitingRoom.dispatching</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.timeouts">WaitingRoom.timeOuts</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.notifytimeout">WaitingRoom.notifyTimeout</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.numberofdispatches">WaitingRoom.numberOfDispatches</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.lastgameroom">WaitingRoom.lastGameRoom</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.group_size">WaitingRoom.GROUP_SIZE</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.pool_size">WaitingRoom.POOL_SIZE</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.disconnect_if_not_selected">WaitingRoom.DISCONNECT_IF_NOT_SELECTED</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.timeouts">WaitingRoom.timeOuts</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.start_date">WaitingRoom.START_DATE</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.execution_mode">WaitingRoom.EXECUTION_MODE</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.max_wait_time">WaitingRoom.MAX_WAIT_TIME</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_timeout">WaitingRoom.ON_TIMEOUT</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_timeout_server">WaitingRoom.ON_TIMEOUT_SERVER</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_open">WaitingRoom.ON_OPEN</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_close">WaitingRoom.ON_CLOSE</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_connect">WaitingRoom.ON_CONNECT</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_disconnect">WaitingRoom.ON_DISCONNECT</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_init">WaitingRoom.ON_INIT</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_dispatch">WaitingRoom.ON_DISPATCH</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.on_dispatched">WaitingRoom.ON_DISPATCHED</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.chosen_treatment">WaitingRoom.CHOSEN_TREATMENT</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.player_sorting">WaitingRoom.PLAYER_SORTING</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.ping_before_dispatch">WaitingRoom.PING_BEFORE_DISPATCH</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.ispinginprogress">WaitingRoom.isPingInProgress</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.suspendedpings">WaitingRoom.suspendedPings</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.closeafterdispatch">WaitingRoom.closeAfterDispatch</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.notify_interval">WaitingRoom.NOTIFY_INTERVAL</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.parsesettings">WaitingRoom.parseSettings</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.makewidgetconfig">WaitingRoom.makeWidgetConfig</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.isroomopen">WaitingRoom.isRoomOpen</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.closeroom">WaitingRoom.closeRoom</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.openroom">WaitingRoom.openRoom</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.shoulddispatchmoregames">WaitingRoom.shouldDispatchMoreGames</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.kickunresponsiveplayers">WaitingRoom.kickUnresponsivePlayers</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.dispatch">WaitingRoom.dispatch</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.notifyplayerupdate">WaitingRoom.notifyPlayerUpdate</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.maketimeout">WaitingRoom.makeTimeOut</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.cleartimeout">WaitingRoom.clearTimeOut</a>
      </div>
      <div class="heading h2">
        <a href="#waitingroom.decidetreatment">WaitingRoom.decideTreatment</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.setdispatchstate">WaitingRoom.setDispatchState</a>
      </div>
      <div class="heading h3">
        <a href="#waitingroom.getdispatchstate">WaitingRoom.getDispatchState</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods">Helper methods</a>
      </div>
      <div class="heading h2">
        <a href="#checkpositiveinteger">checkPositiveInteger</a>
      </div>
      <div class="heading h2">
        <a href="#assigniffunction">assignIfFunction</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitinroom">
  <h1>
    <a href="#waitinroom" name="waitinroom" class="pilcrow">&#182;</a>
    WaitinRoom
  </h1>
</div>


<p>Copyright(c) 2016 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p>Waiting room.</p>

<p><a href='http://www.nodegame.org'>http://www.nodegame.org</a></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global%20scope">
  <h2>
    <a href="#global%20scope" name="global%20scope" class="pilcrow">&#182;</a>
    Global scope
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">WaitingRoom</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;JSUS&#39;</span><span class="p">).</span><span class="nx">JSUS</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">ngt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-game-template&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">PlayerList</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-client&#39;</span><span class="p">).</span><span class="nx">PlayerList</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">HostRoom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./HostRoom&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Inherit from HostRoom.
Same effect as <code>WaitingRoom.prototype.__proto__ = HostRoom.prototype;</code>
without relying on non-standard <code>__proto__</code></p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">HostRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>

<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">=</span> <span class="nx">WaitingRoom</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.sortingcallbacks">
  <h2>
    <a href="#waitingroom.sortingcallbacks" name="waitingroom.sortingcallbacks" class="pilcrow">&#182;</a>
    WaitingRoom.sortingCallbacks
  </h2>
</div>

  </div>
  <div class="body"><p>Predefined callbacks to sort the list of players before dispatching</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">sortingCallbacks</span> <span class="o">=</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="timesnotselected">
  <h3>
    <a href="#timesnotselected" name="timesnotselected" class="pilcrow">&#182;</a>
    timesNotSelected
  </h3>
</div>


<p>Gives priority to players which have been left out in previous dispatch</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">timesNotSelected</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="nx">a</span><span class="p">.</span><span class="nx">timesNotSelected</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">timesNotSelected</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nx">a</span><span class="p">.</span><span class="nx">timesNotSelected</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">.</span><span class="nx">timesNotSelected</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.treatmentcallbacks">
  <h2>
    <a href="#waitingroom.treatmentcallbacks" name="waitingroom.treatmentcallbacks" class="pilcrow">&#182;</a>
    WaitingRoom.treatmentCallbacks
  </h2>
</div>

  </div>
  <div class="body"><p>Names of callbacks for assigning treatments to groups of players</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">treatmentCallbacks</span> <span class="o">=</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Keep treatment_ in front to minimize risk of collision
with real treatment names.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="treatment_rotate">
  <h3>
    <a href="#treatment_rotate" name="treatment_rotate" class="pilcrow">&#182;</a>
    treatment_rotate
  </h3>
</div>


<p>Rotates across all treatments sequentially</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="s1">&#39;treatment_rotate&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="random">
  <h3>
    <a href="#random" name="random" class="pilcrow">&#182;</a>
    random
  </h3>
</div>


<p>Selects a random treatment (with re-sampling)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="s1">&#39;treatment_random&#39;</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.dispatchstates">
  <h2>
    <a href="#waitingroom.dispatchstates" name="waitingroom.dispatchstates" class="pilcrow">&#182;</a>
    WaitingRoom.dispatchStates
  </h2>
</div>

  </div>
  <div class="body"><p>States of the dispatching method</p>

<ul>
<li>NONE: no dispatching called
<ul><li>INITING: dispatching called, but can return if params are not correct</li>
<li>DISPATCHING: dispatching a group of players</li>
<li>NOTIFYING: dispatching is ending by notifying not selected players</li></ul></li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.dispatch
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">dispatchStates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">NONE</span><span class="o">:</span> <span class="s1">&#39;NONE&#39;</span><span class="p">,</span>
    <span class="nx">INITING</span><span class="o">:</span> <span class="s1">&#39;INITING&#39;</span><span class="p">,</span>
    <span class="nx">DISPATCHING</span><span class="o">:</span> <span class="s1">&#39;DISPATCHING&#39;</span><span class="p">,</span>
    <span class="nx">NOTIFYING</span><span class="o">:</span> <span class="s1">&#39;NOTIFYING&#39;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom%20constructor">
  <h2>
    <a href="#waitingroom%20constructor" name="waitingroom%20constructor" class="pilcrow">&#182;</a>
    WaitingRoom constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates a new instance of WaitingRoom</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">config</span>
      <span class="dox_type">object</span>
      <span>Configuration object</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">HostRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">WaitingRoom</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Supercall</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">HostRoom</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;Waiting&#39;</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">logicPath</span> <span class="o">=</span> <span class="nx">ngt</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;waitroom/waitroom.js&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.roomopen">
  <h3>
    <a href="#waitingroom.roomopen" name="waitingroom.roomopen" class="pilcrow">&#182;</a>
    WaitingRoom.roomOpen
  </h3>
</div>

  </div>
  <div class="body"><p>Flag indicating whether the room is open</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">roomOpen</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">roomOpen</span> <span class="o">||</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.dispatching">
  <h3>
    <a href="#waitingroom.dispatching" name="waitingroom.dispatching" class="pilcrow">&#182;</a>
    WaitingRoom.dispatching
  </h3>
</div>

  </div>
  <div class="body"><p>Numeric flag indicating whether the room is dispatching a new game</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">dispatching</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.timeouts">
  <h3>
    <a href="#waitingroom.timeouts" name="waitingroom.timeouts" class="pilcrow">&#182;</a>
    WaitingRoom.timeOuts
  </h3>
</div>

  </div>
  <div class="body"><p>Array of setTimeout return values indexed by playerIDs</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">timeOuts</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.notifytimeout">
  <h3>
    <a href="#waitingroom.notifytimeout" name="waitingroom.notifytimeout" class="pilcrow">&#182;</a>
    WaitingRoom.notifyTimeout
  </h3>
</div>

  </div>
  <div class="body"><p>A timeout to notify players about updates in the number of players</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.notifyPlayers
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">notifyTimeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.numberofdispatches">
  <h3>
    <a href="#waitingroom.numberofdispatches" name="waitingroom.numberofdispatches" class="pilcrow">&#182;</a>
    WaitingRoom.numberOfDispatches
  </h3>
</div>

  </div>
  <div class="body"><p>Non-negative integer indicating the number of game dispatches</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">numberOfDispatches</span> <span class="o">=</span> <span class="nx">config</span><span class="p">.</span><span class="nx">numberOfDispatches</span> <span class="o">||</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.lastgameroom">
  <h3>
    <a href="#waitingroom.lastgameroom" name="waitingroom.lastgameroom" class="pilcrow">&#182;</a>
    WaitingRoom.lastGameRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the last created game room</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">lastGameRoom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.group_size">
  <h3>
    <a href="#waitingroom.group_size" name="waitingroom.group_size" class="pilcrow">&#182;</a>
    WaitingRoom.GROUP_SIZE
  </h3>
</div>

  </div>
  <div class="body"><p>Positive non-zero integer indicating the size of each group</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">GROUP_SIZE</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.pool_size">
  <h3>
    <a href="#waitingroom.pool_size" name="waitingroom.pool_size" class="pilcrow">&#182;</a>
    WaitingRoom.POOL_SIZE
  </h3>
</div>

  </div>
  <div class="body"><p>Positive non-zero integer indicating number of clients for group forming</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">POOL_SIZE</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.disconnect_if_not_selected">
  <h3>
    <a href="#waitingroom.disconnect_if_not_selected" name="waitingroom.disconnect_if_not_selected" class="pilcrow">&#182;</a>
    WaitingRoom.DISCONNECT_IF_NOT_SELECTED
  </h3>
</div>

  </div>
  <div class="body"><p>Boolean or null, indicating whether unselected players are disconnected</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.timeouts">
  <h3>
    <a href="#waitingroom.timeouts" name="waitingroom.timeouts" class="pilcrow">&#182;</a>
    WaitingRoom.timeOuts
  </h3>
</div>

  </div>
  <div class="body"><p>Array of setTimeout return values indexed by playerIDs</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.start_date">
  <h3>
    <a href="#waitingroom.start_date" name="waitingroom.start_date" class="pilcrow">&#182;</a>
    WaitingRoom.START_DATE
  </h3>
</div>

  </div>
  <div class="body"><p>Time and date of game start</p>

<p>Must be valid input for <code>Date</code> constructor</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">START_DATE</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.execution_mode">
  <h3>
    <a href="#waitingroom.execution_mode" name="waitingroom.execution_mode" class="pilcrow">&#182;</a>
    WaitingRoom.EXECUTION_MODE
  </h3>
</div>

  </div>
  <div class="body"><p>String indicating execution mode</p>

<p>In the execution mode ´'TIMEOUT'´, one waits until the time is up, then
it will be checked whether enough players are there to start the game.
In the execution mode ´'WAIT_FOR_N_PLAYERS'´, the game starts right away
if there are the desired number of players. Otherwise, when the time is
up, it will be checked if there are at least a certain minimum number of
players to start the game.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.max_wait_time">
  <h3>
    <a href="#waitingroom.max_wait_time" name="waitingroom.max_wait_time" class="pilcrow">&#182;</a>
    WaitingRoom.MAX_WAIT_TIME
  </h3>
</div>

  </div>
  <div class="body"><p>Positive non-zero integer indicating max number of milliseconds to start</p>

<p>Cannot be defined at the same time as <code>WaitingRoom.START_DATE</code></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_timeout">
  <h3>
    <a href="#waitingroom.on_timeout" name="waitingroom.on_timeout" class="pilcrow">&#182;</a>
    WaitingRoom.ON_TIMEOUT
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed client-side after waiting time has elapsed</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_TIMEOUT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_timeout_server">
  <h3>
    <a href="#waitingroom.on_timeout_server" name="waitingroom.on_timeout_server" class="pilcrow">&#182;</a>
    WaitingRoom.ON_TIMEOUT_SERVER
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed after a timeout has expired</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_TIMEOUT_SERVER</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_open">
  <h3>
    <a href="#waitingroom.on_open" name="waitingroom.on_open" class="pilcrow">&#182;</a>
    WaitingRoom.ON_OPEN
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed when the waiting room becomes open</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_OPEN</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_close">
  <h3>
    <a href="#waitingroom.on_close" name="waitingroom.on_close" class="pilcrow">&#182;</a>
    WaitingRoom.ON_CLOSE
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed when the waiting room becomes close</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_CLOSE</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_connect">
  <h3>
    <a href="#waitingroom.on_connect" name="waitingroom.on_connect" class="pilcrow">&#182;</a>
    WaitingRoom.ON_CONNECT
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed when a player connects</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_CONNECT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_disconnect">
  <h3>
    <a href="#waitingroom.on_disconnect" name="waitingroom.on_disconnect" class="pilcrow">&#182;</a>
    WaitingRoom.ON_DISCONNECT
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed when a player disconnects</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_DISCONNECT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_init">
  <h3>
    <a href="#waitingroom.on_init" name="waitingroom.on_init" class="pilcrow">&#182;</a>
    WaitingRoom.ON_INIT
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed after the settings have been parsed</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_INIT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_dispatch">
  <h3>
    <a href="#waitingroom.on_dispatch" name="waitingroom.on_dispatch" class="pilcrow">&#182;</a>
    WaitingRoom.ON_DISPATCH
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed just before starting dispatching</p>

<p>Receives the options of the dispatch call as second param</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_DISPATCH</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.on_dispatched">
  <h3>
    <a href="#waitingroom.on_dispatched" name="waitingroom.on_dispatched" class="pilcrow">&#182;</a>
    WaitingRoom.ON_DISPATCHED
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to be executed at the end of a dispatch call</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">ON_DISPATCHED</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.chosen_treatment">
  <h3>
    <a href="#waitingroom.chosen_treatment" name="waitingroom.chosen_treatment" class="pilcrow">&#182;</a>
    WaitingRoom.CHOSEN_TREATMENT
  </h3>
</div>

  </div>
  <div class="body"><p>String or undefined indicating chosen treatment</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.player_sorting">
  <h3>
    <a href="#waitingroom.player_sorting" name="waitingroom.player_sorting" class="pilcrow">&#182;</a>
    WaitingRoom.PLAYER_SORTING
  </h3>
</div>

  </div>
  <div class="body"><p>Callback to sort the list of players before dispatching</p>

<p>If NULL, random sorting takes place. Default: 'timesNotSelected'</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span> <span class="o">=</span> <span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">sortingCallbacks</span><span class="p">.</span><span class="nx">timesNotSelected</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.ping_before_dispatch">
  <h3>
    <a href="#waitingroom.ping_before_dispatch" name="waitingroom.ping_before_dispatch" class="pilcrow">&#182;</a>
    WaitingRoom.PING_BEFORE_DISPATCH
  </h3>
</div>

  </div>
  <div class="body"><p>If TRUE, all players are pinged before a dispatch (Default: TRUE)</p>

<p>Non-responding clients are disconnected.</p>

<p>If only one player is needed and mode is 'WAIT_FOR_N_PLAYERS',
pinging is skipped.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">PING_BEFORE_DISPATCH</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.ispinginprogress">
  <h3>
    <a href="#waitingroom.ispinginprogress" name="waitingroom.ispinginprogress" class="pilcrow">&#182;</a>
    WaitingRoom.isPingInProgress
  </h3>
</div>

  </div>
  <div class="body"><p>Flag to indicate whether currently pinging for unresponsive players</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">isPingInProgress</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.suspendedpings">
  <h3>
    <a href="#waitingroom.suspendedpings" name="waitingroom.suspendedpings" class="pilcrow">&#182;</a>
    WaitingRoom.suspendedPings
  </h3>
</div>

  </div>
  <div class="body"><p>Flag to indicate whether currently pinging for unresponsive players</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">suspendedPings</span> <span class="o">=</span> <span class="p">[];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.closeafterdispatch">
  <h3>
    <a href="#waitingroom.closeafterdispatch" name="waitingroom.closeafterdispatch" class="pilcrow">&#182;</a>
    WaitingRoom.closeAfterDispatch
  </h3>
</div>

  </div>
  <div class="body"><p>Flag that the waiting room will close after next dispatch</p>

<p>Note: waiting room can dispatch multiple groups, and then will close</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">closeAfterDispatch</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.notify_interval">
  <h3>
    <a href="#waitingroom.notify_interval" name="waitingroom.notify_interval" class="pilcrow">&#182;</a>
    WaitingRoom.NOTIFY_INTERVAL
  </h3>
</div>

  </div>
  <div class="body"><p>The number of milliseconds to wait before sending a player-update message</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.notifyPlayerUpdate
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">NOTIFY_INTERVAL</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.parsesettings">
  <h2>
    <a href="#waitingroom.parsesettings" name="waitingroom.parsesettings" class="pilcrow">&#182;</a>
    WaitingRoom.parseSettings
  </h2>
</div>

  </div>
  <div class="body"><p>Validates settings and appends values to <code>this</code></p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>Configuration object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseSettings</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">d</span><span class="p">,</span> <span class="nx">where</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">t</span><span class="p">;</span>
    <span class="nx">gameName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="p">;</span>
    <span class="nx">where</span> <span class="o">=</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;WaitingRoom.parseSettings: &#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;settings must be object. Found: &#39;</span> <span class="o">+</span>
                            <span class="nx">settings</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">checkPositiveInteger</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="s1">&#39;GROUP_SIZE&#39;</span><span class="p">,</span> <span class="nx">where</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">GROUP_SIZE</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;GROUP_SIZE must be a positive number. &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;Found: &#39;</span> <span class="o">+</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">checkPositiveInteger</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="s1">&#39;POOL_SIZE&#39;</span><span class="p">,</span> <span class="nx">where</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">POOL_SIZE</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;POOL_SIZE must be a positive &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">POOL_SIZE</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">POOL_SIZE</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;POOL_SIZE should be larger or equal &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;to GROUP_SIZE. Found: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">POOL_SIZE</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span>
                            <span class="k">this</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">N_GAMES</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">checkPositiveInteger</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="s1">&#39;N_GAMES&#39;</span><span class="p">,</span> <span class="nx">where</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">N_GAMES</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;N_GAMES must be a positive number &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;or undefined. Found: &#39;</span> <span class="o">+</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">N_GAMES</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">NOTIFY_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">NOTIFY_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">checkPositiveInteger</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="s1">&#39;NOTIFY_INTRVAL&#39;</span><span class="p">,</span> <span class="nx">where</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">NOTIFY_INTERVAL</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">NOTIFY_INTERVAL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;NOTIFY_INTERVAL must be a positive &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">NOTIFY_INTERVAL</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;boolean&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span> <span class="o">=</span>
                <span class="nx">settings</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;DISCONNECT_IF_NOT_SELECTED must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be boolean or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">DISPATCH_TO_SAME_ROOM</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;boolean&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">DISPATCH_TO_SAME_ROOM</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">DISPATCH_TO_SAME_ROOM</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">DISPATCH_TO_SAME_ROOM</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;DISPATCH_TO_SAME_ROOM must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be boolean or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">DISPATCH_TO_SAME_ROOM</span> <span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;EXECUTION_MODE must be string. Found: &#39;</span> <span class="o">+</span>
                            <span class="nx">settings</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">!==</span> <span class="s1">&#39;TIMEOUT&#39;</span> <span class="o">&amp;&amp;</span>
            <span class="nx">settings</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">!==</span> <span class="s1">&#39;WAIT_FOR_N_PLAYERS&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;Invalid execution mode: &#39;</span> <span class="o">+</span>
                            <span class="nx">settings</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">START_DATE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">===</span> <span class="s1">&#39;WAIT_FOR_N_PLAYERS&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;Execution mode &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">+</span>
                            <span class="s1">&#39; cannot have a START_DATE&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">START_DATE</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;START_DATE must be valid argument &#39;</span> <span class="o">+</span>
                             <span class="s1">&#39;for Date constructor. Found: &#39;</span> <span class="o">+</span>
                             <span class="nx">settings</span><span class="p">.</span><span class="nx">START_DATE</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;Cannot define both MAX_WAIT_TIME and &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;START_DATE.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">START_DATE</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">START_DATE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">checkPositiveInteger</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="s1">&#39;MAX_WAIT_TIME&#39;</span><span class="p">,</span> <span class="nx">where</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;MAX_WAIT_TIME must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">===</span> <span class="s1">&#39;TIMEOUT&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;For EXECUTION_MODE=&quot;TIMEOUT&quot; either &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;MAX_WAIT_TIME or START_DATE must be defined.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_TIMEOUT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_TIMEOUT_SERVER&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_OPEN&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_CLOSE&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_INIT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_CONNECT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_DISCONNECT&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_DISPATCH&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

    <span class="nx">assignIfFunction</span><span class="p">(</span><span class="s1">&#39;ON_DISPATCHED&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>


    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">treatmentCallbacks</span><span class="p">[</span><span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">])</span> <span class="p">{</span>

                <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameLevel</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Treatments are not yet parsed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">levels</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">gameLevel</span><span class="p">].</span><span class="nx">settings</span><span class="p">.</span><span class="nx">treatments</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Treatments are already parsed at this point.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">t</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">settings</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">[</span><span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">])</span> <span class="p">{</span>

                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;CHOSEN_TREATMENT algorithm &#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;or treatment not found: &#39;</span> <span class="o">+</span>
                                        <span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;CHOSEN_TREATMENT must be string, &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">sortingCallbacks</span><span class="p">[</span><span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">])</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;PLAYER_SORTING algorithm &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;not found: &#39;</span> <span class="o">+</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span> <span class="o">&amp;&amp;</span>
                 <span class="kc">null</span> <span class="o">!==</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;PLAYER_SORTING must be string, &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function, null or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span> <span class="o">&amp;&amp;</span>
            <span class="kc">null</span> <span class="o">!==</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;PLAYER_GROUPING must be function, &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;null or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PING_BEFORE_DISPATCH</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;boolean&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PING_BEFORE_DISPATCH</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;PING_BEFORE_DISPATCH must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;be boolean or undefined. Found: &#39;</span> <span class="o">+</span>
                                <span class="nx">settings</span><span class="p">.</span><span class="nx">PING_BEFORE_DISPATCH</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">PING_BEFORE_DISPATCH</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">PING_BEFORE_DISPATCH</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Executes ON_INIT, if found.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_INIT</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">ON_INIT</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.makewidgetconfig">
  <h2>
    <a href="#waitingroom.makewidgetconfig" name="waitingroom.makewidgetconfig" class="pilcrow">&#182;</a>
    WaitingRoom.makeWidgetConfig
  </h2>
</div>

  </div>
  <div class="body"><p>Creates an object to configure the <code>WaitingRoom</code> widget</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>The configuration object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeWidgetConfig</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">groupSize</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">,</span>
        <span class="nx">poolSize</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">,</span>
        <span class="nx">disconnectIfNotSelected</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span><span class="p">,</span>
        <span class="nx">nGames</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span><span class="p">,</span>
        <span class="nx">startDate</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">START_DATE</span><span class="p">,</span>
        <span class="nx">executionMode</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span><span class="p">,</span>
        <span class="nx">maxWaitTime</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span><span class="p">,</span>
        <span class="nx">onTimeout</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ON_TIMEOUT</span><span class="p">,</span>
        <span class="nx">chosenTreatment</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span>
    <span class="p">};</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.isroomopen">
  <h2>
    <a href="#waitingroom.isroomopen" name="waitingroom.isroomopen" class="pilcrow">&#182;</a>
    WaitingRoom.isRoomOpen
  </h2>
</div>

  </div>
  <div class="body"><p>Returns flag indicating whether the <code>WaitingRoom</code> is open</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>Flag indicating whether <code>this</code> is open</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isRoomOpen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">roomOpen</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.closeroom">
  <h2>
    <a href="#waitingroom.closeroom" name="waitingroom.closeroom" class="pilcrow">&#182;</a>
    WaitingRoom.closeRoom
  </h2>
</div>

  </div>
  <div class="body"><p>Changes state of <code>this</code> to closed</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mod</span>
      <span class="dox_type">string</span>
      <span>Optional. Modifies the behavior of closeRoom.
  Available options:

<ul>
<li>'now': (default)</li>
<li>'afterDispatch': true/false</li>
</ul></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">param</span>
      <span class="dox_type">mixed</span>
      <span>Optional. Parameter for modifier</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">closeRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mod</span><span class="p">,</span> <span class="nx">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">&amp;&amp;</span> <span class="nx">mod</span> <span class="o">!==</span> <span class="s1">&#39;now&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mod</span> <span class="o">===</span> <span class="s1">&#39;afterDispatch&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">closeAfterDispatch</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;WaitingRoom.closeRoom: unknown modifier: &#39;</span> <span class="o">+</span> <span class="nx">mod</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">roomOpen</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_CLOSE</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">ON_CLOSE</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.openroom">
  <h2>
    <a href="#waitingroom.openroom" name="waitingroom.openroom" class="pilcrow">&#182;</a>
    WaitingRoom.openRoom
  </h2>
</div>

  </div>
  <div class="body"><p>Changes state of <code>this</code> to open</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">openRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">roomOpen</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_OPEN</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">ON_OPEN</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.shoulddispatchmoregames">
  <h3>
    <a href="#waitingroom.shoulddispatchmoregames" name="waitingroom.shoulddispatchmoregames" class="pilcrow">&#182;</a>
    WaitingRoom.shouldDispatchMoreGames
  </h3>
</div>

  </div>
  <div class="body"><p>Checks whether another game can be dispatched</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">shouldDispatchMoreGames</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">roomOpen</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span><span class="p">)</span> <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">numberOfDispatches</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>TODO: Maybe check other conditions?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.kickunresponsiveplayers">
  <h3>
    <a href="#waitingroom.kickunresponsiveplayers" name="waitingroom.kickunresponsiveplayers" class="pilcrow">&#182;</a>
    WaitingRoom.kickUnresponsivePlayers
  </h3>
</div>

  </div>
  <div class="body"><p>Pings all players and kicks those who fail to respond</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">callback</span>
      <span class="dox_type">function</span>
      <span>Callback to be executed when pinging
   is completed with WaitingRoom as context.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Options object. Accepted values:

<ul>
<li>callbackArgs: (array) arguments to be passed to the callback</li>
<li>timeToWaitForPing: Wait time before kicking in milliseconds.
   Default: 100</li>
<li>waitFullTime: If TRUE, callback is executed after
   (timeToWaitForPing + 500). If FALSE callback is executed when
   pinging is complete.</li>
</ul></span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">kickUnresponsivePlayers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">that</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">timeToWaitForPing</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">doTimeout</span><span class="p">,</span> <span class="nx">timeout</span><span class="p">,</span> <span class="nx">totReturnedPings</span><span class="p">,</span> <span class="nx">pingSuccessCb</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">players</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">pList</span><span class="p">,</span> <span class="nx">pLen</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">where</span><span class="p">;</span>

    <span class="nx">where</span> <span class="o">=</span> <span class="s1">&#39;WaitingRoom.kickUnresponsivePlayers&#39;</span><span class="p">;</span>
    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isPingInProgress</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Warning: Suspending call to &#39;</span> <span class="o">+</span> <span class="nx">where</span> <span class="o">+</span>
               <span class="s1">&#39; because kicking is still in progress.&#39;</span><span class="p">);</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">suspendedPings</span><span class="p">.</span><span class="nx">push</span><span class="p">([</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">options</span><span class="p">]);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>Lock this function.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">isPingInProgress</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="nx">players</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">db</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>Manual copy of player list.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">pList</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PlayerList</span><span class="p">();</span>
    <span class="nx">pLen</span> <span class="o">=</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Need to update pcounter because we use .insert below.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">pList</span><span class="p">.</span><span class="nx">pcounter</span> <span class="o">=</span> <span class="nx">pLen</span><span class="p">;</span>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">timeToWaitForPing</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">timeToWaitForPing</span> <span class="o">||</span> <span class="mi">250</span><span class="p">;</span>
    <span class="nx">doTimeout</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">waitFullTime</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Create callback that will be executed if all players return from PING.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">cb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>When done, unlock function.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">that</span><span class="p">.</span><span class="nx">isPingInProgress</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">success</span> <span class="o">&amp;&amp;</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>Add list of pinged players to dispatch options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">options</span><span class="p">.</span><span class="nx">callbackArgs</span><span class="p">.</span><span class="nx">pList</span> <span class="o">=</span> <span class="nx">pList</span><span class="p">;</span>
            <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">callbackArgs</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Execute suspended calls.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">suspendedPings</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>that.dispatch.apply(that, that.suspendedPings.pop());</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Cancel suspended pings if waiting room is closed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">shouldDispatchMoreGames</span><span class="p">())</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Warning: room is closed. Clearing previously &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;suspended pings.&#39;</span><span class="p">);</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">suspendedPings</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nx">that</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Warning: not enough players now. &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;Aborting previously suspended pings.&#39;</span><span class="p">);</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">suspendedPings</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">kickUnresponsivePlayers</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span>
                                                   <span class="nx">that</span><span class="p">.</span><span class="nx">suspendedPings</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Setup variables for pinging all players.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>Count total pings received back.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">totReturnedPings</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>Callback to execute when a ping-back is received:
do nothing if we have a timeout.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">pingSuccessCb</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">totReturnedPings</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">totReturnedPings</span> <span class="o">===</span> <span class="nx">pLen</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>Mark it as executed (for the timeout).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">totReturned</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">timeout</span><span class="p">)</span> <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span>
            <span class="nx">cb</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">players</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">p</span> <span class="o">=</span> <span class="nx">players</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Call .insert, not .add (saves some operations).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">pList</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">p</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Pinging player &#39;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">timeToWaitForPing</span><span class="p">);</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;PING&#39;</span><span class="p">,</span> <span class="nx">pingSuccessCb</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">timeout</span><span class="o">:</span> <span class="nx">timeToWaitForPing</span><span class="p">,</span>
            <span class="nx">executeOnce</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>The callback on failure.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">timeoutCb</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Mark the PING failed by decreasing totReturned.
Since the whole process is asynchronous, a PING
message could be processed just before the
disconnection takes place.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">totReturnedPings</span><span class="o">--</span><span class="p">;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Player %s unresponsive. Kicking.&#39;</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
                        <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;SERVERCOMMAND&#39;</span><span class="p">,</span>
                        <span class="nx">text</span><span class="o">:</span> <span class="s1">&#39;DISCONNECT&#39;</span><span class="p">,</span>
                        <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
                            <span class="nx">id</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                            <span class="nx">sid</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">sid</span>
                        <span class="p">}</span>
                    <span class="p">}));</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Remove it from pList in case a timeout is set.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">doTimeout</span><span class="p">)</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
                <span class="p">};</span>
            <span class="p">})(</span><span class="nx">p</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
        <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>Do Timeout (execute the cb, also if some players got disconnected).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>TODO: Check these conditions.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">cb</span><span class="p">(</span><span class="nx">totReturnedPings</span> <span class="o">===</span> <span class="nx">pLen</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">timeToWaitForPing</span> <span class="o">+</span> <span class="mi">2000</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.dispatch">
  <h2>
    <a href="#waitingroom.dispatch" name="waitingroom.dispatch" class="pilcrow">&#182;</a>
    WaitingRoom.dispatch
  </h2>
</div>

  </div>
  <div class="body"><p>Initiates the start of the game</p>

<p>It is assumed that it is called only after connected players > POOL_SIZE.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">opts</span>
      <span class="dox_type">object</span>
      <span>Optional. Configuration options for the method.
  Available options:

<ul>
<li>numberOfGames: sets the number of games to dispatch</li>
<li>closeAfterDispatch: closes the waiting room after this dispatch</li>
<li>msg: dispatch-message to send to all players. Default:
   { action: 'AllPlayersConnected', exit: 0 }</li>
</ul></span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">dispatch</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">doDispatch</span><span class="p">,</span> <span class="nx">where</span><span class="p">,</span> <span class="nx">parseGroupSizeOptions</span><span class="p">,</span> <span class="nx">checkShouldDispatch</span><span class="p">;</span>
    <span class="nx">where</span> <span class="o">=</span> <span class="s1">&#39;WaitingRoom.dispatch: &#39;</span><span class="p">;</span>

    <span class="nx">checkShouldDispatch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>Check if we are still allowed to dispatch games.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">shouldDispatchMoreGames</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39; waiting room is closed. &#39;</span> <span class="o">+</span>
                                       <span class="s1">&#39;Dispatches: &#39;</span> <span class="o">+</span>
                                       <span class="k">this</span><span class="p">.</span><span class="nx">numberOfDispatches</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span>
                                       <span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span> <span class="o">+</span>
                                       <span class="s1">&#39;. Aborting current dispatch.&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;warning&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">suspendedPings</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">suspendedPings</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">parseGroupSizeOptions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">groupSize</span><span class="p">,</span> <span class="nx">numberOfGames</span><span class="p">,</span> <span class="nx">nPlayers</span><span class="p">;</span>
        <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">groupSize</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">groupSize</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">isInt</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">groupSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="kc">false</span> <span class="o">===</span> <span class="nx">groupSize</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;opts.groupSize must be a &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;positive number or undefined. Found: &#39;</span> <span class="o">+</span>
                                    <span class="nx">opts</span><span class="p">.</span><span class="nx">groupSize</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">groupSize</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">GROUP_SIZE</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>If nothing is specified, try to dispatch maximal amount of games.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">numberOfGames</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">numberOfGames</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">numberOfGames</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">nPlayers</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">nPlayers</span> <span class="o">||</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">MAX_WAIT_TIME</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">===</span> <span class="s1">&#39;TIMEOUT&#39;</span><span class="p">)</span> <span class="p">{</span>

                <span class="nx">numberOfGames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">numberOfGames</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">nPlayers</span> <span class="o">/</span> <span class="nx">groupSize</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">numberOfGames</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">numberOfGames</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">N_GAMES</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">opts</span><span class="p">.</span><span class="nx">numberOfGames</span> <span class="o">=</span> <span class="nx">numberOfGames</span><span class="p">;</span>
        <span class="nx">opts</span><span class="p">.</span><span class="nx">groupSize</span> <span class="o">=</span> <span class="nx">groupSize</span><span class="p">;</span>

        <span class="k">return</span> <span class="nx">opts</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nx">doDispatch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">treatmentName</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">dispatchList</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">pId</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">groupIdx</span><span class="p">,</span> <span class="nx">groupLimit</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">gameRoom</span><span class="p">,</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">gameNumber</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">pList</span><span class="p">,</span> <span class="nx">nPlayers</span><span class="p">,</span> <span class="nx">nPlayersToDispatch</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">groups</span><span class="p">,</span> <span class="nx">nGroupsCreated</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">numberOfGames</span><span class="p">,</span> <span class="nx">groupSize</span><span class="p">,</span> <span class="nx">closeAfterDispatch</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">sysLogger</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Have we dispatched 'em all?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">checkShouldDispatch</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setDispatchState</span><span class="p">(</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">dispatchStates</span><span class="p">.</span><span class="nx">INITING</span><span class="p">);</span>

        <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>
        <span class="nx">sysLogger</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_DISPATCH</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">ON_DISPATCH</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>If coming from a "kick," there might be more players than
when the original call to dispatch was performed. Additional
players have not been tested, therefore "kick" must pass
the list of tested players.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">pList</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">pList</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">;</span>
        <span class="nx">nPlayers</span> <span class="o">=</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>

        <span class="nx">groupSize</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">groupSize</span><span class="p">;</span>
        <span class="nx">numberOfGames</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">numberOfGames</span><span class="p">;</span>

        <span class="nx">msg</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">msg</span> <span class="o">||</span> <span class="p">{</span> <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;AllPlayersConnected&#39;</span><span class="p">,</span> <span class="nx">exit</span><span class="o">:</span> <span class="mi">0</span> <span class="p">};</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">closeAfterDispatch</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">closeAfterDispatch</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">closeAfterDispatch</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">closeAfterDispatch</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">closeAfterDispatch</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>If numberOfGames is received as input parameter,
the total number of players to dispatch might be too large.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">nPlayersToDispatch</span> <span class="o">=</span> <span class="nx">groupSize</span> <span class="o">*</span> <span class="nx">numberOfGames</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">nPlayers</span> <span class="o">&lt;</span> <span class="nx">nPlayersToDispatch</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;cannot dispatch &#39;</span> <span class="o">+</span> <span class="nx">numberOfGames</span> <span class="o">+</span>
                          <span class="s1">&#39; game/s now, too few players are connected: &#39;</span> <span class="o">+</span>
                          <span class="nx">nPlayers</span> <span class="o">+</span> <span class="s1">&#39;. Aborting dispatch.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Shuffle and sort players, if necessary.
This means that at least two groups will be created.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nPlayersToDispatch</span> <span class="o">&gt;</span> <span class="nx">groupSize</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">groups</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">PLAYER_GROUPING</span><span class="p">(</span><span class="nx">pList</span><span class="p">,</span> <span class="nx">numberOfGames</span><span class="p">);</span>
                <span class="nx">nGroupsCreated</span> <span class="o">=</span> <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">nGroupsCreated</span> <span class="o">!==</span> <span class="nx">numberOfGames</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39; PLAYER_GROUPING did not &#39;</span> <span class="o">+</span>
                                  <span class="s1">&#39;return the expected number of groups: &#39;</span> <span class="o">+</span>
                                  <span class="nx">groups</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; (found) vs &#39;</span> <span class="o">+</span>
                                  <span class="nx">numberOfGames</span> <span class="o">+</span> <span class="s1">&#39; (expected)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;error&#39;</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>TODO: check if each subgroup has the right size.
TODO: shall we allowed groups of different sizes?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">dispatchList</span> <span class="o">=</span> <span class="p">[].</span><span class="nx">concat</span><span class="p">.</span><span class="nx">apply</span><span class="p">([],</span> <span class="nx">groups</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">dispatchList</span><span class="p">.</span><span class="nx">length</span> <span class="o">!==</span> <span class="nx">nPlayersToDispatch</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39; PLAYER_GROUPING did not &#39;</span> <span class="o">+</span>
                                  <span class="s1">&#39;return the expected number of players: &#39;</span> <span class="o">+</span>
                                  <span class="nx">dispatchList</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; (found) vs &#39;</span> <span class="o">+</span>
                                  <span class="nx">nPlayersToDispatch</span> <span class="o">+</span> <span class="s1">&#39; (expected)&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;error&#39;</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>


            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>Shuffle player list anyway.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">dispatchList</span> <span class="o">=</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">shuffle</span><span class="p">().</span><span class="nx">db</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>Sort according to priority.
TODO: We could optimize it, if we knew in advance the
sorting criteria, i.e. there might be no need to sort here.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">!==</span> <span class="k">this</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">dispatchList</span> <span class="o">=</span> <span class="nx">dispatchList</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">PLAYER_SORTING</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">dispatchList</span> <span class="o">=</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">breed</span><span class="p">().</span><span class="nx">db</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">setDispatchState</span><span class="p">(</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">dispatchStates</span><span class="p">.</span><span class="nx">DISPATCHING</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;DISPATCH: &#39;</span><span class="p">,</span> <span class="nx">nPlayersToDispatch</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">nPlayers</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>If we have too many players log a warning.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nPlayers</span> <span class="o">&gt;</span> <span class="nx">nPlayersToDispatch</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>Warn if more participants than spots available.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;There are more players than available &#39;</span> <span class="o">+</span>
                          <span class="s1">&#39;spots in the game.&#39;</span> <span class="o">+</span>
                          <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">DISCONNECT_IF_NOT_SELECTED</span> <span class="o">?</span>
                           <span class="s1">&#39; Some players will be disconnected.&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span> <span class="p">),</span>
                          <span class="s1">&#39;warning&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">gameNumber</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="nx">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">groupSize</span><span class="p">),</span> <span class="nx">groupLimit</span> <span class="o">=</span> <span class="nx">groupSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nPlayersToDispatch</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>Player id.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">pId</span> <span class="o">=</span> <span class="nx">dispatchList</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>Inform players.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;DISPATCH&#39;</span><span class="p">,</span> <span class="nx">pId</span><span class="p">,</span> <span class="nx">msg</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">remoteSetup</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="nx">pId</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">clearBody</span><span class="o">:</span> <span class="kc">true</span>
            <span class="p">});</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p>Clear timeout for players.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">clearTimeOut</span><span class="p">(</span><span class="nx">pId</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>Add it to the group.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">groupIdx</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">%</span> <span class="nx">groupSize</span><span class="p">;</span>
            <span class="nx">group</span><span class="p">[</span><span class="nx">groupIdx</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pId</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">groupIdx</span> <span class="o">===</span> <span class="nx">groupLimit</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">gameNumber</span><span class="o">++</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>If this is the first dispatch or we need to create a new room
anyway, assign a treatment and then setup the game.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">lastGameRoom</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">DISPATCH_TO_SAME_ROOM</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89">&#182;</a>
</div>
<p>Decide treatment.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">treatmentName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">decideTreatment</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">CHOSEN_TREATMENT</span><span class="p">,</span>
                                                        <span class="nx">gameNumber</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>Starts a game level or the main game.
TODO: should the main game have a ghost level?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameLevel</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">gameRoom</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameLevels</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">gameLevel</span><span class="p">]</span>
                            <span class="p">.</span><span class="nx">createGameRoom</span><span class="p">({</span>
                                <span class="nx">clients</span><span class="o">:</span> <span class="nx">group</span><span class="p">,</span>
                                <span class="nx">treatmentName</span><span class="o">:</span> <span class="nx">treatmentName</span>
                            <span class="p">});</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>Create new game room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                        <span class="nx">gameRoom</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">createGameRoom</span><span class="p">({</span>
                            <span class="nx">clients</span><span class="o">:</span> <span class="nx">group</span><span class="p">,</span>
                            <span class="nx">treatmentName</span><span class="o">:</span> <span class="nx">treatmentName</span>
                        <span class="p">});</span>
                    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>Setup and start game.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">gameRoom</span><span class="p">.</span><span class="nx">setupGame</span><span class="p">();</span>
                    <span class="nx">gameRoom</span><span class="p">.</span><span class="nx">startGame</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">[]);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<p>Store reference.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">this</span><span class="p">.</span><span class="nx">lastGameRoom</span> <span class="o">=</span> <span class="nx">gameRoom</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>Move clients into existing room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">j</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">groupSize</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
                        <span class="nx">channel</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">group</span><span class="p">[</span><span class="nx">j</span><span class="p">],</span>
                                           <span class="k">this</span><span class="p">.</span><span class="nx">lastGameRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                                           <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
                    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>Setup new group of players in the old room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">this</span><span class="p">.</span><span class="nx">lastGameRoom</span><span class="p">.</span><span class="nx">setupGame</span><span class="p">(</span><span class="kc">undefined</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">group</span><span class="p">);</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">lastGameRoom</span><span class="p">.</span><span class="nx">startGame</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>One more dispatch done!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="o">++</span><span class="k">this</span><span class="p">.</span><span class="nx">numberOfDispatches</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>Close waitingRoom if next game would not be dispatchable.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">shouldDispatchMoreGames</span><span class="p">())</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">closeRoom</span><span class="p">();</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98">&#182;</a>
</div>
<p>Force to exit loop.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>Clear group.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">group</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">groupSize</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100">&#182;</a>
</div>
<p>All dispatch attempts have been completed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101">&#182;</a>
</div>
<p>Close room, if requested.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">closeAfterDispatch</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">setDispatchState</span><span class="p">(</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">dispatchStates</span><span class="p">.</span><span class="nx">NONE</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">closeRoom</span><span class="p">();</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">closeAfterDispatch</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setDispatchState</span><span class="p">(</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">dispatchStates</span><span class="p">.</span><span class="nx">NOTIFYING</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>Tell players still waiting, that they have not been selected.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">pList</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">;</span>
        <span class="nx">nPlayers</span> <span class="o">=</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">nPlayers</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">pId</span> <span class="o">=</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">db</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>Increment timesNotSelected for player.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">pList</span><span class="p">.</span><span class="nx">db</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">timesNotSelected</span><span class="p">)</span> <span class="o">++</span><span class="nx">pList</span><span class="p">.</span><span class="nx">db</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">timesNotSelected</span><span class="p">;</span>
            <span class="k">else</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">db</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">timesNotSelected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">START_DATE</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">clearTimeOut</span><span class="p">(</span><span class="nx">pId</span><span class="p">);</span>

            <span class="nx">code</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClient</span><span class="p">(</span><span class="nx">pId</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;DISPATCH&#39;</span><span class="p">,</span> <span class="nx">pId</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;NotSelected&#39;</span><span class="p">,</span>
                <span class="nx">exit</span><span class="o">:</span> <span class="nx">code</span><span class="p">.</span><span class="nx">ExitCode</span><span class="p">,</span>
                <span class="nx">shouldDispatchMoreGames</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">shouldDispatchMoreGames</span><span class="p">()</span>
            <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104">&#182;</a>
</div>
<p>Ste was: (but it does not make any sense).
Exit loop.
if (!this.shouldDispatchMoreGames()) break</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setDispatchState</span><span class="p">(</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">dispatchStates</span><span class="p">.</span><span class="nx">NONE</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ON_DISPATCHED</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">ON_DISPATCHED</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">opts</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;opts must be object &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;or undefined. Found: &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">msg</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="s1">&#39;opts.msg must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;object or undefined. Found: &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>Have we dispatched 'em all?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">checkShouldDispatch</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>Fix group size and number of groups.
In case of kickUnresponsivePlayers, these can change in between.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">opts</span> <span class="o">=</span> <span class="nx">parseGroupSizeOptions</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<p>If we have pool of 1 and mode == WAIT_FOR_N_PLAYERS just go ahead!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">PING_BEFORE_DISPATCH</span> <span class="o">||</span>
            <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">EXECUTION_MODE</span> <span class="o">===</span> <span class="s1">&#39;WAIT_FOR_N_PLAYERS&#39;</span> <span class="o">&amp;&amp;</span>
             <span class="k">this</span><span class="p">.</span><span class="nx">POOL_SIZE</span> <span class="o">===</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

            <span class="nx">doDispatch</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">opts</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-108" id="section-108">&#182;</a>
</div>
<p>Blocks until all players have returned the ping or are kicked.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">kickUnresponsivePlayers</span><span class="p">(</span><span class="nx">doDispatch</span><span class="p">,</span> <span class="p">{</span> <span class="nx">callbackArgs</span><span class="o">:</span> <span class="nx">opts</span> <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">})();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.notifyplayerupdate">
  <h3>
    <a href="#waitingroom.notifyplayerupdate" name="waitingroom.notifyplayerupdate" class="pilcrow">&#182;</a>
    WaitingRoom.notifyPlayerUpdate
  </h3>
</div>

  </div>
  <div class="body"><p>Notifies players a change in the number of players</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">np</span>
      <span class="dox_type">number</span>
      <span>Optional. Number of players. If not specified
  the number of players will be fetched at the moment of sending the
  message. If specified, the message is sent immediately.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">notifyPlayerUpdate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">np</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">np</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;PLAYERSCONNECTED&#39;</span><span class="p">,</span> <span class="s1">&#39;ROOM&#39;</span><span class="p">,</span> <span class="nx">np</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">notifyTimeout</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">notifyTimeout</span><span class="p">);</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">notifyTimeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">notifyTimeout</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-110" id="section-110">&#182;</a>
</div>
<p>Group together a few connect-notifications before sending them.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">notifyTimeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-111" id="section-111">&#182;</a>
</div>
<p>Delete timeout.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">that</span><span class="p">.</span><span class="nx">notifyTimeout</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-112" id="section-112">&#182;</a>
</div>
<p>Notify all players of new connection/s.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">that</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;PLAYERSCONNECTED&#39;</span><span class="p">,</span> <span class="s1">&#39;ROOM&#39;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">pl</span><span class="p">.</span><span class="nx">size</span><span class="p">());</span>
        <span class="p">},</span> <span class="k">this</span><span class="p">.</span><span class="nx">NOTIFY_INTERVAL</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.maketimeout">
  <h2>
    <a href="#waitingroom.maketimeout" name="waitingroom.maketimeout" class="pilcrow">&#182;</a>
    WaitingRoom.makeTimeOut
  </h2>
</div>

  </div>
  <div class="body"><p>Register a timeout for a player</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">playerID</span>
      <span class="dox_type">number</span>
      <span>ID of player for which to register timeout.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">waitTime</span>
      <span class="dox_type">number</span>
      <span>Nnumber of milliseconds to wait before execution
  of callback. If null then no timeout is made.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">function</span>
      <span>(Optional) callback to register. If undefined a
  predefine callback is used.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.clearTimeOut
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">makeTimeOut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">playerID</span><span class="p">,</span> <span class="nx">waitTime</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">channel</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nx">waitTime</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>

    <span class="nx">cb</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">pList</span><span class="p">,</span> <span class="nx">nPlayers</span><span class="p">,</span> <span class="nx">res</span><span class="p">;</span>
        <span class="nx">channel</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Waitroom timed out for: &#39;</span> <span class="o">+</span> <span class="nx">playerID</span><span class="p">);</span>
        <span class="nx">pList</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">;</span>
        <span class="nx">nPlayers</span> <span class="o">=</span> <span class="nx">pList</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;TIME&#39;</span><span class="p">,</span> <span class="nx">playerID</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-114" id="section-114">&#182;</a>
</div>
<p>TODO: do we need to check if we have enough players?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nPlayers</span> <span class="o">&gt;=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">POOL_SIZE</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
                <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;AllPlayersConnected&#39;</span><span class="p">,</span>
                <span class="nx">nPlayers</span><span class="o">:</span> <span class="nx">nPlayers</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">code</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClient</span><span class="p">(</span><span class="nx">playerID</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-115" id="section-115">&#182;</a>
</div>
<p>If a timeout function for the server was specified,
executes. If the return value is FALSE, do not continue
with checkout and informing the player about NotEnoughPlayers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">ON_TIMEOUT_SERVER</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-116" id="section-116">&#182;</a>
</div>
<p>TODO: pass that as parameter.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">res</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">ON_TIMEOUT_SERVER</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">code</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">res</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-117" id="section-117">&#182;</a>
</div>
<p>If an access code is defined, checkout remotely.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">checkOut</span><span class="p">(</span><span class="nx">playerID</span><span class="p">);</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">say</span><span class="p">(</span><span class="s1">&#39;DISPATCH&#39;</span><span class="p">,</span> <span class="nx">playerID</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;NotEnoughPlayers&#39;</span><span class="p">,</span>
                <span class="nx">exit</span><span class="o">:</span> <span class="nx">code</span><span class="p">.</span><span class="nx">ExitCode</span>
            <span class="p">});</span>
        <span class="p">}</span>

    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timeOuts</span><span class="p">[</span><span class="nx">playerID</span><span class="p">]</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">waitTime</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.cleartimeout">
  <h2>
    <a href="#waitingroom.cleartimeout" name="waitingroom.cleartimeout" class="pilcrow">&#182;</a>
    WaitingRoom.clearTimeOut
  </h2>
</div>

  </div>
  <div class="body"><p>Clear a timeout for a player</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">playerID</span>
      <span class="dox_type">number</span>
      <span>ID of player for which to clear the timeout.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.makeTimeOut
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">clearTimeOut</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">playerID</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeOuts</span><span class="p">[</span><span class="nx">playerID</span><span class="p">]);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timeOuts</span><span class="p">[</span><span class="nx">playerID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.decidetreatment">
  <h2>
    <a href="#waitingroom.decidetreatment" name="waitingroom.decidetreatment" class="pilcrow">&#182;</a>
    WaitingRoom.decideTreatment
  </h2>
</div>

  </div>
  <div class="body"><p>Check if string, or use it.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">t</span>
      <span class="dox_type">mixed</span>
      <span>String, object, function or undefined
  used to decide a treatment</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>Chosen treatment</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">decideTreatment</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">idxInBatch</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">treatments</span><span class="p">,</span> <span class="nx">tLen</span><span class="p">,</span> <span class="nx">chosenT</span><span class="p">;</span>
    <span class="nx">treatments</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">treatmentNames</span><span class="p">;</span>
    <span class="nx">tLen</span> <span class="o">=</span> <span class="nx">treatments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">t</span> <span class="o">===</span> <span class="s1">&#39;treatment_rotate&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">treatments</span><span class="p">[(</span><span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">autoRoomNo</span><span class="p">)</span> <span class="o">%</span> <span class="nx">tLen</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;random&#39;</span> <span class="o">===</span> <span class="nx">t</span> <span class="o">||</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">treatments</span><span class="p">[</span><span class="nx">J</span><span class="p">.</span><span class="nx">randomInt</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">tLen</span><span class="o">-</span><span class="mi">1</span><span class="p">)];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">chosenT</span> <span class="o">=</span> <span class="nx">t</span><span class="p">(</span><span class="nx">treatments</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">autoRoomNo</span><span class="p">,</span> <span class="nx">idxInBatch</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">chosenT</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;WaitingRoom.decideTreatment: callback must &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;return string. Found: &#39;</span> <span class="o">+</span> <span class="nx">chosenT</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">hasGameTreatment</span><span class="p">(</span><span class="nx">chosenT</span><span class="p">))</span>  <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;WaitingRoom.decideTreatment: callback &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;returned unknown treatment: &#39;</span> <span class="o">+</span> <span class="nx">chosenT</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">chosenT</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-120" id="section-120">&#182;</a>
</div>
<p>Return treatment (was a string already).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">t</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.setdispatchstate">
  <h3>
    <a href="#waitingroom.setdispatchstate" name="waitingroom.setdispatchstate" class="pilcrow">&#182;</a>
    WaitingRoom.setDispatchState
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the dispatching state</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.getdispatchState</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.dispatchState</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.dispatchStates
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDispatchState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">dispatchStates</span><span class="p">[</span><span class="nx">state</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;WaitingRoom.setdispatchState: unknown state. &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Found: &#39;</span> <span class="o">+</span> <span class="nx">state</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dispatchState</span> <span class="o">=</span> <span class="nx">state</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="waitingroom.getdispatchstate">
  <h3>
    <a href="#waitingroom.getdispatchstate" name="waitingroom.getdispatchstate" class="pilcrow">&#182;</a>
    WaitingRoom.getDispatchState
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the dispatching state</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.setdispatchState</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.dispatchState</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.dispatchStates
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">WaitingRoom</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getDispatchState</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">dispatchState</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods">
  <h2>
    <a href="#helper%20methods" name="helper%20methods" class="pilcrow">&#182;</a>
    Helper methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="checkpositiveinteger">
  <h2>
    <a href="#checkpositiveinteger" name="checkpositiveinteger" class="pilcrow">&#182;</a>
    checkPositiveInteger
  </h2>
</div>

  </div>
  <div class="body"><p>Checks whether a property is a positive integer throwing an error if not</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>The object for which to check a property.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">name</span>
      <span class="dox_type">string</span>
      <span>The name of the property to check.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">where</span>
      <span class="dox_type">string</span>
      <span>String to prepend to the error message.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom.parseSettings
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">checkPositiveInteger</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">where</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">N</span><span class="p">;</span>
    <span class="nx">N</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">isInt</span><span class="p">(</span><span class="nx">N</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="p">(</span><span class="nx">where</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; must be an&#39;</span> <span class="o">+</span>
        <span class="s1">&#39; integer and larger than 0. Found: &#39;</span> <span class="o">+</span> <span class="nx">N</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="assigniffunction">
  <h2>
    <a href="#assigniffunction" name="assigniffunction" class="pilcrow">&#182;</a>
    assignIfFunction
  </h2>
</div>

  </div>
  <div class="body"><p>Assigns a property to an object from another one if it is a function</p>

<p>The property in the object must be undefined or function, otherwise
an error will be raised.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">name</span>
      <span class="dox_type">string</span>
      <span>The name of the property to verify and assign</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">toObj</span>
      <span class="dox_type">object</span>
      <span>The object to which the property will be assigned</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fromObj</span>
      <span class="dox_type">object</span>
      <span>The object from which the property will be copied</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">where</span>
      <span class="dox_type">string</span>
      <span>A prefix for the error message. Default:
  'WaitingRoom.parseSettings: '.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">assignIfFunction</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">toObj</span><span class="p">,</span> <span class="nx">fromObj</span><span class="p">,</span> <span class="nx">where</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">fromObj</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">fromObj</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">new</span> <span class="nx">TypeError</span><span class="p">((</span><span class="nx">where</span> <span class="o">||</span> <span class="s1">&#39;WaitingRoom.parseSettings: &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span>
                          <span class="s1">&#39;must be function or undefined. Found: &#39;</span> <span class="o">+</span>
                          <span class="nx">fromObj</span><span class="p">[</span><span class="nx">name</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">toObj</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">fromObj</span><span class="p">[</span><span class="nx">name</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
