<!DOCTYPE html>
<html>
<head>
  <title>ServerChannel.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "lib/ServerChannel.js", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#serverchannel">ServerChannel</a>
      </div>
      <div class="heading h2">
        <a href="#global">Global</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.parseoptions">ServerChannel.parseOptions</a>
      </div>
      <div class="heading h2">
        <a href="#serverchannel%20constructor">ServerChannel constructor</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.servernode">ServerChannel.servernode</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.sio">ServerChannel.sio</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.options">ServerChannel.options</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.name">ServerChannel.name</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.gamename">ServerChannel.gameName</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.defaultchannel">ServerChannel.defaultChannel</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.gameinfo">ServerChannel.gameInfo</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.syslogger">ServerChannel.sysLogger</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.session">ServerChannel.session</a>
      </div>
      <div class="heading h2">
        <a href="#serverchannel.credentials">ServerChannel.credentials</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.session">ServerChannel.session</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.registry">ServerChannel.registry</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.admin">ServerChannel.admin</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.player">ServerChannel.player</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.waitingroom">ServerChannel.waitingRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.requirementsroom">ServerChannel.requirementsRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.gamerooms">ServerChannel.gameRooms</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.maxrooms">ServerChannel.maxRooms</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.autoroomno">ServerChannel.autoRoomNo</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.gamelevels">ServerChannel.gameLevels</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.bots">ServerChannel.bots</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.phantoms">ServerChannel.phantoms</a>
      </div>
      <div class="heading h2">
        <a href="#serverchannel%20methods">ServerChannel methods</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.createservers">ServerChannel.createServers</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.listen">ServerChannel.listen</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.creategameroom">ServerChannel.createGameRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.createwaitingroom">ServerChannel.createWaitingRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.setdefaultwaitingroom">ServerChannel.setDefaultWaitingRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.createrequirementsroom">ServerChannel.createRequirementsRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.setdefaultrequirementroom">ServerChannel.setDefaultRequirementRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.createroom">ServerChannel.createRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.destroyroom">ServerChannel.destroyRoom</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.creategamelevel">ServerChannel.createGameLevel</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.moveclient">ServerChannel.moveClient</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.getgamelevel">ServerChannel.getGameLevel</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.moveclienttogamelevel">ServerChannel.moveClientToGameLevel</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.placeclient">ServerChannel.placeClient</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.require">ServerChannel.require</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.getgamedir">ServerChannel.getGameDir</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.hasgametreatment">ServerChannel.hasGameTreatment</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.authorizesuperuser">ServerChannel.authorizeSuperUser</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.connectbot">ServerChannel.connectBot</a>
      </div>
      <div class="heading h3">
        <a href="#serverchannel.connectphantom">ServerChannel.connectPhantom</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel">
  <h1>
    <a href="#serverchannel" name="serverchannel" class="pilcrow">&#182;</a>
    ServerChannel
  </h1>
</div>


<p>Copyright(c) 2016 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p>Creates the Player, and Admin Server</p>

<p>Keeps a register of connected players.</p>

<p>Uses the Socket.IO app created in ServerNode.</p>

<p>Gives methods to create and destroy game rooms,
and to move players around them.</p>

<p><a href='http://www.nodegame.org'>http://www.nodegame.org</a></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global">
  <h2>
    <a href="#global" name="global" class="pilcrow">&#182;</a>
    Global
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">ServerChannel</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">AdminServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./servers/AdminServer&#39;</span><span class="p">),</span>
    <span class="nx">PlayerServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./servers/PlayerServer&#39;</span><span class="p">),</span>
    <span class="nx">GameServer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./GameServer&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">ChannelRegistry</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./ChannelRegistry&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">GameLevel</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./GameLevel&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">Logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./Logger&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;JSUS&#39;</span><span class="p">).</span><span class="nx">JSUS</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">spawn</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;child_process&#39;</span><span class="p">).</span><span class="nx">spawn</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">ngc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-client&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">PlayerList</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">PlayerList</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">GameRoom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./rooms/GameRoom&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">WaitingRoom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./rooms/WaitingRoom&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">RequirementsRoom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./rooms/RequirementsRoom&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.parseoptions">
  <h3>
    <a href="#serverchannel.parseoptions" name="serverchannel.parseoptions" class="pilcrow">&#182;</a>
    ServerChannel.parseOptions
  </h3>
</div>

  </div>
  <div class="body"><p>Parses configuration options for player and admin server</p>

<p>Each server (player and admin) needs a separate configuration object.
However servernode <em>addChannel</em> method receive a single object.</p>

<p>The object must have the <em>adminServer</em> and <em>playerServer</em> properties,
as two objects. All the other properties in the main configuration object,
and that are not found in <em>admin</em> or <em>player</em> will be added to them.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Configuration options</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>out Parsed configuration object</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">parseOptions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">adminOptions</span><span class="p">,</span> <span class="nx">playerOptions</span><span class="p">,</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Options are mixed in.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">adminOptions</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">;</span>
    <span class="nx">playerOptions</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">options</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">;</span>

    <span class="nx">out</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">adminOptions</span><span class="p">,</span> <span class="nx">out</span><span class="p">);</span>
    <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
    <span class="nx">J</span><span class="p">.</span><span class="nx">mixout</span><span class="p">(</span><span class="nx">playerOptions</span><span class="p">,</span> <span class="nx">out</span><span class="p">);</span>

    <span class="nx">out</span><span class="p">.</span><span class="nx">adminServer</span> <span class="o">=</span> <span class="nx">adminOptions</span><span class="p">;</span>
    <span class="nx">out</span><span class="p">.</span><span class="nx">playerServer</span> <span class="o">=</span> <span class="nx">playerOptions</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel%20constructor">
  <h2>
    <a href="#serverchannel%20constructor" name="serverchannel%20constructor" class="pilcrow">&#182;</a>
    ServerChannel constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Creates an instance of ServerChannel</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Configuration object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">servernode</span>
      <span class="dox_type">ServerNode</span>
      <span>The ServerNode instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">sio</span>
      <span class="dox_type">object</span>
      <span>The socket.io server</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">ServerChannel</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">servernode</span><span class="p">,</span> <span class="nx">sio</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.servernode">
  <h3>
    <a href="#serverchannel.servernode" name="serverchannel.servernode" class="pilcrow">&#182;</a>
    ServerChannel.servernode
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the ServerNode</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span> <span class="o">=</span> <span class="nx">servernode</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.sio">
  <h3>
    <a href="#serverchannel.sio" name="serverchannel.sio" class="pilcrow">&#182;</a>
    ServerChannel.sio
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the Socket.IO app of ServerNode</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">sio</span> <span class="o">=</span> <span class="nx">sio</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.options">
  <h3>
    <a href="#serverchannel.options" name="serverchannel.options" class="pilcrow">&#182;</a>
    ServerChannel.options
  </h3>
</div>

  </div>
  <div class="body"><p>Configuration options</p>

<p>// TODO: do not parse options
// (they are already parsed by ServerNode).</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">options</span> <span class="o">=</span> <span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">parseOptions</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.name">
  <h3>
    <a href="#serverchannel.name" name="serverchannel.name" class="pilcrow">&#182;</a>
    ServerChannel.name
  </h3>
</div>

  </div>
  <div class="body"><p>The name of the channel (under normal condition equal to gameName)</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.gamename">
  <h3>
    <a href="#serverchannel.gamename" name="serverchannel.gamename" class="pilcrow">&#182;</a>
    ServerChannel.gameName
  </h3>
</div>

  </div>
  <div class="body"><p>The name of the game associated with the channel</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.defaultchannel">
  <h3>
    <a href="#serverchannel.defaultchannel" name="serverchannel.defaultchannel" class="pilcrow">&#182;</a>
    ServerChannel.defaultChannel
  </h3>
</div>

  </div>
  <div class="body"><p>TRUE, if this is the ServerNode's default Channel.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">defaultChannel</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.gameinfo">
  <h3>
    <a href="#serverchannel.gameinfo" name="serverchannel.gameinfo" class="pilcrow">&#182;</a>
    ServerChannel.gameInfo
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the game information, including treatments and client types</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">gameName</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.syslogger">
  <h3>
    <a href="#serverchannel.syslogger" name="serverchannel.syslogger" class="pilcrow">&#182;</a>
    ServerChannel.sysLogger
  </h3>
</div>

  </div>
  <div class="body"><p>The logger for the channel</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;channel&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.session">
  <h3>
    <a href="#serverchannel.session" name="serverchannel.session" class="pilcrow">&#182;</a>
    ServerChannel.session
  </h3>
</div>

  </div>
  <div class="body"><p>Unique session id, shared by both Player and Admin Server</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10000000000000000</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.credentials">
  <h2>
    <a href="#serverchannel.credentials" name="serverchannel.credentials" class="pilcrow">&#182;</a>
    ServerChannel.credentials
  </h2>
</div>

  </div>
  <div class="body"><p>Administrator account to manage the channel</p>

<p>The <code>GameLoader</code> will populate the object with the data read from
file system. The final object is of the type:</p>

<ul>
<li>{user: 'admin', pwd: 'pwd' }</li>
</ul>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.loadServerDir
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.session">
  <h3>
    <a href="#serverchannel.session" name="serverchannel.session" class="pilcrow">&#182;</a>
    ServerChannel.session
  </h3>
</div>

  </div>
  <div class="body"><p>Secret string used to sign channels' json tokens</p>

<p>The <code>GameLoader</code> will read the secret from file system.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.loadServerDir
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">secret</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.registry">
  <h3>
    <a href="#serverchannel.registry" name="serverchannel.registry" class="pilcrow">&#182;</a>
    ServerChannel.registry
  </h3>
</div>

  </div>
  <div class="body"><p>The registry of all connected clients</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ChannelRegistry
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ChannelRegistry</span><span class="p">({</span>
        <span class="nx">channelName</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.admin">
  <h3>
    <a href="#serverchannel.admin" name="serverchannel.admin" class="pilcrow">&#182;</a>
    ServerChannel.admin
  </h3>
</div>

  </div>
  <div class="body"><p>The admin server</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">AdminServer
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">adminServer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.player">
  <h3>
    <a href="#serverchannel.player" name="serverchannel.player" class="pilcrow">&#182;</a>
    ServerChannel.player
  </h3>
</div>

  </div>
  <div class="body"><p>The player server</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">PlayerServer
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.waitingroom">
  <h3>
    <a href="#serverchannel.waitingroom" name="serverchannel.waitingroom" class="pilcrow">&#182;</a>
    ServerChannel.waitingRoom
  </h3>
</div>

  </div>
  <div class="body"><p>The waiting room for the channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createWaitingRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.requirementsroom">
  <h3>
    <a href="#serverchannel.requirementsroom" name="serverchannel.requirementsroom" class="pilcrow">&#182;</a>
    ServerChannel.requirementsRoom
  </h3>
</div>

  </div>
  <div class="body"><p>The requirements room for the channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createRequirementsRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">requirementsRoom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.gamerooms">
  <h3>
    <a href="#serverchannel.gamerooms" name="serverchannel.gamerooms" class="pilcrow">&#182;</a>
    ServerChannel.gameRooms
  </h3>
</div>

  </div>
  <div class="body"><p>Associative container for all the game rooms in the channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createGameRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.maxrooms">
  <h3>
    <a href="#serverchannel.maxrooms" name="serverchannel.maxrooms" class="pilcrow">&#182;</a>
    ServerChannel.maxRooms
  </h3>
</div>

  </div>
  <div class="body"><p>The maximum number of game rooms allowed in this channel.
The value -1 means unlimited.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxRooms</span> <span class="o">?</span>
        <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">maxRooms</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.autoroomno">
  <h3>
    <a href="#serverchannel.autoroomno" name="serverchannel.autoroomno" class="pilcrow">&#182;</a>
    ServerChannel.autoRoomNo
  </h3>
</div>

  </div>
  <div class="body"><p>Incremental index used when creating
game rooms with a default name.</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">autoRoomNo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.gamelevels">
  <h3>
    <a href="#serverchannel.gamelevels" name="serverchannel.gamelevels" class="pilcrow">&#182;</a>
    ServerChannel.gameLevels
  </h3>
</div>

  </div>
  <div class="body"><p>Active game levels of the game</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameLevels</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.bots">
  <h3>
    <a href="#serverchannel.bots" name="serverchannel.bots" class="pilcrow">&#182;</a>
    ServerChannel.bots
  </h3>
</div>

  </div>
  <div class="body"><p>node instances of bots inside the channel, indexed by Client ID</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">bots</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.phantoms">
  <h3>
    <a href="#serverchannel.phantoms" name="serverchannel.phantoms" class="pilcrow">&#182;</a>
    ServerChannel.phantoms
  </h3>
</div>

  </div>
  <div class="body"><p>Spawn phantomjs processes, indexed by PID</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">phantoms</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>Creating the AdminServer and PlayerServer.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">createServers</span><span class="p">();</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="serverchannel%20methods">
  <h2>
    <a href="#serverchannel%20methods" name="serverchannel%20methods" class="pilcrow">&#182;</a>
    ServerChannel methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.createservers">
  <h3>
    <a href="#serverchannel.createservers" name="serverchannel.createservers" class="pilcrow">&#182;</a>
    ServerChannel.createServers
  </h3>
</div>

  </div>
  <div class="body"><p>Creates the AdminServer and the PlayerServer</p>

<p>Creates the configuration objects to pass to the constructor of each server.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">PlayerServer</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">AdminServer
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createServers</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Enforce a name.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">options</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;[ADMIN_SERVER]&#39;</span><span class="p">;</span>
    <span class="nx">options</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s1">&#39;[PLAYER_SERVER]&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Actually creates the servers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">adminServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AdminServer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PlayerServer</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>The two servers are aware of each other.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">.</span><span class="nx">setPartner</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">.</span><span class="nx">setPartner</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.listen">
  <h3>
    <a href="#serverchannel.listen" name="serverchannel.listen" class="pilcrow">&#182;</a>
    ServerChannel.listen
  </h3>
</div>

  </div>
  <div class="body"><p>Puts the AdminServer and PlayerServer on listen mode</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE, if both servers are turned on successfully</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listen</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">.</span><span class="nx">listen</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">.</span><span class="nx">listen</span><span class="p">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.creategameroom">
  <h3>
    <a href="#serverchannel.creategameroom" name="serverchannel.creategameroom" class="pilcrow">&#182;</a>
    ServerChannel.createGameRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Creates and returns a new GameRoom object</p>

<p>If conf.name is not given, the next free name in the sequence
'room1', 'room2', ..., 'room999' is automatically chosen and set in
the conf parameter.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">conf</span>
      <span class="dox_type">object</span>
      <span>Config object, acceptable by GameRoom constructor</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">GameRoom</span>
      <span>The new GameRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createGameRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">maxRoomsErr</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">autoRoomNo</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clients</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">playerIds</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">newRoom</span><span class="p">,</span> <span class="nx">roomGroup</span><span class="p">;</span>
    <span class="nx">conf</span> <span class="o">=</span> <span class="nx">conf</span> <span class="o">||</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Checking if the limit in the number of game rooms has been hit.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">J</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">maxRoomsErr</span> <span class="o">=</span> <span class="s1">&#39;Max number of game rooms for &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span>
            <span class="s1">&#39; reached: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxRooms</span><span class="p">;</span>
        <span class="nx">maxRoomsErr</span> <span class="o">+=</span> <span class="s1">&#39; . Cannot create another game room.&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">maxRoomsErr</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">clients</span> <span class="o">=</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">clients</span><span class="p">;</span>

    <span class="nx">roomGroup</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">?</span> <span class="s1">&#39;room&#39;</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Generate default name if none given:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Try 'room1', 'room2', ..., 'room999':</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">do</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">autoRoomNo</span><span class="o">++</span><span class="p">;</span>
            <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">roomGroup</span> <span class="o">+</span> <span class="s1">&#39;&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoRoomNo</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">);</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Check for name availibility:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createGameRoom: Requested room name &#39;&quot;</span> <span class="o">+</span>
                    <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; already taken.&quot;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Check for parent existence:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createGameRoom: Nonexistent room &#39;&quot;</span> <span class="o">+</span>
                    <span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span> <span class="o">+</span> <span class="s2">&quot;&#39; requested as parent.&quot;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;ServerChannel.createGameRoom: channel parameter &quot;</span> <span class="o">+</span>
                           <span class="s2">&quot;ignored.&quot;</span><span class="p">,</span> <span class="s1">&#39;warn&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Adding a reference to this channel.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>Construct room (the players will be moved into it explicitly):</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">delete</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">clients</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Setting group = name if none is defined.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">?</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span><span class="p">;</span>

    <span class="nx">newRoom</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GameRoom</span><span class="p">(</span><span class="nx">conf</span><span class="p">);</span>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">clients</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Add to parent:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">parentRoom</span><span class="p">].</span><span class="nx">children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Register room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">newRoom</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>Move players into the room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">clients</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">playerIds</span> <span class="o">=</span> <span class="nx">clients</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">getAllKeys</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">playerIds</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">playerIds</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">playerIds</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">newRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;channel &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;: room &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoRoomNo</span> <span class="o">+</span>
                       <span class="s1">&#39; created. Chosen treatment: &#39;</span> <span class="o">+</span>
                       <span class="nx">conf</span><span class="p">.</span><span class="nx">treatmentName</span> <span class="o">||</span> <span class="s1">&#39;(undefined).&#39;</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">newRoom</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.createwaitingroom">
  <h3>
    <a href="#serverchannel.createwaitingroom" name="serverchannel.createwaitingroom" class="pilcrow">&#182;</a>
    ServerChannel.createWaitingRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Creates the waiting room and stores a reference in channel</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>Config object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">primary</span>
      <span class="dox_type">boolean</span>
      <span>Optional. Marks the newly created waiting room
   as default, and stores a reference under ServerChannel.waitingRoom.
   If TRUE and a default waiting room is existing an error will be thrown.
   Default: FALSE.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">WaitingRoom</span>
      <span>The waiting room</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.setDefaultWaitingRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createWaitingRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="nx">makeDefault</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">room</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">makeDefault</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Default waiting room for channel &#39;&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span>
                           <span class="s2">&quot;&#39; already existing.&quot;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">room</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createRoom</span><span class="p">(</span><span class="s1">&#39;Waiting&#39;</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Sets it as the default waiting room for the channel, if requested so.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">makeDefault</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultWaitingRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">room</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.setdefaultwaitingroom">
  <h3>
    <a href="#serverchannel.setdefaultwaitingroom" name="serverchannel.setdefaultwaitingroom" class="pilcrow">&#182;</a>
    ServerChannel.setDefaultWaitingRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the default waiting room for the channel</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">The</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>name of the requirements room or the room itself</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">WaitingRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDefaultWaitingRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">roomObj</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">roomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">room</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">roomObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.setDefaultWaitingRoom: &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;could find room: &#39;</span> <span class="o">+</span> <span class="nx">room</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">roomObj</span> <span class="o">=</span> <span class="nx">room</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.setDefaultWaitingRoom: &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;room must be object or string. Found: &#39;</span> <span class="o">+</span> <span class="nx">room</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">roomType</span> <span class="o">!==</span> <span class="s1">&#39;Waiting&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.setDefaultWaitingRoom: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;room is not a waiting room: &#39;</span> <span class="o">+</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.createrequirementsroom">
  <h3>
    <a href="#serverchannel.createrequirementsroom" name="serverchannel.createrequirementsroom" class="pilcrow">&#182;</a>
    ServerChannel.createRequirementsRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Creates the requirements room and stores a reference in channel</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>Config object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">makeDefault</span>
      <span class="dox_type">boolean</span>
      <span>Optional. Marks the newly created
   requirement room as default, and stores a reference under
   ServerChannel.requirementRoom. If TRUE and a requirements room
   is already existing an error will be thrown. Default: FALSE.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">RequirementsRoom</span>
      <span>The requirements room</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">RequirementsRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.setDefaultRequirementsRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createRequirementsRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span>
                                                          <span class="nx">makeDefault</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">room</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">makeDefault</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">requirementsRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Default requirements Room for channel &#39;&quot;</span> <span class="o">+</span>
                           <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot;&#39; already existing.&quot;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">room</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createRoom</span><span class="p">(</span><span class="s1">&#39;Requirements&#39;</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Sets it as the default requirement room for the channel, if requested so.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">makeDefault</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">setDefaultRequirementsRoom</span><span class="p">(</span><span class="nx">room</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">room</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.setdefaultrequirementroom">
  <h3>
    <a href="#serverchannel.setdefaultrequirementroom" name="serverchannel.setdefaultrequirementroom" class="pilcrow">&#182;</a>
    ServerChannel.setDefaultRequirementRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Sets the default requirements room for the channel</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">The</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>name of the requirements room or the room itself</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">RequirementsRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setDefaultRequirementsRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">roomObj</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">roomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">room</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">roomObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.setDefaultRequirementsRoom: &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;could find room: &#39;</span> <span class="o">+</span> <span class="nx">room</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">roomObj</span> <span class="o">=</span> <span class="nx">room</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.setDefaultRequirementsRoom: &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;room must be object or string. Found: &#39;</span> <span class="o">+</span> <span class="nx">room</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">roomType</span> <span class="o">!==</span> <span class="s1">&#39;Requirements&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.setDefaultRequirementsRoom: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;room is not a requirements room: &#39;</span> <span class="o">+</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">type</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">requirementsRoom</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">;</span>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.createroom">
  <h3>
    <a href="#serverchannel.createroom" name="serverchannel.createroom" class="pilcrow">&#182;</a>
    ServerChannel.createRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Primitive for creating a Waiting or Requirements room</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">type</span>
      <span class="dox_type">string</span>
      <span>'Waiting' or 'Requirements'</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>The settings for the constructor of the room</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">RequirementsRoom</span>
      <span class="dox_type">WaitingRoom</span>
      <span>room The created room</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">conf</span><span class="p">;</span>
    <span class="nx">settings</span> <span class="o">=</span> <span class="nx">settings</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.create&#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;Room: settings &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;must be object or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">conf</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">group</span> <span class="o">=</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;Room&#39;</span><span class="p">;</span>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="nx">type</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">gameLevel</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">gameLevel</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.create&#39;</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s1">&#39;Room: room name &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;already taken: &#39;</span> <span class="o">+</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">conf</span><span class="p">.</span><span class="nx">logicPath</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">;</span>

    <span class="k">delete</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">gameLevel</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>Adding a reference to this channel.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Adding settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">conf</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Construct room (the players will be moved into it explicitly):</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;Waiting&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">room</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WaitingRoom</span><span class="p">(</span><span class="nx">conf</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">room</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RequirementsRoom</span><span class="p">(</span><span class="nx">conf</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>TODO: consider this. Maybe waiting and requirements room should not
be added to the gameRooms. But there is a lot refactoring for this.
Notice that unlike game rooms, waiting and requirements room are added
as a direct reference in the channel object, instead of to the
<code>gameRooms</code> object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>Adding room to gameRooms object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">room</span><span class="p">;</span>

    <span class="nx">room</span><span class="p">.</span><span class="nx">setupGame</span><span class="p">();</span>
    <span class="nx">room</span><span class="p">.</span><span class="nx">startGame</span><span class="p">();</span>

    <span class="k">return</span> <span class="nx">room</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.destroyroom">
  <h3>
    <a href="#serverchannel.destroyroom" name="serverchannel.destroyroom" class="pilcrow">&#182;</a>
    ServerChannel.destroyRoom
  </h3>
</div>

  </div>
  <div class="body"><p>Destroys a game|requirements|waiting room</p>

<p>The child-rooms of the destroyed room are reparented to the destroyed room's
parent.
The room is only destroyed if it's empty or if a valid substitute room is
given to move the players to.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">room</span>
      <span class="dox_type">string</span>
      <span class="dox_type">object</span>
      <span>The name of room, or the room object to destroy</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional. Additional parameters.

<ul>
<li>ignoreRunningGame (boolean):
  Optional. Tries to destroy the room even if the game is
  not in gameover state. Default: FALSE</li>
<li>substituteRoomName (string):
  Optional. Name of the room to move the players to.
  If null, the room will not be destroyed if it contains players unless
  <code>disconnectPlayers</code> is true. Default: null</li>
<li>disconnectPlayers (boolean):
  Optional. If no <code>substituteRoomName</code> is given causes remaining players
  to disconnect. Otherwise room will not be destroyed. Default: FALSE</li>
</ul></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>Whether the room was destroyed successfully</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroyGameRoom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">room</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">roomObj</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clientObjs</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">parentRoom</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">childName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">substituteRoomName</span><span class="p">,</span> <span class="nx">ignoreRunningGame</span><span class="p">,</span> <span class="nx">disconnectPlayers</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">socket</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">roomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">room</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">roomObj</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.destroyGameRoom: room not &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;found: &#39;</span> <span class="o">+</span> <span class="nx">room</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">room</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">roomObj</span> <span class="o">=</span> <span class="nx">room</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.destroyGameRoom: room must be &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;string or object.&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>Get parameters.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="nx">substituteRoomName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">substituteRoomName</span> <span class="o">||</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">ignoreRunningGame</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">ignoreRunningGame</span><span class="p">;</span>
    <span class="nx">disconnectPlayers</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">disconnectPlayers</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">substituteRoomName</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">substituteRoomName</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.destroyGameRoom: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;options.substituteRoomName is not a valid room: &#39;</span> <span class="o">+</span>
                        <span class="nx">substituteRoomName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">substituteRoomName</span> <span class="o">&amp;&amp;</span> <span class="nx">disconnectPlayers</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.destroyGameRoom: incompatible &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;options selected: substituteRoomName and &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;disconnectPlayers.&#39;</span><span class="p">);</span>
    <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>Check whether the game in the room is still running.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ignoreRunningGame</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">game</span><span class="p">.</span><span class="nx">isGameover</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ServerChannel.destroyGameRoom: game still &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;running in room &#39;</span> <span class="o">+</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;. Use &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;ignoreRunningGame flag to proceed anyway. &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;Aborting.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="o">!</span><span class="nx">substituteRoomName</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">disconnectPlayers</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;ServerChannel.destroyGameRoom: room &#39;</span> <span class="o">+</span>
                           <span class="nx">roomObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;still contains players. Use &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;substituteRoomName or disconnectPlayers flags &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;to proceed anyway.&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Find out where to move the remaining players.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">clientObjs</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">getAllKeyElements</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">clientObjs</span><span class="p">))</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>Move/disconnect players and disconnect admins.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">clientObjs</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">clientObjs</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">clientObjs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<p>Disconnect admin.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">clientObjs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">sid</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>Move or disconnect player.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">substituteRoomName</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">this</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">substituteRoomName</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">else</span> <span class="p">{</span>
                        <span class="nx">socket</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">clients</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                        <span class="nx">socket</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">(</span><span class="nx">clientObjs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">sid</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Remove from parent's list of children.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">parentRoom</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">parentRoom</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">parentRoom</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">parentRoom</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">parentRoom</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">parentRoom</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>Give orphan rooms to their grandparent.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">childRooms</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">childName</span> <span class="o">=</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">childRooms</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">childName</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Tell child.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">childName</span><span class="p">].</span><span class="nx">parentRoom</span> <span class="o">=</span> <span class="nx">parentRoom</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Tell parent.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">parentRoom</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">parentRoom</span><span class="p">].</span><span class="nx">childRooms</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">childName</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>Remove room references.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">name</span><span class="p">];</span>
    <span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rooms</span><span class="p">[</span><span class="nx">roomObj</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;room destroyed: &#39;</span> <span class="o">+</span> <span class="nx">roomObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.creategamelevel">
  <h3>
    <a href="#serverchannel.creategamelevel" name="serverchannel.creategamelevel" class="pilcrow">&#182;</a>
    ServerChannel.createGameLevel
  </h3>
</div>

  </div>
  <div class="body"><p>Creates a new game level</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>Config object</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">makeDefault</span>
      <span class="dox_type">boolean</span>
      <span>Optional. Marks the newly created
   requirement room as default, and stores a reference under
   ServerChannel.requirementRoom. If TRUE and a requirements room
   is already existing an error will be thrown. Default: FALSE.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">RequirementsRoom</span>
      <span>The requirements room</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">RequirementsRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.setDefaultRequirementsRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createGameLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">level</span><span class="p">;</span>
    <span class="nx">name</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.createGameLevel: settings must &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;be string. Found: &#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameLevels</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.createGameLevel: a level with &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;the same name already exists: &#39;</span> <span class="o">+</span> <span class="nx">name</span><span class="p">);</span>

    <span class="p">}</span>
    <span class="nx">level</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GameLevel</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameLevels</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">level</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">level</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.moveclient">
  <h3>
    <a href="#serverchannel.moveclient" name="serverchannel.moveclient" class="pilcrow">&#182;</a>
    ServerChannel.moveClient
  </h3>
</div>

  </div>
  <div class="body"><p>Moves a player into a different room</p>

<p>Removes player from his old room and inserts him into the given room.
Updates the ChannelRegistry.</p>

<p>Sends out notifications to other clients.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">playerId</span>
      <span class="dox_type">string</span>
      <span>Player ID or game alias</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">toRoom</span>
      <span class="dox_type">string</span>
      <span>New room name (must exist)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fromRoom</span>
      <span class="dox_type">string</span>
      <span>Optional. The name of the current room, to avoid
   further lookup. (if given, must exist)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">moveClient</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">toRoom</span><span class="p">,</span> <span class="nx">fromRoom</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">playerObj</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">toRoomObj</span><span class="p">,</span> <span class="nx">fromRoomObj</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">oldPlayerList</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gameServer</span><span class="p">;</span>

    <span class="nx">playerId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">lookupClient</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fromRoom</span><span class="p">)</span> <span class="nx">fromRoom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>Check for existence of fromRoom:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fromRoom</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">fromRoom</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.moveClient: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Player was in invalid room: &quot;&#39;</span> <span class="o">+</span> <span class="nx">fromRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>Check for existence of toRoom:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">toRoom</span> <span class="o">||</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">toRoom</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.moveClient: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Unknown toRoom: &quot;&#39;</span> <span class="o">+</span> <span class="nx">toRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Delete player from old room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">playerObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">fromRoom</span><span class="p">].</span><span class="nx">clients</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">playerObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.moveClient: &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Player &quot;&#39;</span> <span class="o">+</span> <span class="nx">playerId</span> <span class="o">+</span>
                        <span class="s1">&#39;&quot; not found in room &quot;&#39;</span> <span class="o">+</span> <span class="nx">fromRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">toRoomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">toRoom</span><span class="p">];</span>
    <span class="nx">fromRoomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">fromRoom</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>Add player to new room:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">oldPlayerList</span> <span class="o">=</span> <span class="nx">toRoomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">breed</span><span class="p">();</span>
    <span class="nx">toRoomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>Update ChannelRegistry:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">toRoom</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Send updated PLISTs to all involved players.
It is important that the following code executes <em>after</em> the player has
been registered in the new room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">gameServer</span> <span class="o">=</span> <span class="nx">playerObj</span><span class="p">.</span><span class="nx">admin</span> <span class="o">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">adminServer</span> <span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">;</span>
    <span class="nx">gameServer</span><span class="p">.</span><span class="nx">notifyRoomDisconnection</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">fromRoomObj</span><span class="p">);</span>
    <span class="nx">gameServer</span><span class="p">.</span><span class="nx">notifyRoomConnection</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">toRoomObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>Old room had onConnect, new one not or has no players.
Force clear the player list.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fromRoomObj</span><span class="p">.</span><span class="nx">acm</span><span class="p">.</span><span class="nx">notify</span><span class="p">.</span><span class="nx">onConnect</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="o">!</span><span class="nx">toRoomObj</span><span class="p">.</span><span class="nx">acm</span><span class="p">.</span><span class="nx">notify</span><span class="p">.</span><span class="nx">onConnect</span> <span class="o">||</span> <span class="o">!</span><span class="nx">oldPlayerList</span><span class="p">.</span><span class="nx">size</span><span class="p">()))</span> <span class="p">{</span>

        <span class="nx">gameServer</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">gameServer</span><span class="p">.</span><span class="nx">msg</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
            <span class="nx">target</span><span class="o">:</span> <span class="s1">&#39;SETUP&#39;</span><span class="p">,</span>
            <span class="nx">to</span><span class="o">:</span>     <span class="nx">playerId</span><span class="p">,</span>
            <span class="nx">text</span><span class="o">:</span>   <span class="s1">&#39;plist&#39;</span><span class="p">,</span>
            <span class="nx">reliable</span><span class="o">:</span><span class="mi">500</span><span class="p">,</span>
            <span class="nx">data</span><span class="o">:</span>   <span class="nx">J</span><span class="p">.</span><span class="nx">stringify</span><span class="p">([[],</span> <span class="s1">&#39;replace&#39;</span><span class="p">])</span>
        <span class="p">}));</span>
    <span class="p">}</span>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.getgamelevel">
  <h3>
    <a href="#serverchannel.getgamelevel" name="serverchannel.getgamelevel" class="pilcrow">&#182;</a>
    ServerChannel.getGameLevel
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the game level object</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">level</span>
      <span class="dox_type">string</span>
      <span>The name of the game level</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">GameLevel</span>
      <span>levelObj The game level object</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLevel</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.gameLevels
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getGameLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">levelObj</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.getGameLevel: level must &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;be string. Found: &#39;</span> <span class="o">+</span> <span class="nx">level</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">levelObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameLevels</span><span class="p">[</span><span class="nx">level</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">levelObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.getGameLevel: level not found: &#39;</span> <span class="o">+</span>
                        <span class="nx">level</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">levelObj</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.moveclienttogamelevel">
  <h3>
    <a href="#serverchannel.moveclienttogamelevel" name="serverchannel.moveclienttogamelevel" class="pilcrow">&#182;</a>
    ServerChannel.moveClientToGameLevel
  </h3>
</div>

  </div>
  <div class="body"><p>Moves a client to the entry room of the chosen game level</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">playerId</span>
      <span class="dox_type">string</span>
      <span>Player ID or game alias</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">toLevel</span>
      <span class="dox_type">string</span>
      <span>New level name (must exist, and must have entry room)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">fromRoom</span>
      <span class="dox_type">string</span>
      <span>Optional. The name of the current room, to avoid
   further lookup. (if given, must exist)</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.moveClient
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">moveClientToGameLevel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">toLevel</span><span class="p">,</span>
                                                         <span class="nx">fromRoom</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">toLevelObj</span><span class="p">,</span> <span class="nx">toRoom</span><span class="p">;</span>

    <span class="nx">toLevelObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getGameLevel</span><span class="p">(</span><span class="nx">toLevel</span><span class="p">);</span>
    <span class="nx">toRoom</span> <span class="o">=</span> <span class="nx">toLevelObj</span><span class="p">.</span><span class="nx">getEntryRoom</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">toRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.moveClientToGameLevel: level has no &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;entry room. Level: &#39;</span> <span class="o">+</span> <span class="nx">toLevel</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">toRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">fromRoom</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.placeclient">
  <h3>
    <a href="#serverchannel.placeclient" name="serverchannel.placeclient" class="pilcrow">&#182;</a>
    ServerChannel.placeClient
  </h3>
</div>

  </div>
  <div class="body"><p>Places a player into a room for the first time</p>

<p>Player must not be found in any other room, otherwise
an error is raised.</p>

<p>The method is used to place newly connecting players in their
first room, or reconnecting players in their last room.</p>

<p>Unlike <code>moveClient</code> this method does not send out notifications.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">playerObj</span>
      <span class="dox_type">object</span>
      <span class="dox_type">Player</span>
      <span>An object representing a player</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">inRoom</span>
      <span class="dox_type">string</span>
      <span>New room ID (must exist)</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>Whether the placement was valid and performed</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">placeClient</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">,</span> <span class="nx">inRoom</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">playerId</span><span class="p">,</span> <span class="nx">fromRoomName</span><span class="p">,</span> <span class="nx">roomObj</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">e</span><span class="p">;</span>

    <span class="nx">roomObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">inRoom</span><span class="p">];</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">roomObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="s1">&#39;ServerChannel.placeClient: room not found: &quot;&#39;</span> <span class="o">+</span> <span class="nx">inRoom</span> <span class="o">+</span> <span class="s1">&#39;&quot;.&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">playerId</span> <span class="o">=</span> <span class="nx">playerObj</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="nx">fromRoomName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">playerId</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>Player must not be found already in any room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fromRoomName</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">fromRoomName</span><span class="p">].</span><span class="nx">clients</span><span class="p">.</span><span class="nx">exist</span><span class="p">(</span><span class="nx">playerId</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="s1">&#39;ServerChannel.placeClient: &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;player already in room: &quot;&#39;</span> <span class="o">+</span> <span class="nx">fromRoomName</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>Add player to room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">roomObj</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">playerObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>Adds a new room in the room stack in Channel Registry unless the client
is reconnecting, in which case the new room is the same as the old one.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">moveClient</span><span class="p">(</span><span class="nx">playerId</span><span class="p">,</span> <span class="nx">inRoom</span><span class="p">);</span>

    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.require">
  <h3>
    <a href="#serverchannel.require" name="serverchannel.require" class="pilcrow">&#182;</a>
    ServerChannel.require
  </h3>
</div>

  </div>
  <div class="body"><p>Special require statement to share objects with the required files</p>

<p>Always adds a reference to the current <em>channel</em> amongst the exported
modules.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">path</span>
      <span class="dox_type">string</span>
      <span>The path to the required file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">exports</span>
      <span class="dox_type">object</span>
      <span>Optional. Object literals with properties shared
  with the required file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">nocache</span>
      <span class="dox_type">boolean</span>
      <span>If TRUE, deletes the cached path and forces
  re-reading from file system. Default: FALSE</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">mixed</span>
      <span>The required file</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <a href="           node-js-require-cache-possible-to-invalidate
">http://stackoverflow.com/questions/9210542/
</a>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">require</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">exports</span><span class="p">,</span> <span class="nx">nocache</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>TODO: set it to null instead?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">nocache</span><span class="p">)</span> <span class="k">delete</span> <span class="nx">require</span><span class="p">.</span><span class="nx">cache</span><span class="p">[</span><span class="nx">require</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">path</span><span class="p">)];</span>
    <span class="k">return</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">exports</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">exports</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">require</span><span class="p">(</span><span class="nx">path</span><span class="p">);</span>
    <span class="p">})();</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.getgamedir">
  <h3>
    <a href="#serverchannel.getgamedir" name="serverchannel.getgamedir" class="pilcrow">&#182;</a>
    ServerChannel.getGameDir
  </h3>
</div>

  </div>
  <div class="body"><p>Returns the full path to the game directory</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerNode.resolveGameDir
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getGameDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">resolveGameDir</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gameName</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.hasgametreatment">
  <h3>
    <a href="#serverchannel.hasgametreatment" name="serverchannel.hasgametreatment" class="pilcrow">&#182;</a>
    ServerChannel.hasGameTreatment
  </h3>
</div>

  </div>
  <div class="body"><p>Returns TRUE, if game has specified treatment</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">The</span>
      <span class="dox_type">string</span>
      <span>treatment to check</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.gameInfo
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasGameTreatment</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">settings</span><span class="p">[</span><span class="nx">t</span><span class="p">];</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.authorizesuperuser">
  <h3>
    <a href="#serverchannel.authorizesuperuser" name="serverchannel.authorizesuperuser" class="pilcrow">&#182;</a>
    ServerChannel.authorizeSuperUser
  </h3>
</div>

  </div>
  <div class="body"><p>Returns true if username and password corresponds to channel credentials</p>
  </div>
  <div class="details">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">authorizeSuperUser</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">&amp;&amp;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">user</span> <span class="o">===</span> <span class="nx">user</span> <span class="o">&amp;&amp;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">credentials</span><span class="p">.</span><span class="nx">pwd</span> <span class="o">===</span> <span class="nx">pwd</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.connectbot">
  <h3>
    <a href="#serverchannel.connectbot" name="serverchannel.connectbot" class="pilcrow">&#182;</a>
    ServerChannel.connectBot
  </h3>
</div>

  </div>
  <div class="body"><p>Create a bot and put it in a room</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Bot options with the following fields:

<ul>
<li>clientType (string):
Optional. Client type of the bot. Default: 'bot'</li>
<li>room (GameRoom):
The game room in which to put the bot initially</li>
<li>loadGame (boolean):
Optional. Whether to load a game file. The remaining fields are only
used if this is TRUE. Default: TRUE</li>
<li>botPath (string):
Optional. Relative path to the game file. Default: Value in the
game settings for the given treatment and client type</li>
<li>gameName (string):
Optional. Name of the game. Default: room.gameName</li>
<li>treatmentName (string):
Optional. Name of the treatment. Default: room.treatmentName</li>
</ul></span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">mixinConf</span>
      <span class="dox_type">object</span>
      <span>Optional. Additional options to pass to the node
  instance of the room. Overrides the returned game configuration from the
  require statement.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>The node instance of the new bot</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connectBot</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">mixinConf</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">bot</span><span class="p">,</span> <span class="nx">botPath</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">loadGame</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clientType</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gameName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">game</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">treatmentName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">node</span><span class="p">;</span>

    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>Check inputs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options must be object.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">room</span> <span class="k">instanceof</span> <span class="nx">GameRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.room must be GameRoom.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">clientType</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">clientType</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.clientType must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">clientType</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">clientType</span> <span class="o">||</span> <span class="s1">&#39;bot&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.botPath must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;boolean&#39;</span>   <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.loadGame must be boolean or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">loadGame</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span> <span class="o">?</span>
        <span class="kc">true</span> <span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">loadGame</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.gameName must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">treatmentName</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">treatmentName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;options.treatmentName must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<p>Create the bot.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">node</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">getClient</span><span class="p">();</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">log</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">logger</span> <span class="o">||</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;clients&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="nx">clientType</span><span class="p">});</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">lvl</span><span class="p">)</span> <span class="p">{</span> <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">lvl</span><span class="p">);</span> <span class="p">};</span>
    <span class="p">})();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">loadGame</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;options.gameName or options.room.gameName &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;must exist if options.loadGame is true.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">treatmentName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">treatmentName</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">treatmentName</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">treatmentName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;options.treatmentName or options.room.treatmentName &#39;</span> <span class="o">+</span>
                    <span class="s1">&#39;must exist if options.loadGame is true.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">game</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">getGamesInfo</span><span class="p">(</span><span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>If not given, look up the path of the given type.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>Prepend the path to the game directory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">botPath</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">resolveGameDir</span><span class="p">(</span><span class="nx">gameName</span><span class="p">)</span> <span class="o">+</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">botPath</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">botPath</span> <span class="o">||</span>
                <span class="nx">game</span><span class="p">.</span><span class="nx">treatments</span><span class="p">[</span><span class="nx">treatmentName</span><span class="p">].</span><span class="nx">gamePaths</span><span class="p">[</span><span class="nx">clientType</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nx">settings</span> <span class="o">=</span> <span class="nx">game</span><span class="p">.</span><span class="nx">treatments</span><span class="p">[</span><span class="nx">treatmentName</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>Require bot.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">bot</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">botPath</span><span class="p">)(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">,</span> <span class="nx">treatmentName</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">bot</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectBot: botPath &quot;&#39;</span> <span class="o">+</span>
                    <span class="nx">botPath</span> <span class="o">+</span> <span class="s1">&#39;&quot; did not return a valid game object.&#39;</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>Mixin-in nodeGame options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">mixinConf</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">bot</span><span class="p">,</span> <span class="nx">mixinConf</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98">&#182;</a>
</div>
<p>Setup must be called before connect.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">node</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="s1">&#39;nodegame&#39;</span><span class="p">,</span> <span class="nx">bot</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>This code needs to run as soon as the clientId is generated to avoid
calling GameRoom.setupGame before the node object is stored.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">node</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;PLAYER_CREATED&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">bots</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node</span><span class="p">;</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100">&#182;</a>
</div>
<p>Connect bot to server.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">node</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">setSocketType</span><span class="p">(</span><span class="s1">&#39;SocketDirect&#39;</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">socket</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">.</span><span class="nx">socketManager</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">direct</span>
    <span class="p">});</span>

    <span class="nx">node</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">startingRoom</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">room</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
        <span class="nx">clientType</span><span class="o">:</span>   <span class="nx">clientType</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">node</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="serverchannel.connectphantom">
  <h3>
    <a href="#serverchannel.connectphantom" name="serverchannel.connectphantom" class="pilcrow">&#182;</a>
    ServerChannel.connectPhantom
  </h3>
</div>

  </div>
  <div class="body"><p>Create a PhantomJS player connected to the server</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">options</span>
      <span class="dox_type">object</span>
      <span>Optional. Connection options with these fields:

<ul>
<li>port (number):
Optional. Port to connect to. Default: this.servernode.port</li>
<li>gameName (string):
Optional. Game to connect to. Uses the channel name by default. If all
games have names different from the channel name, this is invalid.
Default: this.name</li>
<li>filePath (string):
Optional. URL suffix for a relative file path, without leading slash.
A trailing slash is required if this is a directory</li>
<li>queryString (string):
Optional. String of query parameters to append
to the URL. Default: '?clientType=autoplay'</li>
<li>phantomjsArgs (array):
Optional. Array of strings to give PhantomJS as command line arguments</li>
</ul></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">ChildProcess</span>
      <span>Handle to the PhantomJS process</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connectPhantom</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">queryString</span><span class="p">,</span> <span class="nx">phantomjsArgs</span><span class="p">,</span> <span class="nx">omitGameName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">serverdir</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">url</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">phantomjs</span><span class="p">,</span> <span class="nx">phPath</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">logger</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>

    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>Check inputs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{};</span>

    <span class="nx">port</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">port</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;number&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">port</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;port must be number or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">port</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">port</span> <span class="o">?</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">port</span> <span class="o">:</span> <span class="nx">port</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">omitGameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">omitGameName</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">options</span><span class="p">.</span><span class="nx">omitGameName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">omitGameName</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">defaultChannel</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">gameName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">gameName</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;gameName must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">filePath</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">filePath</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">filePath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;filePath must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">filePath</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">filePath</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">filePath</span><span class="p">;</span>

    <span class="nx">queryString</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">queryString</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">queryString</span> <span class="o">&amp;&amp;</span>
        <span class="s1">&#39;string&#39;</span>    <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">queryString</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;queryString must be string or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">queryString</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">queryString</span> <span class="o">?</span>
        <span class="s1">&#39;?clientType=autoplay&#39;</span> <span class="o">:</span> <span class="nx">queryString</span><span class="p">;</span>

    <span class="nx">phantomjsArgs</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">phantomjsArgs</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">phantomjsArgs</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">phantomjsArgs</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;ServerChannel.connectPhantom: &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;phantomjsArgs must be array or undefined.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">phantomjsArgs</span> <span class="o">=</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">phantomjsArgs</span> <span class="o">?</span>  <span class="p">[]</span> <span class="o">:</span> <span class="nx">phantomjsArgs</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>Launch a phantomjs process with a connection to the server.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104">&#182;</a>
</div>
<p>Set up the arguments to phantomjs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>Url might or not contain gameName (e.g. not if it is default channel).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:&#39;</span> <span class="o">+</span> <span class="nx">port</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">gameName</span><span class="p">)</span> <span class="nx">url</span> <span class="o">+=</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
    <span class="nx">url</span> <span class="o">+=</span> <span class="nx">filePath</span> <span class="o">+</span> <span class="nx">queryString</span><span class="p">;</span>
    <span class="nx">phantomjsArgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">rootDir</span> <span class="o">+</span> <span class="s1">&#39;/phantomjs/openurl.js&#39;</span><span class="p">);</span>
    <span class="nx">phantomjsArgs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>Do not call /phantomjs/bin/phantomjs to avoid double spawn.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">phPath</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">resolveModuleDir</span><span class="p">(</span><span class="s1">&#39;phantomjs&#39;</span><span class="p">,</span> <span class="nx">__dirname</span><span class="p">);</span>
    <span class="nx">phPath</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">phPath</span> <span class="o">+</span> <span class="s1">&#39;/lib/phantomjs&#39;</span><span class="p">).</span><span class="nx">path</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<p>Spawn.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">phantomjs</span> <span class="o">=</span> <span class="nx">spawn</span><span class="p">(</span><span class="nx">phPath</span><span class="p">,</span> <span class="nx">phantomjsArgs</span><span class="p">);</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">setEncoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
    <span class="nx">logger</span> <span class="o">=</span> <span class="nx">Logger</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;clients&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;phantomjs&#39;</span><span class="p">});</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">stdout</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;stdout: &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">stderr</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;stderr: &#39;</span> <span class="o">+</span> <span class="nx">data</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-108" id="section-108">&#182;</a>
</div>
<p>Wait few ms for error to be printed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;PhantomJS (PID &#39;</span> <span class="o">+</span> <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">pid</span> <span class="o">+</span> <span class="s1">&#39;) exited&#39;</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">code</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;PhantomJS received non-zero exit code: &#39;</span> <span class="o">+</span> <span class="nx">code</span> <span class="o">+</span>
                          <span class="s1">&#39;, Signal: &#39;</span> <span class="o">+</span> <span class="nx">signal</span><span class="p">;</span>
                <span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">code</span><span class="o">:</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="o">:</span> <span class="nx">signal</span> <span class="p">});</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">delete</span> <span class="nx">that</span><span class="p">.</span><span class="nx">phantoms</span><span class="p">[</span><span class="nx">phantomjs</span><span class="p">.</span><span class="nx">pid</span><span class="p">];</span>
        <span class="p">},</span> <span class="mi">20</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="nx">phantomjs</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Error executing phantom at&#39;</span><span class="p">,</span> <span class="nx">phPath</span><span class="p">);</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-109" id="section-109">&#182;</a>
</div>
<p>Add to the global collection.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">phantoms</span><span class="p">[</span><span class="nx">phantomjs</span><span class="p">.</span><span class="nx">pid</span><span class="p">]</span> <span class="o">=</span> <span class="nx">phantomjs</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">phantomjs</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-110" id="section-110">&#182;</a>
</div>
<p>Maybe we do not need this api.
/**
 * ### ServerChannel.killPhantom
 *
 * Sends a SIGHUP signal to all active PhantomJS processes
 *
 * @see ServerChannel.connectPhantom
 */
ServerChannel.prototype.killAllPhantoms = function() {
    var phantom;
    for (phantom in this.phantoms) {
        if (this.phantoms.hasOwnProperty(phantom)) {
            console.log('killing ', phantom);
            process.kill(phantom, 'SIGHUP');
        }
    }
};</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-111" id="section-111">&#182;</a>
</div>
<p>TODO: finish this method. Should destroy all game rooms. clear all players?,
      keep the waiting room</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nx">ServerChannel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reboot</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">roomName</span><span class="p">,</span> <span class="nx">waitingLogicId</span><span class="p">;</span>
    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="nx">waitingLogicId</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">player</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-112" id="section-112">&#182;</a>
</div>
<p>Remove clients from registry, game rooms and disconnect them.
   this.registry.clients.each(function(c) {
       if (c.id !== waitingLogicId) {
           if (c.admin) {</p>


<div class="highlight"><pre><code>           <span class="sr">//</span> <span class="n">This</span> <span class="n">is</span> <span class="n">correct</span> <span class="n">but</span> <span class="n">too</span> <span class="n">much</span><span class="o">...</span>
           <span class="sr">//</span><span class="n">that</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="nb">socket</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">sid</span><span class="p">);</span>


           <span class="nb">delete</span> <span class="n">that</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="nb">socket</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">sid</span><span class="p">];</span>
       <span class="p">}</span>
       <span class="k">else</span> <span class="p">{</span>
           <span class="sr">//</span> <span class="n">This</span> <span class="n">is</span> <span class="n">correct</span> <span class="n">but</span> <span class="n">too</span> <span class="n">much</span><span class="o">...</span>
           <span class="sr">//</span><span class="n">that</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="nb">socket</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">sid</span><span class="p">);</span>

           <span class="n">that</span><span class="o">.</span><span class="n">player</span><span class="o">.</span><span class="nb">socket</span><span class="o">.</span><span class="n">clients</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">sockets</span><span class="o">.</span>
                 <span class="n">sockets</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">sid</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span><span class="o">.</span><span class="n">disconnect</span><span class="p">();</span>
       <span class="p">}</span>
   <span class="p">}</span>
</code></pre></div>



<p>});</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-113" id="section-113">&#182;</a>
</div>
<p>Remove clients from registry, game rooms and disconnect them.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">waitingLogicId</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">removeClient</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>


    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">roomName</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-114" id="section-114">&#182;</a>
</div>
<p>Destroy empty game rooms.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">for</span> <span class="p">(</span><span class="nx">roomName</span> <span class="k">in</span> <span class="nx">that</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">roomName</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">roomName</span> <span class="o">!==</span> <span class="nx">that</span><span class="p">.</span><span class="nx">waitingRoom</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">destroyGameRoom</span><span class="p">(</span><span class="nx">roomName</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-115" id="section-115">&#182;</a>
</div>
<p>Create a brand new Registry.
this.registry = new ChannelRegistry({ name: this.name });</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
