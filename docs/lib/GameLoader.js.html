<!DOCTYPE html>
<html>
<head>
  <title>GameLoader.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "lib/GameLoader.js", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#gameloader">GameLoader</a>
      </div>
      <div class="heading h2">
        <a href="#global%20scope">Global scope</a>
      </div>
      <div class="heading h2">
        <a href="#gameloader%20constructor">GameLoader constructor</a>
      </div>
      <div class="heading h2">
        <a href="#gameloader%20methods">GameLoader methods</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.addgame">GameLoader.addGame</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadlevelsdir">GameLoader.loadLevelsDir</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.buildlevelconf">GameLoader.buildLevelConf</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadgamedir">GameLoader.loadGameDir</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.parsesettings">GameLoader.parseSettings</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadclienttypes">GameLoader.loadClientTypes</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.buildlanguagesobject">GameLoader.buildLanguagesObject</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadchanneldir">GameLoader.loadChannelDir</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadchannelfile">GameLoader.loadChannelFile</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.buildwaitroomconf">GameLoader.buildWaitRoomConf</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadwaitroomdir">GameLoader.loadWaitRoomDir</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadauthdir">GameLoader.loadAuthDir</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.buildrequirementsconf">GameLoader.buildRequirementsConf</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadrequirementsdir">GameLoader.loadRequirementsDir</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.getchannelsandbox">GameLoader.getChannelSandbox</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.updategameinfo">GameLoader.updateGameInfo</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.doerr">GameLoader.doErr</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods">Helper methods</a>
      </div>
      <div class="heading h3">
        <a href="#checklocalpath">checkLocalPath</a>
      </div>
      <div class="heading h3">
        <a href="#version2gamestage">version2GameStage</a>
      </div>
      <div class="heading h3">
        <a href="#gamerequirementsfail">gameRequirementsFail</a>
      </div>
      <div class="heading h3">
        <a href="#parsegamesettings">parseGameSettings</a>
      </div>
      <div class="heading h3">
        <a href="#importauthcodes">importAuthCodes</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.loadviewsfile">GameLoader.loadViewsFile</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader">
  <h1>
    <a href="#gameloader" name="gameloader" class="pilcrow">&#182;</a>
    GameLoader
  </h1>
</div>


<p>Copyright(c) 2016 Stefano Balietti
MIT Licensed</p>
  </div>
  <div class="body"><p>Loads nodeGame games from file system</p>

<p><a href='http://nodegame.org'>http://nodegame.org</a></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">GameLoader</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="global%20scope">
  <h2>
    <a href="#global%20scope" name="global%20scope" class="pilcrow">&#182;</a>
    Global scope
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">GameRouter</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./GameRouter&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">J</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;JSUS&#39;</span><span class="p">).</span><span class="nx">JSUS</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">ngc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-client&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">GameStage</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">GameStage</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">ngt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-game-template&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">serverVersionObj</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader%20constructor">
  <h2>
    <a href="#gameloader%20constructor" name="gameloader%20constructor" class="pilcrow">&#182;</a>
    GameLoader constructor
  </h2>
</div>

  </div>
  <div class="body"><p>Constructs a new instance of GameLoader</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">GameLoader</span><span class="p">(</span><span class="nx">servernode</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span> <span class="o">=</span> <span class="nx">servernode</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">gameRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GameRouter</span><span class="p">(</span><span class="nx">servernode</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Cannot keep a reference to servernode.logger because it gets
overwritten later on.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Transform server version string to object (used to check dependencies).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">serverVersionObj</span> <span class="o">=</span> <span class="nx">version2GameStage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">version</span><span class="p">);</span>
<span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="gameloader%20methods">
  <h2>
    <a href="#gameloader%20methods" name="gameloader%20methods" class="pilcrow">&#182;</a>
    GameLoader methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.addgame">
  <h3>
    <a href="#gameloader.addgame" name="gameloader.addgame" class="pilcrow">&#182;</a>
    GameLoader.addGame
  </h3>
</div>

  </div>
  <div class="body"><p>Adds a new game to the global collection <code>info.games</code></p>

<p>The version of ServerNode is compared against the information in
<em>gameInfo.engines.nodegame</em>, if found.</p>

<p>Aliases will be created, if needed.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameInfo</span>
      <span class="dox_type">object</span>
      <span>A game descriptor, usually from package.json</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameDir</span>
      <span class="dox_type">string</span>
      <span>The root directory of the game (with trailing slash)</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerNode.addGameDir
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addGame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gameInfo</span><span class="p">,</span> <span class="nx">gameDir</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">reqFail</span><span class="p">,</span> <span class="nx">clientTypes</span><span class="p">,</span> <span class="nx">langObject</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">gameConf</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">channel</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameInfo</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameLoader.addGame: gameInfo must be object.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameDir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameLoader.addGame: gameDir must be string.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">channelName</span> <span class="o">||</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Check name.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.addGame: missing or invalid game name: &#39;</span> <span class="o">+</span>
                        <span class="nx">gameDir</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Check if name is unique.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="nx">gameName</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.addGame: a game with the same name &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;already found: &#39;</span> <span class="o">+</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>Checking nodeGame server version requirement.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">engines</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">reqFail</span> <span class="o">=</span> <span class="nx">gameRequirementsFail</span><span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">engines</span><span class="p">.</span><span class="nx">nodegame</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">reqFail</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.addGame: game &#39;</span> <span class="o">+</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;requires nodeGame version &#39;</span> <span class="o">+</span>
                            <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">engines</span><span class="p">.</span><span class="nx">nodegame</span>  <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;but found &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Loading settings, setup, and stages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">gameConf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadGameDir</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>Loading client types.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">clientTypes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadClientTypes</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Building language object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">langObject</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildLanguagesObject</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Adding game info to global info object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="nx">gameName</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">dir</span><span class="o">:</span> <span class="nx">gameDir</span><span class="p">,</span>
        <span class="nx">info</span><span class="o">:</span> <span class="nx">gameInfo</span><span class="p">,</span>
        <span class="nx">clientTypes</span><span class="o">:</span> <span class="nx">clientTypes</span><span class="p">,</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>At this point settings is as it is in game.settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">settings</span><span class="o">:</span> <span class="nx">gameConf</span><span class="p">.</span><span class="nx">settings</span><span class="p">,</span>
        <span class="nx">setup</span><span class="o">:</span> <span class="nx">gameConf</span><span class="p">.</span><span class="nx">setup</span><span class="p">,</span>
        <span class="nx">stager</span><span class="o">:</span> <span class="nx">gameConf</span><span class="p">.</span><span class="nx">stager</span><span class="p">,</span>
        <span class="nx">languages</span><span class="o">:</span> <span class="nx">langObject</span><span class="p">,</span>
        <span class="nx">channel</span><span class="o">:</span> <span class="p">{},</span>
        <span class="nx">levels</span><span class="o">:</span> <span class="p">{},</span>
        <span class="nx">alias</span><span class="o">:</span> <span class="p">[]</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Load channel dir first.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadChannelDir</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Loading levels, if any (nodeGame >= 2.x);</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">loadLevelsDir</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>After all levels are loaded, we can make the treatments
in the main settings object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">parseSettings</span><span class="p">(</span><span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>We add all treatment names.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="nx">gameName</span><span class="p">].</span><span class="nx">treatmentNames</span> <span class="o">=</span>
        <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="nx">gameName</span><span class="p">].</span><span class="nx">settings</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Creates a waiting room.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">loadWaitRoomDir</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Loading Auth dir, if any.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">loadAuthDir</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Loading Requirements dir, if any.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">loadRequirementsDir</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Tries to load Views file from game directory.
this.loadViewsFile(gameDir, gameInfo);</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>Add routes (considering other loaded options: auth, monitor, etc.).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameRouter</span><span class="p">.</span><span class="nx">addRoutes</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span>
                              <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="nx">gameName</span><span class="p">]);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Done.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;GameLoader.addGame: added &#39;</span> <span class="o">+</span>
                                <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">gameDir</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadlevelsdir">
  <h3>
    <a href="#gameloader.loadlevelsdir" name="gameloader.loadlevelsdir" class="pilcrow">&#182;</a>
    GameLoader.loadLevelsDir
  </h3>
</div>

  </div>
  <div class="body"><p>Loads the <em>levels</em> dir of the game</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The path of the game directory</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>An object containing three properties:
  'settings', 'stager', and 'setup'.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.addGame</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.loadLevel
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadLevelsDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">levels</span><span class="p">,</span> <span class="nx">level</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">levelsPath</span><span class="p">,</span> <span class="nx">levelsPaths</span><span class="p">,</span> <span class="nx">levelConf</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">logger</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">;</span>

    <span class="nx">logger</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">logger</span><span class="p">;</span>
    <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadLevelsDir: directory must be &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;string. Game: &#39;</span> <span class="o">+</span> <span class="nx">gameName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">levelsPath</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;levels/&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">levelsPath</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">levelsPaths</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">levelsPath</span><span class="p">);</span>

    <span class="nx">len</span> <span class="o">=</span> <span class="nx">levelsPaths</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">len</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadLevelsDir: levels dir is empty. &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;Game: &#39;</span> <span class="o">+</span> <span class="nx">gameName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">levels</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">level</span> <span class="o">=</span> <span class="nx">levelsPaths</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">levelsPath</span> <span class="o">+</span> <span class="nx">level</span><span class="p">).</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
            <span class="nx">levelConf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildLevelConf</span><span class="p">(</span><span class="nx">levelsPath</span> <span class="o">+</span> <span class="nx">level</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                                            <span class="nx">gameName</span><span class="p">,</span>
                                            <span class="nx">level</span><span class="p">);</span>
            <span class="nx">levels</span><span class="p">[</span><span class="nx">level</span><span class="p">]</span> <span class="o">=</span> <span class="nx">levelConf</span><span class="p">;</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">updateGameInfo</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">,</span> <span class="nx">levelConf</span><span class="p">);</span>
            <span class="nx">channel</span><span class="p">.</span><span class="nx">createGameLevel</span><span class="p">(</span><span class="nx">levelConf</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">levels</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.buildlevelconf">
  <h3>
    <a href="#gameloader.buildlevelconf" name="gameloader.buildlevelconf" class="pilcrow">&#182;</a>
    GameLoader.buildLevelConf
  </h3>
</div>

  </div>
  <div class="body"><p>Loads one of the levels in the <em>levels</em> dir of the game</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The path to the level directory</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>An object containing three properties:
  'settings', 'stager', and 'setup'.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.loadLevel
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">buildLevelConf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">levelObj</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadLevel: game: directory must be string&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
            <span class="nx">found</span><span class="o">:</span> <span class="nx">directory</span>
        <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>This builds an object with already settings parsed as treatments.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">levelObj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadGameDir</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">);</span>

    <span class="nx">levelObj</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">level</span><span class="p">;</span>
    <span class="nx">levelObj</span><span class="p">.</span><span class="nx">waitroom</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildWaitRoomConf</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">);</span>
    <span class="nx">levelObj</span><span class="p">.</span><span class="nx">clientTypes</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadClientTypes</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">);</span>
    <span class="nx">levelObj</span><span class="p">.</span><span class="nx">requirements</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildRequirementsConf</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span>
                                                       <span class="nx">level</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">levelObj</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadgamedir">
  <h3>
    <a href="#gameloader.loadgamedir" name="gameloader.loadgamedir" class="pilcrow">&#182;</a>
    GameLoader.loadGameDir
  </h3>
</div>

  </div>
  <div class="body"><p>Loads the <em>game</em> dir of the game</p>

<p>Files game.settings, game.setup, and game.stages will be loaded.</p>

<p>If loading a game level, game.settings and game.setup will be merged
with default values. Therefore, they can be missing in the level folder.
Otherwise, if missing an error will be thrown.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The path of the game directory</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>An object containing three properties:
  'settings', 'stager', and 'setup'.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.addGame</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">parseGameSettings
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadGameDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gameSetupPath</span><span class="p">,</span> <span class="nx">gameSetup</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gameSettingsPath</span><span class="p">,</span> <span class="nx">gameSettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gameStagesPath</span><span class="p">,</span> <span class="nx">gameStages</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">origInfo</span><span class="p">,</span> <span class="nx">stager</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: directory must be string&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
            <span class="nx">found</span><span class="o">:</span> <span class="nx">directory</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: level must be string&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">found</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Used to Merge/clone from default settings/setup.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">origInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">getGamesInfo</span><span class="p">(</span><span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">gameSettingsPath</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;game/game.settings.js&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>If we are loading a level, settings can be omitted, and the main
game.settings are used. If not not omitted, the settings will be
mixed-in.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">gameSettingsPath</span><span class="p">))</span> <span class="p">{</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">gameSettings</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">gameSettingsPath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: an error occurred &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;while reading game.settings file&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">err</span><span class="o">:</span> <span class="nx">e</span><span class="p">,</span>
                           <span class="nx">throwErr</span><span class="o">:</span> <span class="kc">true</span>
                       <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameSettings</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: invalid settings file, &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;object expected&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">found</span><span class="o">:</span> <span class="nx">gameSettings</span>
                       <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">gameSettings</span><span class="p">.</span><span class="nx">TIMER</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameSettings</span><span class="p">.</span><span class="nx">TIMER</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: gameSettings.TIMER &#39;</span> <span class="o">+</span>
                           <span class="s1">&#39;must be object or undefined&#39;</span><span class="p">,</span> <span class="p">{</span>
                               <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                               <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                               <span class="nx">found</span><span class="o">:</span> <span class="nx">gameSettings</span><span class="p">.</span><span class="nx">TIMER</span>
                           <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">gameSettings</span><span class="p">.</span><span class="nx">TIMER</span> <span class="o">=</span> <span class="p">{};</span>
        <span class="p">}</span>

    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: game.settings file not found&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Merging global options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="nx">gameSettings</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">origInfo</span><span class="p">.</span><span class="nx">settings</span><span class="p">,</span> <span class="nx">gameSettings</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Stages.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">gameStagesPath</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;game/game.stages.js&#39;</span><span class="p">;</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">gameStages</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">gameStagesPath</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: an error occurred while reading &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;game.stages file&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">err</span><span class="o">:</span> <span class="nx">e</span>
                   <span class="p">});</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameStages</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: game.stages file did not &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;export a function&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">found</span><span class="o">:</span> <span class="nx">gameStages</span>
                   <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">stager</span> <span class="o">=</span> <span class="nx">ngc</span><span class="p">.</span><span class="nx">getStager</span><span class="p">();</span>
    <span class="nx">gameStages</span> <span class="o">=</span> <span class="nx">gameStages</span><span class="p">(</span><span class="nx">stager</span><span class="p">,</span> <span class="nx">gameSettings</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Setup.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">gameSetupPath</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;game/game.setup.js&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>If we are loading a level, setup can be omitted, and the main
game.settings are used. If not not omitted, the settings will be
mixed-in.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">gameSettingsPath</span><span class="p">))</span> <span class="p">{</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">gameSetup</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">gameSetupPath</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: an error occurred &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;while reading game.setup file&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">err</span><span class="o">:</span> <span class="nx">e</span>
                       <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameSetup</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: setup file did not &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;export a function&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">found</span><span class="o">:</span> <span class="nx">gameSetup</span>
                       <span class="p">});</span>
        <span class="p">}</span>

        <span class="nx">gameSetup</span> <span class="o">=</span> <span class="nx">gameSetup</span><span class="p">(</span><span class="nx">gameSettings</span><span class="p">,</span> <span class="nx">gameStages</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameSetup</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: setup function did &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;not return a valid object&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">found</span><span class="o">:</span> <span class="nx">gameSetup</span>
                       <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadGameDir: game.setup file not found&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Merging global options.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="nx">gameSetup</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">origInfo</span><span class="p">.</span><span class="nx">setup</span><span class="p">,</span> <span class="nx">gameSetup</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">setup</span><span class="o">:</span> <span class="nx">gameSetup</span><span class="p">,</span>
        <span class="nx">settings</span><span class="o">:</span> <span class="nx">gameSettings</span><span class="p">,</span>
        <span class="nx">stager</span><span class="o">:</span> <span class="nx">stager</span>
    <span class="p">};</span>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.parsesettings">
  <h3>
    <a href="#gameloader.parsesettings" name="gameloader.parsesettings" class="pilcrow">&#182;</a>
    GameLoader.parseSettings
  </h3>
</div>

  </div>
  <div class="body"><p>Look up the settings of a game or a level and parses them into treatments</p>

<p>Modifies the values inside the <code>servernode.info.games</code> object.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameName</span>
      <span class="dox_type">string</span>
      <span>The name of the game</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">level</span>
      <span class="dox_type">string</span>
      <span>Optional. The name of the game level</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>settings The parsed settings</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">parseSettings</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">info</span><span class="p">,</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="nx">info</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="nx">gameName</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.parseSettings: game not found&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">info</span> <span class="o">=</span> <span class="nx">info</span><span class="p">.</span><span class="nx">levels</span><span class="p">[</span><span class="nx">level</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">info</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.parseTreatments: level not found&#39;</span><span class="p">,</span> <span class="p">{</span>
                <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Parse settings into treatments.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">settings</span> <span class="o">=</span> <span class="nx">parseGameSettings</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">settings</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.parseSettings: an error occurred while &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;parsing the settings object&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">found</span><span class="o">:</span> <span class="nx">settings</span>
                   <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Replace old settings with parsed ones.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">info</span><span class="p">.</span><span class="nx">settings</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">settings</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadclienttypes">
  <h3>
    <a href="#gameloader.loadclienttypes" name="gameloader.loadclienttypes" class="pilcrow">&#182;</a>
    GameLoader.loadClientTypes
  </h3>
</div>

  </div>
  <div class="body"><p>Loads client types from <em>game/client_types</em> directory</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The path of the game directory</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.addGame
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadClientTypes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">clientTypesDir</span><span class="p">,</span> <span class="nx">fileNames</span><span class="p">,</span> <span class="nx">fileName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clientType</span><span class="p">,</span> <span class="nx">clientTypes</span><span class="p">,</span> <span class="nx">clientTypePath</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">logger</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadClientTypes: directory must be string&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
            <span class="nx">found</span><span class="o">:</span> <span class="nx">directory</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">logger</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">logger</span><span class="p">;</span>

    <span class="nx">clientTypesDir</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;game/client_types/&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">J</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">clientTypesDir</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadClientTypes: directory not found&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
            <span class="nx">found</span><span class="o">:</span> <span class="nx">directory</span><span class="p">,</span>
            <span class="nx">throwIt</span><span class="o">:</span> <span class="kc">false</span>
        <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">fileNames</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">clientTypesDir</span><span class="p">);</span>

    <span class="nx">clientTypes</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">fileNames</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">fileName</span> <span class="o">=</span> <span class="nx">fileNames</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>Ignore non-js files, and temporary and hidden files (begin with '.').</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">extname</span><span class="p">(</span><span class="nx">fileName</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;.js&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">fileName</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">clientTypePath</span> <span class="o">=</span> <span class="nx">clientTypesDir</span> <span class="o">+</span> <span class="nx">fileName</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">statSync</span><span class="p">(</span><span class="nx">clientTypePath</span><span class="p">).</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">try</span> <span class="p">{</span>
                    <span class="nx">clientType</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">clientTypePath</span><span class="p">);</span>
                    <span class="nx">clientTypes</span><span class="p">[</span><span class="nx">fileName</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">)]</span> <span class="o">=</span> <span class="nx">clientType</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadClientTypes: an error &#39;</span> <span class="o">+</span>
                               <span class="s1">&#39;occurred while reading client type: &#39;</span> <span class="o">+</span>
                               <span class="nx">fileName</span><span class="p">,</span> <span class="p">{</span>
                                   <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                                   <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                                   <span class="nx">err</span><span class="o">:</span> <span class="nx">e</span><span class="p">,</span>
                                   <span class="nx">throwErr</span><span class="o">:</span> <span class="kc">true</span>
                               <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Checking if mandatory types are found.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clientTypes</span><span class="p">.</span><span class="nx">logic</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadClientTypes: logic type not found&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span>
        <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">clientTypes</span><span class="p">.</span><span class="nx">player</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadClientTypes: player type not found&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">clientTypes</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.buildlanguagesobject">
  <h3>
    <a href="#gameloader.buildlanguagesobject" name="gameloader.buildlanguagesobject" class="pilcrow">&#182;</a>
    GameLoader.buildLanguagesObject
  </h3>
</div>

  </div>
  <div class="body"><p>Builds an object containing language objects for a given game directory</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The directory of the game.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameName</span>
      <span class="dox_type">string</span>
      <span>The name of the game.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>languages Object of language objects.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">buildLanguagesObject</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">ctxPath</span><span class="p">,</span> <span class="nx">langPaths</span><span class="p">,</span> <span class="nx">languages</span><span class="p">,</span> <span class="nx">languageObject</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">langFile</span><span class="p">;</span>

    <span class="nx">ctxPath</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;/views/contexts/&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">ctxPath</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">langPaths</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">ctxPath</span><span class="p">);</span>
    <span class="nx">languages</span> <span class="o">=</span> <span class="p">{};</span>

    <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">langPaths</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Only directories.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">lstatSync</span><span class="p">(</span><span class="nx">ctxPath</span> <span class="o">+</span> <span class="nx">langPaths</span><span class="p">[</span><span class="nx">i</span><span class="p">]).</span><span class="nx">isDirectory</span><span class="p">())</span> <span class="k">continue</span><span class="p">;</span>

        <span class="nx">languageObject</span> <span class="o">=</span> <span class="p">{};</span>

        <span class="nx">langFile</span> <span class="o">=</span> <span class="nx">ctxPath</span> <span class="o">+</span> <span class="nx">langPaths</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/languageInfo.json&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">langFile</span><span class="p">))</span> <span class="nx">languageObject</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">langFile</span><span class="p">);</span>

        <span class="nx">languageObject</span><span class="p">.</span><span class="nx">shortName</span> <span class="o">=</span> <span class="nx">langPaths</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="nx">languages</span><span class="p">[</span><span class="nx">languageObject</span><span class="p">.</span><span class="nx">shortName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">languageObject</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">languages</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadchanneldir">
  <h3>
    <a href="#gameloader.loadchanneldir" name="gameloader.loadchanneldir" class="pilcrow">&#182;</a>
    GameLoader.loadChannelDir
  </h3>
</div>

  </div>
  <div class="body"><p>Loads several files from <code>channel/</code> dir</p>

<p>Read: <em>channel.settings.js</em>, <em>channel.credentials.js</em>, _channel.secret.js</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The directory of the game.</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameName</span>
      <span class="dox_type">string</span>
      <span>The name of the game.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">ServerChannel</span>
      <span>The created channel.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.loadChannelFile</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadChannelDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">settings</span><span class="p">,</span> <span class="nx">pwdFile</span><span class="p">,</span> <span class="nx">jwtFile</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">channel</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<ol>
<li>Channel settings.</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">settings</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadChannelFile</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Save ref. to newly created channel.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">channels</span><span class="p">[</span><span class="nx">gameName</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<ol>
<li>Credentials.</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">pwdFile</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;channel/channel.credentials.js&#39;</span><span class="p">;</span>

    <span class="nx">loadSyncAsync</span><span class="p">(</span><span class="nx">pwdFile</span><span class="p">,</span> <span class="nx">settings</span><span class="p">,</span> <span class="s1">&#39;loadChannelDir&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">credentials</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>TODO: checkings. Add method.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">channel</span><span class="p">.</span><span class="nx">credentials</span> <span class="o">=</span> <span class="nx">credentials</span><span class="p">;</span>
    <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<ol>
<li>JWT secret.</li>
</ol>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">jwtFile</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;channel/channel.secret.js&#39;</span><span class="p">;</span>

    <span class="nx">loadSyncAsync</span><span class="p">(</span><span class="nx">jwtFile</span><span class="p">,</span> <span class="nx">settings</span><span class="p">,</span> <span class="s1">&#39;loadChannelDir&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">secret</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>TODO: checkings. Add method.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">channel</span><span class="p">.</span><span class="nx">secret</span> <span class="o">=</span> <span class="nx">secret</span><span class="p">;</span>
    <span class="p">});</span>

    <span class="k">return</span> <span class="nx">channel</span><span class="p">;</span>
<span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadchannelfile">
  <h3>
    <a href="#gameloader.loadchannelfile" name="gameloader.loadchannelfile" class="pilcrow">&#182;</a>
    GameLoader.loadChannelFile
  </h3>
</div>

  </div>
  <div class="body"><p>Loads <em>channel.settings.js</em> from file system and adds channels accordingly</p>

<p>Synchronously looks for a file called <em>channel.settings.js</em> at the top
level of the specified directory.</p>

<p>The file <em>channel.settings.js</em> must export one channel object in the
format specified by the <em>ServerChannel</em> constructor. Every channel
configuration object can optionally have a <em>waitingRoom</em> object to
automatically add a waiting room to the channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The directory of the game</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameName</span>
      <span class="dox_type">string</span>
      <span>The name of the game</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createWaitingRoom</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerNode.addChannel
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadChannelFile</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">channelsFile</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">waitRoom</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">channelConf</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">sn</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadChannelFile: directory must be string.&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">found</span><span class="o">:</span> <span class="nx">directory</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">channelsFile</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;/channel/channel.settings.js&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">channelsFile</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">channelConf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">channelsFile</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>Validate</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">channelConf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadChannelFile: channels must be object&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">found</span><span class="o">:</span> <span class="nx">channelConf</span><span class="p">,</span>
            <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
        <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>TODO: check waitingRoom conf removed.
   var waitRoomConf;
   if (channelConf.waitingRoom &amp;&amp;
       'object' !== typeof channelConf.waitingRoom) {</p>


<div class="highlight"><pre><code>   <span class="n">throw</span> <span class="k">new</span> <span class="n">TypeError</span><span class="p">(</span><span class="s">&#39;GameLoader.loadChannelFile: waitingRoom &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;in channel configuration must be object. &#39;</span> <span class="o">+</span>
                       <span class="s">&#39;Directory: &#39;</span> <span class="o">+</span> <span class="n">directory</span><span class="p">);</span>
</code></pre></div>



<p>}
   waitRoomConf = channelConf.waitingRoom;
   delete channelConf.waitingRoom;</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">if</span> <span class="p">(</span><span class="nx">channelConf</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">channelConf</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadChannelFile: name must be &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;string or undefined&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">found</span><span class="o">:</span> <span class="nx">channelConf</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
                           <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
                       <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">channelConf</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">gameName</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">channelConf</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">=</span> <span class="nx">gameName</span><span class="p">;</span>

    <span class="nx">sn</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">;</span>
    <span class="nx">channel</span> <span class="o">=</span> <span class="nx">sn</span><span class="p">.</span><span class="nx">addChannel</span><span class="p">(</span><span class="nx">channelConf</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Add the list of channels created by the game.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">sn</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">games</span><span class="p">[</span><span class="nx">gameName</span><span class="p">].</span><span class="nx">channel</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">player</span><span class="o">:</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">playerServer</span> <span class="o">?</span>
                <span class="nx">channel</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">.</span><span class="nx">endpoint</span> <span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
            <span class="nx">admin</span><span class="o">:</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">adminServer</span> <span class="o">?</span>
                <span class="nx">channel</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">.</span><span class="nx">endpoint</span> <span class="o">:</span> <span class="kc">null</span>
        <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>TODO: check this was removed.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>

<div class="highlight"><pre><code>    <span class="k">if</span> <span class="p">(</span><span class="n">waitRoomConf</span><span class="p">)</span> <span class="p">{</span>

        <span class="sr">//</span> <span class="n">We</span> <span class="n">prepend</span> <span class="n">the</span> <span class="n">baseDir</span> <span class="n">parameter</span><span class="p">,</span> <span class="k">if</span> <span class="n">any</span><span class="o">.</span>
        <span class="sr">//</span> <span class="n">If</span> <span class="n">logicPath</span> <span class="n">is</span> <span class="ow">not</span> <span class="n">string</span> <span class="n">we</span> <span class="n">let</span> <span class="n">the</span> <span class="n">WaitingRoom</span>
        <span class="sr">//</span> <span class="n">constructor</span> <span class="n">throw</span> <span class="n">an</span> <span class="n">error</span><span class="o">.</span>
        <span class="k">if</span> <span class="p">(</span><span class="s">&#39;string&#39;</span> <span class="o">===</span> <span class="n">typeof</span> <span class="n">waitRoomConf</span><span class="o">.</span><span class="n">logicPath</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">waitRoomConf</span><span class="o">.</span><span class="n">logicPath</span> <span class="o">=</span> <span class="n">checkLocalPath</span><span class="p">(</span>
                <span class="n">directory</span><span class="p">,</span> <span class="s">&#39;channel/&#39;</span><span class="p">,</span> <span class="n">waitRoomConf</span><span class="o">.</span><span class="n">logicPath</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">waitRoom</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">createWaitingRoom</span><span class="p">(</span><span class="n">waitRoomConf</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waitRoom</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;GameLoader.loadChannelFile: could &#39;</span> <span class="o">+</span>
                            <span class="s">&#39;not add waiting room to channel &#39;</span> <span class="o">+</span>
                            <span class="n">channel</span><span class="o">.</span><span class="n">name</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Adding channel alias.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">channelConf</span><span class="p">.</span><span class="nx">alias</span><span class="p">)</span> <span class="nx">sn</span><span class="p">.</span><span class="nx">createGameAlias</span><span class="p">(</span><span class="nx">channelConf</span><span class="p">.</span><span class="nx">alias</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">);</span>

    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>Errors in channel creation are already logged.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">return</span> <span class="nx">channelConf</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.buildwaitroomconf">
  <h3>
    <a href="#gameloader.buildwaitroomconf" name="gameloader.buildwaitroomconf" class="pilcrow">&#182;</a>
    GameLoader.buildWaitRoomConf
  </h3>
</div>

  </div>
  <div class="body"><p>Loads <em>waitroom/room.settings.js</em> from file system, checks it and returns it</p>

<p>Synchronously looks for a file called <em>waitroom/room.settings.js</em> at the top
level of the specified directory.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The directory of the game</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channel</span>
      <span class="dox_type">ServerChannel</span>
      <span>The channel object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>conf The waiting room configuration</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createWaitingRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">buildWaitRoomConf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">waitRoomSettingsFile</span><span class="p">,</span> <span class="nx">waitRoomFile</span><span class="p">,</span> <span class="nx">conf</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildWaitRoomConf: directory must be &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">found</span><span class="o">:</span> <span class="nx">directory</span><span class="p">,</span>
                       <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
                   <span class="p">});</span>
    <span class="p">}</span>

    <span class="nx">waitRoomSettingsFile</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;waitroom/waitroom.settings.js&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">waitRoomSettingsFile</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildWaitRoomConf: file waitroom.settings &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;not found&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">log</span><span class="o">:</span> <span class="s1">&#39;warn&#39;</span>
                  <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">conf</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">waitRoomSettingsFile</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildWaitRoomConf: error reading &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;waitroom.settings file&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">err</span><span class="o">:</span> <span class="nx">e</span><span class="p">,</span>
                       <span class="nx">throwErr</span><span class="o">:</span> <span class="kc">true</span>
                  <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildWaitRoomConf: room.settings file &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;must return a configuration object&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">found</span><span class="o">:</span> <span class="nx">conf</span><span class="p">,</span>
                       <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
                   <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">conf</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildWaitRoomConf: configuration &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;loaded, but &quot;logicPath&quot; must be undefined or string&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">found</span><span class="o">:</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">,</span>
                           <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
                       <span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">conf</span><span class="p">.</span><span class="nx">logicPath</span> <span class="o">=</span> <span class="nx">checkLocalPath</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="s1">&#39;waitroom/&#39;</span><span class="p">,</span> <span class="nx">conf</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">waitRoomFile</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;waitroom/waitroom.js&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">waitRoomFile</span><span class="p">))</span> <span class="p">{</span>
            <span class="nx">conf</span><span class="p">.</span><span class="nx">logicPath</span> <span class="o">=</span> <span class="nx">waitRoomFile</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">conf</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadwaitroomdir">
  <h3>
    <a href="#gameloader.loadwaitroomdir" name="gameloader.loadwaitroomdir" class="pilcrow">&#182;</a>
    GameLoader.loadWaitRoomDir
  </h3>
</div>

  </div>
  <div class="body"><p>Loads the waiting room configuration and creates the object in channel</p>

<p>Synchronously looks for a file called <em>waitroom/room.settings.js</em> at the top
level of the specified directory.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The directory of the game</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channel</span>
      <span class="dox_type">ServerChannel</span>
      <span>The channel object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">WaitingRoom</span>
      <span>waitRoom The created waiting room</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.buildWaitRoomConf</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createWaitingRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadWaitRoomDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">waitRoom</span><span class="p">;</span>
    <span class="nx">conf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildWaitRoomConf</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">channel</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>Add waiting room information to global game object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateGameInfo</span><span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span><span class="p">,</span> <span class="p">{</span> <span class="nx">waitroom</span><span class="o">:</span> <span class="nx">conf</span> <span class="p">});</span>
    <span class="nx">waitRoom</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">createWaitingRoom</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">waitRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadWaitRoomDir: could not create &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;waiting room. Game: &#39;</span> <span class="o">+</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">waitRoom</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadauthdir">
  <h3>
    <a href="#gameloader.loadauthdir" name="gameloader.loadauthdir" class="pilcrow">&#182;</a>
    GameLoader.loadAuthDir
  </h3>
</div>

  </div>
  <div class="body"><p>Reads the <code>auth/</code> directory and imports settings from it</p>

<p>If a function is found in <code>auth/auth.js</code> it calls it with an object
containing a sandboxed environment for authorization, clientId
generation and clientObject decoration.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">file</span>
      <span class="dox_type">string</span>
      <span>The path to the configuration file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channel</span>
      <span class="dox_type">ServerChannel</span>
      <span>The channel object</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">importAuthCodes</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.getChannelSandbox
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadAuthDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">authDir</span><span class="p">,</span> <span class="nx">authFile</span><span class="p">,</span> <span class="nx">authSettingsFile</span><span class="p">,</span> <span class="nx">authCodesFile</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">settings</span><span class="p">,</span> <span class="nx">codes</span><span class="p">,</span> <span class="nx">asyncCodes</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">authObj</span><span class="p">,</span> <span class="nx">sandboxAuth</span><span class="p">,</span> <span class="nx">sandboxIdGen</span><span class="p">,</span> <span class="nx">sandboxDecorate</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gameName</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">logger</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: directory must be &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;string.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>
    <span class="nx">logger</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">logger</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<p>Check if directory exists.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;auth/&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: channel &#39;</span> <span class="o">+</span> <span class="nx">gameName</span> <span class="o">+</span>
                    <span class="s1">&#39;: no auth directory.&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Add information to global game object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">updateGameInfo</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="p">{</span> <span class="nx">auth</span><span class="o">:</span> <span class="p">{</span> <span class="nx">enabled</span><span class="o">:</span> <span class="kc">false</span> <span class="p">}</span> <span class="p">});</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">authDir</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;auth/&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>Auth settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">authSettingsFile</span> <span class="o">=</span> <span class="nx">authDir</span> <span class="o">+</span> <span class="s1">&#39;auth.settings.js&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">authSettingsFile</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;auto&#39;</span><span class="p">,</span>
            <span class="nx">codes</span><span class="o">:</span> <span class="s1">&#39;auth.codes&#39;</span>
        <span class="p">};</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: channel&#39;</span> <span class="o">+</span> <span class="nx">gameName</span> <span class="o">+</span>
                    <span class="s1">&#39;: no auth settings. Default settings used.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">settings</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">authSettingsFile</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: cannot read &#39;</span> <span class="o">+</span>
                            <span class="nx">authSettingsFile</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: invalid settings file: &#39;</span> <span class="o">+</span>
                            <span class="nx">authSettingsFile</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Enable authorization by default.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Add waiting room information to global game object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateGameInfo</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="p">{</span> <span class="nx">auth</span><span class="o">:</span> <span class="nx">settings</span> <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<p>Exit here if auth is disabled.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: channel &#39;</span> <span class="o">+</span> <span class="nx">gameName</span> <span class="o">+</span>
                    <span class="s1">&#39;: authorization disabled in configuration file.&#39;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>Auth codes. Can be synchronous or asynchronous.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>Transform relative to absolute paths.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">codes</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">path</span><span class="p">.</span><span class="nx">isAbsolute</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">codes</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">codes</span> <span class="o">=</span> <span class="nx">authDir</span> <span class="o">+</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">codes</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">codes</span> <span class="o">=</span> <span class="nx">ngt</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;auth/auth.codes.js&#39;</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<p>TODO: only with custom auth.codes.js.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">codes</span><span class="p">))</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>Inject authDir into settings (will be removed by importAuthCodes).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">authDir</span> <span class="o">=</span> <span class="nx">authDir</span><span class="p">;</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">codes</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">codes</span><span class="p">)(</span><span class="nx">settings</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">codes</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: an error &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;occurred: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">importAuthCodes</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">codes</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">asyncCodes</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">channel</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">asyncQueue</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">asyncCodes</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: an error occurred &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;trying to import the codes:&#39;</span> <span class="o">+</span> <span class="s2">&quot;\n&quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">codes</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">importAuthCodes</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">codes</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">asyncCodes</span> <span class="o">=</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;_codes&#39;</span><span class="p">;</span>
            <span class="nx">channel</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">asyncQueue</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">asyncCodes</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Auth file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<p>TODO: do we still need this sandbox? Do we need another file?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">authFile</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;auth/auth.js&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">authFile</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">sandboxAuth</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getChannelSandbox</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="s1">&#39;authorization&#39;</span><span class="p">);</span>
        <span class="nx">sandboxIdGen</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getChannelSandbox</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="s1">&#39;clientIdGenerator&#39;</span><span class="p">);</span>
        <span class="nx">sandboxDecorate</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">getChannelSandbox</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="s1">&#39;clientObjDecorator&#39;</span><span class="p">);</span>

        <span class="nx">authObj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">authorization</span><span class="o">:</span> <span class="nx">sandboxAuth</span><span class="p">,</span>
            <span class="nx">clientIdGenerator</span><span class="o">:</span> <span class="nx">sandboxIdGen</span><span class="p">,</span>
            <span class="nx">clientObjDecorator</span><span class="o">:</span> <span class="nx">sandboxDecorate</span>
        <span class="p">};</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">require</span><span class="p">(</span><span class="nx">authFile</span><span class="p">)(</span><span class="nx">authObj</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadAuthDir: cannot read &#39;</span> <span class="o">+</span>
                            <span class="nx">authFile</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.buildrequirementsconf">
  <h3>
    <a href="#gameloader.buildrequirementsconf" name="gameloader.buildrequirementsconf" class="pilcrow">&#182;</a>
    GameLoader.buildRequirementsConf
  </h3>
</div>

  </div>
  <div class="body"><p>Reads the <code>requirements/</code> directory and imports settings from it</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">file</span>
      <span class="dox_type">string</span>
      <span>The path to the configuration file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channel</span>
      <span class="dox_type">ServerChannel</span>
      <span>The channel object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">RequirementsRoom</span>
      <span>The requirements room (if one is created)</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.buildRequirementsConf</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.createRequirementsRoom
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">buildRequirementsConf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span>
                                                      <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">settingsFile</span><span class="p">,</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">reqFunc</span><span class="p">,</span> <span class="nx">reqObj</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">directory</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildRequirementsConf: directory must be &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">found</span><span class="o">:</span> <span class="nx">directory</span><span class="p">,</span>
                       <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;type&#39;</span>
                   <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;requirements/&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildRequirementsConf: no requirements &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">log</span><span class="o">:</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span>
                       <span class="nx">throwIt</span><span class="o">:</span> <span class="kc">false</span>
                   <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Add information to global game object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">return</span> <span class="p">{</span> <span class="nx">enabled</span><span class="o">:</span> <span class="kc">false</span> <span class="p">};</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<p>Requirements settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">settingsFile</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;requirements/requirements.settings.js&#39;</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">settingsFile</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">enabled</span><span class="o">:</span> <span class="kc">true</span> <span class="p">};</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildRequirementsConf: no settings file &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;found. Default settings used&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">log</span><span class="o">:</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span>
                       <span class="nx">throwIt</span><span class="o">:</span> <span class="kc">false</span>
                   <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">else</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">settings</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">settingsFile</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildRequirementsConf: an error occurred &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;while reading settings file&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">err</span><span class="o">:</span> <span class="nx">e</span>
                       <span class="p">});</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildRequirementsConf: invalid &#39;</span> <span class="o">+</span>
                       <span class="s1">&#39;settings file&#39;</span><span class="p">,</span> <span class="p">{</span>
                           <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                           <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                           <span class="nx">found</span><span class="o">:</span> <span class="nx">settings</span>
                       <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p>We prepend the baseDir parameter, if any.
If logicPath is not string RequirementsRoom constructor throws an error.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">settings</span><span class="p">.</span><span class="nx">logicPath</span> <span class="o">=</span> <span class="nx">checkLocalPath</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="s1">&#39;requirements/&#39;</span><span class="p">,</span>
                                            <span class="nx">settings</span><span class="p">.</span><span class="nx">logicPath</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<p>Enable requirements by default.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p>Exit here if requirements is disabled.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settings</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildRequirementsConf: requirements checking &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;disabled in configuration file&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">log</span><span class="o">:</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span>
                       <span class="nx">throwIt</span><span class="o">:</span> <span class="kc">false</span>
                   <span class="p">});</span>

        <span class="k">return</span> <span class="nx">settings</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<p>Requirements file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">file</span> <span class="o">=</span> <span class="nx">directory</span> <span class="o">+</span> <span class="s1">&#39;requirements/requirements.js&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">file</span> <span class="o">=</span> <span class="nx">ngt</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="s1">&#39;requirements/requirements.js&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">reqObj</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">reqFunc</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RequirementsSandbox</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">reqObj</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p>TODO: move try-catch in self-exec function?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">require</span><span class="p">(</span><span class="nx">file</span><span class="p">)(</span><span class="nx">reqFunc</span><span class="p">,</span> <span class="nx">settings</span><span class="p">);</span>
        <span class="nx">reqObj</span><span class="p">.</span><span class="nx">enabled</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">doErr</span><span class="p">(</span><span class="s1">&#39;GameLoader.buildRequirementsConf: an error occurred &#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;while trying to execute requirements file&#39;</span><span class="p">,</span> <span class="p">{</span>
                       <span class="nx">game</span><span class="o">:</span> <span class="nx">gameName</span><span class="p">,</span>
                       <span class="nx">level</span><span class="o">:</span> <span class="nx">level</span><span class="p">,</span>
                       <span class="nx">err</span><span class="o">:</span> <span class="nx">e</span>
                   <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<p>Return final settings.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">J</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">settings</span><span class="p">,</span> <span class="nx">reqObj</span><span class="p">);</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadrequirementsdir">
  <h3>
    <a href="#gameloader.loadrequirementsdir" name="gameloader.loadrequirementsdir" class="pilcrow">&#182;</a>
    GameLoader.loadRequirementsDir
  </h3>
</div>

  </div>
  <div class="body"><p>Loads the requirements room configuration and creates the object in channel</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">file</span>
      <span class="dox_type">string</span>
      <span>The path to the configuration file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channel</span>
      <span class="dox_type">ServerChannel</span>
      <span>The channel object</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">RequirementsRoom</span>
      <span>The requirements room (if one is created)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">loadRequirementsDir</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">conf</span><span class="p">,</span> <span class="nx">reqRoom</span><span class="p">;</span>
    <span class="nx">conf</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">buildRequirementsConf</span><span class="p">(</span><span class="nx">directory</span><span class="p">,</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<p>Add waiting room information to global game object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">updateGameInfo</span><span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span><span class="p">,</span> <span class="p">{</span> <span class="nx">requirements</span><span class="o">:</span> <span class="nx">conf</span> <span class="p">});</span>
    <span class="nx">reqRoom</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">createRequirementsRoom</span><span class="p">(</span><span class="nx">conf</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">reqRoom</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.loadRequirementsRoomDir: could not &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;create requirements room. Game: &#39;</span> <span class="o">+</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">+</span>
                        <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">reqRoom</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>TODO: see if we want to add it to prototype.
Else remove getChannelSandbox also (maybe).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">function</span> <span class="nx">RequirementsSandbox</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">requirementsObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">errBegin</span><span class="p">;</span>
    <span class="nx">errBegin</span> <span class="o">=</span> <span class="s1">&#39;GameLoader.loadRequirementsDir: &#39;</span> <span class="o">+</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;: &#39;</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">errBegin</span> <span class="o">+</span> <span class="s1">&#39;requirement must be function. &#39;</span> <span class="o">+</span>
                               <span class="s1">&#39;Found: &#39;</span> <span class="o">+</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">requirementsObj</span><span class="p">.</span><span class="nx">requirements</span><span class="p">)</span> <span class="nx">requirementsObj</span><span class="p">.</span><span class="nx">requirements</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="nx">requirementsObj</span><span class="p">.</span><span class="nx">requirements</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="nx">cb</span><span class="o">:</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">params</span><span class="o">:</span> <span class="nx">params</span> <span class="p">});</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onSuccess</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">errBegin</span> <span class="o">+</span> <span class="s1">&#39;onSuccess callback must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function. Found: &#39;</span> <span class="o">+</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">requirementsObj</span><span class="p">.</span><span class="nx">onSuccess</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">onFailure</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">errBegin</span> <span class="o">+</span> <span class="s1">&#39;onFailure callback must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function. Found: &#39;</span> <span class="o">+</span> <span class="nx">cb</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">requirementsObj</span><span class="p">.</span><span class="nx">onFailure</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setMaxExecutionTime</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">maxTime</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;number&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">maxTime</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">errBegin</span> <span class="o">+</span> <span class="s1">&#39;max execution time must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;number. Found: &#39;</span> <span class="o">+</span> <span class="nx">maxTime</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">requirementsObj</span><span class="p">.</span><span class="nx">maxExecTime</span> <span class="o">=</span> <span class="nx">maxTime</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gameName</span> <span class="o">=</span> <span class="nx">gameName</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.getchannelsandbox">
  <h3>
    <a href="#gameloader.getchannelsandbox" name="gameloader.getchannelsandbox" class="pilcrow">&#182;</a>
    GameLoader.getChannelSandbox
  </h3>
</div>

  </div>
  <div class="body"><p>Returns a sandbox function to configure a channel</p>

<p>The sandbox is a callback that accepts 1 or 2 parameters, the last
one must be a callback and the first one is the name of the server
('player' or 'admin') to which the callback should be applied
to. If only the callback is provided, then it is applied to both
'player' and 'admin' servers.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channelName</span>
      <span class="dox_type">string</span>
      <span>The name of the game</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">method</span>
      <span class="dox_type">string</span>
      <span>The name of the method in ServerChannel</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">methodName</span>
      <span class="dox_type">string</span>
      <span>Optional The name of the method as diplayed in
  error messages.</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">function</span>
      <span>The sandbox</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.loadAuthDir</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.getChannelSandbox
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getChannelSandbox</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">methodName</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">channelName</span><span class="p">;</span>

    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">channelName</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
    <span class="nx">methodName</span> <span class="o">=</span> <span class="nx">methodName</span> <span class="o">||</span> <span class="nx">method</span><span class="p">;</span>

    <span class="k">return</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">len</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">callback</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">errorBegin</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">servernode</span><span class="p">;</span>

        <span class="nx">servernode</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">servernode</span><span class="p">;</span>

        <span class="nx">errorBegin</span> <span class="o">=</span> <span class="s1">&#39;GameLoader.loadAuthDir: &#39;</span> <span class="o">+</span> <span class="nx">methodName</span> <span class="o">+</span> <span class="s1">&#39; callback: &#39;</span><span class="p">;</span>

        <span class="nx">len</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">errorBegin</span> <span class="o">+</span>
                            <span class="s1">&#39;accepts maximum 2 input parameters, &#39;</span> <span class="o">+</span>
                            <span class="nx">len</span> <span class="o">+</span> <span class="s1">&#39; given. Game: &#39;</span> <span class="o">+</span> <span class="nx">channelName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nx">callback</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">len</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">errorBegin</span> <span class="o">+</span> <span class="s1">&#39;last parameter must be &#39;</span> <span class="o">+</span>
                                <span class="s1">&#39;function. Game: &#39;</span> <span class="o">+</span> <span class="nx">channelName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>Channels defined by a game with the channels.js file.
Auth callback can modify the authorization only of those.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>1 Auth for both admin and player servers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">len</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">channel</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">[</span><span class="nx">method</span><span class="p">](</span><span class="nx">callback</span><span class="p">);</span>
            <span class="nx">channel</span><span class="p">.</span><span class="nx">playerServer</span><span class="p">[</span><span class="nx">method</span><span class="p">](</span><span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>1 Auth for one server: admin or player.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">else</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;admin&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;player&#39;</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">errorBegin</span> <span class="o">+</span> <span class="s1">&#39;server parameter must &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;be either &quot;player&quot; or &quot;admin&quot;. &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;Given: &#39;</span> <span class="o">+</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;. &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;Game: &#39;</span> <span class="o">+</span> <span class="nx">channelName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">channel</span><span class="p">[</span><span class="nx">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;Server&#39;</span><span class="p">][</span><span class="nx">method</span><span class="p">](</span><span class="nx">callback</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.updategameinfo">
  <h3>
    <a href="#gameloader.updategameinfo" name="gameloader.updategameinfo" class="pilcrow">&#182;</a>
    GameLoader.updateGameInfo
  </h3>
</div>

  </div>
  <div class="body"><p>Updates information about an existing game</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameName</span>
      <span class="dox_type">string</span>
      <span>The name of the game</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">level</span>
      <span class="dox_type">string</span>
      <span>Optional. The name of the level to update. If not
   existing it will be added. Important. This parameter can be omitted</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">update</span>
      <span class="dox_type">object</span>
      <span>An object containing properties to mixin.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">updateGameInfo</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">gameInfo</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">level</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">update</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>3 or more.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">level</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">update</span> <span class="o">=</span> <span class="nx">arguments</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">gameName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameLoader.updateGameInfo: gameName must &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;be string. Found: &#39;</span> <span class="o">+</span> <span class="nx">gameName</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">update</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameLoader.updateGameInfo: update must &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;be object. Found: &#39;</span> <span class="o">+</span> <span class="nx">update</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;string&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameLoader.updateGameInfo: level must &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;be string or undefined. Found: &#39;</span> <span class="o">+</span> <span class="nx">level</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">gameInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">getGamesInfo</span><span class="p">(</span><span class="nx">gameName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gameInfo</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.updateGameInfo: game not found: &#39;</span> <span class="o">+</span>
                        <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">gameInfo</span><span class="p">,</span> <span class="nx">update</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">levels</span><span class="p">[</span><span class="nx">level</span><span class="p">])</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">levels</span><span class="p">[</span><span class="nx">level</span><span class="p">]</span> <span class="o">=</span> <span class="nx">update</span><span class="p">;</span>
        <span class="k">else</span> <span class="nx">J</span><span class="p">.</span><span class="nx">mixin</span><span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">levels</span><span class="p">[</span><span class="nx">level</span><span class="p">],</span> <span class="nx">update</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">gameInfo</span><span class="p">;</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<p>/**
 * ### GameLoader.createGameAlias
 *
 * Adds one or multiple game alias
 *
 * Adds references into the <code>info.games</code> and <code>resourceManager.games</code> objects.
 *
 * @param {string} alias The name of the alias
 * @param {string} gameName The name of the game
 *
 * @see GameLoader.addGame
 * @see ServerChannel.resourceManager
 */
GameLoader.prototype.createGameAlias = function(alias, gameName) {
    var servernode, gameInfo;
    var i, len;</p>


<div class="highlight"><pre><code><span class="k">if</span> <span class="p">(</span><span class="s">&#39;string&#39;</span> <span class="o">===</span> <span class="n">typeof</span> <span class="n">alias</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">alias</span> <span class="o">=</span> <span class="p">[</span><span class="n">alias</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">J</span><span class="o">.</span><span class="n">isArray</span><span class="p">(</span><span class="n">alias</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">throw</span> <span class="k">new</span> <span class="n">TypeError</span><span class="p">(</span><span class="s">&#39;GameLoader.createGameAlias: alias&#39;</span> <span class="o">+</span>
                        <span class="s">&#39;must be either string or array.&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">if</span> <span class="p">(</span><span class="s">&#39;string&#39;</span> <span class="o">!==</span> <span class="n">typeof</span> <span class="n">gameName</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">throw</span> <span class="k">new</span> <span class="n">TypeError</span><span class="p">(</span><span class="s">&#39;GameLoader.createGameAlias: gameName must be &#39;</span> <span class="o">+</span>
                        <span class="s">&#39;string.&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">servernode</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">servernode</span><span class="p">;</span>
<span class="n">gameInfo</span> <span class="o">=</span> <span class="n">servernode</span><span class="o">.</span><span class="n">getGamesInfo</span><span class="p">(</span><span class="n">gameName</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gameInfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">throw</span> <span class="k">new</span> <span class="n">Error</span><span class="p">(</span><span class="s">&#39;GameLoader.createGameAlias: game not found: &#39;</span> <span class="o">+</span>
                    <span class="n">gameName</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">len</span> <span class="o">=</span> <span class="n">alias</span><span class="o">.</span><span class="nb">length</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
</code></pre></div>



<p>//         if ('string' !== typeof alias[i]) {
//             throw new TypeError(
//                 'GameLoader.createGameAlias: alias must be string.');
//         }
//         if (servernode.info.games[alias[i]]) {
//             throw new Error('GameLoader.createGameAlias: ' +
//                             'alias must be unique: ' + alias[i] +
//                             ' (' + gameName + ').');
//         }
//
//         // TODO: do not add aliases to the info.games object.
//         // (we need to make sure aliases do not clash).
//         servernode.info.games[alias[i]] = servernode.info.games[gameName];
//         servernode.resourceManager.createAlias(alias[i], gameName);
//         gameInfo.alias.push(alias[i]);</p>


<div class="highlight"><pre><code><span class="p">}</span>
</code></pre></div>



<p>};</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.doerr">
  <h3>
    <a href="#gameloader.doerr" name="gameloader.doerr" class="pilcrow">&#182;</a>
    GameLoader.doErr
  </h3>
</div>

  </div>
  <div class="body"><p>Throws and/or logs an error happened while loading a game</p>

<p>Adds automatically useful information such as game name, or level name.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">msg</span>
      <span class="dox_type">string</span>
      <span>The error message</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">opts</span>
      <span class="dox_type">object</span>
      <span>Optional. Options to build and handle the error.
   Available options:


<div class="highlight"><pre><code> <span class="o">-</span> <span class="n">game:</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">game</span> <span class="n">where</span> <span class="n">the</span> <span class="n">error</span> <span class="n">happened</span><span class="p">;</span>
 <span class="o">-</span> <span class="n">level:</span> <span class="n">the</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">gameLevel</span> <span class="n">where</span> <span class="n">the</span> <span class="n">error</span> <span class="n">happened</span><span class="p">;</span>
 <span class="o">-</span> <span class="n">found:</span> <span class="n">an</span> <span class="n">invalid</span> <span class="n">value</span> <span class="n">found</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">the</span> <span class="n">expected</span> <span class="n">one</span><span class="p">;</span>
 <span class="o">-</span> <span class="nb">log</span><span class="p">:</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">message</span> <span class="n">will</span> <span class="n">be</span> <span class="n">logged</span>
 <span class="o">-</span> <span class="n">err:</span> <span class="n">an</span> <span class="n">Error</span> <span class="n">object</span> <span class="n">to</span> <span class="k">print</span> <span class="n">the</span> <span class="n">stack</span> <span class="n">of</span>
 <span class="o">-</span> <span class="n">throwErr:</span> <span class="k">if</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">err</span> <span class="n">value</span> <span class="n">will</span> <span class="n">be</span> <span class="n">thrown</span> <span class="n">instead</span>
 <span class="o">-</span> <span class="n">throwIt:</span> <span class="k">if</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">the</span> <span class="n">error</span> <span class="n">will</span> <span class="n">NOT</span> <span class="n">be</span> <span class="n">thrown</span>
 <span class="o">-</span> <span class="n">type:</span> <span class="n">the</span> <span class="n">type</span> <span class="n">of</span> <span class="n">error</span> <span class="n">to</span> <span class="n">throw</span><span class="o">.</span> <span class="p">(</span><span class="s">&#39;type&#39;</span> <span class="k">for</span> <span class="n">TypeError</span><span class="p">)</span>
</code></pre></div>

</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameLoader</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doErr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">game</span><span class="p">)</span> <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;. Game: &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">game</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;. Level: &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">level</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">found</span><span class="p">)</span> <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;. Found: &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">found</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="nx">msg</span> <span class="o">+=</span> <span class="s1">&#39;. Err:\n&#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">log</span> <span class="o">!==</span> <span class="kc">false</span> <span class="o">&amp;&amp;</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">log</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">log</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">log</span> <span class="o">===</span> <span class="s1">&#39;err&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">log</span> <span class="o">===</span> <span class="s1">&#39;warn&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.doErr: invalid value for opts.log: &#39;</span> <span class="o">+</span>
                            <span class="nx">opts</span><span class="p">.</span><span class="nx">log</span> <span class="o">+</span> <span class="s1">&#39;. Msg: &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">throwErr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.doErr: throwErr is true, but no &#39;</span> <span class="o">+</span>
                            <span class="s1">&#39;error given. Msg: &#39;</span> <span class="o">+</span> <span class="nx">msg</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">throw</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">err</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">throwIt</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">errType</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">errType</span> <span class="o">===</span> <span class="s1">&#39;type&#39;</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.doErr: unknown type: &#39;</span> <span class="o">+</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">errType</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods">
  <h2>
    <a href="#helper%20methods" name="helper%20methods" class="pilcrow">&#182;</a>
    Helper methods
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="checklocalpath">
  <h3>
    <a href="#checklocalpath" name="checklocalpath" class="pilcrow">&#182;</a>
    checkLocalPath
  </h3>
</div>

  </div>
  <div class="body"><p>Helper function to specify full path in a game subdir</p>

<p>Checks if the file starts with './' and, if so, adds the absolute path
to the game directory in front.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameDir</span>
      <span class="dox_type">string</span>
      <span>The absolute path of the game directory</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">subDir</span>
      <span class="dox_type">string</span>
      <span>The name of the game sub directory</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">filePath</span>
      <span class="dox_type">string</span>
      <span>The path of the file in the sub directory</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The updated file path (if local)</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">checkLocalPath</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">subDir</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">filePath</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;./&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">gameDir</span><span class="p">,</span> <span class="nx">subDir</span><span class="p">,</span> <span class="nx">filePath</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">filePath</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="version2gamestage">
  <h3>
    <a href="#version2gamestage" name="version2gamestage" class="pilcrow">&#182;</a>
    version2GameStage
  </h3>
</div>

  </div>
  <div class="body"><p>Helper function to parse a version string into a GameStage</p>

<p>Cannot use GameStage constructor because it does not accept stage = 0
Adds always +1 to every component (stage, step, round),
so that GameStage.compare does not complain.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">str</span>
      <span class="dox_type">string</span>
      <span>The version number to parse</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameStage constructor
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">version2GameStage</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">round</span><span class="p">;</span>
    <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">trim</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">);</span>
    <span class="nx">stage</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">stage</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">step</span>  <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">step</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">round</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">round</span><span class="p">))</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">stage</span><span class="o">:</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">step</span><span class="o">:</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">round</span><span class="o">:</span> <span class="nx">round</span>
    <span class="p">};</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gamerequirementsfail">
  <h3>
    <a href="#gamerequirementsfail" name="gamerequirementsfail" class="pilcrow">&#182;</a>
    gameRequirementsFail
  </h3>
</div>

  </div>
  <div class="body"><p>Helper function that checks if game requirements are fullfilled</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">mixed</span>
      <span>The game requirements from <code>package.json</code></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE, if check fails</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameStage constructor
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">gameRequirementsFail</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">reqFail</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101">&#182;</a>
</div>
<ul>
<li>skips the check.</li>
</ul>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<p>Trick: we compare version numbers using the GameStage class.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">req</span> <span class="o">=</span> <span class="nx">version2GameStage</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
        <span class="nx">reqFail</span> <span class="o">=</span> <span class="o">!</span><span class="nx">req</span> <span class="o">||</span> <span class="nx">GameStage</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">serverVersionObj</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">req</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
        <span class="nx">req</span> <span class="o">=</span> <span class="nx">version2GameStage</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
        <span class="nx">reqFail</span> <span class="o">=</span> <span class="o">!</span><span class="nx">req</span> <span class="o">||</span> <span class="nx">GameStage</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">serverVersionObj</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">req</span> <span class="o">=</span> <span class="nx">version2GameStage</span><span class="p">(</span><span class="nx">req</span><span class="p">);</span>
        <span class="nx">reqFail</span> <span class="o">=</span> <span class="o">!</span><span class="nx">req</span> <span class="o">||</span> <span class="nx">GameStage</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">serverVersionObj</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">reqFail</span><span class="p">;</span>
<span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="parsegamesettings">
  <h3>
    <a href="#parsegamesettings" name="parsegamesettings" class="pilcrow">&#182;</a>
    parseGameSettings
  </h3>
</div>

  </div>
  <div class="body"><p>Parses a game settings object and builds the treatments object</p>

<p>If no <code>treatments</code> property is defined, one is created with one entry
named 'standard'.</p>

<p>All properties of the 'standard' treatment are shared with the other
settings.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">game</span>
      <span class="dox_type">object</span>
      <span>The path to a package.json file,
  or its content as loaded from <code>require</code></span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>out The parsed settings object containing treatments</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.addGame
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">parseGameSettings</span><span class="p">(</span><span class="nx">settingsObj</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">standard</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">treatments</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;object&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">settingsObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;parseGameSettings: settingsObj must be object.&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">out</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">standard</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">settingsObj</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">settingsObj</span><span class="p">.</span><span class="nx">treatments</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">standard</span> <span class="o">=</span> <span class="nx">standard</span><span class="p">;</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">standard</span><span class="p">.</span><span class="nx">treatmentName</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span><span class="p">;</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">standard</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">treatments</span> <span class="o">=</span> <span class="nx">settingsObj</span><span class="p">.</span><span class="nx">treatments</span><span class="p">;</span>
        <span class="k">delete</span> <span class="nx">standard</span><span class="p">.</span><span class="nx">treatments</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">t</span> <span class="k">in</span> <span class="nx">treatments</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">treatments</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">t</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">out</span><span class="p">[</span><span class="nx">t</span><span class="p">]</span> <span class="o">=</span> <span class="nx">J</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span><span class="nx">standard</span><span class="p">,</span> <span class="nx">treatments</span><span class="p">[</span><span class="nx">t</span><span class="p">]);</span>
                <span class="nx">out</span><span class="p">[</span><span class="nx">t</span><span class="p">].</span><span class="nx">treatmentName</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
                <span class="nx">out</span><span class="p">[</span><span class="nx">t</span><span class="p">].</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">t</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">loadSyncAsync</span><span class="p">(</span><span class="nx">filepath</span><span class="p">,</span> <span class="nx">settings</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">existsSync</span><span class="p">(</span><span class="nx">filepath</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="nx">result</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">filepath</span><span class="p">)(</span><span class="nx">settings</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: an error &#39;</span> <span class="o">+</span>
                                    <span class="s1">&#39;occurred: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="nx">cb</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;GameLoader.&#39;</span> <span class="o">+</span> <span class="nx">method</span> <span class="o">+</span> <span class="s1">&#39;: cannot read &#39;</span> <span class="o">+</span>
                            <span class="nx">filepath</span> <span class="o">+</span> <span class="s2">&quot;: \n&quot;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="importauthcodes">
  <h3>
    <a href="#importauthcodes" name="importauthcodes" class="pilcrow">&#182;</a>
    importAuthCodes
  </h3>
</div>

  </div>
  <div class="body"><p>Imports an array of authorization codes into the channel registry</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channel</span>
      <span class="dox_type">ServerChannel</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">codes</span>
      <span class="dox_type">array</span>
      <span>The array of codes</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">settings</span>
      <span class="dox_type">object</span>
      <span>The auth settings</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">GameLoader.loadAuthDir
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">importAuthCodes</span><span class="p">(</span><span class="nx">channel</span><span class="p">,</span> <span class="nx">codes</span><span class="p">,</span> <span class="nx">settings</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">authDir</span><span class="p">,</span> <span class="nx">outFile</span><span class="p">,</span> <span class="nx">outFileBak</span><span class="p">;</span>

    <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">importClients</span><span class="p">(</span><span class="nx">codes</span><span class="p">);</span>

    <span class="nx">authDir</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">authDir</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">dumpCodes</span> <span class="o">!==</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">outFile</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">outFile</span> <span class="o">||</span> <span class="s1">&#39;codes.imported.csv&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">path</span><span class="p">.</span><span class="nx">isAbsolute</span><span class="p">(</span><span class="nx">outFile</span><span class="p">))</span> <span class="nx">outFile</span> <span class="o">=</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">authDir</span> <span class="o">+</span> <span class="nx">outFile</span><span class="p">;</span>
        <span class="nx">outFileBak</span> <span class="o">=</span> <span class="nx">outFile</span> <span class="o">+</span> <span class="s1">&#39;.bak&#39;</span><span class="p">;</span>

        <span class="nx">fs</span><span class="p">.</span><span class="nx">rename</span><span class="p">(</span><span class="nx">outFile</span><span class="p">,</span> <span class="nx">outFileBak</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">NDDB</span><span class="p">,</span> <span class="nx">db</span><span class="p">;</span>
            <span class="nx">NDDB</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;NDDB&#39;</span><span class="p">).</span><span class="nx">NDDB</span><span class="p">;</span>
            <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">NDDB</span><span class="p">();</span>
            <span class="nx">db</span><span class="p">.</span><span class="nx">importDB</span><span class="p">(</span><span class="nx">codes</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>Async function. Throws errors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">db</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">outFile</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>Not needed anymore.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">delete</span> <span class="nx">settings</span><span class="p">.</span><span class="nx">authDir</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<p>TODO: see if we need it in the future:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.loadviewsfile">
  <h3>
    <a href="#gameloader.loadviewsfile" name="gameloader.loadviewsfile" class="pilcrow">&#182;</a>
    GameLoader.loadViewsFile
  </h3>
</div>

  </div>
  <div class="body"><p>Loads <em>views.js</em> from file system and adds channels accordingly</p>

<p>Asynchronously looks for a file called <em>channels.js</em> at the top
level of the specified directory.</p>

<p>The file <em>channels.js</em> must export an array containing channels object
in the format specified by the <em>ServerChannel</em> constructor. Every channel
configuration object can optionally have a <em>waitingRoom</em> object to
automatically add a waiting room to the channel.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">directory</span>
      <span class="dox_type">string</span>
      <span>The path in which <em>views.js</em> will be looked for

TODO: views.js file is not loaded anymore because all context are dynamics.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">PageManager
</span>
    </div>
  </div>
</div>

<p>GameLoader.prototype.loadViewsFile = function(directory, gameInfo) {
    var viewsFile, that, gameName;</p>


<div class="highlight"><pre><code><span class="k">if</span> <span class="p">(</span><span class="s">&#39;string&#39;</span> <span class="o">!==</span> <span class="n">typeof</span> <span class="n">directory</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">throw</span> <span class="k">new</span> <span class="n">TypeError</span><span class="p">(</span><span class="s">&#39;GameLoader.loadViewsFile: directory must be &#39;</span> <span class="o">+</span>
                        <span class="s">&#39;string.&#39;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">gameName</span> <span class="o">=</span> <span class="n">gameInfo</span><span class="o">.</span><span class="n">name</span><span class="p">;</span>
</code></pre></div>



<p>// TODO: see if still needed (broken now).
//
//     that = this;
//     viewsFile = directory + 'views/views.js';
//     fs.exists(viewsFile, function(exists) {
//          var cb, sb;
//          if (!exists) return;
//          cb = require(viewsFile);
//          if ('function' !== typeof cb) {
//              throw new TypeError('GameLoader.loadViewsFile: ' +
//                  'views.js did not ' +
//                  'return a valid function. Dir: ' + directory);
//          }
//          // Execute views function in a sandboxed enviroment.
//          // A game cannot modify other games settings.
//          sb = that.servernode.resourceManager
//               .getSandBox(gameName, directory);
//          cb(sb, gameInfo.settings);
//      });
};</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
