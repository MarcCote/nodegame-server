<!DOCTYPE html>
<html>
<head>
  <title>GameRouter.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "lib/GameRouter.js", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#gamerouter">GameRouter</a>
      </div>
      <div class="heading h3">
        <a href="#gamerouter.channel">GameRouter.channel</a>
      </div>
      <div class="heading h3">
        <a href="#gamerouter.servernode">GameRouter.servernode</a>
      </div>
      <div class="heading h3">
        <a href="#gamerouter.tokens">GameRouter.tokens</a>
      </div>
      <div class="heading h3">
        <a href="#gamerouter.supertokens">GameRouter.superTokens</a>
      </div>
      <div class="heading h3">
        <a href="#gameloader.addroutes">GameLoader.addRoutes</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods.">Helper Methods.</a>
      </div>
      <div class="heading h3">
        <a href="#loginsuper">loginSuper</a>
      </div>
      <div class="heading h3">
        <a href="#login">login</a>
      </div>
      <div class="heading h3">
        <a href="#createtoken">createToken</a>
      </div>
      <div class="heading h3">
        <a href="#rendertemplate">renderTemplate</a>
      </div>
      <div class="heading h3">
        <a href="#buildheaders">buildHeaders</a>
      </div>
      <div class="heading h3">
        <a href="#replytoclaimid">replyToClaimId</a>
      </div>
      <div class="heading h3">
        <a href="#getfilefromreq">getFileFromReq</a>
      </div>
      <div class="heading h3">
        <a href="#servefileordie">serveFileOrDie</a>
      </div>
      <div class="heading h3">
        <a href="#zipresults">zipResults</a>
      </div>
      <div class="heading h3">
        <a href="#trystringify">tryStringify</a>
      </div>
      <div class="heading h3">
        <a href="#asyncstringifyandsend">asyncStringifyAndSend</a>
      </div>
      <div class="heading h3">
        <a href="#verifytoken">verifyToken</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gamerouter">
  <h1>
    <a href="#gamerouter" name="gamerouter" class="pilcrow">&#182;</a>
    GameRouter
  </h1>
</div>


<p>Copyright(c) 2017 Stefano Balietti <a href="&#109;a&#105;l&#x74;&#111;:&#x73;&#116;&#x65;&#64;&#x6E;&#x6F;&#100;&#x65;&#103;&#x61;&#x6D;&#x65;&#46;&#111;r&#103;">&#x73;&#116;&#x65;&#64;&#x6E;&#x6F;&#100;&#x65;&#103;&#x61;&#x6D;&#x65;&#46;&#111;r&#103;</a>
MIT Licensed</p>
  </div>
  <div class="body"><p>Adds game routes depending on game settings.</p>

<p><a href='http://nodegame.org'>http://nodegame.org</a></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;path&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;jsonwebtoken&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;url&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;express&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">mime</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">.</span><span class="nx">mime</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">View</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">View</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">monitorDir</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;nodegame-monitor&#39;</span><span class="p">).</span><span class="nx">publicDirPath</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>expressJwt = require('express-jwt');</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="kd">var</span> <span class="nx">unauthMsg</span> <span class="o">=</span> <span class="s1">&#39;Sorry, but your connection is &#39;</span> <span class="o">+</span>
    <span class="s1">&#39;&lt;strong&gt;not&lt;/strong&gt; authorized.&#39;</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">GameRouter</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>TODO: see if we should move them in constructor.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


<span class="kd">function</span> <span class="nx">GameRouter</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gamerouter.channel">
  <h3>
    <a href="#gamerouter.channel" name="gamerouter.channel" class="pilcrow">&#182;</a>
    GameRouter.channel
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the ServerChannel</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">channel</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gamerouter.servernode">
  <h3>
    <a href="#gamerouter.servernode" name="gamerouter.servernode" class="pilcrow">&#182;</a>
    GameRouter.servernode
  </h3>
</div>

  </div>
  <div class="body"><p>Reference to the ServerNode</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">servernode</span><span class="p">;</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>TODO: check if we really needs tokens and superTokens
TODO: check if need tokens and superTokens with channel.noAuthCookie</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gamerouter.tokens">
  <h3>
    <a href="#gamerouter.tokens" name="gamerouter.tokens" class="pilcrow">&#182;</a>
    GameRouter.tokens
  </h3>
</div>

  </div>
  <div class="body"><p>Maps of signed tokens to client objects</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">tokens</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gamerouter.supertokens">
  <h3>
    <a href="#gamerouter.supertokens" name="gamerouter.supertokens" class="pilcrow">&#182;</a>
    GameRouter.superTokens
  </h3>
</div>

  </div>
  <div class="body"><p>Maps of signed tokens to client objects of admins</p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">this</span><span class="p">.</span><span class="nx">superTokens</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="gameloader.addroutes">
  <h3>
    <a href="#gameloader.addroutes" name="gameloader.addroutes" class="pilcrow">&#182;</a>
    GameLoader.addRoutes
  </h3>
</div>

  </div>
  <div class="body"><p>Add routes for the game name (and aliases)</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">alias</span>
      <span class="dox_type">string</span>
      <span>Optional. The name of the alias. Default:
  the channel game's name.</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.gameName</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">ServerChannel.gameInfo
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nx">GameRouter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addRoutes</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">alias</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">that</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">servernode</span><span class="p">,</span> <span class="nx">app</span><span class="p">,</span> <span class="nx">resourceManager</span><span class="p">,</span> <span class="nx">channel</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">basepath</span><span class="p">,</span> <span class="nx">rootDir</span><span class="p">,</span> <span class="nx">publicDir</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">auth</span><span class="p">,</span> <span class="nx">monitorUri</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">superTokens</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">gameDir</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">gameInfo</span><span class="p">,</span> <span class="nx">name</span><span class="p">;</span>

    <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
    <span class="nx">gameInfo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameInfo</span><span class="p">;</span>
    <span class="nx">gameName</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>

    <span class="nx">tokens</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">tokens</span><span class="p">;</span>
    <span class="nx">superTokens</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">superTokens</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>Add alias routes (if any and if it is not an alias already).
We add alias first so they are available also if this is default channel.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">alias</span> <span class="o">&amp;&amp;</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">alias</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">alias</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">addRoutes</span><span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">alias</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">servernode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">servernode</span><span class="p">;</span>
    <span class="nx">channel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>

    <span class="nx">basepath</span> <span class="o">=</span> <span class="nx">servernode</span><span class="p">.</span><span class="nx">basepath</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nx">app</span> <span class="o">=</span> <span class="nx">servernode</span><span class="p">.</span><span class="nx">http</span><span class="p">;</span>
    <span class="nx">resourceManager</span> <span class="o">=</span> <span class="nx">servernode</span><span class="p">.</span><span class="nx">resourceManager</span><span class="p">;</span>
    <span class="nx">rootDir</span> <span class="o">=</span> <span class="nx">servernode</span><span class="p">.</span><span class="nx">rootDir</span><span class="p">;</span>
    <span class="nx">publicDir</span> <span class="o">=</span> <span class="nx">rootDir</span> <span class="o">+</span> <span class="s1">&#39;/public/&#39;</span><span class="p">;</span>

    <span class="nx">gameDir</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">getDefaultChannel</span><span class="p">()</span> <span class="o">===</span> <span class="nx">gameName</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">alias</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">basepath</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">name</span> <span class="o">=</span> <span class="nx">basepath</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">alias</span> <span class="o">||</span> <span class="nx">gameName</span><span class="p">);</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>Adding the public directory of the game to the static directories
<a href='http://stackoverflow.com/questions/5973432/'>http://stackoverflow.com/questions/5973432/</a>
 setting-up-two-different-static-directories-in-node-js-express-framework</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">cacheMaxAge</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">gameDir</span> <span class="o">+</span> <span class="s1">&#39;public&#39;</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">gameDir</span> <span class="o">+</span> <span class="s1">&#39;public&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">maxAge</span><span class="o">:</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">cacheMaxAge</span>
        <span class="p">}));</span>
    <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>app.use(express.static(gameDir + 'public'));</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Auth.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">auth</span> <span class="o">&amp;&amp;</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">enabled</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">auth</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>claimId</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">claimId</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/claimid/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">valid</span><span class="p">,</span> <span class="nx">code</span><span class="p">;</span>
                <span class="kd">var</span> <span class="nx">cb</span><span class="p">;</span>
                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">callback</span> <span class="o">||</span> <span class="s1">&#39;callback&#39;</span><span class="p">;</span>
                <span class="nx">userId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Send it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/javascript&#39;</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Charset&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Claim Id can be disabled while the game runs, check again!</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">auth</span><span class="p">.</span><span class="nx">claimId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">replyToClaimId</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;operation disabled&#39;</span><span class="p">,</span>
                                          <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdModifyReply</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">userId</span> <span class="o">||</span> <span class="nx">userId</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">replyToClaimId</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;no code provided&#39;</span><span class="p">,</span>
                                          <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdModifyReply</span><span class="p">);</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdValidateRequest</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">valid</span> <span class="o">=</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdValidateRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>

                    <span class="k">if</span> <span class="p">(</span><span class="nx">valid</span> <span class="o">!==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">return</span> <span class="nx">replyToClaimId</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="nx">valid</span> <span class="o">||</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Ask the channel for next available code.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">code</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">claimId</span><span class="p">(</span><span class="nx">userId</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdPostProcess</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdPostProcess</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">,</span>
                                                <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
                    <span class="p">}</span>
                    <span class="k">return</span> <span class="nx">replyToClaimId</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="nx">code</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
                                          <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdModifyReply</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">else</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">replyToClaimId</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="s1">&#39;no more codes&#39;</span><span class="p">,</span>
                                          <span class="nx">auth</span><span class="p">.</span><span class="nx">claimIdModifyReply</span><span class="p">);</span>
                <span class="p">}</span>

            <span class="p">});</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>TODO: Monitor route was before auth, now moved in alias-if.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/auth/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">;</span>
            <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
            <span class="nx">userId</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="nx">pwd</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="nx">login</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>If not alias, add monitor route and
optimize auth check for alias and not alias.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">alias</span><span class="p">)</span> <span class="p">{</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor/auth/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">;</span>
                <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">);</span>
                <span class="nx">userId</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
                <span class="nx">pwd</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
                <span class="nx">loginSuper</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">userId</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">req</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
                    <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;monitor/&#39;</span><span class="p">)</span> <span class="p">{</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span> <span class="o">||</span>
                        <span class="o">!</span><span class="nx">superTokens</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span><span class="p">])</span> <span class="p">{</span>

                        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">unauthMsg</span><span class="p">);</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Check if a cookie is set correctly.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span> <span class="o">||</span> <span class="o">!</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">unauthMsg</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Auth OK.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">next</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span> <span class="o">||</span> <span class="o">!</span><span class="nx">tokens</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span><span class="p">])</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">403</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">unauthMsg</span><span class="p">);</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>Auth OK.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">next</span><span class="p">();</span>
            <span class="p">});</span>
        <span class="p">}</span>

    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>Monitor (no monitor in aliases).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">alias</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">monitorUri</span> <span class="o">=</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor/index.htm?channel=&#39;</span> <span class="o">+</span>
            <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">adminServer</span><span class="p">.</span><span class="nx">endpoint</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>If channel can read servernode properties.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">servernode</span><span class="p">.</span><span class="nx">acm</span><span class="p">.</span><span class="nx">read</span><span class="p">[</span><span class="nx">gameName</span><span class="p">])</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>Serving server logs.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor/servernode/logs/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">serveFileOrDie</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">gameInfo</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">servernode</span><span class="p">.</span><span class="nx">logDir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">;</span>
                <span class="p">});</span>
            <span class="p">});</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Serving results from data/ directory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor/data/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">serveFileOrDie</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">gameInfo</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;data/&#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Serving results from data/ directory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor/memorydb/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">roomName</span><span class="p">,</span> <span class="nx">room</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">out</span><span class="p">,</span> <span class="nx">outStr</span><span class="p">;</span>

            <span class="nx">out</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">for</span> <span class="p">(</span><span class="nx">roomName</span> <span class="k">in</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">roomName</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">room</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">roomName</span><span class="p">];</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">roomType</span> <span class="o">===</span> <span class="s1">&#39;Game&#39;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">out</span> <span class="o">=</span> <span class="nx">out</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">room</span><span class="p">.</span><span class="nx">getMemoryDb</span><span class="p">());</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>Stringify fails if there are cycle (it shouldn't anyway).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">outStr</span> <span class="o">=</span> <span class="nx">tryStringify</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">outStr</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="nx">asyncStringifyAndSend</span><span class="p">(</span><span class="nx">out</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
            <span class="k">else</span> <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">outStr</span><span class="p">);</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Serving results from data/ directory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor/authsettings/:setting/*&#39;</span><span class="p">,</span>
                <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">setting</span><span class="p">,</span> <span class="nx">file</span><span class="p">;</span>
            <span class="nx">setting</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">setting</span><span class="p">;</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>Security check.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">file</span> <span class="o">||</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">auth</span><span class="p">[</span><span class="nx">setting</span><span class="p">]</span> <span class="o">!==</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Invalid request.&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">serveFileOrDie</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">gameInfo</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">isAbsolute</span><span class="p">(</span><span class="nx">file</span><span class="p">))</span> <span class="k">return</span> <span class="nx">file</span><span class="p">;</span>
                <span class="k">return</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;auth/&#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">;</span>
            <span class="p">});</span>
        <span class="p">});</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">search</span><span class="p">;</span>
            <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">===</span> <span class="nx">file</span> <span class="o">||</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">search</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">search</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">search</span><span class="p">)</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">monitorUri</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span><span class="nx">search</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
                <span class="k">else</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">monitorUri</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;\/&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Removing the trailing slash because it creates:
Error: ENOTDIR in fetching the file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">file</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>Build path to file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">monitorDir</span> <span class="o">+</span> <span class="nx">file</span><span class="p">);</span>

            <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/monitor&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">monitorUri</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Game. (default index.htm).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/*&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="nx">headers</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">decoded</span><span class="p">,</span> <span class="nx">clientId</span><span class="p">,</span> <span class="nx">token</span><span class="p">;</span>

        <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">===</span> <span class="nx">file</span> <span class="o">||</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">file</span><span class="p">)</span> <span class="nx">file</span> <span class="o">=</span> <span class="s1">&#39;index.htm&#39;</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">channel</span><span class="p">.</span><span class="nx">noAuthCookie</span><span class="p">)</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">decoded</span> <span class="o">=</span> <span class="nx">verifyToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span><span class="p">,</span>
                                      <span class="nx">channel</span><span class="p">.</span><span class="nx">secret</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>If no cookie is found, or if the channel session is
not correct, generates a new ID and sets the cookie.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">decoded</span> <span class="o">||</span> <span class="p">(</span><span class="nx">decoded</span><span class="p">.</span><span class="nx">session</span> <span class="o">!==</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">session</span><span class="p">))</span> <span class="p">{</span>
                    <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">generateClientId</span><span class="p">();</span>
                    <span class="nx">token</span> <span class="o">=</span> <span class="nx">createToken</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">);</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;nodegame_token&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="p">{</span>
                        <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
                        <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span>
                    <span class="p">});</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Build filePath to file in public directory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;public/&#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>TODO: move after refactoring.
Send JSON data as JSONP if there is a callback query parameter:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\.json$/</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Load file contents:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">json</span><span class="p">({</span><span class="nx">error</span><span class="o">:</span> <span class="s1">&#39;file not found&#39;</span><span class="p">});</span>
                    <span class="k">return</span><span class="p">;</span>
                <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Send it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s1">&#39;application/javascript&#39;</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;Charset&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">callback</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">data</span> <span class="o">+</span> <span class="s1">&#39;);&#39;</span><span class="p">);</span>
            <span class="p">});</span>

            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Build headers.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">headers</span> <span class="o">=</span> <span class="nx">buildHeaders</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>If it is not text, it was not cached.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">].</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">&#39;text&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Already found in <code>public/</code> and cached.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">resourceManager</span><span class="p">.</span><span class="nx">getFromPublic</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">file</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cachedFile</span><span class="p">)</span> <span class="p">{</span>

            <span class="kd">var</span> <span class="nx">basename</span><span class="p">,</span> <span class="nx">templatePath</span><span class="p">,</span> <span class="nx">templateFound</span><span class="p">,</span> <span class="nx">contextPath</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>File in public (cached or loaded).</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">cachedFile</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">headers</span><span class="p">);</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">cachedFile</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>FIX HERE.
console.log('NNNNNOT in public: ', file);</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Check if it a template.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">basename</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">));</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Instantiate templates, if available.
<code>html/templates/page.jade</code> holds the template and
<code>html/contexts/xx/xx/page.js</code> holds the context callback
to instantiate the page requested by <code>xx/xx/page*</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>Matches: xx/xx/xx/xx/xx/</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">basename</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[^\/]*\/.*$/</span><span class="p">))</span> <span class="p">{</span>
                <span class="nx">templatePath</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;views/templates/&#39;</span> <span class="o">+</span>
                    <span class="nx">basename</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.jade&#39;</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="nx">templatePath</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;views/templates/&#39;</span> <span class="o">+</span>
                    <span class="nx">basename</span> <span class="o">+</span> <span class="s1">&#39;.jade&#39;</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="nx">contextPath</span> <span class="o">=</span> <span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;views/contexts/&#39;</span> <span class="o">+</span> <span class="nx">basename</span> <span class="o">+</span> <span class="s1">&#39;.js&#39;</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>Info about previous requests to the template file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="nx">templateFound</span> <span class="o">=</span> <span class="nx">resourceManager</span><span class="p">.</span><span class="nx">inTemplates</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">templatePath</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Template not existing.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">if</span> <span class="p">(</span><span class="nx">templateFound</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;File not Found&#39;</span><span class="p">);</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Template existing, render it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">templateFound</span> <span class="o">===</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">resourceManager</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span>
                               <span class="nx">templatePath</span><span class="p">,</span> <span class="nx">contextPath</span><span class="p">);</span>
            <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Do not know if exists or not, check and render it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="k">else</span> <span class="p">{</span>

                <span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">templatePath</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">resourceManager</span><span class="p">.</span><span class="nx">inTemplates</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">templatePath</span><span class="p">,</span>
                                                    <span class="kc">false</span><span class="p">);</span>

                        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;File not found&#39;</span><span class="p">);</span>
                        <span class="k">return</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="nx">resourceManager</span><span class="p">.</span><span class="nx">inTemplates</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">templatePath</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                    <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">resourceManager</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span>
                                   <span class="nx">templatePath</span><span class="p">,</span> <span class="nx">contextPath</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>Check if it is a view.
           resourceManager.getFromViews(gameName, file, function(view) {</p>


<div class="highlight"><pre><code>           <span class="sr">//</span> <span class="n">View</span> <span class="n">found</span><span class="o">.</span>
           <span class="k">if</span> <span class="p">(</span><span class="n">view</span><span class="p">)</span> <span class="p">{</span>
               <span class="n">res</span><span class="o">.</span><span class="nb">send</span><span class="p">(</span><span class="n">view</span><span class="p">);</span>
           <span class="p">}</span>
           <span class="k">else</span> <span class="p">{</span>
               <span class="n">res</span><span class="o">.</span><span class="nb">send</span><span class="p">(</span><span class="mi">404</span><span class="p">);</span>
           <span class="p">}</span>
       <span class="p">},</span> <span class="n">gameInfo</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">headers</span><span class="p">);</span>
   <span class="p">});</span>
</code></pre></div>


        </td>
        <td class="code highlight"><div class="highlight"><pre>


    <span class="p">});</span>

    <span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods.">
  <h2>
    <a href="#helper%20methods." name="helper%20methods." class="pilcrow">&#182;</a>
    Helper Methods.
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="loginsuper">
  <h3>
    <a href="#loginsuper" name="loginsuper" class="pilcrow">&#182;</a>
    loginSuper
  </h3>
</div>

  </div>
  <div class="body"><p>Checks if an incoming super-user connection is authorized, if so registers it</p>

<p>A super-user is a client that is trying to connect to the monitor/ uri.</p>

<p>Authorization is done against the data in channel/channel.credentials.js.</p>

<p>An authorized connection receives a cookie with signed JSON web token
and it is redirected to the actual monitor/ uri.</p>

<p>A connection that is not authorized simply receives a warning message.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Reference</span>
      <span class="dox_type">GameRouter</span>
      <span>to this GameRouter instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameName</span>
      <span class="dox_type">string</span>
      <span>The name of the game (with basedir, if any)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">user</span>
      <span class="dox_type">string</span>
      <span>The id of the user</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">pwd</span>
      <span class="dox_type">string</span>
      <span>The password for the user</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">object</span>
      <span>The request object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">res</span>
      <span class="dox_type">object</span>
      <span>The respond object from Express</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if connection is authorized, FALSE otherwise</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">createToken
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">loginSuper</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">authorized</span><span class="p">,</span> <span class="nx">token</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">search</span><span class="p">,</span> <span class="nx">redirectUri</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">channel</span><span class="p">;</span>

    <span class="nx">channel</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>
    <span class="nx">authorized</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">authorizeSuperUser</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">authorized</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">createToken</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">superTokens</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;nodegame_token&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
            <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>
        <span class="nx">redirectUri</span> <span class="o">=</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;/monitor/&#39;</span><span class="p">;</span>
        <span class="nx">search</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">search</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search</span><span class="p">)</span> <span class="nx">redirectUri</span> <span class="o">+=</span> <span class="nx">search</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">redirectUri</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Wrong user/pwd.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="login">
  <h3>
    <a href="#login" name="login" class="pilcrow">&#182;</a>
    login
  </h3>
</div>

  </div>
  <div class="body"><p>Checks if an incoming connection is authorized, if so registers it</p>

<p>An authorized connection receives a cookie with signed JSON web token
and it is redirected to the actual game uri.</p>

<p>A connection that is not authorized simply receives a warning message.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">Reference</span>
      <span class="dox_type">GameRouter</span>
      <span>to this GameRouter instance</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameName</span>
      <span class="dox_type">string</span>
      <span>The name of the game (with basedir, if any)</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">user</span>
      <span class="dox_type">string</span>
      <span>The id of the user</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">pwd</span>
      <span class="dox_type">string</span>
      <span>The password for the user</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">object</span>
      <span>The request object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">res</span>
      <span class="dox_type">object</span>
      <span>The respond object from Express</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">boolean</span>
      <span>TRUE if connection is authorized, FALSE otherwise</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">createToken
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">login</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pwd</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">authorized</span><span class="p">,</span> <span class="nx">token</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">search</span><span class="p">,</span> <span class="nx">redirectUri</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">channel</span><span class="p">;</span>

    <span class="nx">channel</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">channel</span><span class="p">;</span>
    <span class="nx">authorized</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">authorize</span><span class="p">({</span> <span class="nx">id</span><span class="o">:</span> <span class="nx">user</span><span class="p">,</span> <span class="nx">pwd</span><span class="o">:</span> <span class="nx">pwd</span> <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">authorized</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">token</span> <span class="o">=</span> <span class="nx">createToken</span><span class="p">(</span><span class="nx">user</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">tokens</span><span class="p">);</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">cookie</span><span class="p">(</span><span class="s1">&#39;nodegame_token&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
            <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span>
        <span class="p">});</span>
        <span class="nx">redirectUri</span> <span class="o">=</span> <span class="nx">gameName</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
        <span class="nx">search</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">).</span><span class="nx">search</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">search</span><span class="p">)</span> <span class="nx">redirectUri</span> <span class="o">+=</span> <span class="nx">search</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="nx">redirectUri</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;Wrong user/pwd.&#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="createtoken">
  <h3>
    <a href="#createtoken" name="createtoken" class="pilcrow">&#182;</a>
    createToken
  </h3>
</div>

  </div>
  <div class="body"><p>Creates a signed JSON web token</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">userId</span>
      <span class="dox_type">string</span>
      <span>The id of the user</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">channel</span>
      <span class="dox_type">object</span>
      <span>An object containing the channel's secret
  the channel's session id</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">tokenList</span>
      <span class="dox_type">object</span>
      <span>An object used to map the tokens to user profiles</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The signed JSON web token</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">createToken</span><span class="p">(</span><span class="nx">userId</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span> <span class="nx">tokenList</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">profile</span><span class="p">,</span> <span class="nx">secret</span><span class="p">,</span> <span class="nx">expire</span><span class="p">,</span> <span class="nx">token</span><span class="p">;</span>
    <span class="nx">profile</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nx">clientId</span><span class="o">:</span> <span class="nx">userId</span><span class="p">,</span>
        <span class="nx">session</span><span class="o">:</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">session</span>
    <span class="p">};</span>

    <span class="nx">secret</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">secret</span><span class="p">;</span>
    <span class="nx">expire</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">5</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>We are sending the profile in the token.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">token</span> <span class="o">=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">sign</span><span class="p">(</span><span class="nx">profile</span><span class="p">,</span> <span class="nx">secret</span><span class="p">,</span> <span class="p">{</span> <span class="nx">expiresIn</span><span class="o">:</span> <span class="nx">expire</span><span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<p>Store the token somewhere.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">tokenList</span><span class="p">[</span><span class="nx">token</span><span class="p">]</span> <span class="o">=</span> <span class="nx">profile</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">token</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="rendertemplate">
  <h3>
    <a href="#rendertemplate" name="rendertemplate" class="pilcrow">&#182;</a>
    renderTemplate
  </h3>
</div>

  </div>
  <div class="body"><p>Renders a template and sents it to a client</p>

<p>If an error occurs, or file is not found sends a 404 error.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">resourceManager</span>
      <span class="dox_type">ResourceManager</span>
      <span>Reference to the resource manager</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">object</span>
      <span>The request object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">res</span>
      <span class="dox_type">object</span>
      <span>The respond object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">templatePath</span>
      <span class="dox_type">string</span>
      <span>The path to the template file</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">contextPath</span>
      <span class="dox_type">string</span>
      <span>The path to the context file</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">resourceManager</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">channel</span><span class="p">,</span>
                        <span class="nx">templatePath</span><span class="p">,</span> <span class="nx">contextPath</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">gameName</span><span class="p">,</span> <span class="nx">gameSettings</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">context</span><span class="p">,</span> <span class="nx">cb</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">clientId</span><span class="p">,</span> <span class="nx">room</span><span class="p">,</span> <span class="nx">treatmentName</span><span class="p">;</span>

    <span class="nx">gameName</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameName</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>Build the right settings object to pass to the context callback.
By default, it is the 'standard' treatment. If we
can locate the client id (via signed cookie), and if the client id
is found in a room with a treatment, then use just the settings for
that particular treatment.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">treatmentName</span> <span class="o">=</span> <span class="s1">&#39;standard&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">clientId</span> <span class="o">=</span> <span class="nx">verifyToken</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span><span class="p">,</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">secret</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">clientId</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">channel</span><span class="p">.</span><span class="nx">sysLogger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;GameRouter renderTemplate: failed to &#39;</span> <span class="o">+</span>
                                  <span class="s1">&#39;verify token &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">nodegame_token</span> <span class="o">+</span>
                                  <span class="s1">&#39; in channel &#39;</span> <span class="o">+</span> <span class="nx">gameName</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">room</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">registry</span><span class="p">.</span><span class="nx">getClientRoom</span><span class="p">(</span><span class="nx">clientId</span><span class="p">);</span>
            <span class="nx">room</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameRooms</span><span class="p">[</span><span class="nx">room</span><span class="p">];</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">room</span><span class="p">)</span> <span class="nx">treatmentName</span> <span class="o">=</span> <span class="nx">room</span><span class="p">.</span><span class="nx">treatmentName</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">gameSettings</span> <span class="o">=</span> <span class="nx">channel</span><span class="p">.</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">settings</span><span class="p">[</span><span class="nx">treatmentName</span><span class="p">];</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>Context is retrieved from cache,
and can be modified by user-defined callbacks.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">context</span> <span class="o">=</span> <span class="nx">resourceManager</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">contextPath</span><span class="p">,</span> <span class="nx">gameSettings</span><span class="p">,</span>
                                         <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">templatePath</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">contextPath</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">try</span> <span class="p">{</span>
                <span class="nx">cb</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="nx">contextPath</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;function&#39;</span> <span class="o">!==</span> <span class="k">typeof</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span><span class="p">(</span><span class="s1">&#39;GameRouter renderTemplate: context  &#39;</span> <span class="o">+</span>
                                        <span class="s1">&#39;callback must be function. Found: &#39;</span> <span class="o">+</span>
                                        <span class="nx">cb</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resourceManager</span>
                    <span class="p">.</span><span class="nx">servernode</span>
                    <span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;GameRouter renderTemplate: error loading &#39;</span> <span class="o">+</span>
                                  <span class="s1">&#39;context file: &#39;</span> <span class="o">+</span> <span class="nx">contextPath</span> <span class="o">+</span>
                                  <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>TODO: Log error.
TODO: Mark file as non-existing ?</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
                <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;File not Found&#39;</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nx">resourceManager</span><span class="p">.</span><span class="nx">cacheContextCallback</span><span class="p">(</span><span class="nx">gameName</span><span class="p">,</span> <span class="nx">contextPath</span><span class="p">,</span> <span class="nx">cb</span><span class="p">);</span>
            <span class="nx">context</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">gameSettings</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">);</span>
        <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>Render anyway, with or without context.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">templatePath</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="buildheaders">
  <h3>
    <a href="#buildheaders" name="buildheaders" class="pilcrow">&#182;</a>
    buildHeaders
  </h3>
</div>

  </div>
  <div class="body"><p>Formats the response headers looking up the mime type of the file</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">file</span>
      <span class="dox_type">string</span>
      <span>The name of the file (containing extension) that
  that will be sent to a client</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span>headers The headers with the added 'Content-Type' property</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">buildHeaders</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">mimeType</span><span class="p">,</span> <span class="nx">charset</span><span class="p">,</span> <span class="nx">headers</span><span class="p">;</span>
    <span class="nx">mimeType</span> <span class="o">=</span> <span class="nx">mime</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
    <span class="nx">charset</span> <span class="o">=</span> <span class="nx">mime</span><span class="p">.</span><span class="nx">charsets</span><span class="p">.</span><span class="nx">lookup</span><span class="p">(</span><span class="nx">mimeType</span><span class="p">);</span>
    <span class="nx">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;Content-Type&#39;</span><span class="o">:</span> <span class="nx">mimeType</span> <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">charset</span><span class="p">)</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">charset</span> <span class="o">=</span> <span class="nx">charset</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">headers</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="replytoclaimid">
  <h3>
    <a href="#replytoclaimid" name="replytoclaimid" class="pilcrow">&#182;</a>
    replyToClaimId
  </h3>
</div>

  </div>
  <div class="body"><p>Formats the response to a claim-id a request and sends it as a JSONP</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">res</span>
      <span class="dox_type">object</span>
      <span>The respond object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cbName</span>
      <span class="dox_type">string</span>
      <span>The name of of the callback function that will
  be executed on the clients upon receiving the response</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">responseCode</span>
      <span class="dox_type">number</span>
      <span>The status of the response, 200 for
  for success. It changes how the response objects sends the data
  back to client</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">codeOrErr</span>
      <span class="dox_type">string</span>
      <span>The a valid code, or an error string that
  will be sent to client</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">modReplyCb</span>
      <span class="dox_type">function</span>
      <span>Optional. A callback that modifies the
  reply object before sending it</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">replyToClaimId</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">cbName</span><span class="p">,</span> <span class="nx">responseCode</span><span class="p">,</span> <span class="nx">codeOrErr</span><span class="p">,</span> <span class="nx">modReplyCb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">code</span><span class="p">;</span>
    <span class="nx">code</span> <span class="o">=</span> <span class="nx">responseCode</span> <span class="o">===</span> <span class="mi">200</span> <span class="o">?</span> <span class="p">{</span> <span class="nx">code</span><span class="o">:</span> <span class="nx">codeOrErr</span> <span class="p">}</span> <span class="o">:</span> <span class="p">{</span> <span class="nx">err</span><span class="o">:</span> <span class="nx">codeOrErr</span> <span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">modReplyCb</span><span class="p">)</span> <span class="nx">modReplyCb</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;claim id: &#39;</span> <span class="o">+</span> <span class="nx">codeOrErr</span><span class="p">);</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">responseCode</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">cbName</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="getfilefromreq">
  <h3>
    <a href="#getfilefromreq" name="getfilefromreq" class="pilcrow">&#182;</a>
    getFileFromReq
  </h3>
</div>

  </div>
  <div class="body"><p>Extracts the file from an incoming request (params[0])</p>

<p>If the request is malformed, it sends a 404 error and returns</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">object</span>
      <span>The request object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">res</span>
      <span class="dox_type">object</span>
      <span>The respond object from Express</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span class="dox_type">boolean</span>
      <span>file The requested file or false, if the
  the request was malformed</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">getFileFromReq
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">getFileFromReq</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">file</span><span class="p">;</span>
    <span class="nx">file</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="o">===</span> <span class="nx">file</span> <span class="o">||</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">===</span> <span class="k">typeof</span> <span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;No file specified.&#39;</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;\/&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<p>Removing the trailing slash because it creates:
Error: ENOTDIR in fetching the file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">file</span> <span class="o">=</span> <span class="nx">file</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">file</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">file</span><span class="p">;</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="servefileordie">
  <h3>
    <a href="#servefileordie" name="servefileordie" class="pilcrow">&#182;</a>
    serveFileOrDie
  </h3>
</div>

  </div>
  <div class="body"><p>Analizes the request object and sends the requested file or a 404 error</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">object</span>
      <span>The request object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">res</span>
      <span class="dox_type">object</span>
      <span>The respond object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameInfo</span>
      <span class="dox_type">object</span>
      <span>The game info as in channel</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">function</span>
      <span>A callback function that adjusts the path to
   the requested file (files can be also outside of the game directory)</span>
    </div>
    <div class="dox_tag_title">See</div>
    <div class="dox_tag_detail">
      <span class="dox_type">getFileFromReq
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">serveFileOrDie</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">gameInfo</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">filePath</span><span class="p">,</span> <span class="nx">file</span><span class="p">;</span>

    <span class="nx">file</span> <span class="o">=</span> <span class="nx">getFileFromReq</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">file</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">file</span> <span class="o">===</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">zipResults</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">gameInfo</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Build path to file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">filePath</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>

    <span class="nx">fs</span><span class="p">.</span><span class="nx">exists</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">exists</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">404</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;File not found: &#39;</span> <span class="o">+</span> <span class="nx">file</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">filePath</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="zipresults">
  <h3>
    <a href="#zipresults" name="zipresults" class="pilcrow">&#182;</a>
    zipResults
  </h3>
</div>

  </div>
  <div class="body"><p>Zips all the files in the data/ directory and sends the archive</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">req</span>
      <span class="dox_type">object</span>
      <span>The request object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">res</span>
      <span class="dox_type">object</span>
      <span>The respond object from Express</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">gameInfo</span>
      <span class="dox_type">object</span>
      <span>The game info as in channel</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">zipResults</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">gameInfo</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">archiver</span><span class="p">,</span> <span class="nx">archive</span><span class="p">;</span>

    <span class="nx">archiver</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;archiver&#39;</span><span class="p">);</span>
    <span class="nx">archive</span> <span class="o">=</span> <span class="nx">archiver</span><span class="p">(</span><span class="s1">&#39;zip&#39;</span><span class="p">);</span>

    <span class="nx">archive</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">500</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span><span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">});</span>
    <span class="p">});</span>

    <span class="nx">res</span><span class="p">.</span><span class="nx">attachment</span><span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">info</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;-data_&#39;</span> <span class="o">+</span>
                   <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span> <span class="o">+</span> <span class="s1">&#39;.zip&#39;</span><span class="p">);</span>
    <span class="nx">archive</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">res</span><span class="p">);</span>
    <span class="nx">archive</span><span class="p">.</span><span class="nx">directory</span><span class="p">(</span><span class="nx">gameInfo</span><span class="p">.</span><span class="nx">dir</span> <span class="o">+</span> <span class="s1">&#39;data/&#39;</span><span class="p">,</span> <span class="s1">&#39;data/&#39;</span><span class="p">);</span>
    <span class="nx">archive</span><span class="p">.</span><span class="nx">finalize</span><span class="p">();</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="trystringify">
  <h3>
    <a href="#trystringify" name="trystringify" class="pilcrow">&#182;</a>
    tryStringify
  </h3>
</div>

  </div>
  <div class="body"><p>Try to stringify an object (should not have cycles)</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">o</span>
      <span class="dox_type">mixed</span>
      <span>The item to stringify</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The stringified item, or false if an error occurred</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">tryStringify</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">i</span><span class="p">;</span>
<span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="asyncstringifyandsend">
  <h3>
    <a href="#asyncstringifyandsend" name="asyncstringifyandsend" class="pilcrow">&#182;</a>
    asyncStringifyAndSend
  </h3>
</div>

  </div>
  <div class="body"><p>Decycles and strinfies a collection of items, then sends it</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">db</span>
      <span class="dox_type">array</span>
      <span>The collection of items to stringify</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">string</span>
      <span>The stringified item, or false if an error occurred</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">asyncStringifyAndSend</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">len</span><span class="p">,</span> <span class="nx">out</span><span class="p">;</span>
        <span class="nx">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">len</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
        <span class="nx">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">len</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">len</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
            <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">decycle</span><span class="p">(</span><span class="nx">db</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="nx">out</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="verifytoken">
  <h3>
    <a href="#verifytoken" name="verifytoken" class="pilcrow">&#182;</a>
    verifyToken
  </h3>
</div>

  </div>
  <div class="body"><p>Verifies a signed JSON web token</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">token</span>
      <span class="dox_type">string</span>
      <span>The encrypted token</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">secret</span>
      <span class="dox_type">string</span>
      <span>The secret</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">object</span>
      <span class="dox_type">boolean</span>
      <span>The decoded token, or FALSE if an error occurred</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="kd">function</span> <span class="nx">verifyToken</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secret</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">verify</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">secret</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
